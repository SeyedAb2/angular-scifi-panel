import{A as Aa,B as Sa,C as Ca,D as ba,E as Ra,F as Pa,p as pa,q as ga,r as _a,s as Oe,t as ya,u as va,v as wa,x as Ea,y as Ia,z as Ta}from"./chunk-ENULC5LS.js";import{F as Dg}from"./chunk-M2GAKB2R.js";import{E as yc,G as vc,Ha as oa,Jb as la,V as ta,ba as na,c as Zo,da as Yn,ea as Rg,gb as aa,ha as Pg,ia as ra,j as ea,ja as xg,p as cs,pa as Ng,q as hs,u as Le,ua as ia,va as sa,xa as mn,za as re}from"./chunk-DLPH24CR.js";import{A as z,B as ot,C as Ve,D as Tc,E as jg,F as ms,G as ee,H as Dt,I as da,J as Ac,K as gt,L as Lr,M as fa,N as ma,P as Ur,Q as gn,a as O,b as Mr,c as kg,d as Vg,e as Og,f as Ze,g as ua,h as ds,i as wc,j as Fg,k as Nt,l as Ec,m as Mg,n as Lg,p as ca,q as Pe,r as Ug,s as Bg,t as pt,u as pn,v as ha,w as fs,x as Ic,y as qg,z as Gg}from"./chunk-X2P3SVT6.js";import{a as Fr,b as us,h as _c,i as N}from"./chunk-FFXK657A.js";var Kg="@firebase/database",zg="1.0.8";var Fh="";function Mh(n){Fh=n}var Dc=class{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){t==null?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),Pe(t))}get(e){let t=this.domStorage_.getItem(this.prefixedName_(e));return t==null?null:ca(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}};var kc=class{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){t==null?delete this.cache_[e]:this.cache_[e]=t}get(e){return pt(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}};var I_=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){let e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Dc(e)}}catch{}return new kc},Xn=I_("localStorage"),Vc=I_("sessionStorage");var jr=new Lr("@firebase/database"),T_=function(){let n=1;return function(){return n++}}(),A_=function(n){let e=jg(n),t=new Gg;t.update(e);let r=t.digest();return kg.encodeByteArray(r)},Ls=function(...n){let e="";for(let t=0;t<n.length;t++){let r=n[t];Array.isArray(r)||r&&typeof r=="object"&&typeof r.length=="number"?e+=Ls.apply(null,r):typeof r=="object"?e+=Pe(r):e+=r,e+=" "}return e},Zn=null,Wg=!0,S_=function(n,e){O(!e||n===!0||n===!1,"Can't turn on custom loggers persistently."),n===!0?(jr.logLevel=gt.VERBOSE,Zn=jr.log.bind(jr),e&&Vc.set("logging_enabled",!0)):typeof n=="function"?Zn=n:(Zn=null,Vc.remove("logging_enabled"))},Ue=function(...n){if(Wg===!0&&(Wg=!1,Zn===null&&Vc.get("logging_enabled")===!0&&S_(!0)),Zn){let e=Ls.apply(null,n);Zn(e)}},Us=function(n){return function(...e){Ue(n,...e)}},Oc=function(...n){let e="FIREBASE INTERNAL ERROR: "+Ls(...n);jr.error(e)},Ot=function(...n){let e=`FIREBASE FATAL ERROR: ${Ls(...n)}`;throw jr.error(e),new Error(e)},$e=function(...n){let e="FIREBASE WARNING: "+Ls(...n);jr.warn(e)},xT=function(){typeof window<"u"&&window.location&&window.location.protocol&&window.location.protocol.indexOf("https:")!==-1&&$e("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},rl=function(n){return typeof n=="number"&&(n!==n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},NT=function(n){if(Nt()||document.readyState==="complete")n();else{let e=!1,t=function(){if(!document.body){setTimeout(t,Math.floor(10));return}e||(e=!0,n())};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{document.readyState==="complete"&&t()}),window.attachEvent("onload",t))}},wn="[MIN_NAME]",Jt="[MAX_NAME]",tr=function(n,e){if(n===e)return 0;if(n===wn||e===Jt)return-1;if(e===wn||n===Jt)return 1;{let t=Qg(n),r=Qg(e);return t!==null?r!==null?t-r===0?n.length-e.length:t-r:-1:r!==null?1:n<e?-1:1}},DT=function(n,e){return n===e?0:n<e?-1:1},ps=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+Pe(e))},Lh=function(n){if(typeof n!="object"||n===null)return Pe(n);let e=[];for(let r in n)e.push(r);e.sort();let t="{";for(let r=0;r<e.length;r++)r!==0&&(t+=","),t+=Pe(e[r]),t+=":",t+=Lh(n[e[r]]);return t+="}",t},C_=function(n,e){let t=n.length;if(t<=e)return[n];let r=[];for(let i=0;i<t;i+=e)i+e>t?r.push(n.substring(i,t)):r.push(n.substring(i,i+e));return r};function Be(n,e){for(let t in n)n.hasOwnProperty(t)&&e(t,n[t])}var b_=function(n){O(!rl(n),"Invalid JSON number");let e=11,t=52,r=(1<<e-1)-1,i,s,o,l,u;n===0?(s=0,o=0,i=1/n===-1/0?1:0):(i=n<0,n=Math.abs(n),n>=Math.pow(2,1-r)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),r),s=l+r,o=Math.round(n*Math.pow(2,t-l)-Math.pow(2,t))):(s=0,o=Math.round(n/Math.pow(2,1-r-t))));let c=[];for(u=t;u;u-=1)c.push(o%2?1:0),o=Math.floor(o/2);for(u=e;u;u-=1)c.push(s%2?1:0),s=Math.floor(s/2);c.push(i?1:0),c.reverse();let d=c.join(""),m="";for(u=0;u<64;u+=8){let p=parseInt(d.substr(u,8),2).toString(16);p.length===1&&(p="0"+p),m=m+p}return m.toLowerCase()},kT=function(){return!!(typeof window=="object"&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))},VT=function(){return typeof Windows=="object"&&typeof Windows.UI=="object"};function OT(n,e){let t="Unknown Error";n==="too_big"?t="The data requested exceeds the maximum size that can be accessed with a single request.":n==="permission_denied"?t="Client doesn't have permission to access the desired data.":n==="unavailable"&&(t="The service is unavailable");let r=new Error(n+" at "+e._path.toString()+": "+t);return r.code=n.toUpperCase(),r}var FT=new RegExp("^-?(0*)\\d{1,10}$"),MT=-2147483648,LT=2147483647,Qg=function(n){if(FT.test(n)){let e=Number(n);if(e>=MT&&e<=LT)return e}return null},Xr=function(n){try{n()}catch(e){setTimeout(()=>{let t=e.stack||"";throw $e("Exception was thrown by user callback.",t),e},Math.floor(0))}},UT=function(){return(typeof window=="object"&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},vs=function(n,e){let t=setTimeout(n,e);return typeof t=="number"&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):typeof t=="object"&&t.unref&&t.unref(),t};var Fc=class{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=t?.getImmediate({optional:!0}),this.appCheck||t?.get().then(r=>this.appCheck=r)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,r)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){var t;(t=this.appCheckProvider)===null||t===void 0||t.get().then(r=>r.addTokenListener(e))}notifyForInvalidToken(){$e(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}};var Mc=class{constructor(e,t,r){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=r,this.auth_=null,this.auth_=r.getImmediate({optional:!0}),this.auth_||r.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&t.code==="auth/token-not-initialized"?(Ue("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,r)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,r):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',$e(e)}},ws=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}n.OWNER="owner";return n})(),Na="5",R_="v",P_="s",x_="r",N_="f",D_=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,k_="ls",V_="p",Lc="ac",O_="websocket",F_="long_polling";var Da=class{constructor(e,t,r,i,s=!1,o="",l=!1,u=!1){this.secure=t,this.namespace=r,this.webSocketOnly=i,this.nodeAdmin=s,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=u,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=Xn.get("host:"+e)||this._host}isCacheableHost(){return this.internalHost.substr(0,2)==="s-"}isCustomHost(){return this._domain!=="firebaseio.com"&&this._domain!=="firebaseio-demo.com"}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&Xn.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){let e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}};function BT(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams}function M_(n,e,t){O(typeof e=="string","typeof type must == string"),O(typeof t=="object","typeof params must == object");let r;if(e===O_)r=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else if(e===F_)r=(n.secure?"https://":"http://")+n.internalHost+"/.lp?";else throw new Error("Unknown connection type: "+e);BT(n)&&(t.ns=n.namespace);let i=[];return Be(t,(s,o)=>{i.push(s+"="+o)}),r+i.join("&")}var Uc=class{constructor(){this.counters_={}}incrementCounter(e,t=1){pt(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return Og(this.counters_)}};var Sc={},Cc={};function Uh(n){let e=n.toString();return Sc[e]||(Sc[e]=new Uc),Sc[e]}function qT(n,e){let t=n.toString();return Cc[t]||(Cc[t]=e()),Cc[t]}var Bc=class{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){let r=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<r.length;++i)r[i]&&Xr(()=>{this.onMessage_(r[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}};var $g="start",GT="close",jT="pLPCommand",KT="pRTLPCB",L_="id",U_="pw",B_="ser",zT="cb",WT="seg",QT="ts",$T="d",HT="dframe",q_=1870,G_=30,YT=q_-G_,JT=25e3,XT=3e4,As=class n{constructor(e,t,r,i,s,o,l){this.connId=e,this.repoInfo=t,this.applicationId=r,this.appCheckToken=i,this.authToken=s,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=Us(e),this.stats_=Uh(t),this.urlFn=u=>(this.appCheckToken&&(u[Lc]=this.appCheckToken),M_(t,F_,u))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new Bc(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(XT)),NT(()=>{if(this.isClosed_)return;this.scriptTagHolder=new qc((...s)=>{let[o,l,u,c,d]=s;if(this.incrementIncomingBytes_(s),!!this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,o===$g)this.id=l,this.password=u;else if(o===GT)l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_();else throw new Error("Unrecognized command received: "+o)},(...s)=>{let[o,l]=s;this.incrementIncomingBytes_(s),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);let r={};r[$g]="t",r[B_]=Math.floor(Math.random()*1e8),this.scriptTagHolder.uniqueCallbackIdentifier&&(r[zT]=this.scriptTagHolder.uniqueCallbackIdentifier),r[R_]=Na,this.transportSessionId&&(r[P_]=this.transportSessionId),this.lastSessionId&&(r[k_]=this.lastSessionId),this.applicationId&&(r[V_]=this.applicationId),this.appCheckToken&&(r[Lc]=this.appCheckToken),typeof location<"u"&&location.hostname&&D_.test(location.hostname)&&(r[x_]=N_);let i=this.urlFn(r);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){n.forceAllow_=!0}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){return Nt()?!1:n.forceAllow_?!0:!n.forceDisallow_&&typeof document<"u"&&document.createElement!=null&&!kT()&&!VT()}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){let t=Pe(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);let r=Vg(t),i=C_(r,YT);for(let s=0;s<i.length;s++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[s]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if(Nt())return;this.myDisconnFrame=document.createElement("iframe");let r={};r[HT]="t",r[L_]=e,r[U_]=t,this.myDisconnFrame.src=this.urlFn(r),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){let t=Pe(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}},qc=class n{constructor(e,t,r,i){if(this.onDisconnect=r,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(Math.random()*1e8),this.sendNewPolls=!0,Nt())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=T_(),window[jT+this.uniqueCallbackIdentifier]=e,window[KT+this.uniqueCallbackIdentifier]=t,this.myIFrame=n.createIFrame_();let s="";this.myIFrame.src&&this.myIFrame.src.substr(0,11)==="javascript:"&&(s='<script>document.domain="'+document.domain+'";<\/script>');let o="<html><body>"+s+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){Ue("frame writing exception"),l.stack&&Ue(l.stack),Ue(l)}}}static createIFrame_(){let e=document.createElement("iframe");if(e.style.display="none",document.body){document.body.appendChild(e);try{e.contentWindow.document||Ue("No IE domain setting required")}catch{let r=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+r+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{this.myIFrame!==null&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;let e={};e[L_]=this.myID,e[U_]=this.myPW,e[B_]=this.currentSerial;let t=this.urlFn(e),r="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+G_+r.length<=q_;){let o=this.pendingSegs.shift();r=r+"&"+WT+i+"="+o.seg+"&"+QT+i+"="+o.ts+"&"+$T+i+"="+o.d,i++}return t=t+r,this.addLongPollTag_(t,this.currentSerial),!0}else return!1}enqueueSegment(e,t,r){this.pendingSegs.push({seg:e,ts:t,d:r}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);let r=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(r,Math.floor(JT)),s=()=>{clearTimeout(i),r()};this.addTag(e,s)}addTag(e,t){Nt()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;let r=this.myIFrame.doc.createElement("script");r.type="text/javascript",r.async=!0,r.src=e,r.onload=r.onreadystatechange=function(){let i=r.readyState;(!i||i==="loaded"||i==="complete")&&(r.onload=r.onreadystatechange=null,r.parentNode&&r.parentNode.removeChild(r),t())},r.onerror=()=>{Ue("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(r)}catch{}},Math.floor(1))}};var ZT=16384,eA=45e3,ka=null;typeof MozWebSocket<"u"?ka=MozWebSocket:typeof WebSocket<"u"&&(ka=WebSocket);var qr=(()=>{class n{constructor(t,r,i,s,o,l,u){this.connId=t,this.applicationId=i,this.appCheckToken=s,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=Us(this.connId),this.stats_=Uh(r),this.connURL=n.connectionURL_(r,l,u,s,i),this.nodeAdmin=r.nodeAdmin}static connectionURL_(t,r,i,s,o){let l={};return l[R_]=Na,!Nt()&&typeof location<"u"&&location.hostname&&D_.test(location.hostname)&&(l[x_]=N_),r&&(l[P_]=r),i&&(l[k_]=i),s&&(l[Lc]=s),o&&(l[V_]=o),M_(t,O_,l)}open(t,r){this.onDisconnect=r,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,Xn.set("previous_websocket_failure",!0);try{let i;if(Nt()){let s=this.nodeAdmin?"AdminNode":"Node";i={headers:{"User-Agent":`Firebase/${Na}/${Fh}/${process.platform}/${s}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);let o=process.env,l=this.connURL.indexOf("wss://")===0?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new ka(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");let s=i.message||i.data;s&&this.log_(s),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){let r=/Android ([0-9]{0,}\.[0-9]{0,})/,i=navigator.userAgent.match(r);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&ka!==null&&!n.forceDisallow_}static previouslyFailed(){return Xn.isInMemoryStorage||Xn.get("previous_websocket_failure")===!0}markConnectionHealthy(){Xn.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){let r=this.frames.join("");this.frames=null;let i=ca(r);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if(O(this.frames===null,"We already have a frame buffer"),t.length<=6){let r=Number(t);if(!isNaN(r))return this.handleNewFrameCount_(r),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(this.mySock===null)return;let r=t.data;if(this.bytesReceived+=r.length,this.stats_.incrementCounter("bytes_received",r.length),this.resetKeepAlive(),this.frames!==null)this.appendFrame_(r);else{let i=this.extractFrameCount_(r);i!==null&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();let r=Pe(t);this.bytesSent+=r.length,this.stats_.incrementCounter("bytes_sent",r.length);let i=C_(r,ZT);i.length>1&&this.sendString_(String(i.length));for(let s=0;s<i.length;s++)this.sendString_(i[s])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(eA))}sendString_(t){try{this.mySock.send(t)}catch(r){this.log_("Exception thrown from WebSocket.send():",r.message||r.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4;return n})(),j_=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[As,qr]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){let r=qr&&qr.isAvailable(),i=r&&!qr.previouslyFailed();if(t.webSocketOnly&&(r||$e("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[qr];else{let s=this.transports_=[];for(let o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&s.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}n.globalTransportInitialized_=!1;return n})(),tA=6e4,nA=5e3,rA=10*1024,iA=100*1024,bc="t",Hg="d",sA="s",Yg="r",oA="e",Jg="o",Xg="a",Zg="n",e_="p",aA="h",Gc=class{constructor(e,t,r,i,s,o,l,u,c,d){this.id=e,this.repoInfo_=t,this.applicationId_=r,this.appCheckToken_=i,this.authToken_=s,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=u,this.onKill_=c,this.lastSessionId=d,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=Us("c:"+this.id+":"),this.transportManager_=new j_(t),this.log_("Connection created"),this.start_()}start_(){let e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.conn_),r=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,r)},Math.floor(0));let i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=vs(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>iA?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>rA?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{this.state_!==2&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){let t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if(bc in e){let t=e[bc];t===Xg?this.upgradeIfSecondaryHealthy_():t===Yg?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):t===Jg&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){let t=ps("t",e),r=ps("d",e);if(t==="c")this.onSecondaryControl_(r);else if(t==="d")this.pendingDataMessages.push(r);else throw new Error("Unknown protocol layer: "+t)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:e_,d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:Xg,d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:Zg,d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){let t=ps("t",e),r=ps("d",e);t==="c"?this.onControl_(r):t==="d"&&this.onDataMessage_(r)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){let t=ps(bc,e);if(Hg in e){let r=e[Hg];if(t===aA){let i=Object.assign({},r);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if(t===Zg){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else t===sA?this.onConnectionShutdown_(r):t===Yg?this.onReset_(r):t===oA?Oc("Server Error: "+r):t===Jg?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Oc("Unknown control packet command: "+t)}}onHandshake_(e){let t=e.ts,r=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,this.state_===0&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),Na!==r&&$e("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;let t=this.connReceiver_(this.secondaryConn_),r=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,r),vs(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(tA))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,this.state_===1?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),this.primaryResponsesRequired_===0?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):vs(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(nA))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&this.state_===1&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:e_,d:{}}}))}onSecondaryConnectionLost_(){let e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,!e&&this.state_===0?(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(Xn.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)):this.state_===1&&this.log_("Realtime connection lost."),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(this.state_!==1)throw"Connection is not connected";this.tx_.send(e)}close(){this.state_!==2&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}};var Va=class{put(e,t,r,i){}merge(e,t,r,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,r){}onDisconnectMerge(e,t,r){}onDisconnectCancel(e,t){}reportStats(e){}};var Oa=class{constructor(e){this.allowedEvents_=e,this.listeners_={},O(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){let r=[...this.listeners_[e]];for(let i=0;i<r.length;i++)r[i].callback.apply(r[i].context,t)}}on(e,t,r){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:r});let i=this.getInitialEvent(e);i&&t.apply(r,i)}off(e,t,r){this.validateEventType_(e);let i=this.listeners_[e]||[];for(let s=0;s<i.length;s++)if(i[s].callback===t&&(!r||r===i[s].context)){i.splice(s,1);return}}validateEventType_(e){O(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}};var Fa=class n extends Oa{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!wc()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new n}getInitialEvent(e){return O(e==="online","Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}};var t_=32,n_=768,ue=class{constructor(e,t){if(t===void 0){this.pieces_=e.split("/");let r=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[r]=this.pieces_[i],r++);this.pieces_.length=r,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)this.pieces_[t]!==""&&(e+="/"+this.pieces_[t]);return e||"/"}};function le(){return new ue("")}function J(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function En(n){return n.pieces_.length-n.pieceNum_}function de(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new ue(n.pieces_,e)}function Bh(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function lA(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)n.pieces_[t]!==""&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}function Ss(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function K_(n){if(n.pieceNum_>=n.pieces_.length)return null;let e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new ue(e,0)}function ye(n,e){let t=[];for(let r=n.pieceNum_;r<n.pieces_.length;r++)t.push(n.pieces_[r]);if(e instanceof ue)for(let r=e.pieceNum_;r<e.pieces_.length;r++)t.push(e.pieces_[r]);else{let r=e.split("/");for(let i=0;i<r.length;i++)r[i].length>0&&t.push(r[i])}return new ue(t,0)}function X(n){return n.pieceNum_>=n.pieces_.length}function et(n,e){let t=J(n),r=J(e);if(t===null)return e;if(t===r)return et(de(n),de(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function uA(n,e){let t=Ss(n,0),r=Ss(e,0);for(let i=0;i<t.length&&i<r.length;i++){let s=tr(t[i],r[i]);if(s!==0)return s}return t.length===r.length?0:t.length<r.length?-1:1}function qh(n,e){if(En(n)!==En(e))return!1;for(let t=n.pieceNum_,r=e.pieceNum_;t<=n.pieces_.length;t++,r++)if(n.pieces_[t]!==e.pieces_[r])return!1;return!0}function _t(n,e){let t=n.pieceNum_,r=e.pieceNum_;if(En(n)>En(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[r])return!1;++t,++r}return!0}var jc=class{constructor(e,t){this.errorPrefix_=t,this.parts_=Ss(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let r=0;r<this.parts_.length;r++)this.byteLength_+=ms(this.parts_[r]);z_(this)}};function cA(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=ms(e),z_(n)}function hA(n){let e=n.parts_.pop();n.byteLength_-=ms(e),n.parts_.length>0&&(n.byteLength_-=1)}function z_(n){if(n.byteLength_>n_)throw new Error(n.errorPrefix_+"has a key path longer than "+n_+" bytes ("+n.byteLength_+").");if(n.parts_.length>t_)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+t_+") or object contains a cycle "+Jn(n))}function Jn(n){return n.parts_.length===0?"":"in property '"+n.parts_.join(".")+"'"}var Kc=class n extends Oa{constructor(){super(["visible"]);let e,t;typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{let r=!document[e];r!==this.visible_&&(this.visible_=r,this.trigger("visible",r))},!1)}static getInstance(){return new n}getInitialEvent(e){return O(e==="visible","Unknown event type: "+e),[this.visible_]}};var gs=1e3,dA=60*5*1e3,r_=30*1e3,fA=1.3,mA=3e4,pA="server_kill",i_=3,Gh=(()=>{class n extends Va{constructor(t,r,i,s,o,l,u,c){if(super(),this.repoInfo_=t,this.applicationId_=r,this.onDataUpdate_=i,this.onConnectStatus_=s,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=u,this.authOverride_=c,this.id=n.nextPersistentConnectionId_++,this.log_=Us("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=gs,this.maxReconnectDelay_=dA,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,c&&!Nt())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Kc.getInstance().on("visible",this.onVisible_,this),t.host.indexOf("fblocal")===-1&&Fa.getInstance().on("online",this.onOnline_,this)}sendRequest(t,r,i){let s=++this.requestNumber_,o={r:s,a:t,b:r};this.log_(Pe(o)),O(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[s]=i)}get(t){this.initConnection_();let r=new Ze,s={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{let u=l.d;l.s==="ok"?r.resolve(u):r.reject(u)}};this.outstandingGets_.push(s),this.outstandingGetCount_++;let o=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(o),r.promise}listen(t,r,i,s){this.initConnection_();let o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),O(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");let u={onComplete:s,hashFn:r,query:t,tag:i};this.listens.get(l).set(o,u),this.connected_&&this.sendListen_(u)}sendGet_(t){let r=this.outstandingGets_[t];this.sendRequest("g",r.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,this.outstandingGetCount_===0&&(this.outstandingGets_=[]),r.onComplete&&r.onComplete(i)})}sendListen_(t){let r=t.query,i=r._path.toString(),s=r._queryIdentifier;this.log_("Listen on "+i+" for "+s);let o={p:i},l="q";t.tag&&(o.q=r._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest(l,o,u=>{let c=u.d,d=u.s;n.warnOnListenWarnings_(c,r),(this.listens.get(i)&&this.listens.get(i).get(s))===t&&(this.log_("listen response",u),d!=="ok"&&this.removeListen_(i,s),t.onComplete&&t.onComplete(d,c))})}static warnOnListenWarnings_(t,r){if(t&&typeof t=="object"&&pt(t,"w")){let i=pn(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){let s='".indexOn": "'+r._queryParams.getIndex().toString()+'"',o=r._path.toString();$e(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${s} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&t.length===40||Bg(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=r_)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let t=this.authToken_,r=Ug(t)?"auth":"gauth",i={cred:t};this.authOverride_===null?i.noauth=!0:typeof this.authOverride_=="object"&&(i.authvar=this.authOverride_),this.sendRequest(r,i,s=>{let o=s.s,l=s.d||"error";this.authToken_===t&&(o==="ok"?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{let r=t.s,i=t.d||"error";r==="ok"?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(r,i)})}unlisten(t,r){let i=t._path.toString(),s=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+s),O(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,s)&&this.connected_&&this.sendUnlisten_(i,s,t._queryObject,r)}sendUnlisten_(t,r,i,s){this.log_("Unlisten on "+t+" for "+r);let o={p:t},l="n";s&&(o.q=i,o.t=s),this.sendRequest(l,o)}onDisconnectPut(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:r,onComplete:i})}onDisconnectMerge(t,r,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,r,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:r,onComplete:i})}onDisconnectCancel(t,r){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,r):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:r})}sendOnDisconnect_(t,r,i,s){let o={p:r,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{s&&setTimeout(()=>{s(l.s,l.d)},Math.floor(0))})}put(t,r,i,s){this.putInternal("p",t,r,i,s)}merge(t,r,i,s){this.putInternal("m",t,r,i,s)}putInternal(t,r,i,s,o){this.initConnection_();let l={p:r,d:i};o!==void 0&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:s}),this.outstandingPutCount_++;let u=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(u):this.log_("Buffering put: "+r)}sendPut_(t){let r=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,s=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(r,i,o=>{this.log_(r+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,this.outstandingPutCount_===0&&(this.outstandingPuts_=[]),s&&s(o.s,o.d)})}reportStats(t){if(this.connected_){let r={c:t};this.log_("reportStats",r),this.sendRequest("s",r,i=>{if(i.s!=="ok"){let o=i.d;this.log_("reportStats","Error sending stats: "+o)}})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+Pe(t));let r=t.r,i=this.requestCBHash_[r];i&&(delete this.requestCBHash_[r],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,r){this.log_("handleServerMessage",t,r),t==="d"?this.onDataUpdate_(r.p,r.d,!1,r.t):t==="m"?this.onDataUpdate_(r.p,r.d,!0,r.t):t==="c"?this.onListenRevoked_(r.p,r.q):t==="ac"?this.onAuthRevoked_(r.s,r.d):t==="apc"?this.onAppCheckRevoked_(r.s,r.d):t==="sd"?this.onSecurityDebugPacket_(r):Oc("Unrecognized action received from server: "+Pe(t)+`
Are you using the latest client?`)}onReady_(t,r){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(t),this.lastSessionId=r,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){O(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&(new Date().getTime()-this.lastConnectionEstablishedTime_>mA&&(this.reconnectDelay_=gs),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime());let t=new Date().getTime()-this.lastConnectionAttemptTime_,r=Math.max(0,this.reconnectDelay_-t);r=Math.random()*r,this.log_("Trying to reconnect in "+r+"ms"),this.scheduleConnect_(r),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,this.reconnectDelay_*fA)}this.onConnectStatus_(!1)}establishConnection_(){return N(this,null,function*(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let t=this.onDataMessage_.bind(this),r=this.onReady_.bind(this),i=this.onRealtimeDisconnect_.bind(this),s=this.id+":"+n.nextConnectionId_++,o=this.lastSessionId,l=!1,u=null,c=function(){u?u.close():(l=!0,i())},d=function(p){O(u,"sendRequest call when we're not connected not allowed."),u.sendRequest(p)};this.realtime_={close:c,sendRequest:d};let m=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[p,y]=yield Promise.all([this.authTokenProvider_.getToken(m),this.appCheckTokenProvider_.getToken(m)]);l?Ue("getToken() completed but was canceled"):(Ue("getToken() completed. Creating connection."),this.authToken_=p&&p.accessToken,this.appCheckToken_=y&&y.token,u=new Gc(s,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,t,r,i,S=>{$e(S+" ("+this.repoInfo_.toString()+")"),this.interrupt(pA)},o))}catch(p){this.log_("Failed to get token: "+p),l||(this.repoInfo_.nodeAdmin&&$e(p),c())}}})}interrupt(t){Ue("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){Ue("Resuming connection for reason: "+t),delete this.interruptReasons_[t],ha(this.interruptReasons_)&&(this.reconnectDelay_=gs,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){let r=t-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:r})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){let r=this.outstandingPuts_[t];r&&"h"in r.request&&r.queued&&(r.onComplete&&r.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}this.outstandingPutCount_===0&&(this.outstandingPuts_=[])}onListenRevoked_(t,r){let i;r?i=r.map(o=>Lh(o)).join("$"):i="default";let s=this.removeListen_(t,i);s&&s.onComplete&&s.onComplete("permission_denied")}removeListen_(t,r){let i=new ue(t).toString(),s;if(this.listens.has(i)){let o=this.listens.get(i);s=o.get(r),o.delete(r),o.size===0&&this.listens.delete(i)}else s=void 0;return s}onAuthRevoked_(t,r){Ue("Auth token revoked: "+t+"/"+r),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),(t==="invalid_token"||t==="permission_denied")&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=i_&&(this.reconnectDelay_=r_,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,r){Ue("App check token revoked: "+t+"/"+r),this.appCheckToken_=null,this.forceTokenRefresh_=!0,(t==="invalid_token"||t==="permission_denied")&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=i_&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace(`
`,`
FIREBASE: `))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(let t of this.listens.values())for(let r of t.values())this.sendListen_(r);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){let t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){let t={},r="js";Nt()&&(this.repoInfo_.nodeAdmin?r="admin_node":r="node"),t["sdk."+r+"."+Fh.replace(/\./g,"-")]=1,wc()?t["framework.cordova"]=1:Fg()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){let t=Fa.getInstance().currentlyOnline();return ha(this.interruptReasons_)&&t}}n.nextPersistentConnectionId_=0,n.nextConnectionId_=0;return n})(),Z=class n{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new n(e,t)}};var Kr=class{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){let r=new Z(wn,e),i=new Z(wn,t);return this.compare(r,i)!==0}minPost(){return Z.MIN}};var xa,Ma=class extends Kr{static get __EMPTY_NODE(){return xa}static set __EMPTY_NODE(e){xa=e}compare(e,t){return tr(e.name,t.name)}isDefinedOn(e){throw Mr("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return Z.MIN}maxPost(){return new Z(Jt,xa)}makePost(e,t){return O(typeof e=="string","KeyIndex indexValue must always be a string."),new Z(e,xa)}toString(){return".key"}},Vt=new Ma;var Gr=class{constructor(e,t,r,i,s=null){this.isReverse_=i,this.resultGenerator_=s,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(e=e,o=t?r(e.key,t):1,i&&(o*=-1),o<0)this.isReverse_?e=e.left:e=e.right;else if(o===0){this.nodeStack_.push(e);break}else this.nodeStack_.push(e),this.isReverse_?e=e.right:e=e.left}getNext(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_.pop(),t;if(this.resultGenerator_?t=this.resultGenerator_(e.key,e.value):t={key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(this.nodeStack_.length===0)return null;let e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}},At=(()=>{class n{constructor(t,r,i,s,o){this.key=t,this.value=r,this.color=i??n.RED,this.left=s??yt.EMPTY_NODE,this.right=o??yt.EMPTY_NODE}copy(t,r,i,s,o){return new n(t??this.key,r??this.value,i??this.color,s??this.left,o??this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,r,i){let s=this,o=i(t,s.key);return o<0?s=s.copy(null,null,null,s.left.insert(t,r,i),null):o===0?s=s.copy(null,r,null,null,null):s=s.copy(null,null,null,null,s.right.insert(t,r,i)),s.fixUp_()}removeMin_(){if(this.left.isEmpty())return yt.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,r){let i,s;if(i=this,r(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,r),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),r(t,i.key)===0){if(i.right.isEmpty())return yt.EMPTY_NODE;s=i.right.min_(),i=i.copy(s.key,s.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,r))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){let t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){let t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){let t=this.left.copy(null,null,!this.left.color,null,null),r=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,r)}checkMaxDepth_(){let t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");let t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})(),zc=class{copy(e,t,r,i,s){return this}insert(e,t,r){return new At(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}},yt=class n{constructor(e,t=n.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new n(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,At.BLACK,null,null))}remove(e){return new n(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,At.BLACK,null,null))}get(e){let t,r=this.root_;for(;!r.isEmpty();){if(t=this.comparator_(e,r.key),t===0)return r.value;t<0?r=r.left:t>0&&(r=r.right)}return null}getPredecessorKey(e){let t,r=this.root_,i=null;for(;!r.isEmpty();)if(t=this.comparator_(e,r.key),t===0){if(r.left.isEmpty())return i?i.key:null;for(r=r.left;!r.right.isEmpty();)r=r.right;return r.key}else t<0?r=r.left:t>0&&(i=r,r=r.right);throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Gr(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Gr(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Gr(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Gr(this.root_,null,this.comparator_,!0,e)}};yt.EMPTY_NODE=new zc;function gA(n,e){return tr(n.name,e.name)}function jh(n,e){return tr(n,e)}var Wc;function _A(n){Wc=n}var W_=function(n){return typeof n=="number"?"number:"+b_(n):"string:"+n},Q_=function(n){if(n.isLeafNode()){let e=n.val();O(typeof e=="string"||typeof e=="number"||typeof e=="object"&&pt(e,".sv"),"Priority must be a string or number.")}else O(n===Wc||n.isEmpty(),"priority of unexpected type.");O(n===Wc||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};var s_,zr=(()=>{class n{constructor(t,r=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=r,this.lazyHash_=null,O(this.value_!==void 0&&this.value_!==null,"LeafNode shouldn't be created with null/undefined value."),Q_(this.priorityNode_)}static set __childrenNodeConstructor(t){s_=t}static get __childrenNodeConstructor(){return s_}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return t===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return X(t)?this:J(t)===".priority"?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,r){return null}updateImmediateChild(t,r){return t===".priority"?this.updatePriority(r):r.isEmpty()&&t!==".priority"?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,r).updatePriority(this.priorityNode_)}updateChild(t,r){let i=J(t);return i===null?r:r.isEmpty()&&i!==".priority"?this:(O(i!==".priority"||En(t)===1,".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(de(t),r)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,r){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(this.lazyHash_===null){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+W_(this.priorityNode_.val())+":");let r=typeof this.value_;t+=r+":",r==="number"?t+=b_(this.value_):t+=this.value_,this.lazyHash_=A_(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:(O(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){let r=typeof t.value_,i=typeof this.value_,s=n.VALUE_TYPE_ORDER.indexOf(r),o=n.VALUE_TYPE_ORDER.indexOf(i);return O(s>=0,"Unknown leaf type: "+r),O(o>=0,"Unknown leaf type: "+i),s===o?i==="object"?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-s}withIndex(){return this}isIndexed(){return!0}equals(t){if(t===this)return!0;if(t.isLeafNode()){let r=t;return this.value_===r.value_&&this.priorityNode_.equals(r.priorityNode_)}else return!1}}n.VALUE_TYPE_ORDER=["object","boolean","number","string"];return n})(),$_,H_;function yA(n){$_=n}function vA(n){H_=n}var Qc=class extends Kr{compare(e,t){let r=e.node.getPriority(),i=t.node.getPriority(),s=r.compareTo(i);return s===0?tr(e.name,t.name):s}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return Z.MIN}maxPost(){return new Z(Jt,new zr("[PRIORITY-POST]",H_))}makePost(e,t){let r=$_(e);return new Z(t,new zr("[PRIORITY-POST]",r))}toString(){return".priority"}},me=new Qc;var wA=Math.log(2),$c=class{constructor(e){let t=s=>parseInt(Math.log(s)/wA,10),r=s=>parseInt(Array(s+1).join("1"),2);this.count=t(e+1),this.current_=this.count-1;let i=r(this.count);this.bits_=e+1&i}nextBitIsOne(){let e=!(this.bits_&1<<this.current_);return this.current_--,e}},La=function(n,e,t,r){n.sort(e);let i=function(u,c){let d=c-u,m,p;if(d===0)return null;if(d===1)return m=n[u],p=t?t(m):m,new At(p,m.node,At.BLACK,null,null);{let y=parseInt(d/2,10)+u,S=i(u,y),x=i(y+1,c);return m=n[y],p=t?t(m):m,new At(p,m.node,At.BLACK,S,x)}},s=function(u){let c=null,d=null,m=n.length,p=function(S,x){let D=m-S,q=m;m-=S;let j=i(D+1,q),B=n[D],Y=t?t(B):B;y(new At(Y,B.node,x,null,j))},y=function(S){c?(c.left=S,c=S):(d=S,c=S)};for(let S=0;S<u.count;++S){let x=u.nextBitIsOne(),D=Math.pow(2,u.count-(S+1));x?p(D,At.BLACK):(p(D,At.BLACK),p(D,At.RED))}return d},o=new $c(n.length),l=s(o);return new yt(r||e,l)};var Rc,Br={},Wr=class n{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return O(Br&&me,"ChildrenNode.ts has not been loaded"),Rc=Rc||new n({".priority":Br},{".priority":me}),Rc}get(e){let t=pn(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof yt?t:null}hasIndex(e){return pt(this.indexSet_,e.toString())}addIndex(e,t){O(e!==Vt,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let r=[],i=!1,s=t.getIterator(Z.Wrap),o=s.getNext();for(;o;)i=i||e.isDefinedOn(o.node),r.push(o),o=s.getNext();let l;i?l=La(r,e.getCompare()):l=Br;let u=e.toString(),c=Object.assign({},this.indexSet_);c[u]=e;let d=Object.assign({},this.indexes_);return d[u]=l,new n(d,c)}addToIndexes(e,t){let r=fs(this.indexes_,(i,s)=>{let o=pn(this.indexSet_,s);if(O(o,"Missing index implementation for "+s),i===Br)if(o.isDefinedOn(e.node)){let l=[],u=t.getIterator(Z.Wrap),c=u.getNext();for(;c;)c.name!==e.name&&l.push(c),c=u.getNext();return l.push(e),La(l,o.getCompare())}else return Br;else{let l=t.get(e.name),u=i;return l&&(u=u.remove(new Z(e.name,l))),u.insert(e,e.node)}});return new n(r,this.indexSet_)}removeFromIndexes(e,t){let r=fs(this.indexes_,i=>{if(i===Br)return i;{let s=t.get(e.name);return s?i.remove(new Z(e.name,s)):i}});return new n(r,this.indexSet_)}};var _s,$=(()=>{class n{constructor(t,r,i){this.children_=t,this.priorityNode_=r,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&Q_(this.priorityNode_),this.children_.isEmpty()&&O(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return _s||(_s=new n(new yt(jh),null,Wr.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||_s}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(t===".priority")return this.getPriority();{let r=this.children_.get(t);return r===null?_s:r}}getChild(t){let r=J(t);return r===null?this:this.getImmediateChild(r).getChild(de(t))}hasChild(t){return this.children_.get(t)!==null}updateImmediateChild(t,r){if(O(r,"We should always be passing snapshot nodes"),t===".priority")return this.updatePriority(r);{let i=new Z(t,r),s,o;r.isEmpty()?(s=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(s=this.children_.insert(t,r),o=this.indexMap_.addToIndexes(i,this.children_));let l=s.isEmpty()?_s:this.priorityNode_;return new n(s,l,o)}}updateChild(t,r){let i=J(t);if(i===null)return r;{O(J(t)!==".priority"||En(t)===1,".priority must be the last token in a path");let s=this.getImmediateChild(i).updateChild(de(t),r);return this.updateImmediateChild(i,s)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;let r={},i=0,s=0,o=!0;if(this.forEachChild(me,(l,u)=>{r[l]=u.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?s=Math.max(s,Number(l)):o=!1}),!t&&o&&s<2*i){let l=[];for(let u in r)l[u]=r[u];return l}else return t&&!this.getPriority().isEmpty()&&(r[".priority"]=this.getPriority().val()),r}hash(){if(this.lazyHash_===null){let t="";this.getPriority().isEmpty()||(t+="priority:"+W_(this.getPriority().val())+":"),this.forEachChild(me,(r,i)=>{let s=i.hash();s!==""&&(t+=":"+r+":"+s)}),this.lazyHash_=t===""?"":A_(t)}return this.lazyHash_}getPredecessorChildName(t,r,i){let s=this.resolveIndex_(i);if(s){let o=s.getPredecessorKey(new Z(t,r));return o?o.name:null}else return this.children_.getPredecessorKey(t)}getFirstChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.minKey();return i&&i.name}else return this.children_.minKey()}getFirstChild(t){let r=this.getFirstChildName(t);return r?new Z(r,this.children_.get(r)):null}getLastChildName(t){let r=this.resolveIndex_(t);if(r){let i=r.maxKey();return i&&i.name}else return this.children_.maxKey()}getLastChild(t){let r=this.getLastChildName(t);return r?new Z(r,this.children_.get(r)):null}forEachChild(t,r){let i=this.resolveIndex_(t);return i?i.inorderTraversal(s=>r(s.name,s.node)):this.children_.inorderTraversal(r)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getIteratorFrom(t,s=>s);{let s=this.children_.getIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)<0;)s.getNext(),o=s.peek();return s}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,r){let i=this.resolveIndex_(r);if(i)return i.getReverseIteratorFrom(t,s=>s);{let s=this.children_.getReverseIteratorFrom(t.name,Z.Wrap),o=s.peek();for(;o!=null&&r.compare(o,t)>0;)s.getNext(),o=s.peek();return s}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===Bs?-1:0}withIndex(t){if(t===Vt||this.indexMap_.hasIndex(t))return this;{let r=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,r)}}isIndexed(t){return t===Vt||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{let r=t;if(this.getPriority().equals(r.getPriority()))if(this.children_.count()===r.children_.count()){let i=this.getIterator(me),s=r.getIterator(me),o=i.getNext(),l=s.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=s.getNext()}return o===null&&l===null}else return!1;else return!1}}resolveIndex_(t){return t===Vt?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})(),Hc=class extends ${constructor(){super(new yt(jh),$.EMPTY_NODE,Wr.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return $.EMPTY_NODE}isEmpty(){return!1}},Bs=new Hc;Object.defineProperties(Z,{MIN:{value:new Z(wn,$.EMPTY_NODE)},MAX:{value:new Z(Jt,Bs)}});Ma.__EMPTY_NODE=$.EMPTY_NODE;zr.__childrenNodeConstructor=$;_A(Bs);vA(Bs);var EA=!0;function we(n,e=null){if(n===null)return $.EMPTY_NODE;if(typeof n=="object"&&".priority"in n&&(e=n[".priority"]),O(e===null||typeof e=="string"||typeof e=="number"||typeof e=="object"&&".sv"in e,"Invalid priority type found: "+typeof e),typeof n=="object"&&".value"in n&&n[".value"]!==null&&(n=n[".value"]),typeof n!="object"||".sv"in n){let t=n;return new zr(t,we(e))}if(!(n instanceof Array)&&EA){let t=[],r=!1;if(Be(n,(o,l)=>{if(o.substring(0,1)!=="."){let u=we(l);u.isEmpty()||(r=r||!u.getPriority().isEmpty(),t.push(new Z(o,u)))}}),t.length===0)return $.EMPTY_NODE;let s=La(t,gA,o=>o.name,jh);if(r){let o=La(t,me.getCompare());return new $(s,we(e),new Wr({".priority":o},{".priority":me}))}else return new $(s,we(e),Wr.Default)}else{let t=$.EMPTY_NODE;return Be(n,(r,i)=>{if(pt(n,r)&&r.substring(0,1)!=="."){let s=we(i);(s.isLeafNode()||!s.isEmpty())&&(t=t.updateImmediateChild(r,s))}}),t.updatePriority(we(e))}}yA(we);var Cs=class extends Kr{constructor(e){super(),this.indexPath_=e,O(!X(e)&&J(e)!==".priority","Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){let r=this.extractChild(e.node),i=this.extractChild(t.node),s=r.compareTo(i);return s===0?tr(e.name,t.name):s}makePost(e,t){let r=we(e),i=$.EMPTY_NODE.updateChild(this.indexPath_,r);return new Z(t,i)}maxPost(){let e=$.EMPTY_NODE.updateChild(this.indexPath_,Bs);return new Z(Jt,e)}toString(){return Ss(this.indexPath_,0).join("/")}};var Yc=class extends Kr{compare(e,t){let r=e.node.compareTo(t.node);return r===0?tr(e.name,t.name):r}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return Z.MIN}maxPost(){return Z.MAX}makePost(e,t){let r=we(e);return new Z(t,r)}toString(){return".value"}},Kh=new Yc;function Y_(n){return{type:"value",snapshotNode:n}}function Qr(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function bs(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Rs(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}function IA(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}var Ps=class{constructor(e){this.index_=e}updateChild(e,t,r,i,s,o){O(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");let l=e.getImmediateChild(t);return l.getChild(i).equals(r.getChild(i))&&l.isEmpty()===r.isEmpty()||(o!=null&&(r.isEmpty()?e.hasChild(t)?o.trackChildChange(bs(t,l)):O(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(Qr(t,r)):o.trackChildChange(Rs(t,r,l))),e.isLeafNode()&&r.isEmpty())?e:e.updateImmediateChild(t,r).withIndex(this.index_)}updateFullNode(e,t,r){return r!=null&&(e.isLeafNode()||e.forEachChild(me,(i,s)=>{t.hasChild(i)||r.trackChildChange(bs(i,s))}),t.isLeafNode()||t.forEachChild(me,(i,s)=>{if(e.hasChild(i)){let o=e.getImmediateChild(i);o.equals(s)||r.trackChildChange(Rs(i,s,o))}else r.trackChildChange(Qr(i,s))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?$.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}};var Ua=class n{constructor(e){this.indexedFilter_=new Ps(e.getIndex()),this.index_=e.getIndex(),this.startPost_=n.getStartPost_(e),this.endPost_=n.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){let t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,r=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&r}updateChild(e,t,r,i,s,o){return this.matches(new Z(t,r))||(r=$.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,r,i,s,o)}updateFullNode(e,t,r){t.isLeafNode()&&(t=$.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority($.EMPTY_NODE);let s=this;return t.forEachChild(me,(o,l)=>{s.matches(new Z(o,l))||(i=i.updateImmediateChild(o,$.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){let t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}else return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){let t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}else return e.getIndex().maxPost()}};var Jc=class{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{let r=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?r<=0:r<0},this.withinEndPost=t=>{let r=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?r<=0:r<0},this.rangedFilter_=new Ua(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,r,i,s,o){return this.rangedFilter_.matches(new Z(t,r))||(r=$.EMPTY_NODE),e.getImmediateChild(t).equals(r)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,r,i,s,o):this.fullLimitUpdateChild_(e,t,r,s,o)}updateFullNode(e,t,r){let i;if(t.isLeafNode()||t.isEmpty())i=$.EMPTY_NODE.withIndex(this.index_);else if(this.limit_*2<t.numChildren()&&t.isIndexed(this.index_)){i=$.EMPTY_NODE.withIndex(this.index_);let s;this.reverse_?s=t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):s=t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;s.hasNext()&&o<this.limit_;){let l=s.getNext();if(this.withinDirectionalStart(l))if(this.withinDirectionalEnd(l))i=i.updateImmediateChild(l.name,l.node),o++;else break;else continue}}else{i=t.withIndex(this.index_),i=i.updatePriority($.EMPTY_NODE);let s;this.reverse_?s=i.getReverseIterator(this.index_):s=i.getIterator(this.index_);let o=0;for(;s.hasNext();){let l=s.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,$.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,r)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,r,i,s){let o;if(this.reverse_){let m=this.index_.getCompare();o=(p,y)=>m(y,p)}else o=this.index_.getCompare();let l=e;O(l.numChildren()===this.limit_,"");let u=new Z(t,r),c=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),d=this.rangedFilter_.matches(u);if(l.hasChild(t)){let m=l.getImmediateChild(t),p=i.getChildAfterChild(this.index_,c,this.reverse_);for(;p!=null&&(p.name===t||l.hasChild(p.name));)p=i.getChildAfterChild(this.index_,p,this.reverse_);let y=p==null?1:o(p,u);if(d&&!r.isEmpty()&&y>=0)return s?.trackChildChange(Rs(t,r,m)),l.updateImmediateChild(t,r);{s?.trackChildChange(bs(t,m));let x=l.updateImmediateChild(t,$.EMPTY_NODE);return p!=null&&this.rangedFilter_.matches(p)?(s?.trackChildChange(Qr(p.name,p.node)),x.updateImmediateChild(p.name,p.node)):x}}else return r.isEmpty()?e:d&&o(c,u)>=0?(s!=null&&(s.trackChildChange(bs(c.name,c.node)),s.trackChildChange(Qr(t,r))),l.updateImmediateChild(t,r).updateImmediateChild(c.name,$.EMPTY_NODE)):e}};var xs=class n{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=me}hasStart(){return this.startSet_}isViewFromLeft(){return this.viewFrom_===""?this.startSet_:this.viewFrom_==="l"}getIndexStartValue(){return O(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return O(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:wn}hasEnd(){return this.endSet_}getIndexEndValue(){return O(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return O(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Jt}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&this.viewFrom_!==""}getLimit(){return O(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===me}copy(){let e=new n;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}};function TA(n){return n.loadsAllData()?new Ps(n.getIndex()):n.hasLimit()?new Jc(n):new Ua(n)}function AA(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}function SA(n,e){let t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}function Xc(n,e,t){let r=n.copy();return r.startSet_=!0,e===void 0&&(e=null),r.indexStartValue_=e,t!=null?(r.startNameSet_=!0,r.indexStartName_=t):(r.startNameSet_=!1,r.indexStartName_=""),r}function CA(n,e,t){let r;return n.index_===Vt||t?r=Xc(n,e,t):r=Xc(n,e,Jt),r.startAfterSet_=!0,r}function Zc(n,e,t){let r=n.copy();return r.endSet_=!0,e===void 0&&(e=null),r.indexEndValue_=e,t!==void 0?(r.endNameSet_=!0,r.indexEndName_=t):(r.endNameSet_=!1,r.indexEndName_=""),r}function bA(n,e,t){let r;return n.index_===Vt||t?r=Zc(n,e,t):r=Zc(n,e,wn),r.endBeforeSet_=!0,r}function il(n,e){let t=n.copy();return t.index_=e,t}function o_(n){let e={};if(n.isDefault())return e;let t;if(n.index_===me?t="$priority":n.index_===Kh?t="$value":n.index_===Vt?t="$key":(O(n.index_ instanceof Cs,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=Pe(t),n.startSet_){let r=n.startAfterSet_?"startAfter":"startAt";e[r]=Pe(n.indexStartValue_),n.startNameSet_&&(e[r]+=","+Pe(n.indexStartName_))}if(n.endSet_){let r=n.endBeforeSet_?"endBefore":"endAt";e[r]=Pe(n.indexEndValue_),n.endNameSet_&&(e[r]+=","+Pe(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function a_(n){let e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;t===""&&(n.isViewFromLeft()?t="l":t="r"),e.vf=t}return n.index_!==me&&(e.i=n.index_.toString()),e}var eh=class n extends Va{constructor(e,t,r,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=r,this.appCheckTokenProvider_=i,this.log_=Us("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return t!==void 0?"tag$"+t:(O(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,r,i){let s=e._path.toString();this.log_("Listen called for "+s+" "+e._queryIdentifier);let o=n.getListenId_(e,r),l={};this.listens_[o]=l;let u=o_(e._queryParams);this.restRequest_(s+".json",u,(c,d)=>{let m=d;if(c===404&&(m=null,c=null),c===null&&this.onDataUpdate_(s,m,!1,r),pn(this.listens_,o)===l){let p;c?c===401?p="permission_denied":p="rest_error:"+c:p="ok",i(p,null)}})}unlisten(e,t){let r=n.getListenId_(e,t);delete this.listens_[r]}get(e){let t=o_(e._queryParams),r=e._path.toString(),i=new Ze;return this.restRequest_(r+".json",t,(s,o)=>{let l=o;s===404&&(l=null,s=null),s===null?(this.onDataUpdate_(r,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},r){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,s])=>{i&&i.accessToken&&(t.auth=i.accessToken),s&&s.token&&(t.ac=s.token);let o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+qg(t);this.log_("Sending REST request for "+o);let l=new XMLHttpRequest;l.onreadystatechange=()=>{if(r&&l.readyState===4){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let u=null;if(l.status>=200&&l.status<300){try{u=ca(l.responseText)}catch{$e("Failed to parse JSON response for "+o+": "+l.responseText)}r(null,u)}else l.status!==401&&l.status!==404&&$e("Got unsuccessful REST response for "+o+" Status: "+l.status),r(l.status);r=null}},l.open("GET",o,!0),l.send()})}};var th=class{constructor(){this.rootNode_=$.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}};function Ba(){return{value:null,children:new Map}}function Zr(n,e,t){if(X(e))n.value=t,n.children.clear();else if(n.value!==null)n.value=n.value.updateChild(e,t);else{let r=J(e);n.children.has(r)||n.children.set(r,Ba());let i=n.children.get(r);e=de(e),Zr(i,e,t)}}function nh(n,e){if(X(e))return n.value=null,n.children.clear(),!0;if(n.value!==null){if(n.value.isLeafNode())return!1;{let t=n.value;return n.value=null,t.forEachChild(me,(r,i)=>{Zr(n,new ue(r),i)}),nh(n,e)}}else if(n.children.size>0){let t=J(e);return e=de(e),n.children.has(t)&&nh(n.children.get(t),e)&&n.children.delete(t),n.children.size===0}else return!0}function rh(n,e,t){n.value!==null?t(e,n.value):RA(n,(r,i)=>{let s=new ue(e.toString()+"/"+r);rh(i,s,t)})}function RA(n,e){n.children.forEach((t,r)=>{e(r,t)})}var ih=class{constructor(e){this.collection_=e,this.last_=null}get(){let e=this.collection_.get(),t=Object.assign({},e);return this.last_&&Be(this.last_,(r,i)=>{t[r]=t[r]-i}),this.last_=e,t}};var l_=10*1e3,PA=30*1e3,xA=5*60*1e3,sh=class{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new ih(e);let r=l_+(PA-l_)*Math.random();vs(this.reportStats_.bind(this),Math.floor(r))}reportStats_(){let e=this.statsListener_.get(),t={},r=!1;Be(e,(i,s)=>{s>0&&pt(this.statsToReport_,i)&&(t[i]=s,r=!0)}),r&&this.server_.reportStats(t),vs(this.reportStats_.bind(this),Math.floor(Math.random()*2*xA))}};var kt=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(kt||{});function zh(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function Wh(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function Qh(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}var oh=class n{constructor(e,t,r){this.path=e,this.affectedTree=t,this.revert=r,this.type=kt.ACK_USER_WRITE,this.source=zh()}operationForChild(e){if(X(this.path)){if(this.affectedTree.value!=null)return O(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let t=this.affectedTree.subtree(new ue(e));return new n(le(),t,this.revert)}}else return O(J(this.path)===e,"operationForChild called for unrelated child."),new n(de(this.path),this.affectedTree,this.revert)}};var qa=class n{constructor(e,t){this.source=e,this.path=t,this.type=kt.LISTEN_COMPLETE}operationForChild(e){return X(this.path)?new n(this.source,le()):new n(this.source,de(this.path))}};var $r=class n{constructor(e,t,r){this.source=e,this.path=t,this.snap=r,this.type=kt.OVERWRITE}operationForChild(e){return X(this.path)?new n(this.source,le(),this.snap.getImmediateChild(e)):new n(this.source,de(this.path),this.snap)}};var Ns=class n{constructor(e,t,r){this.source=e,this.path=t,this.children=r,this.type=kt.MERGE}operationForChild(e){if(X(this.path)){let t=this.children.subtree(new ue(e));return t.isEmpty()?null:t.value?new $r(this.source,le(),t.value):new n(this.source,le(),t)}else return O(J(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new n(this.source,de(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}};var Ft=class{constructor(e,t,r){this.node_=e,this.fullyInitialized_=t,this.filtered_=r}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(X(e))return this.isFullyInitialized()&&!this.filtered_;let t=J(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}};var ah=class{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}};function NA(n,e,t,r){let i=[],s=[];return e.forEach(o=>{o.type==="child_changed"&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&s.push(IA(o.childName,o.snapshotNode))}),ys(n,i,"child_removed",e,r,t),ys(n,i,"child_added",e,r,t),ys(n,i,"child_moved",s,r,t),ys(n,i,"child_changed",e,r,t),ys(n,i,"value",e,r,t),i}function ys(n,e,t,r,i,s){let o=r.filter(l=>l.type===t);o.sort((l,u)=>kA(n,l,u)),o.forEach(l=>{let u=DA(n,l,s);i.forEach(c=>{c.respondsTo(l.type)&&e.push(c.createEvent(u,n.query_))})})}function DA(n,e,t){return e.type==="value"||e.type==="child_removed"||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}function kA(n,e,t){if(e.childName==null||t.childName==null)throw Mr("Should only compare child_ events.");let r=new Z(e.childName,e.snapshotNode),i=new Z(t.childName,t.snapshotNode);return n.index_.compare(r,i)}function sl(n,e){return{eventCache:n,serverCache:e}}function Es(n,e,t,r){return sl(new Ft(e,t,r),n.serverCache)}function J_(n,e,t,r){return sl(n.eventCache,new Ft(e,t,r))}function Ga(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function er(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}var Pc,VA=()=>(Pc||(Pc=new yt(DT)),Pc),tt=class n{constructor(e,t=VA()){this.value=e,this.children=t}static fromObject(e){let t=new n(null);return Be(e,(r,i)=>{t=t.set(new ue(r),i)}),t}isEmpty(){return this.value===null&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(this.value!=null&&t(this.value))return{path:le(),value:this.value};if(X(e))return null;{let r=J(e),i=this.children.get(r);if(i!==null){let s=i.findRootMostMatchingPathAndValue(de(e),t);return s!=null?{path:ye(new ue(r),s.path),value:s.value}:null}else return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(X(e))return this;{let t=J(e),r=this.children.get(t);return r!==null?r.subtree(de(e)):new n(null)}}set(e,t){if(X(e))return new n(t,this.children);{let r=J(e),s=(this.children.get(r)||new n(null)).set(de(e),t),o=this.children.insert(r,s);return new n(this.value,o)}}remove(e){if(X(e))return this.children.isEmpty()?new n(null):new n(null,this.children);{let t=J(e),r=this.children.get(t);if(r){let i=r.remove(de(e)),s;return i.isEmpty()?s=this.children.remove(t):s=this.children.insert(t,i),this.value===null&&s.isEmpty()?new n(null):new n(this.value,s)}else return this}}get(e){if(X(e))return this.value;{let t=J(e),r=this.children.get(t);return r?r.get(de(e)):null}}setTree(e,t){if(X(e))return t;{let r=J(e),s=(this.children.get(r)||new n(null)).setTree(de(e),t),o;return s.isEmpty()?o=this.children.remove(r):o=this.children.insert(r,s),new n(this.value,o)}}fold(e){return this.fold_(le(),e)}fold_(e,t){let r={};return this.children.inorderTraversal((i,s)=>{r[i]=s.fold_(ye(e,i),t)}),t(e,this.value,r)}findOnPath(e,t){return this.findOnPath_(e,le(),t)}findOnPath_(e,t,r){let i=this.value?r(t,this.value):!1;if(i)return i;if(X(e))return null;{let s=J(e),o=this.children.get(s);return o?o.findOnPath_(de(e),ye(t,s),r):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,le(),t)}foreachOnPath_(e,t,r){if(X(e))return this;{this.value&&r(t,this.value);let i=J(e),s=this.children.get(i);return s?s.foreachOnPath_(de(e),ye(t,i),r):new n(null)}}foreach(e){this.foreach_(le(),e)}foreach_(e,t){this.children.inorderTraversal((r,i)=>{i.foreach_(ye(e,r),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,r)=>{r.value&&e(t,r.value)})}};var St=class n{constructor(e){this.writeTree_=e}static empty(){return new n(new tt(null))}};function Is(n,e,t){if(X(e))return new St(new tt(t));{let r=n.writeTree_.findRootMostValueAndPath(e);if(r!=null){let i=r.path,s=r.value,o=et(i,e);return s=s.updateChild(o,t),new St(n.writeTree_.set(i,s))}else{let i=new tt(t),s=n.writeTree_.setTree(e,i);return new St(s)}}}function lh(n,e,t){let r=n;return Be(t,(i,s)=>{r=Is(r,ye(e,i),s)}),r}function u_(n,e){if(X(e))return St.empty();{let t=n.writeTree_.setTree(e,new tt(null));return new St(t)}}function uh(n,e){return nr(n,e)!=null}function nr(n,e){let t=n.writeTree_.findRootMostValueAndPath(e);return t!=null?n.writeTree_.get(t.path).getChild(et(t.path,e)):null}function c_(n){let e=[],t=n.writeTree_.value;return t!=null?t.isLeafNode()||t.forEachChild(me,(r,i)=>{e.push(new Z(r,i))}):n.writeTree_.children.inorderTraversal((r,i)=>{i.value!=null&&e.push(new Z(r,i.value))}),e}function yn(n,e){if(X(e))return n;{let t=nr(n,e);return t!=null?new St(new tt(t)):new St(n.writeTree_.subtree(e))}}function ch(n){return n.writeTree_.isEmpty()}function Hr(n,e){return X_(le(),n.writeTree_,e)}function X_(n,e,t){if(e.value!=null)return t.updateChild(n,e.value);{let r=null;return e.children.inorderTraversal((i,s)=>{i===".priority"?(O(s.value!==null,"Priority writes must always be leaf nodes"),r=s.value):t=X_(ye(n,i),s,t)}),!t.getChild(n).isEmpty()&&r!==null&&(t=t.updateChild(ye(n,".priority"),r)),t}}function ol(n,e){return ny(e,n)}function OA(n,e,t,r,i){O(r>n.lastWriteId,"Stacking an older write on top of newer ones"),i===void 0&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:r,visible:i}),i&&(n.visibleWrites=Is(n.visibleWrites,e,t)),n.lastWriteId=r}function FA(n,e,t,r){O(r>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:r,visible:!0}),n.visibleWrites=lh(n.visibleWrites,e,t),n.lastWriteId=r}function MA(n,e){for(let t=0;t<n.allWrites.length;t++){let r=n.allWrites[t];if(r.writeId===e)return r}return null}function LA(n,e){let t=n.allWrites.findIndex(l=>l.writeId===e);O(t>=0,"removeWrite called with nonexistent writeId.");let r=n.allWrites[t];n.allWrites.splice(t,1);let i=r.visible,s=!1,o=n.allWrites.length-1;for(;i&&o>=0;){let l=n.allWrites[o];l.visible&&(o>=t&&UA(l,r.path)?i=!1:_t(r.path,l.path)&&(s=!0)),o--}if(i){if(s)return BA(n),!0;if(r.snap)n.visibleWrites=u_(n.visibleWrites,r.path);else{let l=r.children;Be(l,u=>{n.visibleWrites=u_(n.visibleWrites,ye(r.path,u))})}return!0}else return!1}function UA(n,e){if(n.snap)return _t(n.path,e);for(let t in n.children)if(n.children.hasOwnProperty(t)&&_t(ye(n.path,t),e))return!0;return!1}function BA(n){n.visibleWrites=Z_(n.allWrites,qA,le()),n.allWrites.length>0?n.lastWriteId=n.allWrites[n.allWrites.length-1].writeId:n.lastWriteId=-1}function qA(n){return n.visible}function Z_(n,e,t){let r=St.empty();for(let i=0;i<n.length;++i){let s=n[i];if(e(s)){let o=s.path,l;if(s.snap)_t(t,o)?(l=et(t,o),r=Is(r,l,s.snap)):_t(o,t)&&(l=et(o,t),r=Is(r,le(),s.snap.getChild(l)));else if(s.children){if(_t(t,o))l=et(t,o),r=lh(r,l,s.children);else if(_t(o,t))if(l=et(o,t),X(l))r=lh(r,le(),s.children);else{let u=pn(s.children,J(l));if(u){let c=u.getChild(de(l));r=Is(r,le(),c)}}}else throw Mr("WriteRecord should have .snap or .children")}}return r}function ey(n,e,t,r,i){if(!r&&!i){let s=nr(n.visibleWrites,e);if(s!=null)return s;{let o=yn(n.visibleWrites,e);if(ch(o))return t;if(t==null&&!uh(o,le()))return null;{let l=t||$.EMPTY_NODE;return Hr(o,l)}}}else{let s=yn(n.visibleWrites,e);if(!i&&ch(s))return t;if(!i&&t==null&&!uh(s,le()))return null;{let o=function(c){return(c.visible||i)&&(!r||!~r.indexOf(c.writeId))&&(_t(c.path,e)||_t(e,c.path))},l=Z_(n.allWrites,o,e),u=t||$.EMPTY_NODE;return Hr(l,u)}}}function GA(n,e,t){let r=$.EMPTY_NODE,i=nr(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(me,(s,o)=>{r=r.updateImmediateChild(s,o)}),r;if(t){let s=yn(n.visibleWrites,e);return t.forEachChild(me,(o,l)=>{let u=Hr(yn(s,new ue(o)),l);r=r.updateImmediateChild(o,u)}),c_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}else{let s=yn(n.visibleWrites,e);return c_(s).forEach(o=>{r=r.updateImmediateChild(o.name,o.node)}),r}}function jA(n,e,t,r,i){O(r||i,"Either existingEventSnap or existingServerSnap must exist");let s=ye(e,t);if(uh(n.visibleWrites,s))return null;{let o=yn(n.visibleWrites,s);return ch(o)?i.getChild(t):Hr(o,i.getChild(t))}}function KA(n,e,t,r){let i=ye(e,t),s=nr(n.visibleWrites,i);if(s!=null)return s;if(r.isCompleteForChild(t)){let o=yn(n.visibleWrites,i);return Hr(o,r.getNode().getImmediateChild(t))}else return null}function zA(n,e){return nr(n.visibleWrites,e)}function WA(n,e,t,r,i,s,o){let l,u=yn(n.visibleWrites,e),c=nr(u,le());if(c!=null)l=c;else if(t!=null)l=Hr(u,t);else return[];if(l=l.withIndex(o),!l.isEmpty()&&!l.isLeafNode()){let d=[],m=o.getCompare(),p=s?l.getReverseIteratorFrom(r,o):l.getIteratorFrom(r,o),y=p.getNext();for(;y&&d.length<i;)m(y,r)!==0&&d.push(y),y=p.getNext();return d}else return[]}function QA(){return{visibleWrites:St.empty(),allWrites:[],lastWriteId:-1}}function ja(n,e,t,r){return ey(n.writeTree,n.treePath,e,t,r)}function $h(n,e){return GA(n.writeTree,n.treePath,e)}function h_(n,e,t,r){return jA(n.writeTree,n.treePath,e,t,r)}function Ka(n,e){return zA(n.writeTree,ye(n.treePath,e))}function $A(n,e,t,r,i,s){return WA(n.writeTree,n.treePath,e,t,r,i,s)}function Hh(n,e,t){return KA(n.writeTree,n.treePath,e,t)}function ty(n,e){return ny(ye(n.treePath,e),n.writeTree)}function ny(n,e){return{treePath:n,writeTree:e}}var hh=class{constructor(){this.changeMap=new Map}trackChildChange(e){let t=e.type,r=e.childName;O(t==="child_added"||t==="child_changed"||t==="child_removed","Only child changes supported for tracking"),O(r!==".priority","Only non-priority child changes can be tracked.");let i=this.changeMap.get(r);if(i){let s=i.type;if(t==="child_added"&&s==="child_removed")this.changeMap.set(r,Rs(r,e.snapshotNode,i.snapshotNode));else if(t==="child_removed"&&s==="child_added")this.changeMap.delete(r);else if(t==="child_removed"&&s==="child_changed")this.changeMap.set(r,bs(r,i.oldSnap));else if(t==="child_changed"&&s==="child_added")this.changeMap.set(r,Qr(r,e.snapshotNode));else if(t==="child_changed"&&s==="child_changed")this.changeMap.set(r,Rs(r,e.snapshotNode,i.oldSnap));else throw Mr("Illegal combination of changes: "+e+" occurred after "+i)}else this.changeMap.set(r,e)}getChanges(){return Array.from(this.changeMap.values())}};var dh=class{getCompleteChild(e){return null}getChildAfterChild(e,t,r){return null}},ry=new dh,Ds=class{constructor(e,t,r=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=r}getCompleteChild(e){let t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{let r=this.optCompleteServerCache_!=null?new Ft(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Hh(this.writes_,e,r)}}getChildAfterChild(e,t,r){let i=this.optCompleteServerCache_!=null?this.optCompleteServerCache_:er(this.viewCache_),s=$A(this.writes_,i,t,1,r,e);return s.length===0?null:s[0]}};function HA(n){return{filter:n}}function YA(n,e){O(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),O(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}function JA(n,e,t,r,i){let s=new hh,o,l;if(t.type===kt.OVERWRITE){let c=t;c.source.fromUser?o=fh(n,e,c.path,c.snap,r,i,s):(O(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered()&&!X(c.path),o=za(n,e,c.path,c.snap,r,i,l,s))}else if(t.type===kt.MERGE){let c=t;c.source.fromUser?o=ZA(n,e,c.path,c.children,r,i,s):(O(c.source.fromServer,"Unknown source."),l=c.source.tagged||e.serverCache.isFiltered(),o=mh(n,e,c.path,c.children,r,i,l,s))}else if(t.type===kt.ACK_USER_WRITE){let c=t;c.revert?o=n0(n,e,c.path,r,i,s):o=e0(n,e,c.path,c.affectedTree,r,i,s)}else if(t.type===kt.LISTEN_COMPLETE)o=t0(n,e,t.path,r,s);else throw Mr("Unknown operation type: "+t.type);let u=s.getChanges();return XA(e,o,u),{viewCache:o,changes:u}}function XA(n,e,t){let r=e.eventCache;if(r.isFullyInitialized()){let i=r.getNode().isLeafNode()||r.getNode().isEmpty(),s=Ga(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!r.getNode().equals(s)||!r.getNode().getPriority().equals(s.getPriority()))&&t.push(Y_(Ga(e)))}}function iy(n,e,t,r,i,s){let o=e.eventCache;if(Ka(r,t)!=null)return e;{let l,u;if(X(t))if(O(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){let c=er(e),d=c instanceof $?c:$.EMPTY_NODE,m=$h(r,d);l=n.filter.updateFullNode(e.eventCache.getNode(),m,s)}else{let c=ja(r,er(e));l=n.filter.updateFullNode(e.eventCache.getNode(),c,s)}else{let c=J(t);if(c===".priority"){O(En(t)===1,"Can't have a priority with additional path components");let d=o.getNode();u=e.serverCache.getNode();let m=h_(r,t,d,u);m!=null?l=n.filter.updatePriority(d,m):l=o.getNode()}else{let d=de(t),m;if(o.isCompleteForChild(c)){u=e.serverCache.getNode();let p=h_(r,t,o.getNode(),u);p!=null?m=o.getNode().getImmediateChild(c).updateChild(d,p):m=o.getNode().getImmediateChild(c)}else m=Hh(r,c,e.serverCache);m!=null?l=n.filter.updateChild(o.getNode(),c,m,d,i,s):l=o.getNode()}}return Es(e,l,o.isFullyInitialized()||X(t),n.filter.filtersNodes())}}function za(n,e,t,r,i,s,o,l){let u=e.serverCache,c,d=o?n.filter:n.filter.getIndexedFilter();if(X(t))c=d.updateFullNode(u.getNode(),r,null);else if(d.filtersNodes()&&!u.isFiltered()){let y=u.getNode().updateChild(t,r);c=d.updateFullNode(u.getNode(),y,null)}else{let y=J(t);if(!u.isCompleteForPath(t)&&En(t)>1)return e;let S=de(t),D=u.getNode().getImmediateChild(y).updateChild(S,r);y===".priority"?c=d.updatePriority(u.getNode(),D):c=d.updateChild(u.getNode(),y,D,S,ry,null)}let m=J_(e,c,u.isFullyInitialized()||X(t),d.filtersNodes()),p=new Ds(i,m,s);return iy(n,m,t,i,p,l)}function fh(n,e,t,r,i,s,o){let l=e.eventCache,u,c,d=new Ds(i,e,s);if(X(t))c=n.filter.updateFullNode(e.eventCache.getNode(),r,o),u=Es(e,c,!0,n.filter.filtersNodes());else{let m=J(t);if(m===".priority")c=n.filter.updatePriority(e.eventCache.getNode(),r),u=Es(e,c,l.isFullyInitialized(),l.isFiltered());else{let p=de(t),y=l.getNode().getImmediateChild(m),S;if(X(p))S=r;else{let x=d.getCompleteChild(m);x!=null?Bh(p)===".priority"&&x.getChild(K_(p)).isEmpty()?S=x:S=x.updateChild(p,r):S=$.EMPTY_NODE}if(y.equals(S))u=e;else{let x=n.filter.updateChild(l.getNode(),m,S,p,d,o);u=Es(e,x,l.isFullyInitialized(),n.filter.filtersNodes())}}}return u}function d_(n,e){return n.eventCache.isCompleteForChild(e)}function ZA(n,e,t,r,i,s,o){let l=e;return r.foreach((u,c)=>{let d=ye(t,u);d_(e,J(d))&&(l=fh(n,l,d,c,i,s,o))}),r.foreach((u,c)=>{let d=ye(t,u);d_(e,J(d))||(l=fh(n,l,d,c,i,s,o))}),l}function f_(n,e,t){return t.foreach((r,i)=>{e=e.updateChild(r,i)}),e}function mh(n,e,t,r,i,s,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u=e,c;X(t)?c=r:c=new tt(null).setTree(t,r);let d=e.serverCache.getNode();return c.children.inorderTraversal((m,p)=>{if(d.hasChild(m)){let y=e.serverCache.getNode().getImmediateChild(m),S=f_(n,y,p);u=za(n,u,new ue(m),S,i,s,o,l)}}),c.children.inorderTraversal((m,p)=>{let y=!e.serverCache.isCompleteForChild(m)&&p.value===null;if(!d.hasChild(m)&&!y){let S=e.serverCache.getNode().getImmediateChild(m),x=f_(n,S,p);u=za(n,u,new ue(m),x,i,s,o,l)}}),u}function e0(n,e,t,r,i,s,o){if(Ka(i,t)!=null)return e;let l=e.serverCache.isFiltered(),u=e.serverCache;if(r.value!=null){if(X(t)&&u.isFullyInitialized()||u.isCompleteForPath(t))return za(n,e,t,u.getNode().getChild(t),i,s,l,o);if(X(t)){let c=new tt(null);return u.getNode().forEachChild(Vt,(d,m)=>{c=c.set(new ue(d),m)}),mh(n,e,t,c,i,s,l,o)}else return e}else{let c=new tt(null);return r.foreach((d,m)=>{let p=ye(t,d);u.isCompleteForPath(p)&&(c=c.set(d,u.getNode().getChild(p)))}),mh(n,e,t,c,i,s,l,o)}}function t0(n,e,t,r,i){let s=e.serverCache,o=J_(e,s.getNode(),s.isFullyInitialized()||X(t),s.isFiltered());return iy(n,o,t,r,ry,i)}function n0(n,e,t,r,i,s){let o;if(Ka(r,t)!=null)return e;{let l=new Ds(r,e,i),u=e.eventCache.getNode(),c;if(X(t)||J(t)===".priority"){let d;if(e.serverCache.isFullyInitialized())d=ja(r,er(e));else{let m=e.serverCache.getNode();O(m instanceof $,"serverChildren would be complete if leaf node"),d=$h(r,m)}d=d,c=n.filter.updateFullNode(u,d,s)}else{let d=J(t),m=Hh(r,d,e.serverCache);m==null&&e.serverCache.isCompleteForChild(d)&&(m=u.getImmediateChild(d)),m!=null?c=n.filter.updateChild(u,d,m,de(t),l,s):e.eventCache.getNode().hasChild(d)?c=n.filter.updateChild(u,d,$.EMPTY_NODE,de(t),l,s):c=u,c.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=ja(r,er(e)),o.isLeafNode()&&(c=n.filter.updateFullNode(c,o,s)))}return o=e.serverCache.isFullyInitialized()||Ka(r,le())!=null,Es(e,c,o,n.filter.filtersNodes())}}var ph=class{constructor(e,t){this.query_=e,this.eventRegistrations_=[];let r=this.query_._queryParams,i=new Ps(r.getIndex()),s=TA(r);this.processor_=HA(s);let o=t.serverCache,l=t.eventCache,u=i.updateFullNode($.EMPTY_NODE,o.getNode(),null),c=s.updateFullNode($.EMPTY_NODE,l.getNode(),null),d=new Ft(u,o.isFullyInitialized(),i.filtersNodes()),m=new Ft(c,l.isFullyInitialized(),s.filtersNodes());this.viewCache_=sl(m,d),this.eventGenerator_=new ah(this.query_)}get query(){return this.query_}};function r0(n){return n.viewCache_.serverCache.getNode()}function i0(n){return Ga(n.viewCache_)}function s0(n,e){let t=er(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!X(e)&&!t.getImmediateChild(J(e)).isEmpty())?t.getChild(e):null}function m_(n){return n.eventRegistrations_.length===0}function o0(n,e){n.eventRegistrations_.push(e)}function p_(n,e,t){let r=[];if(t){O(e==null,"A cancel should cancel all event registrations.");let i=n.query._path;n.eventRegistrations_.forEach(s=>{let o=s.createCancelEvent(t,i);o&&r.push(o)})}if(e){let i=[];for(let s=0;s<n.eventRegistrations_.length;++s){let o=n.eventRegistrations_[s];if(!o.matches(e))i.push(o);else if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(s+1));break}}n.eventRegistrations_=i}else n.eventRegistrations_=[];return r}function g_(n,e,t,r){e.type===kt.MERGE&&e.source.queryId!==null&&(O(er(n.viewCache_),"We should always have a full cache before handling merges"),O(Ga(n.viewCache_),"Missing event cache, even though we have a server cache"));let i=n.viewCache_,s=JA(n.processor_,i,e,t,r);return YA(n.processor_,s.viewCache),O(s.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=s.viewCache,sy(n,s.changes,s.viewCache.eventCache.getNode(),null)}function a0(n,e){let t=n.viewCache_.eventCache,r=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(me,(s,o)=>{r.push(Qr(s,o))}),t.isFullyInitialized()&&r.push(Y_(t.getNode())),sy(n,r,t.getNode(),e)}function sy(n,e,t,r){let i=r?[r]:n.eventRegistrations_;return NA(n.eventGenerator_,e,t,i)}var Wa,Qa=class{constructor(){this.views=new Map}};function l0(n){O(!Wa,"__referenceConstructor has already been defined"),Wa=n}function u0(){return O(Wa,"Reference.ts has not been loaded"),Wa}function c0(n){return n.views.size===0}function Yh(n,e,t,r){let i=e.source.queryId;if(i!==null){let s=n.views.get(i);return O(s!=null,"SyncTree gave us an op for an invalid query."),g_(s,e,t,r)}else{let s=[];for(let o of n.views.values())s=s.concat(g_(o,e,t,r));return s}}function oy(n,e,t,r,i){let s=e._queryIdentifier,o=n.views.get(s);if(!o){let l=ja(t,i?r:null),u=!1;l?u=!0:r instanceof $?(l=$h(t,r),u=!1):(l=$.EMPTY_NODE,u=!1);let c=sl(new Ft(l,u,!1),new Ft(r,i,!1));return new ph(e,c)}return o}function h0(n,e,t,r,i,s){let o=oy(n,e,r,i,s);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),o0(o,t),a0(o,t)}function d0(n,e,t,r){let i=e._queryIdentifier,s=[],o=[],l=In(n);if(i==="default")for(let[u,c]of n.views.entries())o=o.concat(p_(c,t,r)),m_(c)&&(n.views.delete(u),c.query._queryParams.loadsAllData()||s.push(c.query));else{let u=n.views.get(i);u&&(o=o.concat(p_(u,t,r)),m_(u)&&(n.views.delete(i),u.query._queryParams.loadsAllData()||s.push(u.query)))}return l&&!In(n)&&s.push(new(u0())(e._repo,e._path)),{removed:s,events:o}}function ay(n){let e=[];for(let t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function vn(n,e){let t=null;for(let r of n.views.values())t=t||s0(r,e);return t}function ly(n,e){if(e._queryParams.loadsAllData())return al(n);{let r=e._queryIdentifier;return n.views.get(r)}}function uy(n,e){return ly(n,e)!=null}function In(n){return al(n)!=null}function al(n){for(let e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}var $a;function f0(n){O(!$a,"__referenceConstructor has already been defined"),$a=n}function m0(){return O($a,"Reference.ts has not been loaded"),$a}var p0=1,Ha=class{constructor(e){this.listenProvider_=e,this.syncPointTree_=new tt(null),this.pendingWriteTree_=QA(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}};function Jh(n,e,t,r,i){return OA(n.pendingWriteTree_,e,t,r,i),i?ei(n,new $r(zh(),e,t)):[]}function g0(n,e,t,r){FA(n.pendingWriteTree_,e,t,r);let i=tt.fromObject(t);return ei(n,new Ns(zh(),e,i))}function _n(n,e,t=!1){let r=MA(n.pendingWriteTree_,e);if(LA(n.pendingWriteTree_,e)){let s=new tt(null);return r.snap!=null?s=s.set(le(),!0):Be(r.children,o=>{s=s.set(new ue(o),!0)}),ei(n,new oh(r.path,s,t))}else return[]}function qs(n,e,t){return ei(n,new $r(Wh(),e,t))}function _0(n,e,t){let r=tt.fromObject(t);return ei(n,new Ns(Wh(),e,r))}function y0(n,e){return ei(n,new qa(Wh(),e))}function v0(n,e,t){let r=Xh(n,t);if(r){let i=Zh(r),s=i.path,o=i.queryId,l=et(s,e),u=new qa(Qh(o),l);return ed(n,s,u)}else return[]}function Ya(n,e,t,r,i=!1){let s=e._path,o=n.syncPointTree_.get(s),l=[];if(o&&(e._queryIdentifier==="default"||uy(o,e))){let u=d0(o,e,t,r);c0(o)&&(n.syncPointTree_=n.syncPointTree_.remove(s));let c=u.removed;if(l=u.events,!i){let d=c.findIndex(p=>p._queryParams.loadsAllData())!==-1,m=n.syncPointTree_.findOnPath(s,(p,y)=>In(y));if(d&&!m){let p=n.syncPointTree_.subtree(s);if(!p.isEmpty()){let y=I0(p);for(let S=0;S<y.length;++S){let x=y[S],D=x.query,q=fy(n,x);n.listenProvider_.startListening(Ts(D),ks(n,D),q.hashFn,q.onComplete)}}}!m&&c.length>0&&!r&&(d?n.listenProvider_.stopListening(Ts(e),null):c.forEach(p=>{let y=n.queryToTagMap.get(ul(p));n.listenProvider_.stopListening(Ts(p),y)}))}T0(n,c)}return l}function cy(n,e,t,r){let i=Xh(n,r);if(i!=null){let s=Zh(i),o=s.path,l=s.queryId,u=et(o,e),c=new $r(Qh(l),u,t);return ed(n,o,c)}else return[]}function w0(n,e,t,r){let i=Xh(n,r);if(i){let s=Zh(i),o=s.path,l=s.queryId,u=et(o,e),c=tt.fromObject(t),d=new Ns(Qh(l),u,c);return ed(n,o,d)}else return[]}function gh(n,e,t,r=!1){let i=e._path,s=null,o=!1;n.syncPointTree_.foreachOnPath(i,(p,y)=>{let S=et(p,i);s=s||vn(y,S),o=o||In(y)});let l=n.syncPointTree_.get(i);l?(o=o||In(l),s=s||vn(l,le())):(l=new Qa,n.syncPointTree_=n.syncPointTree_.set(i,l));let u;s!=null?u=!0:(u=!1,s=$.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((y,S)=>{let x=vn(S,le());x&&(s=s.updateImmediateChild(y,x))}));let c=uy(l,e);if(!c&&!e._queryParams.loadsAllData()){let p=ul(e);O(!n.queryToTagMap.has(p),"View does not exist, but we have a tag");let y=A0();n.queryToTagMap.set(p,y),n.tagToQueryMap.set(y,p)}let d=ol(n.pendingWriteTree_,i),m=h0(l,e,t,d,s,u);if(!c&&!o&&!r){let p=ly(l,e);m=m.concat(S0(n,e,p))}return m}function ll(n,e,t){let i=n.pendingWriteTree_,s=n.syncPointTree_.findOnPath(e,(o,l)=>{let u=et(o,e),c=vn(l,u);if(c)return c});return ey(i,e,s,t,!0)}function E0(n,e){let t=e._path,r=null;n.syncPointTree_.foreachOnPath(t,(c,d)=>{let m=et(c,t);r=r||vn(d,m)});let i=n.syncPointTree_.get(t);i?r=r||vn(i,le()):(i=new Qa,n.syncPointTree_=n.syncPointTree_.set(t,i));let s=r!=null,o=s?new Ft(r,!0,!1):null,l=ol(n.pendingWriteTree_,e._path),u=oy(i,e,l,s?o.getNode():$.EMPTY_NODE,s);return i0(u)}function ei(n,e){return hy(e,n.syncPointTree_,null,ol(n.pendingWriteTree_,le()))}function hy(n,e,t,r){if(X(n.path))return dy(n,e,t,r);{let i=e.get(le());t==null&&i!=null&&(t=vn(i,le()));let s=[],o=J(n.path),l=n.operationForChild(o),u=e.children.get(o);if(u&&l){let c=t?t.getImmediateChild(o):null,d=ty(r,o);s=s.concat(hy(l,u,c,d))}return i&&(s=s.concat(Yh(i,n,r,t))),s}}function dy(n,e,t,r){let i=e.get(le());t==null&&i!=null&&(t=vn(i,le()));let s=[];return e.children.inorderTraversal((o,l)=>{let u=t?t.getImmediateChild(o):null,c=ty(r,o),d=n.operationForChild(o);d&&(s=s.concat(dy(d,l,u,c)))}),i&&(s=s.concat(Yh(i,n,r,t))),s}function fy(n,e){let t=e.query,r=ks(n,t);return{hashFn:()=>(r0(e)||$.EMPTY_NODE).hash(),onComplete:i=>{if(i==="ok")return r?v0(n,t._path,r):y0(n,t._path);{let s=OT(i,t);return Ya(n,t,null,s)}}}}function ks(n,e){let t=ul(e);return n.queryToTagMap.get(t)}function ul(n){return n._path.toString()+"$"+n._queryIdentifier}function Xh(n,e){return n.tagToQueryMap.get(e)}function Zh(n){let e=n.indexOf("$");return O(e!==-1&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new ue(n.substr(0,e))}}function ed(n,e,t){let r=n.syncPointTree_.get(e);O(r,"Missing sync point for query tag that we're tracking");let i=ol(n.pendingWriteTree_,e);return Yh(r,t,i,null)}function I0(n){return n.fold((e,t,r)=>{if(t&&In(t))return[al(t)];{let i=[];return t&&(i=ay(t)),Be(r,(s,o)=>{i=i.concat(o)}),i}})}function Ts(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(m0())(n._repo,n._path):n}function T0(n,e){for(let t=0;t<e.length;++t){let r=e[t];if(!r._queryParams.loadsAllData()){let i=ul(r),s=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(s)}}}function A0(){return p0++}function S0(n,e,t){let r=e._path,i=ks(n,e),s=fy(n,t),o=n.listenProvider_.startListening(Ts(e),i,s.hashFn,s.onComplete),l=n.syncPointTree_.subtree(r);if(i)O(!In(l.value),"If we're adding a query, it shouldn't be shadowed");else{let u=l.fold((c,d,m)=>{if(!X(c)&&d&&In(d))return[al(d).query];{let p=[];return d&&(p=p.concat(ay(d).map(y=>y.query))),Be(m,(y,S)=>{p=p.concat(S)}),p}});for(let c=0;c<u.length;++c){let d=u[c];n.listenProvider_.stopListening(Ts(d),ks(n,d))}}return o}var _h=class n{constructor(e){this.node_=e}getImmediateChild(e){let t=this.node_.getImmediateChild(e);return new n(t)}node(){return this.node_}},yh=class n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){let t=ye(this.path_,e);return new n(this.syncTree_,t)}node(){return ll(this.syncTree_,this.path_)}},C0=function(n){return n=n||{},n.timestamp=n.timestamp||new Date().getTime(),n},__=function(n,e,t){if(!n||typeof n!="object")return n;if(O(".sv"in n,"Unexpected leaf node or priority contents"),typeof n[".sv"]=="string")return b0(n[".sv"],e,t);if(typeof n[".sv"]=="object")return R0(n[".sv"],e);O(!1,"Unexpected server value: "+JSON.stringify(n,null,2))},b0=function(n,e,t){switch(n){case"timestamp":return t.timestamp;default:O(!1,"Unexpected server value: "+n)}},R0=function(n,e,t){n.hasOwnProperty("increment")||O(!1,"Unexpected server value: "+JSON.stringify(n,null,2));let r=n.increment;typeof r!="number"&&O(!1,"Unexpected increment value: "+r);let i=e.node();if(O(i!==null&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return r;let o=i.getValue();return typeof o!="number"?r:o+r},my=function(n,e,t,r){return nd(e,new yh(t,n),r)},td=function(n,e,t){return nd(n,new _h(e),t)};function nd(n,e,t){let r=n.getPriority().val(),i=__(r,e.getImmediateChild(".priority"),t),s;if(n.isLeafNode()){let o=n,l=__(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new zr(l,we(i)):n}else{let o=n;return s=o,i!==o.getPriority().val()&&(s=s.updatePriority(new zr(i))),o.forEachChild(me,(l,u)=>{let c=nd(u,e.getImmediateChild(l),t);c!==u&&(s=s.updateImmediateChild(l,c))}),s}}var Vs=class{constructor(e="",t=null,r={children:{},childCount:0}){this.name=e,this.parent=t,this.node=r}};function cl(n,e){let t=e instanceof ue?e:new ue(e),r=n,i=J(t);for(;i!==null;){let s=pn(r.node.children,i)||{children:{},childCount:0};r=new Vs(i,r,s),t=de(t),i=J(t)}return r}function rr(n){return n.node.value}function rd(n,e){n.node.value=e,vh(n)}function py(n){return n.node.childCount>0}function P0(n){return rr(n)===void 0&&!py(n)}function hl(n,e){Be(n.node.children,(t,r)=>{e(new Vs(t,n,r))})}function gy(n,e,t,r){t&&!r&&e(n),hl(n,i=>{gy(i,e,!0,r)}),t&&r&&e(n)}function x0(n,e,t){let r=t?n:n.parent;for(;r!==null;){if(e(r))return!0;r=r.parent}return!1}function Gs(n){return new ue(n.parent===null?n.name:Gs(n.parent)+"/"+n.name)}function vh(n){n.parent!==null&&N0(n.parent,n.name,n)}function N0(n,e,t){let r=P0(t),i=pt(n.node.children,e);r&&i?(delete n.node.children[e],n.node.childCount--,vh(n)):!r&&!i&&(n.node.children[e]=t.node,n.node.childCount++,vh(n))}var D0=/[\[\].#$\/\u0000-\u001F\u007F]/,k0=/[\[\].#$\u0000-\u001F\u007F]/,xc=10*1024*1024,dl=function(n){return typeof n=="string"&&n.length!==0&&!D0.test(n)},_y=function(n){return typeof n=="string"&&n.length!==0&&!k0.test(n)},V0=function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),_y(n)},Os=function(n){return n===null||typeof n=="string"||typeof n=="number"&&!rl(n)||n&&typeof n=="object"&&pt(n,".sv")},Mt=function(n,e,t,r){r&&e===void 0||js(ot(n,"value"),e,t)},js=function(n,e,t){let r=t instanceof ue?new jc(t,n):t;if(e===void 0)throw new Error(n+"contains undefined "+Jn(r));if(typeof e=="function")throw new Error(n+"contains a function "+Jn(r)+" with contents = "+e.toString());if(rl(e))throw new Error(n+"contains "+e.toString()+" "+Jn(r));if(typeof e=="string"&&e.length>xc/3&&ms(e)>xc)throw new Error(n+"contains a string greater than "+xc+" utf8 bytes "+Jn(r)+" ('"+e.substring(0,50)+"...')");if(e&&typeof e=="object"){let i=!1,s=!1;if(Be(e,(o,l)=>{if(o===".value")i=!0;else if(o!==".priority"&&o!==".sv"&&(s=!0,!dl(o)))throw new Error(n+" contains an invalid key ("+o+") "+Jn(r)+`.  Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`);cA(r,o),js(n,l,r),hA(r)}),i&&s)throw new Error(n+' contains ".value" child '+Jn(r)+" in addition to actual children.")}},O0=function(n,e){let t,r;for(t=0;t<e.length;t++){r=e[t];let s=Ss(r);for(let o=0;o<s.length;o++)if(!(s[o]===".priority"&&o===s.length-1)){if(!dl(s[o]))throw new Error(n+"contains an invalid key ("+s[o]+") in path "+r.toString()+`. Keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]"`)}}e.sort(uA);let i=null;for(t=0;t<e.length;t++){if(r=e[t],i!==null&&_t(i,r))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+r.toString());i=r}},yy=function(n,e,t,r){if(r&&e===void 0)return;let i=ot(n,"values");if(!(e&&typeof e=="object")||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");let s=[];Be(e,(o,l)=>{let u=new ue(o);if(js(i,l,ye(t,u)),Bh(u)===".priority"&&!Os(l))throw new Error(i+"contains an invalid value for '"+u.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");s.push(u)}),O0(i,s)},id=function(n,e,t){if(!(t&&e===void 0)){if(rl(e))throw new Error(ot(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!Os(e))throw new Error(ot(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},Ks=function(n,e,t,r){if(!(r&&t===void 0)&&!dl(t))throw new Error(ot(n,e)+'was an invalid key = "'+t+`".  Firebase keys must be non-empty strings and can't contain ".", "#", "$", "/", "[", or "]").`)},ti=function(n,e,t,r){if(!(r&&t===void 0)&&!_y(t))throw new Error(ot(n,e)+'was an invalid path = "'+t+`". Paths must be non-empty strings and can't contain ".", "#", "$", "[", or "]"`)},F0=function(n,e,t,r){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),ti(n,e,t,r)},ut=function(n,e){if(J(e)===".info")throw new Error(n+" failed = Can't modify data under /.info/")},vy=function(n,e){let t=e.path.toString();if(typeof e.repoInfo.host!="string"||e.repoInfo.host.length===0||!dl(e.repoInfo.namespace)&&e.repoInfo.host.split(":")[0]!=="localhost"||t.length!==0&&!V0(t))throw new Error(ot(n,"url")+`must be a valid firebase URL and the path can't contain ".", "#", "$", "[", or "]".`)};var wh=class{constructor(){this.eventLists_=[],this.recursionDepth_=0}};function fl(n,e){let t=null;for(let r=0;r<e.length;r++){let i=e[r],s=i.getPath();t!==null&&!qh(s,t.path)&&(n.eventLists_.push(t),t=null),t===null&&(t={events:[],path:s}),t.events.push(i)}t&&n.eventLists_.push(t)}function wy(n,e,t){fl(n,t),Ey(n,r=>qh(r,e))}function ct(n,e,t){fl(n,t),Ey(n,r=>_t(r,e)||_t(e,r))}function Ey(n,e){n.recursionDepth_++;let t=!0;for(let r=0;r<n.eventLists_.length;r++){let i=n.eventLists_[r];if(i){let s=i.path;e(s)?(M0(n.eventLists_[r]),n.eventLists_[r]=null):t=!1}}t&&(n.eventLists_=[]),n.recursionDepth_--}function M0(n){for(let e=0;e<n.events.length;e++){let t=n.events[e];if(t!==null){n.events[e]=null;let r=t.getEventRunner();Zn&&Ue("event: "+t.toString()),Xr(r)}}}var Iy="repo_interrupt",L0=25,Eh=class{constructor(e,t,r,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=r,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new wh,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Ba(),this.transactionQueueTree_=new Vs,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}};function U0(n,e,t){if(n.stats_=Uh(n.repoInfo_),n.forceRestClient_||UT())n.server_=new eh(n.repoInfo_,(r,i,s,o)=>{y_(n,r,i,s,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>v_(n,!0),0);else{if(typeof t<"u"&&t!==null){if(typeof t!="object")throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{Pe(t)}catch(r){throw new Error("Invalid authOverride provided: "+r)}}n.persistentConnection_=new Gh(n.repoInfo_,e,(r,i,s,o)=>{y_(n,r,i,s,o)},r=>{v_(n,r)},r=>{B0(n,r)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(r=>{n.server_.refreshAuthToken(r)}),n.appCheckProvider_.addTokenChangeListener(r=>{n.server_.refreshAppCheckToken(r.token)}),n.statsReporter_=qT(n.repoInfo_,()=>new sh(n.stats_,n.server_)),n.infoData_=new th,n.infoSyncTree_=new Ha({startListening:(r,i,s,o)=>{let l=[],u=n.infoData_.getNode(r._path);return u.isEmpty()||(l=qs(n.infoSyncTree_,r._path,u),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),sd(n,"connected",!1),n.serverSyncTree_=new Ha({startListening:(r,i,s,o)=>(n.server_.listen(r,s,i,(l,u)=>{let c=o(l,u);ct(n.eventQueue_,r._path,c)}),[]),stopListening:(r,i)=>{n.server_.unlisten(r,i)}})}function Ty(n){let t=n.infoData_.getNode(new ue(".info/serverTimeOffset")).val()||0;return new Date().getTime()+t}function zs(n){return C0({timestamp:Ty(n)})}function y_(n,e,t,r,i){n.dataUpdateCount++;let s=new ue(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(r){let u=fs(t,c=>we(c));o=w0(n.serverSyncTree_,s,u,i)}else{let u=we(t);o=cy(n.serverSyncTree_,s,u,i)}else if(r){let u=fs(t,c=>we(c));o=_0(n.serverSyncTree_,s,u)}else{let u=we(t);o=qs(n.serverSyncTree_,s,u)}let l=s;o.length>0&&(l=Yr(n,s)),ct(n.eventQueue_,l,o)}function v_(n,e){sd(n,"connected",e),e===!1&&j0(n)}function B0(n,e){Be(e,(t,r)=>{sd(n,t,r)})}function sd(n,e,t){let r=new ue("/.info/"+e),i=we(t);n.infoData_.updateSnapshot(r,i);let s=qs(n.infoSyncTree_,r,i);ct(n.eventQueue_,r,s)}function ml(n){return n.nextWriteId_++}function q0(n,e,t){let r=E0(n.serverSyncTree_,e);return r!=null?Promise.resolve(r):n.server_.get(e).then(i=>{let s=we(i).withIndex(e._queryParams.getIndex());gh(n.serverSyncTree_,e,t,!0);let o;if(e._queryParams.loadsAllData())o=qs(n.serverSyncTree_,e._path,s);else{let l=ks(n.serverSyncTree_,e);o=cy(n.serverSyncTree_,e._path,s,l)}return ct(n.eventQueue_,e._path,o),Ya(n.serverSyncTree_,e,t,null,!0),s},i=>(ni(n,"get for query "+Pe(e)+" failed: "+i),Promise.reject(new Error(i))))}function od(n,e,t,r,i){ni(n,"set",{path:e.toString(),value:t,priority:r});let s=zs(n),o=we(t,r),l=ll(n.serverSyncTree_,e),u=td(o,l,s),c=ml(n),d=Jh(n.serverSyncTree_,e,u,c,!0);fl(n.eventQueue_,d),n.server_.put(e.toString(),o.val(!0),(p,y)=>{let S=p==="ok";S||$e("set at "+e+" failed: "+p);let x=_n(n.serverSyncTree_,c,!S);ct(n.eventQueue_,e,x),Tn(n,i,p,y)});let m=ld(n,e);Yr(n,m),ct(n.eventQueue_,m,[])}function G0(n,e,t,r){ni(n,"update",{path:e.toString(),value:t});let i=!0,s=zs(n),o={};if(Be(t,(l,u)=>{i=!1,o[l]=my(ye(e,l),we(u),n.serverSyncTree_,s)}),i)Ue("update() called with empty data.  Don't do anything."),Tn(n,r,"ok",void 0);else{let l=ml(n),u=g0(n.serverSyncTree_,e,o,l);fl(n.eventQueue_,u),n.server_.merge(e.toString(),t,(c,d)=>{let m=c==="ok";m||$e("update at "+e+" failed: "+c);let p=_n(n.serverSyncTree_,l,!m),y=p.length>0?Yr(n,e):e;ct(n.eventQueue_,y,p),Tn(n,r,c,d)}),Be(t,c=>{let d=ld(n,ye(e,c));Yr(n,d)}),ct(n.eventQueue_,e,[])}}function j0(n){ni(n,"onDisconnectEvents");let e=zs(n),t=Ba();rh(n.onDisconnect_,le(),(i,s)=>{let o=my(i,s,n.serverSyncTree_,e);Zr(t,i,o)});let r=[];rh(t,le(),(i,s)=>{r=r.concat(qs(n.serverSyncTree_,i,s));let o=ld(n,i);Yr(n,o)}),n.onDisconnect_=Ba(),ct(n.eventQueue_,le(),r)}function K0(n,e,t){n.server_.onDisconnectCancel(e.toString(),(r,i)=>{r==="ok"&&nh(n.onDisconnect_,e),Tn(n,t,r,i)})}function w_(n,e,t,r){let i=we(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(s,o)=>{s==="ok"&&Zr(n.onDisconnect_,e,i),Tn(n,r,s,o)})}function z0(n,e,t,r,i){let s=we(t,r);n.server_.onDisconnectPut(e.toString(),s.val(!0),(o,l)=>{o==="ok"&&Zr(n.onDisconnect_,e,s),Tn(n,i,o,l)})}function W0(n,e,t,r){if(ha(t)){Ue("onDisconnect().update() called with empty data.  Don't do anything."),Tn(n,r,"ok",void 0);return}n.server_.onDisconnectMerge(e.toString(),t,(i,s)=>{i==="ok"&&Be(t,(o,l)=>{let u=we(l);Zr(n.onDisconnect_,ye(e,o),u)}),Tn(n,r,i,s)})}function Q0(n,e,t){let r;J(e._path)===".info"?r=gh(n.infoSyncTree_,e,t):r=gh(n.serverSyncTree_,e,t),wy(n.eventQueue_,e._path,r)}function Ih(n,e,t){let r;J(e._path)===".info"?r=Ya(n.infoSyncTree_,e,t):r=Ya(n.serverSyncTree_,e,t),wy(n.eventQueue_,e._path,r)}function Ay(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Iy)}function $0(n){n.persistentConnection_&&n.persistentConnection_.resume(Iy)}function ni(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),Ue(t,...e)}function Tn(n,e,t,r){e&&Xr(()=>{if(t==="ok")e(null);else{let i=(t||"error").toUpperCase(),s=i;r&&(s+=": "+r);let o=new Error(s);o.code=i,e(o)}})}function H0(n,e,t,r,i,s){ni(n,"transaction on "+e);let o={path:e,update:t,onComplete:r,status:null,order:T_(),applyLocally:s,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=ad(n,e,void 0);o.currentInputSnapshot=l;let u=o.update(l.val());if(u===void 0)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{js("transaction failed: Data returned ",u,o.path),o.status=0;let c=cl(n.transactionQueueTree_,e),d=rr(c)||[];d.push(o),rd(c,d);let m;typeof u=="object"&&u!==null&&pt(u,".priority")?(m=pn(u,".priority"),O(Os(m),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):m=(ll(n.serverSyncTree_,e)||$.EMPTY_NODE).getPriority().val();let p=zs(n),y=we(u,m),S=td(y,l,p);o.currentOutputSnapshotRaw=y,o.currentOutputSnapshotResolved=S,o.currentWriteId=ml(n);let x=Jh(n.serverSyncTree_,e,S,o.currentWriteId,o.applyLocally);ct(n.eventQueue_,e,x),pl(n,n.transactionQueueTree_)}}function ad(n,e,t){return ll(n.serverSyncTree_,e,t)||$.EMPTY_NODE}function pl(n,e=n.transactionQueueTree_){if(e||gl(n,e),rr(e)){let t=Cy(n,e);O(t.length>0,"Sending zero length transaction queue"),t.every(i=>i.status===0)&&Y0(n,Gs(e),t)}else py(e)&&hl(e,t=>{pl(n,t)})}function Y0(n,e,t){let r=t.map(c=>c.currentWriteId),i=ad(n,e,r),s=i,o=i.hash();for(let c=0;c<t.length;c++){let d=t[c];O(d.status===0,"tryToSendTransactionQueue_: items in queue should all be run."),d.status=1,d.retryCount++;let m=et(e,d.path);s=s.updateChild(m,d.currentOutputSnapshotRaw)}let l=s.val(!0),u=e;n.server_.put(u.toString(),l,c=>{ni(n,"transaction put response",{path:u.toString(),status:c});let d=[];if(c==="ok"){let m=[];for(let p=0;p<t.length;p++)t[p].status=2,d=d.concat(_n(n.serverSyncTree_,t[p].currentWriteId)),t[p].onComplete&&m.push(()=>t[p].onComplete(null,!0,t[p].currentOutputSnapshotResolved)),t[p].unwatcher();gl(n,cl(n.transactionQueueTree_,e)),pl(n,n.transactionQueueTree_),ct(n.eventQueue_,e,d);for(let p=0;p<m.length;p++)Xr(m[p])}else{if(c==="datastale")for(let m=0;m<t.length;m++)t[m].status===3?t[m].status=4:t[m].status=0;else{$e("transaction at "+u.toString()+" failed: "+c);for(let m=0;m<t.length;m++)t[m].status=4,t[m].abortReason=c}Yr(n,e)}},o)}function Yr(n,e){let t=Sy(n,e),r=Gs(t),i=Cy(n,t);return J0(n,i,r),r}function J0(n,e,t){if(e.length===0)return;let r=[],i=[],o=e.filter(l=>l.status===0).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){let u=e[l],c=et(t,u.path),d=!1,m;if(O(c!==null,"rerunTransactionsUnderNode_: relativePath should not be null."),u.status===4)d=!0,m=u.abortReason,i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0));else if(u.status===0)if(u.retryCount>=L0)d=!0,m="maxretry",i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0));else{let p=ad(n,u.path,o);u.currentInputSnapshot=p;let y=e[l].update(p.val());if(y!==void 0){js("transaction failed: Data returned ",y,u.path);let S=we(y);typeof y=="object"&&y!=null&&pt(y,".priority")||(S=S.updatePriority(p.getPriority()));let D=u.currentWriteId,q=zs(n),j=td(S,p,q);u.currentOutputSnapshotRaw=S,u.currentOutputSnapshotResolved=j,u.currentWriteId=ml(n),o.splice(o.indexOf(D),1),i=i.concat(Jh(n.serverSyncTree_,u.path,j,u.currentWriteId,u.applyLocally)),i=i.concat(_n(n.serverSyncTree_,D,!0))}else d=!0,m="nodata",i=i.concat(_n(n.serverSyncTree_,u.currentWriteId,!0))}ct(n.eventQueue_,t,i),i=[],d&&(e[l].status=2,function(p){setTimeout(p,Math.floor(0))}(e[l].unwatcher),e[l].onComplete&&(m==="nodata"?r.push(()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot)):r.push(()=>e[l].onComplete(new Error(m),!1,null))))}gl(n,n.transactionQueueTree_);for(let l=0;l<r.length;l++)Xr(r[l]);pl(n,n.transactionQueueTree_)}function Sy(n,e){let t,r=n.transactionQueueTree_;for(t=J(e);t!==null&&rr(r)===void 0;)r=cl(r,t),e=de(e),t=J(e);return r}function Cy(n,e){let t=[];return by(n,e,t),t.sort((r,i)=>r.order-i.order),t}function by(n,e,t){let r=rr(e);if(r)for(let i=0;i<r.length;i++)t.push(r[i]);hl(e,i=>{by(n,i,t)})}function gl(n,e){let t=rr(e);if(t){let r=0;for(let i=0;i<t.length;i++)t[i].status!==2&&(t[r]=t[i],r++);t.length=r,rd(e,t.length>0?t:void 0)}hl(e,r=>{gl(n,r)})}function ld(n,e){let t=Gs(Sy(n,e)),r=cl(n.transactionQueueTree_,e);return x0(r,i=>{Nc(n,i)}),Nc(n,r),gy(r,i=>{Nc(n,i)}),t}function Nc(n,e){let t=rr(e);if(t){let r=[],i=[],s=-1;for(let o=0;o<t.length;o++)t[o].status===3||(t[o].status===1?(O(s===o-1,"All SENT items should be at beginning of queue."),s=o,t[o].status=3,t[o].abortReason="set"):(O(t[o].status===0,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(_n(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&r.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));s===-1?rd(e,void 0):t.length=s+1,ct(n.eventQueue_,Gs(e),i);for(let o=0;o<r.length;o++)Xr(r[o])}}function X0(n){let e="",t=n.split("/");for(let r=0;r<t.length;r++)if(t[r].length>0){let i=t[r];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}function Z0(n){let e={};n.charAt(0)==="?"&&(n=n.substring(1));for(let t of n.split("&")){if(t.length===0)continue;let r=t.split("=");r.length===2?e[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):$e(`Invalid query segment '${t}' in query '${n}'`)}return e}var Th=function(n,e){let t=eS(n),r=t.namespace;t.domain==="firebase.com"&&Ot(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!r||r==="undefined")&&t.domain!=="localhost"&&Ot("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||xT();let i=t.scheme==="ws"||t.scheme==="wss";return{repoInfo:new Da(t.host,t.secure,r,i,e,"",r!==t.subdomain),path:new ue(t.pathString)}},eS=function(n){let e="",t="",r="",i="",s="",o=!0,l="https",u=443;if(typeof n=="string"){let c=n.indexOf("//");c>=0&&(l=n.substring(0,c-1),n=n.substring(c+2));let d=n.indexOf("/");d===-1&&(d=n.length);let m=n.indexOf("?");m===-1&&(m=n.length),e=n.substring(0,Math.min(d,m)),d<m&&(i=X0(n.substring(d,m)));let p=Z0(n.substring(Math.min(n.length,m)));c=e.indexOf(":"),c>=0?(o=l==="https"||l==="wss",u=parseInt(e.substring(c+1),10)):c=e.length;let y=e.slice(0,c);if(y.toLowerCase()==="localhost")t="localhost";else if(y.split(".").length<=2)t=y;else{let S=e.indexOf(".");r=e.substring(0,S).toLowerCase(),t=e.substring(S+1),s=r}"ns"in p&&(s=p.ns)}return{host:e,port:u,domain:t,subdomain:r,secure:o,scheme:l,pathString:i,namespace:s}};var E_="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",tS=function(){let n=0,e=[];return function(t){let r=t===n;n=t;let i,s=new Array(8);for(i=7;i>=0;i--)s[i]=E_.charAt(t%64),t=Math.floor(t/64);O(t===0,"Cannot push at time == 0");let o=s.join("");if(r){for(i=11;i>=0&&e[i]===63;i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(Math.random()*64);for(i=0;i<12;i++)o+=E_.charAt(e[i]);return O(o.length===20,"nextPushId: Length should be 20."),o}}();var Ja=class{constructor(e,t,r,i){this.eventType=e,this.eventRegistration=t,this.snapshot=r,this.prevName=i}getPath(){let e=this.snapshot.ref;return this.eventType==="value"?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+Pe(this.snapshot.exportVal())}},Xa=class{constructor(e,t,r){this.eventRegistration=e,this.error=t,this.path=r}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}};var Fs=class{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return O(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||this.snapshotCallback.userCallback!==void 0&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}};var Za=class{constructor(e,t){this._repo=e,this._path=t}cancel(){let e=new Ze;return K0(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){ut("OnDisconnect.remove",this._path);let e=new Ze;return w_(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){ut("OnDisconnect.set",this._path),Mt("OnDisconnect.set",e,this._path,!1);let t=new Ze;return w_(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){ut("OnDisconnect.setWithPriority",this._path),Mt("OnDisconnect.setWithPriority",e,this._path,!1),id("OnDisconnect.setWithPriority",t,!1);let r=new Ze;return z0(this._repo,this._path,e,t,r.wrapCallback(()=>{})),r.promise}update(e){ut("OnDisconnect.update",this._path),yy("OnDisconnect.update",e,this._path,!1);let t=new Ze;return W0(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}};var nt=class n{constructor(e,t,r,i){this._repo=e,this._path=t,this._queryParams=r,this._orderByCalled=i}get key(){return X(this._path)?null:Bh(this._path)}get ref(){return new ht(this._repo,this._path)}get _queryIdentifier(){let e=a_(this._queryParams),t=Lh(e);return t==="{}"?"default":t}get _queryObject(){return a_(this._queryParams)}isEqual(e){if(e=ee(e),!(e instanceof n))return!1;let t=this._repo===e._repo,r=qh(this._path,e._path),i=this._queryIdentifier===e._queryIdentifier;return t&&r&&i}toJSON(){return this.toString()}toString(){return this._repo.toString()+lA(this._path)}};function _l(n,e){if(n._orderByCalled===!0)throw new Error(e+": You can't combine multiple orderBy calls.")}function Sn(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===Vt){let r="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==wn)throw new Error(r);if(typeof e!="string")throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==Jt)throw new Error(r);if(typeof t!="string")throw new Error(i)}}else if(n.getIndex()===me){if(e!=null&&!Os(e)||t!=null&&!Os(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if(O(n.getIndex()instanceof Cs||n.getIndex()===Kh,"unknown index type."),e!=null&&typeof e=="object"||t!=null&&typeof t=="object")throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function yl(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}var ht=class n extends nt{constructor(e,t){super(e,t,new xs,!1)}get parent(){let e=K_(this._path);return e===null?null:new n(this._repo,e)}get root(){let e=this;for(;e.parent!==null;)e=e.parent;return e}},Jr=class n{constructor(e,t,r){this._node=e,this.ref=t,this._index=r}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){let t=new ue(e),r=An(this.ref,e);return new n(this._node.getChild(t),r,me)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return this._node.isLeafNode()?!1:!!this._node.forEachChild(this._index,(r,i)=>e(new n(i,An(this.ref,r),me)))}hasChild(e){let t=new ue(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return this._node.isLeafNode()?!1:!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}};function ud(n,e){return n=ee(n),n._checkNotDeleted("ref"),e!==void 0?An(n._root,e):n._root}function cd(n,e){n=ee(n),n._checkNotDeleted("refFromURL");let t=Th(e,n._repo.repoInfo_.nodeAdmin);vy("refFromURL",t);let r=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&r.host!==n._repo.repoInfo_.host&&Ot("refFromURL: Host name does not match the current database: (found "+r.host+" but expected "+n._repo.repoInfo_.host+")"),ud(n,t.path.toString())}function An(n,e){return n=ee(n),J(n._path)===null?F0("child","path",e,!1):ti("child","path",e,!1),new ht(n._repo,ye(n._path,e))}function Ry(n,e){n=ee(n),ut("push",n._path),Mt("push",e,n._path,!0);let t=Ty(n._repo),r=tS(t),i=An(n,r),s=An(n,r),o;return e!=null?o=vl(s,e).then(()=>s):o=Promise.resolve(s),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}function Py(n){return ut("remove",n._path),vl(n,null)}function vl(n,e){n=ee(n),ut("set",n._path),Mt("set",e,n._path,!1);let t=new Ze;return od(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function xy(n,e){n=ee(n),ut("setPriority",n._path),id("setPriority",e,!1);let t=new Ze;return od(n._repo,ye(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}function Ny(n,e,t){if(ut("setWithPriority",n._path),Mt("setWithPriority",e,n._path,!1),id("setWithPriority",t,!1),n.key===".length"||n.key===".keys")throw"setWithPriority failed: "+n.key+" is a read-only object.";let r=new Ze;return od(n._repo,n._path,e,t,r.wrapCallback(()=>{})),r.promise}function Dy(n,e){yy("update",e,n._path,!1);let t=new Ze;return G0(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function ky(n){n=ee(n);let e=new Fs(()=>{}),t=new Ms(e);return q0(n._repo,n,t).then(r=>new Jr(r,new ht(n._repo,n._path),n._queryParams.getIndex()))}var Ms=class n{constructor(e){this.callbackContext=e}respondsTo(e){return e==="value"}createEvent(e,t){let r=t._queryParams.getIndex();return new Ja("value",this,new Jr(e.snapshotNode,new ht(t._repo,t._path),r))}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Xa(this,e,t):null}matches(e){return e instanceof n?!e.callbackContext||!this.callbackContext?!0:e.callbackContext.matches(this.callbackContext):!1}hasAnyCallback(){return this.callbackContext!==null}},el=class n{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t=e==="children_added"?"child_added":e;return t=t==="children_removed"?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new Xa(this,e,t):null}createEvent(e,t){O(e.childName!=null,"Child events should have a childName.");let r=An(new ht(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new Ja(e.type,this,new Jr(e.snapshotNode,r,i),e.prevName)}getEventRunner(e){return e.getEventType()==="cancel"?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof n?this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext)):!1}hasAnyCallback(){return!!this.callbackContext}};function Ws(n,e,t,r,i){let s;if(typeof r=="object"&&(s=void 0,i=r),typeof r=="function"&&(s=r),i&&i.onlyOnce){let u=t,c=(d,m)=>{Ih(n._repo,n,l),u(d,m)};c.userCallback=t.userCallback,c.context=t.context,t=c}let o=new Fs(t,s||void 0),l=e==="value"?new Ms(o):new el(e,o);return Q0(n._repo,n,l),()=>Ih(n._repo,n,l)}function wl(n,e,t,r){return Ws(n,"value",e,t,r)}function hd(n,e,t,r){return Ws(n,"child_added",e,t,r)}function dd(n,e,t,r){return Ws(n,"child_changed",e,t,r)}function fd(n,e,t,r){return Ws(n,"child_moved",e,t,r)}function md(n,e,t,r){return Ws(n,"child_removed",e,t,r)}function pd(n,e,t){let r=null,i=t?new Fs(t):null;e==="value"?r=new Ms(i):e&&(r=new el(e,i)),Ih(n._repo,n,r)}var dt=class{},tl=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){Mt("endAt",this._value,e._path,!0);let t=Zc(e._queryParams,this._value,this._key);if(yl(t),Sn(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function Vy(n,e){return Ks("endAt","key",e,!0),new tl(n,e)}var Ah=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){Mt("endBefore",this._value,e._path,!1);let t=bA(e._queryParams,this._value,this._key);if(yl(t),Sn(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function Oy(n,e){return Ks("endBefore","key",e,!0),new Ah(n,e)}var nl=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){Mt("startAt",this._value,e._path,!0);let t=Xc(e._queryParams,this._value,this._key);if(yl(t),Sn(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function Fy(n=null,e){return Ks("startAt","key",e,!0),new nl(n,e)}var Sh=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){Mt("startAfter",this._value,e._path,!1);let t=CA(e._queryParams,this._value,this._key);if(yl(t),Sn(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new nt(e._repo,e._path,t,e._orderByCalled)}};function My(n,e){return Ks("startAfter","key",e,!0),new Sh(n,e)}var Ch=class extends dt{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new nt(e._repo,e._path,AA(e._queryParams,this._limit),e._orderByCalled)}};function Ly(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new Ch(n)}var bh=class extends dt{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new nt(e._repo,e._path,SA(e._queryParams,this._limit),e._orderByCalled)}};function Uy(n){if(typeof n!="number"||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new bh(n)}var Rh=class extends dt{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){_l(e,"orderByChild");let t=new ue(this._path);if(X(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");let r=new Cs(t),i=il(e._queryParams,r);return Sn(i),new nt(e._repo,e._path,i,!0)}};function By(n){if(n==="$key")throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if(n==="$priority")throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if(n==="$value")throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return ti("orderByChild","path",n,!1),new Rh(n)}var Ph=class extends dt{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){_l(e,"orderByKey");let t=il(e._queryParams,Vt);return Sn(t),new nt(e._repo,e._path,t,!0)}};function qy(){return new Ph}var xh=class extends dt{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){_l(e,"orderByPriority");let t=il(e._queryParams,me);return Sn(t),new nt(e._repo,e._path,t,!0)}};function Gy(){return new xh}var Nh=class extends dt{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){_l(e,"orderByValue");let t=il(e._queryParams,Kh);return Sn(t),new nt(e._repo,e._path,t,!0)}};function jy(){return new Nh}var Dh=class extends dt{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(Mt("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new tl(this._value,this._key)._apply(new nl(this._value,this._key)._apply(e))}};function Ky(n,e){return Ks("equalTo","key",e,!0),new Dh(n,e)}function vt(n,...e){let t=ee(n);for(let r of e)t=r._apply(t);return t}l0(ht);f0(ht);var nS="FIREBASE_DATABASE_EMULATOR_HOST",kh={},rS=!1;function iS(n,e,t,r){n.repoInfo_=new Da(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),r&&(n.authTokenProvider_=r)}function gd(n,e,t,r,i){let s=r||n.options.databaseURL;s===void 0&&(n.options.projectId||Ot("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Ue("Using default host for project ",n.options.projectId),s=`${n.options.projectId}-default-rtdb.firebaseio.com`);let o=Th(s,i),l=o.repoInfo,u,c;typeof process<"u"&&process.env&&(c=process.env[nS]),c?(u=!0,s=`http://${c}?ns=${l.namespace}`,o=Th(s,i),l=o.repoInfo):u=!o.repoInfo.secure;let d=i&&u?new ws(ws.OWNER):new Mc(n.name,n.options,e);vy("Invalid Firebase Database URL",o),X(o.path)||Ot("Database URL must point to the root of a Firebase Database (not including a child path).");let m=oS(l,n,d,new Fc(n.name,t));return new Vh(m,n)}function sS(n,e){let t=kh[e];(!t||t[n.key]!==n)&&Ot(`Database ${e}(${n.repoInfo_}) has already been deleted.`),Ay(n),delete t[n.key]}function oS(n,e,t,r){let i=kh[e.name];i||(i={},kh[e.name]=i);let s=i[n.toURLString()];return s&&Ot("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),s=new Eh(n,rS,t,r),i[n.toURLString()]=s,s}var Vh=class{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(U0(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new ht(this._repo,le())),this._rootInternal}_delete(){return this._rootInternal!==null&&(sS(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){this._rootInternal===null&&Ot("Cannot call "+e+" on a deleted database.")}};function zy(){j_.IS_TRANSPORT_INITIALIZED&&$e("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function Wy(){zy(),As.forceDisallow()}function Qy(){zy(),qr.forceDisallow(),As.forceAllow()}function $y(n,e,t,r={}){n=ee(n),n._checkNotDeleted("useEmulator"),n._instanceStarted&&Ot("Cannot call useEmulator() after instance has already been initialized.");let i=n._repoInternal,s;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&Ot('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),s=new ws(ws.OWNER);else if(r.mockUserToken){let o=typeof r.mockUserToken=="string"?r.mockUserToken:ua(r.mockUserToken,n.app.options.projectId);s=new ws(o)}iS(i,e,t,s)}function Hy(n){n=ee(n),n._checkNotDeleted("goOffline"),Ay(n._repo)}function Yy(n){n=ee(n),n._checkNotDeleted("goOnline"),$0(n._repo)}function Jy(n,e){S_(n,e)}function aS(n){Mh(ma),fa(new Dt("database",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app").getImmediate(),i=e.getProvider("auth-internal"),s=e.getProvider("app-check-internal");return gd(r,i,s,t)},"PUBLIC").setMultipleInstances(!0)),Ur(Kg,zg,n),Ur(Kg,zg,"esm2017")}var lS={".sv":"timestamp"};function Xy(){return lS}function Zy(n){return{".sv":{increment:n}}}var Oh=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}};function ev(n,e,t){var r;if(n=ee(n),ut("Reference.transaction",n._path),n.key===".length"||n.key===".keys")throw"Reference.transaction failed: "+n.key+" is a read-only object.";let i=(r=t?.applyLocally)!==null&&r!==void 0?r:!0,s=new Ze,o=(u,c,d)=>{let m=null;u?s.reject(u):(m=new Jr(d,new ht(n._repo,n._path),me),s.resolve(new Oh(c,m)))},l=wl(n,()=>{});return H0(n._repo,n._path,e,o,l,i),s.promise}Gh.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)};Gh.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)};aS();var uS="@firebase/database-compat",cS="1.0.8";var hS=new Lr("@firebase/database-compat"),tv=function(n){let e="FIREBASE WARNING: "+n;hS.warn(e)};var dS=function(n,e,t,r){if(!(r&&t===void 0)&&typeof t!="boolean")throw new Error(ot(n,e)+"must be a boolean.")},fS=function(n,e,t){if(!(t&&e===void 0))switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error(ot(n,"eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}};var _d=class{constructor(e){this._delegate=e}cancel(e){z("OnDisconnect.cancel",0,1,arguments.length),Ve("OnDisconnect.cancel","onComplete",e,!0);let t=this._delegate.cancel();return e&&t.then(()=>e(null),r=>e(r)),t}remove(e){z("OnDisconnect.remove",0,1,arguments.length),Ve("OnDisconnect.remove","onComplete",e,!0);let t=this._delegate.remove();return e&&t.then(()=>e(null),r=>e(r)),t}set(e,t){z("OnDisconnect.set",1,2,arguments.length),Ve("OnDisconnect.set","onComplete",t,!0);let r=this._delegate.set(e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){z("OnDisconnect.setWithPriority",2,3,arguments.length),Ve("OnDisconnect.setWithPriority","onComplete",r,!0);let i=this._delegate.setWithPriority(e,t);return r&&i.then(()=>r(null),s=>r(s)),i}update(e,t){if(z("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,tv("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}Ve("OnDisconnect.update","onComplete",t,!0);let r=this._delegate.update(e);return t&&r.then(()=>t(null),i=>t(i)),r}};var yd=class{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return z("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}};var ir=class n{constructor(e,t){this._database=e,this._delegate=t}val(){return z("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return z("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return z("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return z("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return z("DataSnapshot.child",0,1,arguments.length),e=String(e),ti("DataSnapshot.child","path",e,!1),new n(this._database,this._delegate.child(e))}hasChild(e){return z("DataSnapshot.hasChild",1,1,arguments.length),ti("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return z("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return z("DataSnapshot.forEach",1,1,arguments.length),Ve("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new n(this._database,t)))}hasChildren(){return z("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return z("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return z("DataSnapshot.ref",0,0,arguments.length),new Xt(this._database,this._delegate.ref)}get ref(){return this.getRef()}},El=class n{constructor(e,t){this.database=e,this._delegate=t}on(e,t,r,i){var s;z("Query.on",2,4,arguments.length),Ve("Query.on","callback",t,!1);let o=n.getCancelAndContextArgs_("Query.on",r,i),l=(c,d)=>{t.call(o.context,new ir(this.database,c),d)};l.userCallback=t,l.context=o.context;let u=(s=o.cancel)===null||s===void 0?void 0:s.bind(o.context);switch(e){case"value":return wl(this._delegate,l,u),t;case"child_added":return hd(this._delegate,l,u),t;case"child_removed":return md(this._delegate,l,u),t;case"child_changed":return dd(this._delegate,l,u),t;case"child_moved":return fd(this._delegate,l,u),t;default:throw new Error(ot("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,r){if(z("Query.off",0,3,arguments.length),fS("Query.off",e,!0),Ve("Query.off","callback",t,!0),Tc("Query.off","context",r,!0),t){let i=()=>{};i.userCallback=t,i.context=r,pd(this._delegate,e,i)}else pd(this._delegate,e)}get(){return ky(this._delegate).then(e=>new ir(this.database,e))}once(e,t,r,i){z("Query.once",1,4,arguments.length),Ve("Query.once","callback",t,!0);let s=n.getCancelAndContextArgs_("Query.once",r,i),o=new Ze,l=(c,d)=>{let m=new ir(this.database,c);t&&t.call(s.context,m,d),o.resolve(m)};l.userCallback=t,l.context=s.context;let u=c=>{s.cancel&&s.cancel.call(s.context,c),o.reject(c)};switch(e){case"value":wl(this._delegate,l,u,{onlyOnce:!0});break;case"child_added":hd(this._delegate,l,u,{onlyOnce:!0});break;case"child_removed":md(this._delegate,l,u,{onlyOnce:!0});break;case"child_changed":dd(this._delegate,l,u,{onlyOnce:!0});break;case"child_moved":fd(this._delegate,l,u,{onlyOnce:!0});break;default:throw new Error(ot("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return z("Query.limitToFirst",1,1,arguments.length),new n(this.database,vt(this._delegate,Ly(e)))}limitToLast(e){return z("Query.limitToLast",1,1,arguments.length),new n(this.database,vt(this._delegate,Uy(e)))}orderByChild(e){return z("Query.orderByChild",1,1,arguments.length),new n(this.database,vt(this._delegate,By(e)))}orderByKey(){return z("Query.orderByKey",0,0,arguments.length),new n(this.database,vt(this._delegate,qy()))}orderByPriority(){return z("Query.orderByPriority",0,0,arguments.length),new n(this.database,vt(this._delegate,Gy()))}orderByValue(){return z("Query.orderByValue",0,0,arguments.length),new n(this.database,vt(this._delegate,jy()))}startAt(e=null,t){return z("Query.startAt",0,2,arguments.length),new n(this.database,vt(this._delegate,Fy(e,t)))}startAfter(e=null,t){return z("Query.startAfter",0,2,arguments.length),new n(this.database,vt(this._delegate,My(e,t)))}endAt(e=null,t){return z("Query.endAt",0,2,arguments.length),new n(this.database,vt(this._delegate,Vy(e,t)))}endBefore(e=null,t){return z("Query.endBefore",0,2,arguments.length),new n(this.database,vt(this._delegate,Oy(e,t)))}equalTo(e,t){return z("Query.equalTo",1,2,arguments.length),new n(this.database,vt(this._delegate,Ky(e,t)))}toString(){return z("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return z("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if(z("Query.isEqual",1,1,arguments.length),!(e instanceof n)){let t="Query.isEqual failed: First argument must be an instance of firebase.database.Query.";throw new Error(t)}return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,r){let i={cancel:void 0,context:void 0};if(t&&r)i.cancel=t,Ve(e,"cancel",i.cancel,!0),i.context=r,Tc(e,"context",i.context,!0);else if(t)if(typeof t=="object"&&t!==null)i.context=t;else if(typeof t=="function")i.cancel=t;else throw new Error(ot(e,"cancelOrContext")+" must either be a cancel callback or a context object.");return i}get ref(){return new Xt(this.database,new ht(this._delegate._repo,this._delegate._path))}},Xt=class n extends El{constructor(e,t){super(e,new nt(t._repo,t._path,new xs,!1)),this.database=e,this._delegate=t}getKey(){return z("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return z("Reference.child",1,1,arguments.length),typeof e=="number"&&(e=String(e)),new n(this.database,An(this._delegate,e))}getParent(){z("Reference.parent",0,0,arguments.length);let e=this._delegate.parent;return e?new n(this.database,e):null}getRoot(){return z("Reference.root",0,0,arguments.length),new n(this.database,this._delegate.root)}set(e,t){z("Reference.set",1,2,arguments.length),Ve("Reference.set","onComplete",t,!0);let r=vl(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}update(e,t){if(z("Reference.update",1,2,arguments.length),Array.isArray(e)){let i={};for(let s=0;s<e.length;++s)i[""+s]=e[s];e=i,tv("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}ut("Reference.update",this._delegate._path),Ve("Reference.update","onComplete",t,!0);let r=Dy(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}setWithPriority(e,t,r){z("Reference.setWithPriority",2,3,arguments.length),Ve("Reference.setWithPriority","onComplete",r,!0);let i=Ny(this._delegate,e,t);return r&&i.then(()=>r(null),s=>r(s)),i}remove(e){z("Reference.remove",0,1,arguments.length),Ve("Reference.remove","onComplete",e,!0);let t=Py(this._delegate);return e&&t.then(()=>e(null),r=>e(r)),t}transaction(e,t,r){z("Reference.transaction",1,3,arguments.length),Ve("Reference.transaction","transactionUpdate",e,!1),Ve("Reference.transaction","onComplete",t,!0),dS("Reference.transaction","applyLocally",r,!0);let i=ev(this._delegate,e,{applyLocally:r}).then(s=>new yd(s.committed,new ir(this.database,s.snapshot)));return t&&i.then(s=>t(null,s.committed,s.snapshot),s=>t(s,!1,null)),i}setPriority(e,t){z("Reference.setPriority",1,2,arguments.length),Ve("Reference.setPriority","onComplete",t,!0);let r=xy(this._delegate,e);return t&&r.then(()=>t(null),i=>t(i)),r}push(e,t){z("Reference.push",0,2,arguments.length),Ve("Reference.push","onComplete",t,!0);let r=Ry(this._delegate,e),i=r.then(o=>new n(this.database,o));t&&i.then(()=>t(null),o=>t(o));let s=new n(this.database,r);return s.then=i.then.bind(i),s.catch=i.catch.bind(i,void 0),s}onDisconnect(){return ut("Reference.onDisconnect",this._delegate._path),new _d(new Za(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}};var sr=class{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:Wy,forceLongPolling:Qy}}useEmulator(e,t,r={}){$y(this._delegate,e,t,r)}ref(e){if(z("database.ref",0,1,arguments.length),e instanceof Xt){let t=cd(this._delegate,e.toString());return new Xt(this,t)}else{let t=ud(this._delegate,e);return new Xt(this,t)}}refFromURL(e){z("database.refFromURL",1,1,arguments.length);let r=cd(this._delegate,e);return new Xt(this,r)}goOffline(){return z("database.goOffline",0,0,arguments.length),Hy(this._delegate)}goOnline(){return z("database.goOnline",0,0,arguments.length),Yy(this._delegate)}};sr.ServerValue={TIMESTAMP:Xy(),increment:n=>Zy(n)};function mS({app:n,url:e,version:t,customAuthImpl:r,customAppCheckImpl:i,namespace:s,nodeAdmin:o=!1}){Mh(t);let l=new Ac("database-standalone"),u=new da("auth-internal",l);u.setComponent(new Dt("auth-internal",()=>r,"PRIVATE"));let c;return i&&(c=new da("app-check-internal",l),c.setComponent(new Dt("app-check-internal",()=>i,"PRIVATE"))),{instance:new sr(gd(n,u,c,e,o),n),namespace:s}}var pS=Object.freeze({__proto__:null,initStandalone:mS});var gS=sr.ServerValue;function _S(n){n.INTERNAL.registerComponent(new Dt("database-compat",(e,{instanceIdentifier:t})=>{let r=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new sr(i,r)},"PUBLIC").setServiceProps({Reference:Xt,Query:El,Database:sr,DataSnapshot:ir,enableLogging:Jy,INTERNAL:pS,ServerValue:gS}).setMultipleInstances(!0)),n.registerVersion(uS,cS)}_S(gn);function Qs(n,e,t="on",r=ea){return new Zo(i=>{let s=null;return s=n[t](e,(o,l)=>{r.schedule(()=>{i.next({snapshot:o,prevKey:l})}),t==="once"&&r.schedule(()=>i.complete())},o=>{r.schedule(()=>i.error(o))}),t==="on"?{unsubscribe(){s!=null&&n.off(e,s)}}:{unsubscribe(){}}}).pipe(Le(i=>{let{snapshot:s,prevKey:o}=i,l=null;return s.exists()&&(l=s.key),{type:e,payload:s,prevKey:o,key:l}}),Rg())}function IS(n){return typeof n=="string"}function TS(n){return typeof n.exportVal=="function"}function ov(n){return n==null}function av(n){return typeof n.set=="function"}function nv(n,e){return av(e)?e:n.ref(e)}function lv(n,e){if(IS(n))return e.stringCase();if(av(n))return e.firebaseCase();if(TS(n))return e.snapshotCase();throw new Error(`Expects a string, snapshot, or reference. Got: ${typeof n}`)}function uv(n){return(ov(n)||n.length===0)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function cv(n,e,t){e=uv(e);let r=e.map(i=>Qs(n,i,"on",t));return yc(...r)}function AS(n,e,t){let r=cv(n,e).pipe(Yn((i,s)=>[...i,s],[]));return CS(n,r,t)}function SS(n,e){return Qs(n,"value","on",e).pipe(Le(t=>{let r;return t.payload.forEach(i=>(r=i.key,!1)),{data:t,lastKeyToLoad:r}}))}function CS(n,e,t){return SS(n,t).pipe(Ng(e),Le(([i,s])=>{let o=i.lastKeyToLoad,l=s.map(u=>u.key);return{actions:s,lastKeyToLoad:o,loadedKeys:l}}),Pg(i=>i.loadedKeys.indexOf(i.lastKeyToLoad)===-1),Le(i=>i.actions))}function rv(n,e){return function(r,i){return lv(r,{stringCase:()=>n.child(r)[e](i),firebaseCase:()=>r[e](i),snapshotCase:()=>r.ref[e](i)})}}function bS(n){return function(t){return t?lv(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function RS(n,e,t){return Qs(n,"value","once",t).pipe(xg(r=>{let i=[hs(r)];return e.forEach(s=>i.push(Qs(n,s,"on",t))),yc(...i).pipe(Yn(xS,[]))}),ta())}function hv(n,e){let t=n.length;for(let r=0;r<t;r++)if(n[r].payload.key===e)return r;return-1}function PS(n,e){if(ov(e))return 0;{let t=hv(n,e);return t===-1?n.length:t+1}}function xS(n,e){let{payload:t,prevKey:r,key:i}=e,s=hv(n,i),o=PS(n,r);switch(e.type){case"value":if(e.payload?.exists()){let l=null;e.payload.forEach(u=>{let c={payload:u,type:"value",prevKey:l,key:u.key};return l=u.key,n=[...n,c],!1})}return n;case"child_added":if(s>-1)(n[s-1]?.key||null)!==r&&(n=n.filter(u=>u.payload.key!==t.key),n.splice(o,0,e));else{if(r==null)return[e,...n];n=n.slice(),n.splice(o,0,e)}return n;case"child_removed":return n.filter(l=>l.payload.key!==t.key);case"child_changed":return n.map(l=>l.payload.key===i?e:l);case"child_moved":if(s>-1){let l=n.splice(s,1)[0];return n=n.slice(),n.splice(o,0,l),n}return n;default:return n}}function iv(n,e,t){return e=uv(e),RS(n,e,t)}function NS(n,e){let t=e.schedulers.outsideAngular,r=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:rv(r,"update"),set:rv(r,"set"),push:i=>r.push(i),remove:bS(r),snapshotChanges(i){return iv(n,i,t).pipe(Oe)},stateChanges(i){return cv(n,i,t).pipe(Oe)},auditTrail(i){return AS(n,i,t).pipe(Oe)},valueChanges(i,s){return iv(n,i,t).pipe(Le(l=>l.map(u=>s&&s.idField?us(Fr({},u.payload.val()),{[s.idField]:u.key}):u.payload.val())),Oe)}}}function sv(n,e){return function(){return Qs(n,"value","on",e)}}function DS(n,e){return{query:n,snapshotChanges(){return sv(n,e.schedulers.outsideAngular)().pipe(Oe)},update(t){return n.ref.update(t)},set(t){return n.ref.set(t)},remove(){return n.ref.remove()},valueChanges(){return sv(n,e.schedulers.outsideAngular)().pipe(Oe,Le(r=>r.payload.exists()?r.payload.val():null))}}}var kS=new mn("angularfire2.realtimeDatabaseURL"),VS=new mn("angularfire2.database.use-emulator"),OS=(()=>{class n{schedulers;database;constructor(t,r,i,s,o,l,u,c,d,m,p,y,S,x,D){this.schedulers=l;let q=u,j=wa(t,o,r);c&&Ra(j,o,d,p,y,S,m,x),this.database=Ea(`${j.name}.database.${i}`,"AngularFireDatabase",j.name,()=>{let B=o.runOutsideAngular(()=>j.database(i||void 0));return q&&B.useEmulator(...q),B},[q])}list(t,r){let i=this.schedulers.ngZone.runOutsideAngular(()=>nv(this.database,t)),s=i;return r&&(s=r(i)),NS(s,this)}object(t){let r=this.schedulers.ngZone.runOutsideAngular(()=>nv(this.database,t));return DS(r,this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}static \u0275fac=function(r){return new(r||n)(re(ya),re(va,8),re(kS,8),re(aa),re(la),re(_a),re(VS,8),re(Pa,8),re(Ia,8),re(Ta,8),re(Aa,8),re(Sa,8),re(Ca,8),re(ba,8),re(ga,8))};static \u0275prov=ia({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),yR=(()=>{class n{constructor(){gn.registerVersion("angularfire",pa.full,"rtdb-compat")}static \u0275fac=function(r){return new(r||n)};static \u0275mod=oa({type:n});static \u0275inj=sa({providers:[OS]})}return n})();var dv=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},fv={};var Cn,vd;(function(){var n;function e(E,_){function w(){}w.prototype=_.prototype,E.D=_.prototype,E.prototype=new w,E.prototype.constructor=E,E.C=function(I,T,C){for(var v=Array(arguments.length-2),$t=2;$t<arguments.length;$t++)v[$t-2]=arguments[$t];return _.prototype[T].apply(I,v)}}function t(){this.blockSize=-1}function r(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(r,t),r.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,_,w){w||(w=0);var I=Array(16);if(typeof _=="string")for(var T=0;16>T;++T)I[T]=_.charCodeAt(w++)|_.charCodeAt(w++)<<8|_.charCodeAt(w++)<<16|_.charCodeAt(w++)<<24;else for(T=0;16>T;++T)I[T]=_[w++]|_[w++]<<8|_[w++]<<16|_[w++]<<24;_=E.g[0],w=E.g[1],T=E.g[2];var C=E.g[3],v=_+(C^w&(T^C))+I[0]+3614090360&4294967295;_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[1]+3905402710&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[2]+606105819&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[3]+3250441966&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[4]+4118548399&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[5]+1200080426&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[6]+2821735955&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[7]+4249261313&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[8]+1770035416&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[9]+2336552879&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[10]+4294925233&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[11]+2304563134&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(C^w&(T^C))+I[12]+1804603682&4294967295,_=w+(v<<7&4294967295|v>>>25),v=C+(T^_&(w^T))+I[13]+4254626195&4294967295,C=_+(v<<12&4294967295|v>>>20),v=T+(w^C&(_^w))+I[14]+2792965006&4294967295,T=C+(v<<17&4294967295|v>>>15),v=w+(_^T&(C^_))+I[15]+1236535329&4294967295,w=T+(v<<22&4294967295|v>>>10),v=_+(T^C&(w^T))+I[1]+4129170786&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[6]+3225465664&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[11]+643717713&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[0]+3921069994&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[5]+3593408605&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[10]+38016083&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[15]+3634488961&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[4]+3889429448&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[9]+568446438&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[14]+3275163606&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[3]+4107603335&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[8]+1163531501&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(T^C&(w^T))+I[13]+2850285829&4294967295,_=w+(v<<5&4294967295|v>>>27),v=C+(w^T&(_^w))+I[2]+4243563512&4294967295,C=_+(v<<9&4294967295|v>>>23),v=T+(_^w&(C^_))+I[7]+1735328473&4294967295,T=C+(v<<14&4294967295|v>>>18),v=w+(C^_&(T^C))+I[12]+2368359562&4294967295,w=T+(v<<20&4294967295|v>>>12),v=_+(w^T^C)+I[5]+4294588738&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[8]+2272392833&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[11]+1839030562&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[14]+4259657740&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[1]+2763975236&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[4]+1272893353&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[7]+4139469664&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[10]+3200236656&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[13]+681279174&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[0]+3936430074&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[3]+3572445317&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[6]+76029189&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(w^T^C)+I[9]+3654602809&4294967295,_=w+(v<<4&4294967295|v>>>28),v=C+(_^w^T)+I[12]+3873151461&4294967295,C=_+(v<<11&4294967295|v>>>21),v=T+(C^_^w)+I[15]+530742520&4294967295,T=C+(v<<16&4294967295|v>>>16),v=w+(T^C^_)+I[2]+3299628645&4294967295,w=T+(v<<23&4294967295|v>>>9),v=_+(T^(w|~C))+I[0]+4096336452&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[7]+1126891415&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[14]+2878612391&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[5]+4237533241&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[12]+1700485571&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[3]+2399980690&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[10]+4293915773&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[1]+2240044497&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[8]+1873313359&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[15]+4264355552&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[6]+2734768916&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[13]+1309151649&4294967295,w=T+(v<<21&4294967295|v>>>11),v=_+(T^(w|~C))+I[4]+4149444226&4294967295,_=w+(v<<6&4294967295|v>>>26),v=C+(w^(_|~T))+I[11]+3174756917&4294967295,C=_+(v<<10&4294967295|v>>>22),v=T+(_^(C|~w))+I[2]+718787259&4294967295,T=C+(v<<15&4294967295|v>>>17),v=w+(C^(T|~_))+I[9]+3951481745&4294967295,E.g[0]=E.g[0]+_&4294967295,E.g[1]=E.g[1]+(T+(v<<21&4294967295|v>>>11))&4294967295,E.g[2]=E.g[2]+T&4294967295,E.g[3]=E.g[3]+C&4294967295}r.prototype.u=function(E,_){_===void 0&&(_=E.length);for(var w=_-this.blockSize,I=this.B,T=this.h,C=0;C<_;){if(T==0)for(;C<=w;)i(this,E,C),C+=this.blockSize;if(typeof E=="string"){for(;C<_;)if(I[T++]=E.charCodeAt(C++),T==this.blockSize){i(this,I),T=0;break}}else for(;C<_;)if(I[T++]=E[C++],T==this.blockSize){i(this,I),T=0;break}}this.h=T,this.o+=_},r.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var _=1;_<E.length-8;++_)E[_]=0;var w=8*this.o;for(_=E.length-8;_<E.length;++_)E[_]=w&255,w/=256;for(this.u(E),E=Array(16),_=w=0;4>_;++_)for(var I=0;32>I;I+=8)E[w++]=this.g[_]>>>I&255;return E};function s(E,_){var w=l;return Object.prototype.hasOwnProperty.call(w,E)?w[E]:w[E]=_(E)}function o(E,_){this.h=_;for(var w=[],I=!0,T=E.length-1;0<=T;T--){var C=E[T]|0;I&&C==_||(w[T]=C,I=!1)}this.g=w}var l={};function u(E){return-128<=E&&128>E?s(E,function(_){return new o([_|0],0>_?-1:0)}):new o([E|0],0>E?-1:0)}function c(E){if(isNaN(E)||!isFinite(E))return m;if(0>E)return D(c(-E));for(var _=[],w=1,I=0;E>=w;I++)_[I]=E/w|0,w*=4294967296;return new o(_,0)}function d(E,_){if(E.length==0)throw Error("number format error: empty string");if(_=_||10,2>_||36<_)throw Error("radix out of range: "+_);if(E.charAt(0)=="-")return D(d(E.substring(1),_));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var w=c(Math.pow(_,8)),I=m,T=0;T<E.length;T+=8){var C=Math.min(8,E.length-T),v=parseInt(E.substring(T,T+C),_);8>C?(C=c(Math.pow(_,C)),I=I.j(C).add(c(v))):(I=I.j(w),I=I.add(c(v)))}return I}var m=u(0),p=u(1),y=u(16777216);n=o.prototype,n.m=function(){if(x(this))return-D(this).m();for(var E=0,_=1,w=0;w<this.g.length;w++){var I=this.i(w);E+=(0<=I?I:4294967296+I)*_,_*=4294967296}return E},n.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(S(this))return"0";if(x(this))return"-"+D(this).toString(E);for(var _=c(Math.pow(E,6)),w=this,I="";;){var T=Y(w,_).g;w=q(w,T.j(_));var C=((0<w.g.length?w.g[0]:w.h)>>>0).toString(E);if(w=T,S(w))return C+I;for(;6>C.length;)C="0"+C;I=C+I}},n.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function S(E){if(E.h!=0)return!1;for(var _=0;_<E.g.length;_++)if(E.g[_]!=0)return!1;return!0}function x(E){return E.h==-1}n.l=function(E){return E=q(this,E),x(E)?-1:S(E)?0:1};function D(E){for(var _=E.g.length,w=[],I=0;I<_;I++)w[I]=~E.g[I];return new o(w,~E.h).add(p)}n.abs=function(){return x(this)?D(this):this},n.add=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0,T=0;T<=_;T++){var C=I+(this.i(T)&65535)+(E.i(T)&65535),v=(C>>>16)+(this.i(T)>>>16)+(E.i(T)>>>16);I=v>>>16,C&=65535,v&=65535,w[T]=v<<16|C}return new o(w,w[w.length-1]&-2147483648?-1:0)};function q(E,_){return E.add(D(_))}n.j=function(E){if(S(this)||S(E))return m;if(x(this))return x(E)?D(this).j(D(E)):D(D(this).j(E));if(x(E))return D(this.j(D(E)));if(0>this.l(y)&&0>E.l(y))return c(this.m()*E.m());for(var _=this.g.length+E.g.length,w=[],I=0;I<2*_;I++)w[I]=0;for(I=0;I<this.g.length;I++)for(var T=0;T<E.g.length;T++){var C=this.i(I)>>>16,v=this.i(I)&65535,$t=E.i(T)>>>16,Ki=E.i(T)&65535;w[2*I+2*T]+=v*Ki,j(w,2*I+2*T),w[2*I+2*T+1]+=C*Ki,j(w,2*I+2*T+1),w[2*I+2*T+1]+=v*$t,j(w,2*I+2*T+1),w[2*I+2*T+2]+=C*$t,j(w,2*I+2*T+2)}for(I=0;I<_;I++)w[I]=w[2*I+1]<<16|w[2*I];for(I=_;I<2*_;I++)w[I]=0;return new o(w,0)};function j(E,_){for(;(E[_]&65535)!=E[_];)E[_+1]+=E[_]>>>16,E[_]&=65535,_++}function B(E,_){this.g=E,this.h=_}function Y(E,_){if(S(_))throw Error("division by zero");if(S(E))return new B(m,m);if(x(E))return _=Y(D(E),_),new B(D(_.g),D(_.h));if(x(_))return _=Y(E,D(_)),new B(D(_.g),_.h);if(30<E.g.length){if(x(E)||x(_))throw Error("slowDivide_ only works with positive integers.");for(var w=p,I=_;0>=I.l(E);)w=ne(w),I=ne(I);var T=Q(w,1),C=Q(I,1);for(I=Q(I,2),w=Q(w,2);!S(I);){var v=C.add(I);0>=v.l(E)&&(T=T.add(w),C=v),I=Q(I,1),w=Q(w,1)}return _=q(E,T.j(_)),new B(T,_)}for(T=m;0<=E.l(_);){for(w=Math.max(1,Math.floor(E.m()/_.m())),I=Math.ceil(Math.log(w)/Math.LN2),I=48>=I?1:Math.pow(2,I-48),C=c(w),v=C.j(_);x(v)||0<v.l(E);)w-=I,C=c(w),v=C.j(_);S(C)&&(C=p),T=T.add(C),E=q(E,v)}return new B(T,E)}n.A=function(E){return Y(this,E).h},n.and=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)&E.i(I);return new o(w,this.h&E.h)},n.or=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)|E.i(I);return new o(w,this.h|E.h)},n.xor=function(E){for(var _=Math.max(this.g.length,E.g.length),w=[],I=0;I<_;I++)w[I]=this.i(I)^E.i(I);return new o(w,this.h^E.h)};function ne(E){for(var _=E.g.length+1,w=[],I=0;I<_;I++)w[I]=E.i(I)<<1|E.i(I-1)>>>31;return new o(w,E.h)}function Q(E,_){var w=_>>5;_%=32;for(var I=E.g.length-w,T=[],C=0;C<I;C++)T[C]=0<_?E.i(C+w)>>>_|E.i(C+w+1)<<32-_:E.i(C+w);return new o(T,E.h)}r.prototype.digest=r.prototype.v,r.prototype.reset=r.prototype.s,r.prototype.update=r.prototype.u,vd=fv.Md5=r,o.prototype.add=o.prototype.add,o.prototype.multiply=o.prototype.j,o.prototype.modulo=o.prototype.A,o.prototype.compare=o.prototype.l,o.prototype.toNumber=o.prototype.m,o.prototype.toString=o.prototype.toString,o.prototype.getBits=o.prototype.i,o.fromNumber=c,o.fromString=d,Cn=fv.Integer=o}).apply(typeof dv<"u"?dv:typeof self<"u"?self:typeof window<"u"?window:{});var Il=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Zt={};var wd,FS,ri,Ed,$s,Tl,Id,Td,Ad;(function(){var n,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,h,f){return a==Array.prototype||a==Object.prototype||(a[h]=f.value),a};function t(a){a=[typeof globalThis=="object"&&globalThis,a,typeof window=="object"&&window,typeof self=="object"&&self,typeof Il=="object"&&Il];for(var h=0;h<a.length;++h){var f=a[h];if(f&&f.Math==Math)return f}throw Error("Cannot find global object")}var r=t(this);function i(a,h){if(h)e:{var f=r;a=a.split(".");for(var g=0;g<a.length-1;g++){var A=a[g];if(!(A in f))break e;f=f[A]}a=a[a.length-1],g=f[a],h=h(g),h!=g&&h!=null&&e(f,a,{configurable:!0,writable:!0,value:h})}}function s(a,h){a instanceof String&&(a+="");var f=0,g=!1,A={next:function(){if(!g&&f<a.length){var R=f++;return{value:h(R,a[R]),done:!1}}return g=!0,{done:!0,value:void 0}}};return A[Symbol.iterator]=function(){return A},A}i("Array.prototype.values",function(a){return a||function(){return s(this,function(h,f){return f})}});var o=o||{},l=this||self;function u(a){var h=typeof a;return h=h!="object"?h:a?Array.isArray(a)?"array":h:"null",h=="array"||h=="object"&&typeof a.length=="number"}function c(a){var h=typeof a;return h=="object"&&a!=null||h=="function"}function d(a,h,f){return a.call.apply(a.bind,arguments)}function m(a,h,f){if(!a)throw Error();if(2<arguments.length){var g=Array.prototype.slice.call(arguments,2);return function(){var A=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(A,g),a.apply(h,A)}}return function(){return a.apply(h,arguments)}}function p(a,h,f){return p=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?d:m,p.apply(null,arguments)}function y(a,h){var f=Array.prototype.slice.call(arguments,1);return function(){var g=f.slice();return g.push.apply(g,arguments),a.apply(this,g)}}function S(a,h){function f(){}f.prototype=h.prototype,a.aa=h.prototype,a.prototype=new f,a.prototype.constructor=a,a.Qb=function(g,A,R){for(var F=Array(arguments.length-2),he=2;he<arguments.length;he++)F[he-2]=arguments[he];return h.prototype[A].apply(g,F)}}function x(a){let h=a.length;if(0<h){let f=Array(h);for(let g=0;g<h;g++)f[g]=a[g];return f}return[]}function D(a,h){for(let f=1;f<arguments.length;f++){let g=arguments[f];if(u(g)){let A=a.length||0,R=g.length||0;a.length=A+R;for(let F=0;F<R;F++)a[A+F]=g[F]}else a.push(g)}}class q{constructor(h,f){this.i=h,this.j=f,this.h=0,this.g=null}get(){let h;return 0<this.h?(this.h--,h=this.g,this.g=h.next,h.next=null):h=this.i(),h}}function j(a){return/^[\s\xa0]*$/.test(a)}function B(){var a=l.navigator;return a&&(a=a.userAgent)?a:""}function Y(a){return Y[" "](a),a}Y[" "]=function(){};var ne=B().indexOf("Gecko")!=-1&&!(B().toLowerCase().indexOf("webkit")!=-1&&B().indexOf("Edge")==-1)&&!(B().indexOf("Trident")!=-1||B().indexOf("MSIE")!=-1)&&B().indexOf("Edge")==-1;function Q(a,h,f){for(let g in a)h.call(f,a[g],g,a)}function E(a,h){for(let f in a)h.call(void 0,a[f],f,a)}function _(a){let h={};for(let f in a)h[f]=a[f];return h}let w="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function I(a,h){let f,g;for(let A=1;A<arguments.length;A++){g=arguments[A];for(f in g)a[f]=g[f];for(let R=0;R<w.length;R++)f=w[R],Object.prototype.hasOwnProperty.call(g,f)&&(a[f]=g[f])}}function T(a){var h=1;a=a.split(":");let f=[];for(;0<h&&a.length;)f.push(a.shift()),h--;return a.length&&f.push(a.join(":")),f}function C(a){l.setTimeout(()=>{throw a},0)}function v(){var a=Wu;let h=null;return a.g&&(h=a.g,a.g=a.g.next,a.g||(a.h=null),h.next=null),h}class $t{constructor(){this.h=this.g=null}add(h,f){let g=Ki.get();g.set(h,f),this.h?this.h.next=g:this.g=g,this.h=g}}var Ki=new q(()=>new QI,a=>a.reset());class QI{constructor(){this.next=this.g=this.h=null}set(h,f){this.h=h,this.g=f,this.next=null}reset(){this.next=this.g=this.h=null}}let zi,Wi=!1,Wu=new $t,bp=()=>{let a=l.Promise.resolve(void 0);zi=()=>{a.then($I)}};var $I=()=>{for(var a;a=v();){try{a.h.call(a.g)}catch(f){C(f)}var h=Ki;h.j(a),100>h.h&&(h.h++,a.next=h.g,h.g=a)}Wi=!1};function cn(){this.s=this.s,this.C=this.C}cn.prototype.s=!1,cn.prototype.ma=function(){this.s||(this.s=!0,this.N())},cn.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function Ke(a,h){this.type=a,this.g=this.target=h,this.defaultPrevented=!1}Ke.prototype.h=function(){this.defaultPrevented=!0};var HI=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var a=!1,h=Object.defineProperty({},"passive",{get:function(){a=!0}});try{let f=()=>{};l.addEventListener("test",f,h),l.removeEventListener("test",f,h)}catch{}return a}();function Qi(a,h){if(Ke.call(this,a?a.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,a){var f=this.type=a.type,g=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.g=h,h=a.relatedTarget){if(ne){e:{try{Y(h.nodeName);var A=!0;break e}catch{}A=!1}A||(h=null)}}else f=="mouseover"?h=a.fromElement:f=="mouseout"&&(h=a.toElement);this.relatedTarget=h,g?(this.clientX=g.clientX!==void 0?g.clientX:g.pageX,this.clientY=g.clientY!==void 0?g.clientY:g.pageY,this.screenX=g.screenX||0,this.screenY=g.screenY||0):(this.clientX=a.clientX!==void 0?a.clientX:a.pageX,this.clientY=a.clientY!==void 0?a.clientY:a.pageY,this.screenX=a.screenX||0,this.screenY=a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType=typeof a.pointerType=="string"?a.pointerType:YI[a.pointerType]||"",this.state=a.state,this.i=a,a.defaultPrevented&&Qi.aa.h.call(this)}}S(Qi,Ke);var YI={2:"touch",3:"pen",4:"mouse"};Qi.prototype.h=function(){Qi.aa.h.call(this);var a=this.i;a.preventDefault?a.preventDefault():a.returnValue=!1};var $i="closure_listenable_"+(1e6*Math.random()|0),JI=0;function XI(a,h,f,g,A){this.listener=a,this.proxy=null,this.src=h,this.type=f,this.capture=!!g,this.ha=A,this.key=++JI,this.da=this.fa=!1}function Fo(a){a.da=!0,a.listener=null,a.proxy=null,a.src=null,a.ha=null}function Mo(a){this.src=a,this.g={},this.h=0}Mo.prototype.add=function(a,h,f,g,A){var R=a.toString();a=this.g[R],a||(a=this.g[R]=[],this.h++);var F=$u(a,h,g,A);return-1<F?(h=a[F],f||(h.fa=!1)):(h=new XI(h,this.src,R,!!g,A),h.fa=f,a.push(h)),h};function Qu(a,h){var f=h.type;if(f in a.g){var g=a.g[f],A=Array.prototype.indexOf.call(g,h,void 0),R;(R=0<=A)&&Array.prototype.splice.call(g,A,1),R&&(Fo(h),a.g[f].length==0&&(delete a.g[f],a.h--))}}function $u(a,h,f,g){for(var A=0;A<a.length;++A){var R=a[A];if(!R.da&&R.listener==h&&R.capture==!!f&&R.ha==g)return A}return-1}var Hu="closure_lm_"+(1e6*Math.random()|0),Yu={};function Rp(a,h,f,g,A){if(g&&g.once)return xp(a,h,f,g,A);if(Array.isArray(h)){for(var R=0;R<h.length;R++)Rp(a,h[R],f,g,A);return null}return f=ec(f),a&&a[$i]?a.K(h,f,c(g)?!!g.capture:!!g,A):Pp(a,h,f,!1,g,A)}function Pp(a,h,f,g,A,R){if(!h)throw Error("Invalid event type");var F=c(A)?!!A.capture:!!A,he=Xu(a);if(he||(a[Hu]=he=new Mo(a)),f=he.add(h,f,g,F,R),f.proxy)return f;if(g=ZI(),f.proxy=g,g.src=a,g.listener=f,a.addEventListener)HI||(A=F),A===void 0&&(A=!1),a.addEventListener(h.toString(),g,A);else if(a.attachEvent)a.attachEvent(Dp(h.toString()),g);else if(a.addListener&&a.removeListener)a.addListener(g);else throw Error("addEventListener and attachEvent are unavailable.");return f}function ZI(){function a(f){return h.call(a.src,a.listener,f)}let h=eT;return a}function xp(a,h,f,g,A){if(Array.isArray(h)){for(var R=0;R<h.length;R++)xp(a,h[R],f,g,A);return null}return f=ec(f),a&&a[$i]?a.L(h,f,c(g)?!!g.capture:!!g,A):Pp(a,h,f,!0,g,A)}function Np(a,h,f,g,A){if(Array.isArray(h))for(var R=0;R<h.length;R++)Np(a,h[R],f,g,A);else g=c(g)?!!g.capture:!!g,f=ec(f),a&&a[$i]?(a=a.i,h=String(h).toString(),h in a.g&&(R=a.g[h],f=$u(R,f,g,A),-1<f&&(Fo(R[f]),Array.prototype.splice.call(R,f,1),R.length==0&&(delete a.g[h],a.h--)))):a&&(a=Xu(a))&&(h=a.g[h.toString()],a=-1,h&&(a=$u(h,f,g,A)),(f=-1<a?h[a]:null)&&Ju(f))}function Ju(a){if(typeof a!="number"&&a&&!a.da){var h=a.src;if(h&&h[$i])Qu(h.i,a);else{var f=a.type,g=a.proxy;h.removeEventListener?h.removeEventListener(f,g,a.capture):h.detachEvent?h.detachEvent(Dp(f),g):h.addListener&&h.removeListener&&h.removeListener(g),(f=Xu(h))?(Qu(f,a),f.h==0&&(f.src=null,h[Hu]=null)):Fo(a)}}}function Dp(a){return a in Yu?Yu[a]:Yu[a]="on"+a}function eT(a,h){if(a.da)a=!0;else{h=new Qi(h,this);var f=a.listener,g=a.ha||a.src;a.fa&&Ju(a),a=f.call(g,h)}return a}function Xu(a){return a=a[Hu],a instanceof Mo?a:null}var Zu="__closure_events_fn_"+(1e9*Math.random()>>>0);function ec(a){return typeof a=="function"?a:(a[Zu]||(a[Zu]=function(h){return a.handleEvent(h)}),a[Zu])}function ze(){cn.call(this),this.i=new Mo(this),this.M=this,this.F=null}S(ze,cn),ze.prototype[$i]=!0,ze.prototype.removeEventListener=function(a,h,f,g){Np(this,a,h,f,g)};function Je(a,h){var f,g=a.F;if(g)for(f=[];g;g=g.F)f.push(g);if(a=a.M,g=h.type||h,typeof h=="string")h=new Ke(h,a);else if(h instanceof Ke)h.target=h.target||a;else{var A=h;h=new Ke(g,a),I(h,A)}if(A=!0,f)for(var R=f.length-1;0<=R;R--){var F=h.g=f[R];A=Lo(F,g,!0,h)&&A}if(F=h.g=a,A=Lo(F,g,!0,h)&&A,A=Lo(F,g,!1,h)&&A,f)for(R=0;R<f.length;R++)F=h.g=f[R],A=Lo(F,g,!1,h)&&A}ze.prototype.N=function(){if(ze.aa.N.call(this),this.i){var a=this.i,h;for(h in a.g){for(var f=a.g[h],g=0;g<f.length;g++)Fo(f[g]);delete a.g[h],a.h--}}this.F=null},ze.prototype.K=function(a,h,f,g){return this.i.add(String(a),h,!1,f,g)},ze.prototype.L=function(a,h,f,g){return this.i.add(String(a),h,!0,f,g)};function Lo(a,h,f,g){if(h=a.i.g[String(h)],!h)return!0;h=h.concat();for(var A=!0,R=0;R<h.length;++R){var F=h[R];if(F&&!F.da&&F.capture==f){var he=F.listener,qe=F.ha||F.src;F.fa&&Qu(a.i,F),A=he.call(qe,g)!==!1&&A}}return A&&!g.defaultPrevented}function kp(a,h,f){if(typeof a=="function")f&&(a=p(a,f));else if(a&&typeof a.handleEvent=="function")a=p(a.handleEvent,a);else throw Error("Invalid listener argument");return 2147483647<Number(h)?-1:l.setTimeout(a,h||0)}function Vp(a){a.g=kp(()=>{a.g=null,a.i&&(a.i=!1,Vp(a))},a.l);let h=a.h;a.h=null,a.m.apply(null,h)}class tT extends cn{constructor(h,f){super(),this.m=h,this.l=f,this.h=null,this.i=!1,this.g=null}j(h){this.h=arguments,this.g?this.i=!0:Vp(this)}N(){super.N(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Hi(a){cn.call(this),this.h=a,this.g={}}S(Hi,cn);var Op=[];function Fp(a){Q(a.g,function(h,f){this.g.hasOwnProperty(f)&&Ju(h)},a),a.g={}}Hi.prototype.N=function(){Hi.aa.N.call(this),Fp(this)},Hi.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var tc=l.JSON.stringify,nT=l.JSON.parse,rT=class{stringify(a){return l.JSON.stringify(a,void 0)}parse(a){return l.JSON.parse(a,void 0)}};function nc(){}nc.prototype.h=null;function Mp(a){return a.h||(a.h=a.i())}function Lp(){}var Yi={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function rc(){Ke.call(this,"d")}S(rc,Ke);function ic(){Ke.call(this,"c")}S(ic,Ke);var Wn={},Up=null;function Uo(){return Up=Up||new ze}Wn.La="serverreachability";function Bp(a){Ke.call(this,Wn.La,a)}S(Bp,Ke);function Ji(a){let h=Uo();Je(h,new Bp(h))}Wn.STAT_EVENT="statevent";function qp(a,h){Ke.call(this,Wn.STAT_EVENT,a),this.stat=h}S(qp,Ke);function Xe(a){let h=Uo();Je(h,new qp(h,a))}Wn.Ma="timingevent";function Gp(a,h){Ke.call(this,Wn.Ma,a),this.size=h}S(Gp,Ke);function Xi(a,h){if(typeof a!="function")throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){a()},h)}function Zi(){this.g=!0}Zi.prototype.xa=function(){this.g=!1};function iT(a,h,f,g,A,R){a.info(function(){if(a.g)if(R)for(var F="",he=R.split("&"),qe=0;qe<he.length;qe++){var ae=he[qe].split("=");if(1<ae.length){var We=ae[0];ae=ae[1];var Qe=We.split("_");F=2<=Qe.length&&Qe[1]=="type"?F+(We+"="+ae+"&"):F+(We+"=redacted&")}}else F=null;else F=R;return"XMLHTTP REQ ("+g+") [attempt "+A+"]: "+h+`
`+f+`
`+F})}function sT(a,h,f,g,A,R,F){a.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+A+"]: "+h+`
`+f+`
`+R+" "+F})}function Dr(a,h,f,g){a.info(function(){return"XMLHTTP TEXT ("+h+"): "+aT(a,f)+(g?" "+g:"")})}function oT(a,h){a.info(function(){return"TIMEOUT: "+h})}Zi.prototype.info=function(){};function aT(a,h){if(!a.g)return h;if(!h)return null;try{var f=JSON.parse(h);if(f){for(a=0;a<f.length;a++)if(Array.isArray(f[a])){var g=f[a];if(!(2>g.length)){var A=g[1];if(Array.isArray(A)&&!(1>A.length)){var R=A[0];if(R!="noop"&&R!="stop"&&R!="close")for(var F=1;F<A.length;F++)A[F]=""}}}}return tc(f)}catch{return h}}var Bo={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},jp={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},sc;function qo(){}S(qo,nc),qo.prototype.g=function(){return new XMLHttpRequest},qo.prototype.i=function(){return{}},sc=new qo;function hn(a,h,f,g){this.j=a,this.i=h,this.l=f,this.R=g||1,this.U=new Hi(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Kp}function Kp(){this.i=null,this.g="",this.h=!1}var zp={},oc={};function ac(a,h,f){a.L=1,a.v=zo(Ht(h)),a.m=f,a.P=!0,Wp(a,null)}function Wp(a,h){a.F=Date.now(),Go(a),a.A=Ht(a.v);var f=a.A,g=a.R;Array.isArray(g)||(g=[String(g)]),og(f.i,"t",g),a.C=0,f=a.j.J,a.h=new Kp,a.g=Ag(a.j,f?h:null,!a.m),0<a.O&&(a.M=new tT(p(a.Y,a,a.g),a.O)),h=a.U,f=a.g,g=a.ca;var A="readystatechange";Array.isArray(A)||(A&&(Op[0]=A.toString()),A=Op);for(var R=0;R<A.length;R++){var F=Rp(f,A[R],g||h.handleEvent,!1,h.h||h);if(!F)break;h.g[F.key]=F}h=a.H?_(a.H):{},a.m?(a.u||(a.u="POST"),h["Content-Type"]="application/x-www-form-urlencoded",a.g.ea(a.A,a.u,a.m,h)):(a.u="GET",a.g.ea(a.A,a.u,null,h)),Ji(),iT(a.i,a.u,a.A,a.l,a.R,a.m)}hn.prototype.ca=function(a){a=a.target;let h=this.M;h&&Yt(a)==3?h.j():this.Y(a)},hn.prototype.Y=function(a){try{if(a==this.g)e:{let Qe=Yt(this.g);var h=this.g.Ba();let Or=this.g.Z();if(!(3>Qe)&&(Qe!=3||this.g&&(this.h.h||this.g.oa()||fg(this.g)))){this.J||Qe!=4||h==7||(h==8||0>=Or?Ji(3):Ji(2)),lc(this);var f=this.g.Z();this.X=f;t:if(Qp(this)){var g=fg(this.g);a="";var A=g.length,R=Yt(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){Qn(this),es(this);var F="";break t}this.h.i=new l.TextDecoder}for(h=0;h<A;h++)this.h.h=!0,a+=this.h.i.decode(g[h],{stream:!(R&&h==A-1)});g.length=0,this.h.g+=a,this.C=0,F=this.h.g}else F=this.g.oa();if(this.o=f==200,sT(this.i,this.u,this.A,this.l,this.R,Qe,f),this.o){if(this.T&&!this.K){t:{if(this.g){var he,qe=this.g;if((he=qe.g?qe.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(he)){var ae=he;break t}}ae=null}if(f=ae)Dr(this.i,this.l,f,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,uc(this,f);else{this.o=!1,this.s=3,Xe(12),Qn(this),es(this);break e}}if(this.P){f=!0;let Tt;for(;!this.J&&this.C<F.length;)if(Tt=lT(this,F),Tt==oc){Qe==4&&(this.s=4,Xe(14),f=!1),Dr(this.i,this.l,null,"[Incomplete Response]");break}else if(Tt==zp){this.s=4,Xe(15),Dr(this.i,this.l,F,"[Invalid Chunk]"),f=!1;break}else Dr(this.i,this.l,Tt,null),uc(this,Tt);if(Qp(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Qe!=4||F.length!=0||this.h.h||(this.s=1,Xe(16),f=!1),this.o=this.o&&f,!f)Dr(this.i,this.l,F,"[Invalid Chunked Response]"),Qn(this),es(this);else if(0<F.length&&!this.W){this.W=!0;var We=this.j;We.g==this&&We.ba&&!We.M&&(We.j.info("Great, no buffering proxy detected. Bytes received: "+F.length),pc(We),We.M=!0,Xe(11))}}else Dr(this.i,this.l,F,null),uc(this,F);Qe==4&&Qn(this),this.o&&!this.J&&(Qe==4?wg(this.j,this):(this.o=!1,Go(this)))}else ST(this.g),f==400&&0<F.indexOf("Unknown SID")?(this.s=3,Xe(12)):(this.s=0,Xe(13)),Qn(this),es(this)}}}catch{}finally{}};function Qp(a){return a.g?a.u=="GET"&&a.L!=2&&a.j.Ca:!1}function lT(a,h){var f=a.C,g=h.indexOf(`
`,f);return g==-1?oc:(f=Number(h.substring(f,g)),isNaN(f)?zp:(g+=1,g+f>h.length?oc:(h=h.slice(g,g+f),a.C=g+f,h)))}hn.prototype.cancel=function(){this.J=!0,Qn(this)};function Go(a){a.S=Date.now()+a.I,$p(a,a.I)}function $p(a,h){if(a.B!=null)throw Error("WatchDog timer not null");a.B=Xi(p(a.ba,a),h)}function lc(a){a.B&&(l.clearTimeout(a.B),a.B=null)}hn.prototype.ba=function(){this.B=null;let a=Date.now();0<=a-this.S?(oT(this.i,this.A),this.L!=2&&(Ji(),Xe(17)),Qn(this),this.s=2,es(this)):$p(this,this.S-a)};function es(a){a.j.G==0||a.J||wg(a.j,a)}function Qn(a){lc(a);var h=a.M;h&&typeof h.ma=="function"&&h.ma(),a.M=null,Fp(a.U),a.g&&(h=a.g,a.g=null,h.abort(),h.ma())}function uc(a,h){try{var f=a.j;if(f.G!=0&&(f.g==a||cc(f.h,a))){if(!a.K&&cc(f.h,a)&&f.G==3){try{var g=f.Da.g.parse(h)}catch{g=null}if(Array.isArray(g)&&g.length==3){var A=g;if(A[0]==0){e:if(!f.u){if(f.g)if(f.g.F+3e3<a.F)Yo(f),$o(f);else break e;mc(f),Xe(18)}}else f.za=A[1],0<f.za-f.T&&37500>A[2]&&f.F&&f.v==0&&!f.C&&(f.C=Xi(p(f.Za,f),6e3));if(1>=Jp(f.h)&&f.ca){try{f.ca()}catch{}f.ca=void 0}}else Hn(f,11)}else if((a.K||f.g==a)&&Yo(f),!j(h))for(A=f.Da.g.parse(h),h=0;h<A.length;h++){let ae=A[h];if(f.T=ae[0],ae=ae[1],f.G==2)if(ae[0]=="c"){f.K=ae[1],f.ia=ae[2];let We=ae[3];We!=null&&(f.la=We,f.j.info("VER="+f.la));let Qe=ae[4];Qe!=null&&(f.Aa=Qe,f.j.info("SVER="+f.Aa));let Or=ae[5];Or!=null&&typeof Or=="number"&&0<Or&&(g=1.5*Or,f.L=g,f.j.info("backChannelRequestTimeoutMs_="+g)),g=f;let Tt=a.g;if(Tt){let Xo=Tt.g?Tt.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Xo){var R=g.h;R.g||Xo.indexOf("spdy")==-1&&Xo.indexOf("quic")==-1&&Xo.indexOf("h2")==-1||(R.j=R.l,R.g=new Set,R.h&&(hc(R,R.h),R.h=null))}if(g.D){let gc=Tt.g?Tt.g.getResponseHeader("X-HTTP-Session-Id"):null;gc&&(g.ya=gc,ge(g.I,g.D,gc))}}f.G=3,f.l&&f.l.ua(),f.ba&&(f.R=Date.now()-a.F,f.j.info("Handshake RTT: "+f.R+"ms")),g=f;var F=a;if(g.qa=Tg(g,g.J?g.ia:null,g.W),F.K){Xp(g.h,F);var he=F,qe=g.L;qe&&(he.I=qe),he.B&&(lc(he),Go(he)),g.g=F}else yg(g);0<f.i.length&&Ho(f)}else ae[0]!="stop"&&ae[0]!="close"||Hn(f,7);else f.G==3&&(ae[0]=="stop"||ae[0]=="close"?ae[0]=="stop"?Hn(f,7):fc(f):ae[0]!="noop"&&f.l&&f.l.ta(ae),f.v=0)}}Ji(4)}catch{}}var uT=class{constructor(a,h){this.g=a,this.map=h}};function Hp(a){this.l=a||10,l.PerformanceNavigationTiming?(a=l.performance.getEntriesByType("navigation"),a=0<a.length&&(a[0].nextHopProtocol=="hq"||a[0].nextHopProtocol=="h2")):a=!!(l.chrome&&l.chrome.loadTimes&&l.chrome.loadTimes()&&l.chrome.loadTimes().wasFetchedViaSpdy),this.j=a?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Yp(a){return a.h?!0:a.g?a.g.size>=a.j:!1}function Jp(a){return a.h?1:a.g?a.g.size:0}function cc(a,h){return a.h?a.h==h:a.g?a.g.has(h):!1}function hc(a,h){a.g?a.g.add(h):a.h=h}function Xp(a,h){a.h&&a.h==h?a.h=null:a.g&&a.g.has(h)&&a.g.delete(h)}Hp.prototype.cancel=function(){if(this.i=Zp(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(let a of this.g.values())a.cancel();this.g.clear()}};function Zp(a){if(a.h!=null)return a.i.concat(a.h.D);if(a.g!=null&&a.g.size!==0){let h=a.i;for(let f of a.g.values())h=h.concat(f.D);return h}return x(a.i)}function cT(a){if(a.V&&typeof a.V=="function")return a.V();if(typeof Map<"u"&&a instanceof Map||typeof Set<"u"&&a instanceof Set)return Array.from(a.values());if(typeof a=="string")return a.split("");if(u(a)){for(var h=[],f=a.length,g=0;g<f;g++)h.push(a[g]);return h}h=[],f=0;for(g in a)h[f++]=a[g];return h}function hT(a){if(a.na&&typeof a.na=="function")return a.na();if(!a.V||typeof a.V!="function"){if(typeof Map<"u"&&a instanceof Map)return Array.from(a.keys());if(!(typeof Set<"u"&&a instanceof Set)){if(u(a)||typeof a=="string"){var h=[];a=a.length;for(var f=0;f<a;f++)h.push(f);return h}h=[],f=0;for(let g in a)h[f++]=g;return h}}}function eg(a,h){if(a.forEach&&typeof a.forEach=="function")a.forEach(h,void 0);else if(u(a)||typeof a=="string")Array.prototype.forEach.call(a,h,void 0);else for(var f=hT(a),g=cT(a),A=g.length,R=0;R<A;R++)h.call(void 0,g[R],f&&f[R],a)}var tg=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function dT(a,h){if(a){a=a.split("&");for(var f=0;f<a.length;f++){var g=a[f].indexOf("="),A=null;if(0<=g){var R=a[f].substring(0,g);A=a[f].substring(g+1)}else R=a[f];h(R,A?decodeURIComponent(A.replace(/\+/g," ")):"")}}}function $n(a){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,a instanceof $n){this.h=a.h,jo(this,a.j),this.o=a.o,this.g=a.g,Ko(this,a.s),this.l=a.l;var h=a.i,f=new rs;f.i=h.i,h.g&&(f.g=new Map(h.g),f.h=h.h),ng(this,f),this.m=a.m}else a&&(h=String(a).match(tg))?(this.h=!1,jo(this,h[1]||"",!0),this.o=ts(h[2]||""),this.g=ts(h[3]||"",!0),Ko(this,h[4]),this.l=ts(h[5]||"",!0),ng(this,h[6]||"",!0),this.m=ts(h[7]||"")):(this.h=!1,this.i=new rs(null,this.h))}$n.prototype.toString=function(){var a=[],h=this.j;h&&a.push(ns(h,rg,!0),":");var f=this.g;return(f||h=="file")&&(a.push("//"),(h=this.o)&&a.push(ns(h,rg,!0),"@"),a.push(encodeURIComponent(String(f)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),f=this.s,f!=null&&a.push(":",String(f))),(f=this.l)&&(this.g&&f.charAt(0)!="/"&&a.push("/"),a.push(ns(f,f.charAt(0)=="/"?pT:mT,!0))),(f=this.i.toString())&&a.push("?",f),(f=this.m)&&a.push("#",ns(f,_T)),a.join("")};function Ht(a){return new $n(a)}function jo(a,h,f){a.j=f?ts(h,!0):h,a.j&&(a.j=a.j.replace(/:$/,""))}function Ko(a,h){if(h){if(h=Number(h),isNaN(h)||0>h)throw Error("Bad port number "+h);a.s=h}else a.s=null}function ng(a,h,f){h instanceof rs?(a.i=h,yT(a.i,a.h)):(f||(h=ns(h,gT)),a.i=new rs(h,a.h))}function ge(a,h,f){a.i.set(h,f)}function zo(a){return ge(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),a}function ts(a,h){return a?h?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function ns(a,h,f){return typeof a=="string"?(a=encodeURI(a).replace(h,fT),f&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function fT(a){return a=a.charCodeAt(0),"%"+(a>>4&15).toString(16)+(a&15).toString(16)}var rg=/[#\/\?@]/g,mT=/[#\?:]/g,pT=/[#\?]/g,gT=/[#\?@]/g,_T=/#/g;function rs(a,h){this.h=this.g=null,this.i=a||null,this.j=!!h}function dn(a){a.g||(a.g=new Map,a.h=0,a.i&&dT(a.i,function(h,f){a.add(decodeURIComponent(h.replace(/\+/g," ")),f)}))}n=rs.prototype,n.add=function(a,h){dn(this),this.i=null,a=kr(this,a);var f=this.g.get(a);return f||this.g.set(a,f=[]),f.push(h),this.h+=1,this};function ig(a,h){dn(a),h=kr(a,h),a.g.has(h)&&(a.i=null,a.h-=a.g.get(h).length,a.g.delete(h))}function sg(a,h){return dn(a),h=kr(a,h),a.g.has(h)}n.forEach=function(a,h){dn(this),this.g.forEach(function(f,g){f.forEach(function(A){a.call(h,A,g,this)},this)},this)},n.na=function(){dn(this);let a=Array.from(this.g.values()),h=Array.from(this.g.keys()),f=[];for(let g=0;g<h.length;g++){let A=a[g];for(let R=0;R<A.length;R++)f.push(h[g])}return f},n.V=function(a){dn(this);let h=[];if(typeof a=="string")sg(this,a)&&(h=h.concat(this.g.get(kr(this,a))));else{a=Array.from(this.g.values());for(let f=0;f<a.length;f++)h=h.concat(a[f])}return h},n.set=function(a,h){return dn(this),this.i=null,a=kr(this,a),sg(this,a)&&(this.h-=this.g.get(a).length),this.g.set(a,[h]),this.h+=1,this},n.get=function(a,h){return a?(a=this.V(a),0<a.length?String(a[0]):h):h};function og(a,h,f){ig(a,h),0<f.length&&(a.i=null,a.g.set(kr(a,h),x(f)),a.h+=f.length)}n.toString=function(){if(this.i)return this.i;if(!this.g)return"";let a=[],h=Array.from(this.g.keys());for(var f=0;f<h.length;f++){var g=h[f];let R=encodeURIComponent(String(g)),F=this.V(g);for(g=0;g<F.length;g++){var A=R;F[g]!==""&&(A+="="+encodeURIComponent(String(F[g]))),a.push(A)}}return this.i=a.join("&")};function kr(a,h){return h=String(h),a.j&&(h=h.toLowerCase()),h}function yT(a,h){h&&!a.j&&(dn(a),a.i=null,a.g.forEach(function(f,g){var A=g.toLowerCase();g!=A&&(ig(this,g),og(this,A,f))},a)),a.j=h}function vT(a,h){let f=new Zi;if(l.Image){let g=new Image;g.onload=y(fn,f,"TestLoadImage: loaded",!0,h,g),g.onerror=y(fn,f,"TestLoadImage: error",!1,h,g),g.onabort=y(fn,f,"TestLoadImage: abort",!1,h,g),g.ontimeout=y(fn,f,"TestLoadImage: timeout",!1,h,g),l.setTimeout(function(){g.ontimeout&&g.ontimeout()},1e4),g.src=a}else h(!1)}function wT(a,h){let f=new Zi,g=new AbortController,A=setTimeout(()=>{g.abort(),fn(f,"TestPingServer: timeout",!1,h)},1e4);fetch(a,{signal:g.signal}).then(R=>{clearTimeout(A),R.ok?fn(f,"TestPingServer: ok",!0,h):fn(f,"TestPingServer: server error",!1,h)}).catch(()=>{clearTimeout(A),fn(f,"TestPingServer: error",!1,h)})}function fn(a,h,f,g,A){try{A&&(A.onload=null,A.onerror=null,A.onabort=null,A.ontimeout=null),g(f)}catch{}}function ET(){this.g=new rT}function IT(a,h,f){let g=f||"";try{eg(a,function(A,R){let F=A;c(A)&&(F=tc(A)),h.push(g+R+"="+encodeURIComponent(F))})}catch(A){throw h.push(g+"type="+encodeURIComponent("_badmap")),A}}function is(a){this.l=a.Ub||null,this.j=a.eb||!1}S(is,nc),is.prototype.g=function(){return new Wo(this.l,this.j)},is.prototype.i=function(a){return function(){return a}}({});function Wo(a,h){ze.call(this),this.D=a,this.o=h,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}S(Wo,ze),n=Wo.prototype,n.open=function(a,h){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=a,this.A=h,this.readyState=1,os(this)},n.send=function(a){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;let h={headers:this.u,method:this.B,credentials:this.m,cache:void 0};a&&(h.body=a),(this.D||l).fetch(new Request(this.A,h)).then(this.Sa.bind(this),this.ga.bind(this))},n.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,ss(this)),this.readyState=0},n.Sa=function(a){if(this.g&&(this.l=a,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=a.headers,this.readyState=2,os(this)),this.g&&(this.readyState=3,os(this),this.g)))if(this.responseType==="arraybuffer")a.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof l.ReadableStream<"u"&&"body"in a){if(this.j=a.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;ag(this)}else a.text().then(this.Ra.bind(this),this.ga.bind(this))};function ag(a){a.j.read().then(a.Pa.bind(a)).catch(a.ga.bind(a))}n.Pa=function(a){if(this.g){if(this.o&&a.value)this.response.push(a.value);else if(!this.o){var h=a.value?a.value:new Uint8Array(0);(h=this.v.decode(h,{stream:!a.done}))&&(this.response=this.responseText+=h)}a.done?ss(this):os(this),this.readyState==3&&ag(this)}},n.Ra=function(a){this.g&&(this.response=this.responseText=a,ss(this))},n.Qa=function(a){this.g&&(this.response=a,ss(this))},n.ga=function(){this.g&&ss(this)};function ss(a){a.readyState=4,a.l=null,a.j=null,a.v=null,os(a)}n.setRequestHeader=function(a,h){this.u.append(a,h)},n.getResponseHeader=function(a){return this.h&&this.h.get(a.toLowerCase())||""},n.getAllResponseHeaders=function(){if(!this.h)return"";let a=[],h=this.h.entries();for(var f=h.next();!f.done;)f=f.value,a.push(f[0]+": "+f[1]),f=h.next();return a.join(`\r
`)};function os(a){a.onreadystatechange&&a.onreadystatechange.call(a)}Object.defineProperty(Wo.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(a){this.m=a?"include":"same-origin"}});function lg(a){let h="";return Q(a,function(f,g){h+=g,h+=":",h+=f,h+=`\r
`}),h}function dc(a,h,f){e:{for(g in f){var g=!1;break e}g=!0}g||(f=lg(f),typeof a=="string"?f!=null&&encodeURIComponent(String(f)):ge(a,h,f))}function Te(a){ze.call(this),this.headers=new Map,this.o=a||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}S(Te,ze);var TT=/^https?$/i,AT=["POST","PUT"];n=Te.prototype,n.Ha=function(a){this.J=a},n.ea=function(a,h,f,g){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+a);h=h?h.toUpperCase():"GET",this.D=a,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():sc.g(),this.v=this.o?Mp(this.o):Mp(sc),this.g.onreadystatechange=p(this.Ea,this);try{this.B=!0,this.g.open(h,String(a),!0),this.B=!1}catch(R){ug(this,R);return}if(a=f||"",f=new Map(this.headers),g)if(Object.getPrototypeOf(g)===Object.prototype)for(var A in g)f.set(A,g[A]);else if(typeof g.keys=="function"&&typeof g.get=="function")for(let R of g.keys())f.set(R,g.get(R));else throw Error("Unknown input type for opt_headers: "+String(g));g=Array.from(f.keys()).find(R=>R.toLowerCase()=="content-type"),A=l.FormData&&a instanceof l.FormData,!(0<=Array.prototype.indexOf.call(AT,h,void 0))||g||A||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(let[R,F]of f)this.g.setRequestHeader(R,F);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{dg(this),this.u=!0,this.g.send(a),this.u=!1}catch(R){ug(this,R)}};function ug(a,h){a.h=!1,a.g&&(a.j=!0,a.g.abort(),a.j=!1),a.l=h,a.m=5,cg(a),Qo(a)}function cg(a){a.A||(a.A=!0,Je(a,"complete"),Je(a,"error"))}n.abort=function(a){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=a||7,Je(this,"complete"),Je(this,"abort"),Qo(this))},n.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Qo(this,!0)),Te.aa.N.call(this)},n.Ea=function(){this.s||(this.B||this.u||this.j?hg(this):this.bb())},n.bb=function(){hg(this)};function hg(a){if(a.h&&typeof o<"u"&&(!a.v[1]||Yt(a)!=4||a.Z()!=2)){if(a.u&&Yt(a)==4)kp(a.Ea,0,a);else if(Je(a,"readystatechange"),Yt(a)==4){a.h=!1;try{let F=a.Z();e:switch(F){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var h=!0;break e;default:h=!1}var f;if(!(f=h)){var g;if(g=F===0){var A=String(a.D).match(tg)[1]||null;!A&&l.self&&l.self.location&&(A=l.self.location.protocol.slice(0,-1)),g=!TT.test(A?A.toLowerCase():"")}f=g}if(f)Je(a,"complete"),Je(a,"success");else{a.m=6;try{var R=2<Yt(a)?a.g.statusText:""}catch{R=""}a.l=R+" ["+a.Z()+"]",cg(a)}}finally{Qo(a)}}}}function Qo(a,h){if(a.g){dg(a);let f=a.g,g=a.v[0]?()=>{}:null;a.g=null,a.v=null,h||Je(a,"ready");try{f.onreadystatechange=g}catch{}}}function dg(a){a.I&&(l.clearTimeout(a.I),a.I=null)}n.isActive=function(){return!!this.g};function Yt(a){return a.g?a.g.readyState:0}n.Z=function(){try{return 2<Yt(this)?this.g.status:-1}catch{return-1}},n.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},n.Oa=function(a){if(this.g){var h=this.g.responseText;return a&&h.indexOf(a)==0&&(h=h.substring(a.length)),nT(h)}};function fg(a){try{if(!a.g)return null;if("response"in a.g)return a.g.response;switch(a.H){case"":case"text":return a.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in a.g)return a.g.mozResponseArrayBuffer}return null}catch{return null}}function ST(a){let h={};a=(a.g&&2<=Yt(a)&&a.g.getAllResponseHeaders()||"").split(`\r
`);for(let g=0;g<a.length;g++){if(j(a[g]))continue;var f=T(a[g]);let A=f[0];if(f=f[1],typeof f!="string")continue;f=f.trim();let R=h[A]||[];h[A]=R,R.push(f)}E(h,function(g){return g.join(", ")})}n.Ba=function(){return this.m},n.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function as(a,h,f){return f&&f.internalChannelParams&&f.internalChannelParams[a]||h}function mg(a){this.Aa=0,this.i=[],this.j=new Zi,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=as("failFast",!1,a),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=as("baseRetryDelayMs",5e3,a),this.cb=as("retryDelaySeedMs",1e4,a),this.Wa=as("forwardChannelMaxRetries",2,a),this.wa=as("forwardChannelRequestTimeoutMs",2e4,a),this.pa=a&&a.xmlHttpFactory||void 0,this.Xa=a&&a.Tb||void 0,this.Ca=a&&a.useFetchStreams||!1,this.L=void 0,this.J=a&&a.supportsCrossDomainXhr||!1,this.K="",this.h=new Hp(a&&a.concurrentRequestLimit),this.Da=new ET,this.P=a&&a.fastHandshake||!1,this.O=a&&a.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=a&&a.Rb||!1,a&&a.xa&&this.j.xa(),a&&a.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&a&&a.detectBufferingProxy||!1,this.ja=void 0,a&&a.longPollingTimeout&&0<a.longPollingTimeout&&(this.ja=a.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}n=mg.prototype,n.la=8,n.G=1,n.connect=function(a,h,f,g){Xe(0),this.W=a,this.H=h||{},f&&g!==void 0&&(this.H.OSID=f,this.H.OAID=g),this.F=this.X,this.I=Tg(this,null,this.W),Ho(this)};function fc(a){if(pg(a),a.G==3){var h=a.U++,f=Ht(a.I);if(ge(f,"SID",a.K),ge(f,"RID",h),ge(f,"TYPE","terminate"),ls(a,f),h=new hn(a,a.j,h),h.L=2,h.v=zo(Ht(f)),f=!1,l.navigator&&l.navigator.sendBeacon)try{f=l.navigator.sendBeacon(h.v.toString(),"")}catch{}!f&&l.Image&&(new Image().src=h.v,f=!0),f||(h.g=Ag(h.j,null),h.g.ea(h.v)),h.F=Date.now(),Go(h)}Ig(a)}function $o(a){a.g&&(pc(a),a.g.cancel(),a.g=null)}function pg(a){$o(a),a.u&&(l.clearTimeout(a.u),a.u=null),Yo(a),a.h.cancel(),a.s&&(typeof a.s=="number"&&l.clearTimeout(a.s),a.s=null)}function Ho(a){if(!Yp(a.h)&&!a.s){a.s=!0;var h=a.Ga;zi||bp(),Wi||(zi(),Wi=!0),Wu.add(h,a),a.B=0}}function CT(a,h){return Jp(a.h)>=a.h.j-(a.s?1:0)?!1:a.s?(a.i=h.D.concat(a.i),!0):a.G==1||a.G==2||a.B>=(a.Va?0:a.Wa)?!1:(a.s=Xi(p(a.Ga,a,h),Eg(a,a.B)),a.B++,!0)}n.Ga=function(a){if(this.s)if(this.s=null,this.G==1){if(!a){this.U=Math.floor(1e5*Math.random()),a=this.U++;let A=new hn(this,this.j,a),R=this.o;if(this.S&&(R?(R=_(R),I(R,this.S)):R=this.S),this.m!==null||this.O||(A.H=R,R=null),this.P)e:{for(var h=0,f=0;f<this.i.length;f++){t:{var g=this.i[f];if("__data__"in g.map&&(g=g.map.__data__,typeof g=="string")){g=g.length;break t}g=void 0}if(g===void 0)break;if(h+=g,4096<h){h=f;break e}if(h===4096||f===this.i.length-1){h=f+1;break e}}h=1e3}else h=1e3;h=_g(this,A,h),f=Ht(this.I),ge(f,"RID",a),ge(f,"CVER",22),this.D&&ge(f,"X-HTTP-Session-Id",this.D),ls(this,f),R&&(this.O?h="headers="+encodeURIComponent(String(lg(R)))+"&"+h:this.m&&dc(f,this.m,R)),hc(this.h,A),this.Ua&&ge(f,"TYPE","init"),this.P?(ge(f,"$req",h),ge(f,"SID","null"),A.T=!0,ac(A,f,null)):ac(A,f,h),this.G=2}}else this.G==3&&(a?gg(this,a):this.i.length==0||Yp(this.h)||gg(this))};function gg(a,h){var f;h?f=h.l:f=a.U++;let g=Ht(a.I);ge(g,"SID",a.K),ge(g,"RID",f),ge(g,"AID",a.T),ls(a,g),a.m&&a.o&&dc(g,a.m,a.o),f=new hn(a,a.j,f,a.B+1),a.m===null&&(f.H=a.o),h&&(a.i=h.D.concat(a.i)),h=_g(a,f,1e3),f.I=Math.round(.5*a.wa)+Math.round(.5*a.wa*Math.random()),hc(a.h,f),ac(f,g,h)}function ls(a,h){a.H&&Q(a.H,function(f,g){ge(h,g,f)}),a.l&&eg({},function(f,g){ge(h,g,f)})}function _g(a,h,f){f=Math.min(a.i.length,f);var g=a.l?p(a.l.Na,a.l,a):null;e:{var A=a.i;let R=-1;for(;;){let F=["count="+f];R==-1?0<f?(R=A[0].g,F.push("ofs="+R)):R=0:F.push("ofs="+R);let he=!0;for(let qe=0;qe<f;qe++){let ae=A[qe].g,We=A[qe].map;if(ae-=R,0>ae)R=Math.max(0,A[qe].g-100),he=!1;else try{IT(We,F,"req"+ae+"_")}catch{g&&g(We)}}if(he){g=F.join("&");break e}}}return a=a.i.splice(0,f),h.D=a,g}function yg(a){if(!a.g&&!a.u){a.Y=1;var h=a.Fa;zi||bp(),Wi||(zi(),Wi=!0),Wu.add(h,a),a.v=0}}function mc(a){return a.g||a.u||3<=a.v?!1:(a.Y++,a.u=Xi(p(a.Fa,a),Eg(a,a.v)),a.v++,!0)}n.Fa=function(){if(this.u=null,vg(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var a=2*this.R;this.j.info("BP detection timer enabled: "+a),this.A=Xi(p(this.ab,this),a)}},n.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Xe(10),$o(this),vg(this))};function pc(a){a.A!=null&&(l.clearTimeout(a.A),a.A=null)}function vg(a){a.g=new hn(a,a.j,"rpc",a.Y),a.m===null&&(a.g.H=a.o),a.g.O=0;var h=Ht(a.qa);ge(h,"RID","rpc"),ge(h,"SID",a.K),ge(h,"AID",a.T),ge(h,"CI",a.F?"0":"1"),!a.F&&a.ja&&ge(h,"TO",a.ja),ge(h,"TYPE","xmlhttp"),ls(a,h),a.m&&a.o&&dc(h,a.m,a.o),a.L&&(a.g.I=a.L);var f=a.g;a=a.ia,f.L=1,f.v=zo(Ht(h)),f.m=null,f.P=!0,Wp(f,a)}n.Za=function(){this.C!=null&&(this.C=null,$o(this),mc(this),Xe(19))};function Yo(a){a.C!=null&&(l.clearTimeout(a.C),a.C=null)}function wg(a,h){var f=null;if(a.g==h){Yo(a),pc(a),a.g=null;var g=2}else if(cc(a.h,h))f=h.D,Xp(a.h,h),g=1;else return;if(a.G!=0){if(h.o)if(g==1){f=h.m?h.m.length:0,h=Date.now()-h.F;var A=a.B;g=Uo(),Je(g,new Gp(g,f)),Ho(a)}else yg(a);else if(A=h.s,A==3||A==0&&0<h.X||!(g==1&&CT(a,h)||g==2&&mc(a)))switch(f&&0<f.length&&(h=a.h,h.i=h.i.concat(f)),A){case 1:Hn(a,5);break;case 4:Hn(a,10);break;case 3:Hn(a,6);break;default:Hn(a,2)}}}function Eg(a,h){let f=a.Ta+Math.floor(Math.random()*a.cb);return a.isActive()||(f*=2),f*h}function Hn(a,h){if(a.j.info("Error code "+h),h==2){var f=p(a.fb,a),g=a.Xa;let A=!g;g=new $n(g||"//www.google.com/images/cleardot.gif"),l.location&&l.location.protocol=="http"||jo(g,"https"),zo(g),A?vT(g.toString(),f):wT(g.toString(),f)}else Xe(2);a.G=0,a.l&&a.l.sa(h),Ig(a),pg(a)}n.fb=function(a){a?(this.j.info("Successfully pinged google.com"),Xe(2)):(this.j.info("Failed to ping google.com"),Xe(1))};function Ig(a){if(a.G=0,a.ka=[],a.l){let h=Zp(a.h);(h.length!=0||a.i.length!=0)&&(D(a.ka,h),D(a.ka,a.i),a.h.i.length=0,x(a.i),a.i.length=0),a.l.ra()}}function Tg(a,h,f){var g=f instanceof $n?Ht(f):new $n(f);if(g.g!="")h&&(g.g=h+"."+g.g),Ko(g,g.s);else{var A=l.location;g=A.protocol,h=h?h+"."+A.hostname:A.hostname,A=+A.port;var R=new $n(null);g&&jo(R,g),h&&(R.g=h),A&&Ko(R,A),f&&(R.l=f),g=R}return f=a.D,h=a.ya,f&&h&&ge(g,f,h),ge(g,"VER",a.la),ls(a,g),g}function Ag(a,h,f){if(h&&!a.J)throw Error("Can't create secondary domain capable XhrIo object.");return h=a.Ca&&!a.pa?new Te(new is({eb:f})):new Te(a.pa),h.Ha(a.J),h}n.isActive=function(){return!!this.l&&this.l.isActive(this)};function Sg(){}n=Sg.prototype,n.ua=function(){},n.ta=function(){},n.sa=function(){},n.ra=function(){},n.isActive=function(){return!0},n.Na=function(){};function Jo(){}Jo.prototype.g=function(a,h){return new lt(a,h)};function lt(a,h){ze.call(this),this.g=new mg(h),this.l=a,this.h=h&&h.messageUrlParams||null,a=h&&h.messageHeaders||null,h&&h.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.g.o=a,a=h&&h.initMessageHeaders||null,h&&h.messageContentType&&(a?a["X-WebChannel-Content-Type"]=h.messageContentType:a={"X-WebChannel-Content-Type":h.messageContentType}),h&&h.va&&(a?a["X-WebChannel-Client-Profile"]=h.va:a={"X-WebChannel-Client-Profile":h.va}),this.g.S=a,(a=h&&h.Sb)&&!j(a)&&(this.g.m=a),this.v=h&&h.supportsCrossDomainXhr||!1,this.u=h&&h.sendRawJson||!1,(h=h&&h.httpSessionIdParam)&&!j(h)&&(this.g.D=h,a=this.h,a!==null&&h in a&&(a=this.h,h in a&&delete a[h])),this.j=new Vr(this)}S(lt,ze),lt.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},lt.prototype.close=function(){fc(this.g)},lt.prototype.o=function(a){var h=this.g;if(typeof a=="string"){var f={};f.__data__=a,a=f}else this.u&&(f={},f.__data__=tc(a),a=f);h.i.push(new uT(h.Ya++,a)),h.G==3&&Ho(h)},lt.prototype.N=function(){this.g.l=null,delete this.j,fc(this.g),delete this.g,lt.aa.N.call(this)};function Cg(a){rc.call(this),a.__headers__&&(this.headers=a.__headers__,this.statusCode=a.__status__,delete a.__headers__,delete a.__status__);var h=a.__sm__;if(h){e:{for(let f in h){a=f;break e}a=void 0}(this.i=a)&&(a=this.i,h=h!==null&&a in h?h[a]:void 0),this.data=h}else this.data=a}S(Cg,rc);function bg(){ic.call(this),this.status=1}S(bg,ic);function Vr(a){this.g=a}S(Vr,Sg),Vr.prototype.ua=function(){Je(this.g,"a")},Vr.prototype.ta=function(a){Je(this.g,new Cg(a))},Vr.prototype.sa=function(a){Je(this.g,new bg)},Vr.prototype.ra=function(){Je(this.g,"b")},Jo.prototype.createWebChannel=Jo.prototype.g,lt.prototype.send=lt.prototype.o,lt.prototype.open=lt.prototype.m,lt.prototype.close=lt.prototype.close,Ad=Zt.createWebChannelTransport=function(){return new Jo},Td=Zt.getStatEventTarget=function(){return Uo()},Id=Zt.Event=Wn,Tl=Zt.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Bo.NO_ERROR=0,Bo.TIMEOUT=8,Bo.HTTP_ERROR=6,$s=Zt.ErrorCode=Bo,jp.COMPLETE="complete",Ed=Zt.EventType=jp,Lp.EventType=Yi,Yi.OPEN="a",Yi.CLOSE="b",Yi.ERROR="c",Yi.MESSAGE="d",ze.prototype.listen=ze.prototype.K,ri=Zt.WebChannel=Lp,FS=Zt.FetchXmlHttpFactory=is,Te.prototype.listenOnce=Te.prototype.L,Te.prototype.getLastError=Te.prototype.Ka,Te.prototype.getLastErrorCode=Te.prototype.Ba,Te.prototype.getStatus=Te.prototype.Z,Te.prototype.getResponseJson=Te.prototype.Oa,Te.prototype.getResponseText=Te.prototype.oa,Te.prototype.send=Te.prototype.ea,Te.prototype.setWithCredentials=Te.prototype.Ha,wd=Zt.XhrIo=Te}).apply(typeof Il<"u"?Il:typeof self<"u"?self:typeof window<"u"?window:{});var mv="@firebase/firestore";var De=class{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}};De.UNAUTHENTICATED=new De(null),De.GOOGLE_CREDENTIALS=new De("google-credentials-uid"),De.FIRST_PARTY=new De("first-party-uid"),De.MOCK_USER=new De("mock-user");var Vi="10.14.0";var kn=new Lr("@firebase/firestore");function li(){return kn.logLevel}function _w(n){kn.setLogLevel(n)}function V(n,...e){if(kn.logLevel<=gt.DEBUG){let t=e.map(xm);kn.debug(`Firestore (${Vi}): ${n}`,...t)}}function Se(n,...e){if(kn.logLevel<=gt.ERROR){let t=e.map(xm);kn.error(`Firestore (${Vi}): ${n}`,...t)}}function Ct(n,...e){if(kn.logLevel<=gt.WARN){let t=e.map(xm);kn.warn(`Firestore (${Vi}): ${n}`,...t)}}function xm(n){if(typeof n=="string")return n;try{return function(t){return JSON.stringify(t)}(n)}catch{return n}}function U(n="Unexpected state"){let e=`FIRESTORE (${Vi}) INTERNAL ASSERTION FAILED: `+n;throw Se(e),new Error(e)}function G(n,e){n||U()}function yw(n,e){n||U()}function M(n,e){return n}var P={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},k=class extends Lg{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var Fe=class{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}};var kl=class{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}},xd=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(De.UNAUTHENTICATED))}shutdown(){}},Nd=class{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}},Dd=class{constructor(e){this.t=e,this.currentUser=De.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){G(this.o===void 0);let r=this.i,i=u=>this.i!==r?(r=this.i,t(u)):Promise.resolve(),s=new Fe;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new Fe,e.enqueueRetryable(()=>i(this.currentUser))};let o=()=>{let u=s;e.enqueueRetryable(()=>N(this,null,function*(){yield u.promise,yield i(this.currentUser)}))},l=u=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=u,this.o&&(this.auth.addAuthTokenListener(this.o),o())};this.t.onInit(u=>l(u)),setTimeout(()=>{if(!this.auth){let u=this.t.getImmediate({optional:!0});u?l(u):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new Fe)}},0),o()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(r=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):r?(G(typeof r.accessToken=="string"),new kl(r.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return G(e===null||typeof e=="string"),new De(e)}},kd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r,this.type="FirstParty",this.user=De.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},Vd=class{constructor(e,t,r){this.l=e,this.h=t,this.P=r}getToken(){return Promise.resolve(new kd(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(De.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Od=class{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},Fd=class{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){G(this.o===void 0);let r=s=>{s.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${s.error.message}`);let o=s.token!==this.R;return this.R=s.token,V("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?t(s.token):Promise.resolve()};this.o=s=>{e.enqueueRetryable(()=>r(s))};let i=s=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=s,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(s=>i(s)),setTimeout(()=>{if(!this.appCheck){let s=this.A.getImmediate({optional:!0});s?i(s):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(G(typeof t.token=="string"),this.R=t.token,new Od(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}};function MS(n){let e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(n);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let r=0;r<n;r++)t[r]=Math.floor(256*Math.random());return t}var Vl=class{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,r="";for(;r.length<20;){let i=MS(40);for(let s=0;s<i.length;++s)r.length<20&&i[s]<t&&(r+=e.charAt(i[s]%e.length))}return r}};function W(n,e){return n<e?-1:n>e?1:0}function _i(n,e,t){return n.length===e.length&&n.every((r,i)=>t(r,e[i]))}function vw(n){return n+"\0"}var Ee=class n{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new k(P.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new k(P.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return n.fromMillis(Date.now())}static fromDate(e){return n.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),r=Math.floor(1e6*(e-1e3*t));return new n(t,r)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?W(this.nanoseconds,e.nanoseconds):W(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var K=class n{constructor(e){this.timestamp=e}static fromTimestamp(e){return new n(e)}static min(){return new n(new Ee(0,0))}static max(){return new n(new Ee(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var Ol=class n{constructor(e,t,r){t===void 0?t=0:t>e.length&&U(),r===void 0?r=e.length-t:r>e.length-t&&U(),this.segments=e,this.offset=t,this.len=r}get length(){return this.len}isEqual(e){return n.comparator(this,e)===0}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof n?e.forEach(r=>{t.push(r)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,r=this.limit();t<r;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let r=Math.min(e.length,t.length);for(let i=0;i<r;i++){let s=e.get(i),o=t.get(i);if(s<o)return-1;if(s>o)return 1}return e.length<t.length?-1:e.length>t.length?1:0}},se=class n extends Ol{construct(e,t,r){return new n(e,t,r)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let r of e){if(r.indexOf("//")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid segment (${r}). Paths must not contain // in them.`);t.push(...r.split("/").filter(i=>i.length>0))}return new n(t)}static emptyPath(){return new n([])}},LS=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Ce=class n extends Ol{construct(e,t,r){return new n(e,t,r)}static isValidIdentifier(e){return LS.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),n.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new n(["__name__"])}static fromServerFormat(e){let t=[],r="",i=0,s=()=>{if(r.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(r),r=""},o=!1;for(;i<e.length;){let l=e[i];if(l==="\\"){if(i+1===e.length)throw new k(P.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let u=e[i+1];if(u!=="\\"&&u!=="."&&u!=="`")throw new k(P.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);r+=u,i+=2}else l==="`"?(o=!o,i++):l!=="."||o?(r+=l,i++):(s(),i++)}if(s(),o)throw new k(P.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new n(t)}static emptyPath(){return new n([])}};var L=class n{constructor(e){this.path=e}static fromPath(e){return new n(se.fromString(e))}static fromName(e){return new n(se.fromString(e).popFirst(5))}static empty(){return new n(se.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&se.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return se.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new n(new se(e.slice()))}};var yi=class{constructor(e,t,r,i){this.indexId=e,this.collectionGroup=t,this.fields=r,this.indexState=i}};function Md(n){return n.fields.find(e=>e.kind===2)}function ar(n){return n.fields.filter(e=>e.kind!==2)}yi.UNKNOWN_ID=-1;var mi=class{constructor(e,t){this.fieldPath=e,this.kind=t}};var oo=class n{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new n(0,Et.min())}};function ww(n,e){let t=n.toTimestamp().seconds,r=n.toTimestamp().nanoseconds+1,i=K.fromTimestamp(r===1e9?new Ee(t+1,0):new Ee(t,r));return new Et(i,L.empty(),e)}function Ew(n){return new Et(n.readTime,n.key,-1)}var Et=class n{constructor(e,t,r){this.readTime=e,this.documentKey=t,this.largestBatchId=r}static min(){return new n(K.min(),L.empty(),-1)}static max(){return new n(K.max(),L.empty(),-1)}};function Nm(n,e){let t=n.readTime.compareTo(e.readTime);return t!==0?t:(t=L.comparator(n.documentKey,e.documentKey),t!==0?t:W(n.largestBatchId,e.largestBatchId))}var Iw="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Fl=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}};function jn(n){return N(this,null,function*(){if(n.code!==P.FAILED_PRECONDITION||n.message!==Iw)throw n;V("LocalStore","Unexpectedly lost primary lease")})}var b=class n{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&U(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new n((r,i)=>{this.nextCallback=s=>{this.wrapSuccess(e,s).next(r,i)},this.catchCallback=s=>{this.wrapFailure(t,s).next(r,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof n?t:n.resolve(t)}catch(t){return n.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):n.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):n.reject(t)}static resolve(e){return new n((t,r)=>{t(e)})}static reject(e){return new n((t,r)=>{r(e)})}static waitFor(e){return new n((t,r)=>{let i=0,s=0,o=!1;e.forEach(l=>{++i,l.next(()=>{++s,o&&s===i&&t()},u=>r(u))}),o=!0,s===i&&t()})}static or(e){let t=n.resolve(!1);for(let r of e)t=t.next(i=>i?n.resolve(i):r());return t}static forEach(e,t){let r=[];return e.forEach((i,s)=>{r.push(t.call(this,i,s))}),this.waitFor(r)}static mapArray(e,t){return new n((r,i)=>{let s=e.length,o=new Array(s),l=0;for(let u=0;u<s;u++){let c=u;t(e[c]).next(d=>{o[c]=d,++l,l===s&&r(o)},d=>i(d))}})}static doWhile(e,t){return new n((r,i)=>{let s=()=>{e()===!0?t().next(()=>{s()},i):r()};s()})}};var Ml=class n{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new Fe,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new fr(e,t.error)):this.V.resolve()},this.transaction.onerror=r=>{let i=Dm(r.target.error);this.V.reject(new fr(e,i))}}static open(e,t,r,i){try{return new n(t,e.transaction(i,r))}catch(s){throw new fr(t,s)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(V("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||typeof e.commit!="function"||e.commit()}store(e){let t=this.transaction.objectStore(e);return new Ud(t)}},Vn=class n{constructor(e,t,r){this.name=e,this.version=t,this.p=r,n.S(ds())===12.2&&Se("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return V("SimpleDb","Removing database:",e),lr(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!Mg())return!1;if(n.v())return!0;let e=ds(),t=n.S(e),r=0<t&&t<10,i=Tw(e),s=0<i&&i<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||r||s)}static v(){var e;return typeof process<"u"&&((e=process.__PRIVATE_env)===null||e===void 0?void 0:e.C)==="YES"}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),r=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(r)}M(e){return N(this,null,function*(){return this.db||(V("SimpleDb","Opening database:",this.name),this.db=yield new Promise((t,r)=>{let i=indexedDB.open(this.name,this.version);i.onsuccess=s=>{let o=s.target.result;t(o)},i.onblocked=()=>{r(new fr(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=s=>{let o=s.target.error;o.name==="VersionError"?r(new k(P.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?r(new k(P.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):r(new fr(e,o))},i.onupgradeneeded=s=>{V("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',s.oldVersion);let o=s.target.result;this.p.O(o,i.transaction,s.oldVersion,this.version).next(()=>{V("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=t=>this.N(t)),this.db})}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}runTransaction(e,t,r,i){return N(this,null,function*(){let s=t==="readonly",o=0;for(;;){++o;try{this.db=yield this.M(e);let l=Ml.open(this.db,e,s?"readonly":"readwrite",r),u=i(l).next(c=>(l.g(),c)).catch(c=>(l.abort(c),b.reject(c))).toPromise();return u.catch(()=>{}),yield l.m,u}catch(l){let u=l,c=u.name!=="FirebaseError"&&o<3;if(V("SimpleDb","Transaction failed with error:",u.message,"Retrying:",c),this.close(),!c)return Promise.reject(u)}}})}close(){this.db&&this.db.close(),this.db=void 0}};function Tw(n){let e=n.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}var Ld=class{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return lr(this.B.delete())}},fr=class extends k{constructor(e,t){super(P.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}};function Kn(n){return n.name==="IndexedDbTransactionError"}var Ud=class{constructor(e){this.store=e}put(e,t){let r;return t!==void 0?(V("SimpleDb","PUT",this.store.name,e,t),r=this.store.put(t,e)):(V("SimpleDb","PUT",this.store.name,"<auto-key>",e),r=this.store.put(e)),lr(r)}add(e){return V("SimpleDb","ADD",this.store.name,e,e),lr(this.store.add(e))}get(e){return lr(this.store.get(e)).next(t=>(t===void 0&&(t=null),V("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return V("SimpleDb","DELETE",this.store.name,e),lr(this.store.delete(e))}count(){return V("SimpleDb","COUNT",this.store.name),lr(this.store.count())}U(e,t){let r=this.options(e,t),i=r.index?this.store.index(r.index):this.store;if(typeof i.getAll=="function"){let s=i.getAll(r.range);return new b((o,l)=>{s.onerror=u=>{l(u.target.error)},s.onsuccess=u=>{o(u.target.result)}})}{let s=this.cursor(r),o=[];return this.W(s,(l,u)=>{o.push(u)}).next(()=>o)}}G(e,t){let r=this.store.getAll(e,t===null?void 0:t);return new b((i,s)=>{r.onerror=o=>{s(o.target.error)},r.onsuccess=o=>{i(o.target.result)}})}j(e,t){V("SimpleDb","DELETE ALL",this.store.name);let r=this.options(e,t);r.H=!1;let i=this.cursor(r);return this.W(i,(s,o,l)=>l.delete())}J(e,t){let r;t?r=e:(r={},t=e);let i=this.cursor(r);return this.W(i,t)}Y(e){let t=this.cursor({});return new b((r,i)=>{t.onerror=s=>{let o=Dm(s.target.error);i(o)},t.onsuccess=s=>{let o=s.target.result;o?e(o.primaryKey,o.value).next(l=>{l?o.continue():r()}):r()}})}W(e,t){let r=[];return new b((i,s)=>{e.onerror=o=>{s(o.target.error)},e.onsuccess=o=>{let l=o.target.result;if(!l)return void i();let u=new Ld(l),c=t(l.primaryKey,l.value,u);if(c instanceof b){let d=c.catch(m=>(u.done(),b.reject(m)));r.push(d)}u.isDone?i():u.K===null?l.continue():l.continue(u.K)}}).next(()=>b.waitFor(r))}options(e,t){let r;return e!==void 0&&(typeof e=="string"?r=e:t=e),{index:r,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let r=this.store.index(e.index);return e.H?r.openKeyCursor(e.range,t):r.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}};function lr(n){return new b((e,t)=>{n.onsuccess=r=>{let i=r.target.result;e(i)},n.onerror=r=>{let i=Dm(r.target.error);t(i)}})}var pv=!1;function Dm(n){let e=Vn.S(ds());if(e>=12.2&&e<13){let t="An internal error was encountered in the Indexed Database server";if(n.message.indexOf(t)>=0){let r=new k("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return pv||(pv=!0,setTimeout(()=>{throw r},0)),r}}return n}var Bd=class{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return this.task!==null}X(e){V("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,()=>N(this,null,function*(){this.task=null;try{V("IndexBackfiller",`Documents written: ${yield this.Z.ee()}`)}catch(t){Kn(t)?V("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):yield jn(t)}yield this.X(6e4)}))}},qd=class{constructor(e,t){this.localStore=e,this.persistence=t}ee(e=50){return N(this,null,function*(){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))})}te(e,t){let r=new Set,i=t,s=!0;return b.doWhile(()=>s===!0&&i>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(o=>{if(o!==null&&!r.has(o))return V("IndexBackfiller",`Processing collection: ${o}`),this.ne(e,o,i).next(l=>{i-=l,r.add(o)});s=!1})).next(()=>t-i)}ne(e,t,r){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(i=>this.localStore.localDocuments.getNextDocuments(e,t,i,r).next(s=>{let o=s.changes;return this.localStore.indexManager.updateIndexEntries(e,o).next(()=>this.re(i,s)).next(l=>(V("IndexBackfiller",`Updating offset: ${l}`),this.localStore.indexManager.updateCollectionGroup(e,t,l))).next(()=>o.size)}))}re(e,t){let r=e;return t.changes.forEach((i,s)=>{let o=Ew(s);Nm(o,r)>0&&(r=o)}),new Et(r.readTime,r.documentKey,Math.max(t.batchId,e.largestBatchId))}};var ft=(()=>{class n{constructor(t,r){this.previousValue=t,r&&(r.sequenceNumberHandler=i=>this.ie(i),this.se=i=>r.writeSequenceNumber(i))}ie(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){let t=++this.previousValue;return this.se&&this.se(t),t}}return n.oe=-1,n})();function Ro(n){return n==null}function ao(n){return n===0&&1/n==-1/0}function Aw(n){return typeof n=="number"&&Number.isInteger(n)&&!ao(n)&&n<=Number.MAX_SAFE_INTEGER&&n>=Number.MIN_SAFE_INTEGER}function rt(n){let e="";for(let t=0;t<n.length;t++)e.length>0&&(e=gv(e)),e=US(n.get(t),e);return gv(e)}function US(n,e){let t=e,r=n.length;for(let i=0;i<r;i++){let s=n.charAt(i);switch(s){case"\0":t+="";break;case"":t+="";break;default:t+=s}}return t}function gv(n){return n+""}function Lt(n){let e=n.length;if(G(e>=2),e===2)return G(n.charAt(0)===""&&n.charAt(1)===""),se.emptyPath();let t=e-2,r=[],i="";for(let s=0;s<e;){let o=n.indexOf("",s);switch((o<0||o>t)&&U(),n.charAt(o+1)){case"":let l=n.substring(s,o),u;i.length===0?u=l:(i+=l,u=i,i=""),r.push(u);break;case"":i+=n.substring(s,o),i+="\0";break;case"":i+=n.substring(s,o+1);break;default:U()}s=o+2}return new se(r)}var _v=["userId","batchId"];function Rl(n,e){return[n,rt(e)]}function Sw(n,e,t){return[n,rt(e),t]}var BS={},qS=["prefixPath","collectionGroup","readTime","documentId"],GS=["prefixPath","collectionGroup","documentId"],jS=["collectionGroup","readTime","prefixPath","documentId"],KS=["canonicalId","targetId"],zS=["targetId","path"],WS=["path","targetId"],QS=["collectionId","parent"],$S=["indexId","uid"],HS=["uid","sequenceNumber"],YS=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],JS=["indexId","uid","orderedDocumentKey"],XS=["userId","collectionPath","documentId"],ZS=["userId","collectionPath","largestBatchId"],eC=["userId","collectionGroup","largestBatchId"],Cw=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],tC=[...Cw,"documentOverlays"],bw=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Rw=bw,km=[...Rw,"indexConfiguration","indexState","indexEntries"],nC=km,rC=[...km,"globals"];var lo=class extends Fl{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}};function Me(n,e){let t=M(n);return Vn.F(t._e,e)}function yv(n){let e=0;for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e++;return e}function Sr(n,e){for(let t in n)Object.prototype.hasOwnProperty.call(n,t)&&e(t,n[t])}function Pw(n){for(let e in n)if(Object.prototype.hasOwnProperty.call(n,e))return!1;return!0}var _e=class n{constructor(e,t){this.comparator=e,this.root=t||Bt.EMPTY}insert(e,t){return new n(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Bt.BLACK,null,null))}remove(e){return new n(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Bt.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let r=this.comparator(e,t.key);if(r===0)return t.value;r<0?t=t.left:r>0&&(t=t.right)}return null}indexOf(e){let t=0,r=this.root;for(;!r.isEmpty();){let i=this.comparator(e,r.key);if(i===0)return t+r.left.size;i<0?r=r.left:(t+=r.left.size+1,r=r.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,r)=>(e(t,r),!1))}toString(){let e=[];return this.inorderTraversal((t,r)=>(e.push(`${t}:${r}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new fi(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new fi(this.root,e,this.comparator,!1)}getReverseIterator(){return new fi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new fi(this.root,e,this.comparator,!0)}},fi=class{constructor(e,t,r,i){this.isReverse=i,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?r(e.key,t):1,t&&i&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(s===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}},Bt=class n{constructor(e,t,r,i,s){this.key=e,this.value=t,this.color=r??n.RED,this.left=i??n.EMPTY,this.right=s??n.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,r,i,s){return new n(e??this.key,t??this.value,r??this.color,i??this.left,s??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,r){let i=this,s=r(e,i.key);return i=s<0?i.copy(null,null,null,i.left.insert(e,t,r),null):s===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,r)),i.fixUp()}removeMin(){if(this.left.isEmpty())return n.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let r,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return n.EMPTY;r=i.right.min(),i=i.copy(r.key,r.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){let e=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){let e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw U();let e=this.left.check();if(e!==this.right.check())throw U();return e+(this.isRed()?0:1)}};Bt.EMPTY=null,Bt.RED=!0,Bt.BLACK=!1;Bt.EMPTY=new class{constructor(){this.size=0}get key(){throw U()}get value(){throw U()}get color(){throw U()}get left(){throw U()}get right(){throw U()}copy(e,t,r,i,s){return this}insert(e,t,r){return new Bt(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var fe=class n{constructor(e){this.comparator=e,this.data=new _e(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,r)=>(e(t),!1))}forEachInRange(e,t){let r=this.data.getIteratorFrom(e[0]);for(;r.hasNext();){let i=r.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let r;for(r=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();r.hasNext();)if(!e(r.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Ll(this.data.getIterator())}getIteratorFrom(e){return new Ll(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(r=>{t=t.add(r)}),t}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.data.getIterator(),r=e.data.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(this.comparator(i,s)!==0)return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new n(this.comparator);return t.data=e,t}},Ll=class{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};function ii(n){return n.hasNext()?n.getNext():void 0}var mt=class n{constructor(e){this.fields=e,e.sort(Ce.comparator)}static empty(){return new n([])}unionWith(e){let t=new fe(Ce.comparator);for(let r of this.fields)t=t.add(r);for(let r of e)t=t.add(r);return new n(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return _i(this.fields,e.fields,(t,r)=>t.isEqual(r))}};var Ul=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};function xw(){return typeof atob<"u"}var Re=class n{constructor(e){this.binaryString=e}static fromBase64String(e){let t=function(i){try{return atob(i)}catch(s){throw typeof DOMException<"u"&&s instanceof DOMException?new Ul("Invalid base64 string: "+s):s}}(e);return new n(t)}static fromUint8Array(e){let t=function(i){let s="";for(let o=0;o<i.length;++o)s+=String.fromCharCode(i[o]);return s}(e);return new n(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){let r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return W(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}};Re.EMPTY_BYTE_STRING=new Re("");var iC=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function nn(n){if(G(!!n),typeof n=="string"){let e=0,t=iC.exec(n);if(G(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}let r=new Date(n);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:ve(n.seconds),nanos:ve(n.nanos)}}function ve(n){return typeof n=="number"?n:typeof n=="string"?Number(n):0}function On(n){return typeof n=="string"?Re.fromBase64String(n):Re.fromUint8Array(n)}function xu(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function Vm(n){let e=n.mapValue.fields.__previous_value__;return xu(e)?Vm(e):e}function uo(n){let e=nn(n.mapValue.fields.__local_write_time__.timestampValue);return new Ee(e.seconds,e.nanos)}var Gd=class{constructor(e,t,r,i,s,o,l,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=r,this.host=i,this.ssl=s,this.forceLongPolling=o,this.autoDetectLongPolling=l,this.longPollingOptions=u,this.useFetchStreams=c}},Fn=class n{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new n("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof n&&e.projectId===this.projectId&&e.database===this.database}};var Nn={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Pl={nullValue:"NULL_VALUE"};function mr(n){return"nullValue"in n?0:"booleanValue"in n?1:"integerValue"in n||"doubleValue"in n?2:"timestampValue"in n?3:"stringValue"in n?5:"bytesValue"in n?6:"referenceValue"in n?7:"geoPointValue"in n?8:"arrayValue"in n?9:"mapValue"in n?xu(n)?4:Nw(n)?9007199254740991:Nu(n)?10:11:U()}function jt(n,e){if(n===e)return!0;let t=mr(n);if(t!==mr(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return n.booleanValue===e.booleanValue;case 4:return uo(n).isEqual(uo(e));case 3:return function(i,s){if(typeof i.timestampValue=="string"&&typeof s.timestampValue=="string"&&i.timestampValue.length===s.timestampValue.length)return i.timestampValue===s.timestampValue;let o=nn(i.timestampValue),l=nn(s.timestampValue);return o.seconds===l.seconds&&o.nanos===l.nanos}(n,e);case 5:return n.stringValue===e.stringValue;case 6:return function(i,s){return On(i.bytesValue).isEqual(On(s.bytesValue))}(n,e);case 7:return n.referenceValue===e.referenceValue;case 8:return function(i,s){return ve(i.geoPointValue.latitude)===ve(s.geoPointValue.latitude)&&ve(i.geoPointValue.longitude)===ve(s.geoPointValue.longitude)}(n,e);case 2:return function(i,s){if("integerValue"in i&&"integerValue"in s)return ve(i.integerValue)===ve(s.integerValue);if("doubleValue"in i&&"doubleValue"in s){let o=ve(i.doubleValue),l=ve(s.doubleValue);return o===l?ao(o)===ao(l):isNaN(o)&&isNaN(l)}return!1}(n,e);case 9:return _i(n.arrayValue.values||[],e.arrayValue.values||[],jt);case 10:case 11:return function(i,s){let o=i.mapValue.fields||{},l=s.mapValue.fields||{};if(yv(o)!==yv(l))return!1;for(let u in o)if(o.hasOwnProperty(u)&&(l[u]===void 0||!jt(o[u],l[u])))return!1;return!0}(n,e);default:return U()}}function co(n,e){return(n.values||[]).find(t=>jt(t,e))!==void 0}function Mn(n,e){if(n===e)return 0;let t=mr(n),r=mr(e);if(t!==r)return W(t,r);switch(t){case 0:case 9007199254740991:return 0;case 1:return W(n.booleanValue,e.booleanValue);case 2:return function(s,o){let l=ve(s.integerValue||s.doubleValue),u=ve(o.integerValue||o.doubleValue);return l<u?-1:l>u?1:l===u?0:isNaN(l)?isNaN(u)?0:-1:1}(n,e);case 3:return vv(n.timestampValue,e.timestampValue);case 4:return vv(uo(n),uo(e));case 5:return W(n.stringValue,e.stringValue);case 6:return function(s,o){let l=On(s),u=On(o);return l.compareTo(u)}(n.bytesValue,e.bytesValue);case 7:return function(s,o){let l=s.split("/"),u=o.split("/");for(let c=0;c<l.length&&c<u.length;c++){let d=W(l[c],u[c]);if(d!==0)return d}return W(l.length,u.length)}(n.referenceValue,e.referenceValue);case 8:return function(s,o){let l=W(ve(s.latitude),ve(o.latitude));return l!==0?l:W(ve(s.longitude),ve(o.longitude))}(n.geoPointValue,e.geoPointValue);case 9:return wv(n.arrayValue,e.arrayValue);case 10:return function(s,o){var l,u,c,d;let m=s.fields||{},p=o.fields||{},y=(l=m.value)===null||l===void 0?void 0:l.arrayValue,S=(u=p.value)===null||u===void 0?void 0:u.arrayValue,x=W(((c=y?.values)===null||c===void 0?void 0:c.length)||0,((d=S?.values)===null||d===void 0?void 0:d.length)||0);return x!==0?x:wv(y,S)}(n.mapValue,e.mapValue);case 11:return function(s,o){if(s===Nn.mapValue&&o===Nn.mapValue)return 0;if(s===Nn.mapValue)return 1;if(o===Nn.mapValue)return-1;let l=s.fields||{},u=Object.keys(l),c=o.fields||{},d=Object.keys(c);u.sort(),d.sort();for(let m=0;m<u.length&&m<d.length;++m){let p=W(u[m],d[m]);if(p!==0)return p;let y=Mn(l[u[m]],c[d[m]]);if(y!==0)return y}return W(u.length,d.length)}(n.mapValue,e.mapValue);default:throw U()}}function vv(n,e){if(typeof n=="string"&&typeof e=="string"&&n.length===e.length)return W(n,e);let t=nn(n),r=nn(e),i=W(t.seconds,r.seconds);return i!==0?i:W(t.nanos,r.nanos)}function wv(n,e){let t=n.values||[],r=e.values||[];for(let i=0;i<t.length&&i<r.length;++i){let s=Mn(t[i],r[i]);if(s)return s}return W(t.length,r.length)}function vi(n){return jd(n)}function jd(n){return"nullValue"in n?"null":"booleanValue"in n?""+n.booleanValue:"integerValue"in n?""+n.integerValue:"doubleValue"in n?""+n.doubleValue:"timestampValue"in n?function(t){let r=nn(t);return`time(${r.seconds},${r.nanos})`}(n.timestampValue):"stringValue"in n?n.stringValue:"bytesValue"in n?function(t){return On(t).toBase64()}(n.bytesValue):"referenceValue"in n?function(t){return L.fromName(t).toString()}(n.referenceValue):"geoPointValue"in n?function(t){return`geo(${t.latitude},${t.longitude})`}(n.geoPointValue):"arrayValue"in n?function(t){let r="[",i=!0;for(let s of t.values||[])i?i=!1:r+=",",r+=jd(s);return r+"]"}(n.arrayValue):"mapValue"in n?function(t){let r=Object.keys(t.fields||{}).sort(),i="{",s=!0;for(let o of r)s?s=!1:i+=",",i+=`${o}:${jd(t.fields[o])}`;return i+"}"}(n.mapValue):U()}function pr(n,e){return{referenceValue:`projects/${n.projectId}/databases/${n.database}/documents/${e.path.canonicalString()}`}}function Kd(n){return!!n&&"integerValue"in n}function ho(n){return!!n&&"arrayValue"in n}function Ev(n){return!!n&&"nullValue"in n}function Iv(n){return!!n&&"doubleValue"in n&&isNaN(Number(n.doubleValue))}function xl(n){return!!n&&"mapValue"in n}function Nu(n){var e,t;return((t=(((e=n?.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="__vector__"}function to(n){if(n.geoPointValue)return{geoPointValue:Object.assign({},n.geoPointValue)};if(n.timestampValue&&typeof n.timestampValue=="object")return{timestampValue:Object.assign({},n.timestampValue)};if(n.mapValue){let e={mapValue:{fields:{}}};return Sr(n.mapValue.fields,(t,r)=>e.mapValue.fields[t]=to(r)),e}if(n.arrayValue){let e={arrayValue:{values:[]}};for(let t=0;t<(n.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=to(n.arrayValue.values[t]);return e}return Object.assign({},n)}function Nw(n){return(((n.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var Dw={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function sC(n){return"nullValue"in n?Pl:"booleanValue"in n?{booleanValue:!1}:"integerValue"in n||"doubleValue"in n?{doubleValue:NaN}:"timestampValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in n?{stringValue:""}:"bytesValue"in n?{bytesValue:""}:"referenceValue"in n?pr(Fn.empty(),L.empty()):"geoPointValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in n?{arrayValue:{}}:"mapValue"in n?Nu(n)?Dw:{mapValue:{}}:U()}function oC(n){return"nullValue"in n?{booleanValue:!1}:"booleanValue"in n?{doubleValue:NaN}:"integerValue"in n||"doubleValue"in n?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in n?{stringValue:""}:"stringValue"in n?{bytesValue:""}:"bytesValue"in n?pr(Fn.empty(),L.empty()):"referenceValue"in n?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in n?{arrayValue:{}}:"arrayValue"in n?Dw:"mapValue"in n?Nu(n)?{mapValue:{}}:Nn:U()}function Tv(n,e){let t=Mn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?-1:!n.inclusive&&e.inclusive?1:0}function Av(n,e){let t=Mn(n.value,e.value);return t!==0?t:n.inclusive&&!e.inclusive?1:!n.inclusive&&e.inclusive?-1:0}var Ye=class n{constructor(e){this.value=e}static empty(){return new n({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let r=0;r<e.length-1;++r)if(t=(t.mapValue.fields||{})[e.get(r)],!xl(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=to(t)}setAll(e){let t=Ce.emptyPath(),r={},i=[];e.forEach((o,l)=>{if(!t.isImmediateParentOf(l)){let u=this.getFieldsMap(t);this.applyChanges(u,r,i),r={},i=[],t=l.popLast()}o?r[l.lastSegment()]=to(o):i.push(l.lastSegment())});let s=this.getFieldsMap(t);this.applyChanges(s,r,i)}delete(e){let t=this.field(e.popLast());xl(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return jt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let r=0;r<e.length;++r){let i=t.mapValue.fields[e.get(r)];xl(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(r)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,r){Sr(t,(i,s)=>e[i]=s);for(let i of r)delete e[i]}clone(){return new n(to(this.value))}};function kw(n){let e=[];return Sr(n.fields,(t,r)=>{let i=new Ce([t]);if(xl(r)){let s=kw(r.mapValue).fields;if(s.length===0)e.push(i);else for(let o of s)e.push(i.child(o))}else e.push(i)}),new mt(e)}var ke=class n{constructor(e,t,r,i,s,o,l){this.key=e,this.documentType=t,this.version=r,this.readTime=i,this.createTime=s,this.data=o,this.documentState=l}static newInvalidDocument(e){return new n(e,0,K.min(),K.min(),K.min(),Ye.empty(),0)}static newFoundDocument(e,t,r,i){return new n(e,1,t,K.min(),r,i,0)}static newNoDocument(e,t){return new n(e,2,t,K.min(),K.min(),Ye.empty(),0)}static newUnknownDocument(e,t){return new n(e,3,t,K.min(),K.min(),Ye.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(K.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ye.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ye.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=K.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof n&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new n(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Kt=class{constructor(e,t){this.position=e,this.inclusive=t}};function Sv(n,e,t){let r=0;for(let i=0;i<n.position.length;i++){let s=e[i],o=n.position[i];if(s.field.isKeyField()?r=L.comparator(L.fromName(o.referenceValue),t.key):r=Mn(o,t.data.field(s.field)),s.dir==="desc"&&(r*=-1),r!==0)break}return r}function Cv(n,e){if(n===null)return e===null;if(e===null||n.inclusive!==e.inclusive||n.position.length!==e.position.length)return!1;for(let t=0;t<n.position.length;t++)if(!jt(n.position[t],e.position[t]))return!1;return!0}var gr=class{constructor(e,t="asc"){this.field=e,this.dir=t}};function aC(n,e){return n.dir===e.dir&&n.field.isEqual(e.field)}var Bl=class{},te=class n extends Bl{constructor(e,t,r){super(),this.field=e,this.op=t,this.value=r}static create(e,t,r){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,r):new Qd(e,t,r):t==="array-contains"?new Yd(e,r):t==="in"?new ql(e,r):t==="not-in"?new Jd(e,r):t==="array-contains-any"?new Xd(e,r):new n(e,t,r)}static createKeyFieldInFilter(e,t,r){return t==="in"?new $d(e,r):new Hd(e,r)}matches(e){let t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Mn(t,this.value)):t!==null&&mr(this.value)===mr(t)&&this.matchesComparison(Mn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return U()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},ce=class n extends Bl{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new n(e,t)}matches(e){return wi(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}};function wi(n){return n.op==="and"}function zd(n){return n.op==="or"}function Om(n){return Vw(n)&&wi(n)}function Vw(n){for(let e of n.filters)if(e instanceof ce)return!1;return!0}function Wd(n){if(n instanceof te)return n.field.canonicalString()+n.op.toString()+vi(n.value);if(Om(n))return n.filters.map(e=>Wd(e)).join(",");{let e=n.filters.map(t=>Wd(t)).join(",");return`${n.op}(${e})`}}function Ow(n,e){return n instanceof te?function(r,i){return i instanceof te&&r.op===i.op&&r.field.isEqual(i.field)&&jt(r.value,i.value)}(n,e):n instanceof ce?function(r,i){return i instanceof ce&&r.op===i.op&&r.filters.length===i.filters.length?r.filters.reduce((s,o,l)=>s&&Ow(o,i.filters[l]),!0):!1}(n,e):void U()}function Fw(n,e){let t=n.filters.concat(e);return ce.create(t,n.op)}function Mw(n){return n instanceof te?function(t){return`${t.field.canonicalString()} ${t.op} ${vi(t.value)}`}(n):n instanceof ce?function(t){return t.op.toString()+" {"+t.getFilters().map(Mw).join(" ,")+"}"}(n):"Filter"}var Qd=class extends te{constructor(e,t,r){super(e,t,r),this.key=L.fromName(r.referenceValue)}matches(e){let t=L.comparator(e.key,this.key);return this.matchesComparison(t)}},$d=class extends te{constructor(e,t){super(e,"in",t),this.keys=Lw("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}},Hd=class extends te{constructor(e,t){super(e,"not-in",t),this.keys=Lw("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}};function Lw(n,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(r=>L.fromName(r.referenceValue))}var Yd=class extends te{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return ho(t)&&co(t.arrayValue,this.value)}},ql=class extends te{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return t!==null&&co(this.value.arrayValue,t)}},Jd=class extends te{constructor(e,t){super(e,"not-in",t)}matches(e){if(co(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return t!==null&&!co(this.value.arrayValue,t)}},Xd=class extends te{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!ho(t)||!t.arrayValue.values)&&t.arrayValue.values.some(r=>co(this.value.arrayValue,r))}};var Zd=class{constructor(e,t=null,r=[],i=[],s=null,o=null,l=null){this.path=e,this.collectionGroup=t,this.orderBy=r,this.filters=i,this.limit=s,this.startAt=o,this.endAt=l,this.ue=null}};function ef(n,e=null,t=[],r=[],i=null,s=null,o=null){return new Zd(n,e,t,r,i,s,o)}function _r(n){let e=M(n);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(r=>Wd(r)).join(","),t+="|ob:",t+=e.orderBy.map(r=>function(s){return s.field.canonicalString()+s.dir}(r)).join(","),Ro(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(r=>vi(r)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(r=>vi(r)).join(",")),e.ue=t}return e.ue}function Po(n,e){if(n.limit!==e.limit||n.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<n.orderBy.length;t++)if(!aC(n.orderBy[t],e.orderBy[t]))return!1;if(n.filters.length!==e.filters.length)return!1;for(let t=0;t<n.filters.length;t++)if(!Ow(n.filters[t],e.filters[t]))return!1;return n.collectionGroup===e.collectionGroup&&!!n.path.isEqual(e.path)&&!!Cv(n.startAt,e.startAt)&&Cv(n.endAt,e.endAt)}function Gl(n){return L.isDocumentKey(n.path)&&n.collectionGroup===null&&n.filters.length===0}function jl(n,e){return n.filters.filter(t=>t instanceof te&&t.field.isEqual(e))}function bv(n,e,t){let r=Pl,i=!0;for(let s of jl(n,e)){let o=Pl,l=!0;switch(s.op){case"<":case"<=":o=sC(s.value);break;case"==":case"in":case">=":o=s.value;break;case">":o=s.value,l=!1;break;case"!=":case"not-in":o=Pl}Tv({value:r,inclusive:i},{value:o,inclusive:l})<0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Tv({value:r,inclusive:i},{value:o,inclusive:t.inclusive})<0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}function Rv(n,e,t){let r=Nn,i=!0;for(let s of jl(n,e)){let o=Nn,l=!0;switch(s.op){case">=":case">":o=oC(s.value),l=!1;break;case"==":case"in":case"<=":o=s.value;break;case"<":o=s.value,l=!1;break;case"!=":case"not-in":o=Nn}Av({value:r,inclusive:i},{value:o,inclusive:l})>0&&(r=o,i=l)}if(t!==null){for(let s=0;s<n.orderBy.length;++s)if(n.orderBy[s].field.isEqual(e)){let o=t.position[s];Av({value:r,inclusive:i},{value:o,inclusive:t.inclusive})>0&&(r=o,i=t.inclusive);break}}return{value:r,inclusive:i}}var bt=class{constructor(e,t=null,r=[],i=[],s=null,o="F",l=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=r,this.filters=i,this.limit=s,this.limitType=o,this.startAt=l,this.endAt=u,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}};function Uw(n,e,t,r,i,s,o,l){return new bt(n,e,t,r,i,s,o,l)}function Oi(n){return new bt(n)}function Pv(n){return n.filters.length===0&&n.limit===null&&n.startAt==null&&n.endAt==null&&(n.explicitOrderBy.length===0||n.explicitOrderBy.length===1&&n.explicitOrderBy[0].field.isKeyField())}function Fm(n){return n.collectionGroup!==null}function pi(n){let e=M(n);if(e.ce===null){e.ce=[];let t=new Set;for(let s of e.explicitOrderBy)e.ce.push(s),t.add(s.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(o){let l=new fe(Ce.comparator);return o.filters.forEach(u=>{u.getFlattenedFilters().forEach(c=>{c.isInequality()&&(l=l.add(c.field))})}),l})(e).forEach(s=>{t.has(s.canonicalString())||s.isKeyField()||e.ce.push(new gr(s,r))}),t.has(Ce.keyField().canonicalString())||e.ce.push(new gr(Ce.keyField(),r))}return e.ce}function it(n){let e=M(n);return e.le||(e.le=lC(e,pi(n))),e.le}function lC(n,e){if(n.limitType==="F")return ef(n.path,n.collectionGroup,e,n.filters,n.limit,n.startAt,n.endAt);{e=e.map(i=>{let s=i.dir==="desc"?"asc":"desc";return new gr(i.field,s)});let t=n.endAt?new Kt(n.endAt.position,n.endAt.inclusive):null,r=n.startAt?new Kt(n.startAt.position,n.startAt.inclusive):null;return ef(n.path,n.collectionGroup,e,n.filters,n.limit,t,r)}}function tf(n,e){let t=n.filters.concat([e]);return new bt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),t,n.limit,n.limitType,n.startAt,n.endAt)}function Kl(n,e,t){return new bt(n.path,n.collectionGroup,n.explicitOrderBy.slice(),n.filters.slice(),e,t,n.startAt,n.endAt)}function xo(n,e){return Po(it(n),it(e))&&n.limitType===e.limitType}function Bw(n){return`${_r(it(n))}|lt:${n.limitType}`}function ui(n){return`Query(target=${function(t){let r=t.path.canonicalString();return t.collectionGroup!==null&&(r+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(r+=`, filters: [${t.filters.map(i=>Mw(i)).join(", ")}]`),Ro(t.limit)||(r+=", limit: "+t.limit),t.orderBy.length>0&&(r+=`, orderBy: [${t.orderBy.map(i=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(i)).join(", ")}]`),t.startAt&&(r+=", startAt: ",r+=t.startAt.inclusive?"b:":"a:",r+=t.startAt.position.map(i=>vi(i)).join(",")),t.endAt&&(r+=", endAt: ",r+=t.endAt.inclusive?"a:":"b:",r+=t.endAt.position.map(i=>vi(i)).join(",")),`Target(${r})`}(it(n))}; limitType=${n.limitType})`}function No(n,e){return e.isFoundDocument()&&function(r,i){let s=i.key.path;return r.collectionGroup!==null?i.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(s):L.isDocumentKey(r.path)?r.path.isEqual(s):r.path.isImmediateParentOf(s)}(n,e)&&function(r,i){for(let s of pi(r))if(!s.field.isKeyField()&&i.data.field(s.field)===null)return!1;return!0}(n,e)&&function(r,i){for(let s of r.filters)if(!s.matches(i))return!1;return!0}(n,e)&&function(r,i){return!(r.startAt&&!function(o,l,u){let c=Sv(o,l,u);return o.inclusive?c<=0:c<0}(r.startAt,pi(r),i)||r.endAt&&!function(o,l,u){let c=Sv(o,l,u);return o.inclusive?c>=0:c>0}(r.endAt,pi(r),i))}(n,e)}function qw(n){return n.collectionGroup||(n.path.length%2==1?n.path.lastSegment():n.path.get(n.path.length-2))}function Gw(n){return(e,t)=>{let r=!1;for(let i of pi(n)){let s=uC(i,e,t);if(s!==0)return s;r=r||i.field.isKeyField()}return 0}}function uC(n,e,t){let r=n.field.isKeyField()?L.comparator(e.key,t.key):function(s,o,l){let u=o.data.field(s),c=l.data.field(s);return u!==null&&c!==null?Mn(u,c):U()}(n.field,e,t);switch(n.dir){case"asc":return r;case"desc":return-1*r;default:return U()}}var zt=class{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r!==void 0){for(let[i,s]of r)if(this.equalsFn(i,e))return s}}has(e){return this.get(e)!==void 0}set(e,t){let r=this.mapKeyFn(e),i=this.inner[r];if(i===void 0)return this.inner[r]=[[e,t]],void this.innerSize++;for(let s=0;s<i.length;s++)if(this.equalsFn(i[s][0],e))return void(i[s]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),r=this.inner[t];if(r===void 0)return!1;for(let i=0;i<r.length;i++)if(this.equalsFn(r[i][0],e))return r.length===1?delete this.inner[t]:r.splice(i,1),this.innerSize--,!0;return!1}forEach(e){Sr(this.inner,(t,r)=>{for(let[i,s]of r)e(i,s)})}isEmpty(){return Pw(this.inner)}size(){return this.innerSize}};var cC=new _e(L.comparator);function at(){return cC}var jw=new _e(L.comparator);function Zs(...n){let e=jw;for(let t of n)e=e.insert(t.key,t);return e}function Kw(n){let e=jw;return n.forEach((t,r)=>e=e.insert(t,r.overlayedDocument)),e}function Ut(){return no()}function zw(){return no()}function no(){return new zt(n=>n.toString(),(n,e)=>n.isEqual(e))}var hC=new _e(L.comparator),dC=new fe(L.comparator);function H(...n){let e=dC;for(let t of n)e=e.add(t);return e}var fC=new fe(W);function Mm(){return fC}function Lm(n,e){if(n.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ao(e)?"-0":e}}function Ww(n){return{integerValue:""+n}}function Qw(n,e){return Aw(e)?Ww(e):Lm(n,e)}var Ei=class{constructor(){this._=void 0}};function mC(n,e,t){return n instanceof Ln?function(i,s){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return s&&xu(s)&&(s=Vm(s)),s&&(o.fields.__previous_value__=s),{mapValue:o}}(t,e):n instanceof rn?Hw(n,e):n instanceof sn?Yw(n,e):function(i,s){let o=$w(i,s),l=xv(o)+xv(i.Pe);return Kd(o)&&Kd(i.Pe)?Ww(l):Lm(i.serializer,l)}(n,e)}function pC(n,e,t){return n instanceof rn?Hw(n,e):n instanceof sn?Yw(n,e):t}function $w(n,e){return n instanceof Un?function(r){return Kd(r)||function(s){return!!s&&"doubleValue"in s}(r)}(e)?e:{integerValue:0}:null}var Ln=class extends Ei{},rn=class extends Ei{constructor(e){super(),this.elements=e}};function Hw(n,e){let t=Jw(e);for(let r of n.elements)t.some(i=>jt(i,r))||t.push(r);return{arrayValue:{values:t}}}var sn=class extends Ei{constructor(e){super(),this.elements=e}};function Yw(n,e){let t=Jw(e);for(let r of n.elements)t=t.filter(i=>!jt(i,r));return{arrayValue:{values:t}}}var Un=class extends Ei{constructor(e,t){super(),this.serializer=e,this.Pe=t}};function xv(n){return ve(n.integerValue||n.doubleValue)}function Jw(n){return ho(n)&&n.arrayValue.values?n.arrayValue.values.slice():[]}var yr=class{constructor(e,t){this.field=e,this.transform=t}};function gC(n,e){return n.field.isEqual(e.field)&&function(r,i){return r instanceof rn&&i instanceof rn||r instanceof sn&&i instanceof sn?_i(r.elements,i.elements,jt):r instanceof Un&&i instanceof Un?jt(r.Pe,i.Pe):r instanceof Ln&&i instanceof Ln}(n.transform,e.transform)}var nf=class{constructor(e,t){this.version=e,this.transformResults=t}},Ae=class n{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new n}static exists(e){return new n(void 0,e)}static updateTime(e){return new n(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}};function Nl(n,e){return n.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(n.updateTime):n.exists===void 0||n.exists===e.isFoundDocument()}var Ii=class{};function Xw(n,e){if(!n.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return n.isNoDocument()?new qn(n.key,Ae.none()):new Bn(n.key,n.data,Ae.none());{let t=n.data,r=Ye.empty(),i=new fe(Ce.comparator);for(let s of e.fields)if(!i.has(s)){let o=t.field(s);o===null&&s.length>1&&(s=s.popLast(),o=t.field(s)),o===null?r.delete(s):r.set(s,o),i=i.add(s)}return new Rt(n.key,r,new mt(i.toArray()),Ae.none())}}function _C(n,e,t){n instanceof Bn?function(i,s,o){let l=i.value.clone(),u=Dv(i.fieldTransforms,s,o.transformResults);l.setAll(u),s.convertToFoundDocument(o.version,l).setHasCommittedMutations()}(n,e,t):n instanceof Rt?function(i,s,o){if(!Nl(i.precondition,s))return void s.convertToUnknownDocument(o.version);let l=Dv(i.fieldTransforms,s,o.transformResults),u=s.data;u.setAll(Zw(i)),u.setAll(l),s.convertToFoundDocument(o.version,u).setHasCommittedMutations()}(n,e,t):function(i,s,o){s.convertToNoDocument(o.version).setHasCommittedMutations()}(0,e,t)}function ro(n,e,t,r){return n instanceof Bn?function(s,o,l,u){if(!Nl(s.precondition,o))return l;let c=s.value.clone(),d=kv(s.fieldTransforms,u,o);return c.setAll(d),o.convertToFoundDocument(o.version,c).setHasLocalMutations(),null}(n,e,t,r):n instanceof Rt?function(s,o,l,u){if(!Nl(s.precondition,o))return l;let c=kv(s.fieldTransforms,u,o),d=o.data;return d.setAll(Zw(s)),d.setAll(c),o.convertToFoundDocument(o.version,d).setHasLocalMutations(),l===null?null:l.unionWith(s.fieldMask.fields).unionWith(s.fieldTransforms.map(m=>m.field))}(n,e,t,r):function(s,o,l){return Nl(s.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):l}(n,e,t)}function yC(n,e){let t=null;for(let r of n.fieldTransforms){let i=e.data.field(r.field),s=$w(r.transform,i||null);s!=null&&(t===null&&(t=Ye.empty()),t.set(r.field,s))}return t||null}function Nv(n,e){return n.type===e.type&&!!n.key.isEqual(e.key)&&!!n.precondition.isEqual(e.precondition)&&!!function(r,i){return r===void 0&&i===void 0||!(!r||!i)&&_i(r,i,(s,o)=>gC(s,o))}(n.fieldTransforms,e.fieldTransforms)&&(n.type===0?n.value.isEqual(e.value):n.type!==1||n.data.isEqual(e.data)&&n.fieldMask.isEqual(e.fieldMask))}var Bn=class extends Ii{constructor(e,t,r,i=[]){super(),this.key=e,this.value=t,this.precondition=r,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}},Rt=class extends Ii{constructor(e,t,r,i,s=[]){super(),this.key=e,this.data=t,this.fieldMask=r,this.precondition=i,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}};function Zw(n){let e=new Map;return n.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){let r=n.data.field(t);e.set(t,r)}}),e}function Dv(n,e,t){let r=new Map;G(n.length===t.length);for(let i=0;i<t.length;i++){let s=n[i],o=s.transform,l=e.data.field(s.field);r.set(s.field,pC(o,l,t[i]))}return r}function kv(n,e,t){let r=new Map;for(let i of n){let s=i.transform,o=t.data.field(i.field);r.set(i.field,mC(s,o,e))}return r}var qn=class extends Ii{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},fo=class extends Ii{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var mo=class{constructor(e,t,r,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=r,this.mutations=i}applyToRemoteDocument(e,t){let r=t.mutationResults;for(let i=0;i<this.mutations.length;i++){let s=this.mutations[i];s.key.isEqual(e.key)&&_C(s,e,r[i])}}applyToLocalView(e,t){for(let r of this.baseMutations)r.key.isEqual(e.key)&&(t=ro(r,e,t,this.localWriteTime));for(let r of this.mutations)r.key.isEqual(e.key)&&(t=ro(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let r=zw();return this.mutations.forEach(i=>{let s=e.get(i.key),o=s.overlayedDocument,l=this.applyToLocalView(o,s.mutatedFields);l=t.has(i.key)?null:l;let u=Xw(o,l);u!==null&&r.set(i.key,u),o.isValidDocument()||o.convertToNoDocument(K.min())}),r}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),H())}isEqual(e){return this.batchId===e.batchId&&_i(this.mutations,e.mutations,(t,r)=>Nv(t,r))&&_i(this.baseMutations,e.baseMutations,(t,r)=>Nv(t,r))}},rf=class n{constructor(e,t,r,i){this.batch=e,this.commitVersion=t,this.mutationResults=r,this.docVersions=i}static from(e,t,r){G(e.mutations.length===r.length);let i=function(){return hC}(),s=e.mutations;for(let o=0;o<s.length;o++)i=i.insert(s[o].key,r[o].version);return new n(e,t,r,i)}};var po=class{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var sf=class{constructor(e,t){this.count=e,this.unchangedNames=t}};var xe,ie;function eE(n){switch(n){default:return U();case P.CANCELLED:case P.UNKNOWN:case P.DEADLINE_EXCEEDED:case P.RESOURCE_EXHAUSTED:case P.INTERNAL:case P.UNAVAILABLE:case P.UNAUTHENTICATED:return!1;case P.INVALID_ARGUMENT:case P.NOT_FOUND:case P.ALREADY_EXISTS:case P.PERMISSION_DENIED:case P.FAILED_PRECONDITION:case P.ABORTED:case P.OUT_OF_RANGE:case P.UNIMPLEMENTED:case P.DATA_LOSS:return!0}}function tE(n){if(n===void 0)return Se("GRPC error has no .code"),P.UNKNOWN;switch(n){case xe.OK:return P.OK;case xe.CANCELLED:return P.CANCELLED;case xe.UNKNOWN:return P.UNKNOWN;case xe.DEADLINE_EXCEEDED:return P.DEADLINE_EXCEEDED;case xe.RESOURCE_EXHAUSTED:return P.RESOURCE_EXHAUSTED;case xe.INTERNAL:return P.INTERNAL;case xe.UNAVAILABLE:return P.UNAVAILABLE;case xe.UNAUTHENTICATED:return P.UNAUTHENTICATED;case xe.INVALID_ARGUMENT:return P.INVALID_ARGUMENT;case xe.NOT_FOUND:return P.NOT_FOUND;case xe.ALREADY_EXISTS:return P.ALREADY_EXISTS;case xe.PERMISSION_DENIED:return P.PERMISSION_DENIED;case xe.FAILED_PRECONDITION:return P.FAILED_PRECONDITION;case xe.ABORTED:return P.ABORTED;case xe.OUT_OF_RANGE:return P.OUT_OF_RANGE;case xe.UNIMPLEMENTED:return P.UNIMPLEMENTED;case xe.DATA_LOSS:return P.DATA_LOSS;default:return U()}}(ie=xe||(xe={}))[ie.OK=0]="OK",ie[ie.CANCELLED=1]="CANCELLED",ie[ie.UNKNOWN=2]="UNKNOWN",ie[ie.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",ie[ie.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",ie[ie.NOT_FOUND=5]="NOT_FOUND",ie[ie.ALREADY_EXISTS=6]="ALREADY_EXISTS",ie[ie.PERMISSION_DENIED=7]="PERMISSION_DENIED",ie[ie.UNAUTHENTICATED=16]="UNAUTHENTICATED",ie[ie.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",ie[ie.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",ie[ie.ABORTED=10]="ABORTED",ie[ie.OUT_OF_RANGE=11]="OUT_OF_RANGE",ie[ie.UNIMPLEMENTED=12]="UNIMPLEMENTED",ie[ie.INTERNAL=13]="INTERNAL",ie[ie.UNAVAILABLE=14]="UNAVAILABLE",ie[ie.DATA_LOSS=15]="DATA_LOSS";var Vv=null;function nE(){return new TextEncoder}var vC=new Cn([4294967295,4294967295],0);function Ov(n){let e=nE().encode(n),t=new vd;return t.update(e),new Uint8Array(t.digest())}function Fv(n){let e=new DataView(n.buffer),t=e.getUint32(0,!0),r=e.getUint32(4,!0),i=e.getUint32(8,!0),s=e.getUint32(12,!0);return[new Cn([t,r],0),new Cn([i,s],0)]}var of=class n{constructor(e,t,r){if(this.bitmap=e,this.padding=t,this.hashCount=r,t<0||t>=8)throw new dr(`Invalid padding: ${t}`);if(r<0)throw new dr(`Invalid hash count: ${r}`);if(e.length>0&&this.hashCount===0)throw new dr(`Invalid hash count: ${r}`);if(e.length===0&&t!==0)throw new dr(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=Cn.fromNumber(this.Ie)}Ee(e,t,r){let i=e.add(t.multiply(Cn.fromNumber(r)));return i.compare(vC)===1&&(i=new Cn([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return(this.bitmap[Math.floor(e/8)]&1<<e%8)!=0}mightContain(e){if(this.Ie===0)return!1;let t=Ov(e),[r,i]=Fv(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);if(!this.de(o))return!1}return!0}static create(e,t,r){let i=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),o=new n(s,i,t);return r.forEach(l=>o.insert(l)),o}insert(e){if(this.Ie===0)return;let t=Ov(e),[r,i]=Fv(t);for(let s=0;s<this.hashCount;s++){let o=this.Ee(r,i,s);this.Ae(o)}}Ae(e){let t=Math.floor(e/8),r=e%8;this.bitmap[t]|=1<<r}},dr=class extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}};var go=class n{constructor(e,t,r,i,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=r,this.documentUpdates=i,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,r){let i=new Map;return i.set(e,_o.createSynthesizedTargetChangeForCurrentChange(e,t,r)),new n(K.min(),i,new _e(W),at(),H())}},_o=class n{constructor(e,t,r,i,s){this.resumeToken=e,this.current=t,this.addedDocuments=r,this.modifiedDocuments=i,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,r){return new n(r,t,H(),H(),H())}};var gi=class{constructor(e,t,r,i){this.Re=e,this.removedTargetIds=t,this.key=r,this.Ve=i}},zl=class{constructor(e,t){this.targetId=e,this.me=t}},Wl=class{constructor(e,t,r=Re.EMPTY_BYTE_STRING,i=null){this.state=e,this.targetIds=t,this.resumeToken=r,this.cause=i}},Ql=class{constructor(){this.fe=0,this.ge=Lv(),this.pe=Re.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=H(),t=H(),r=H();return this.ge.forEach((i,s)=>{switch(s){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:r=r.add(i);break;default:U()}}),new _o(this.pe,this.ye,e,t,r)}Ce(){this.we=!1,this.ge=Lv()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,G(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}},af=class{constructor(e){this.Le=e,this.Be=new Map,this.ke=at(),this.qe=Mv(),this.Qe=new _e(W)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let r=this.Ge(t);switch(e.state){case 0:this.ze(t)&&r.De(e.resumeToken);break;case 1:r.Oe(),r.Se||r.Ce(),r.De(e.resumeToken);break;case 2:r.Oe(),r.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(r.Ne(),r.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),r.De(e.resumeToken));break;default:U()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((r,i)=>{this.ze(i)&&t(i)})}He(e){let t=e.targetId,r=e.me.count,i=this.Je(t);if(i){let s=i.target;if(Gl(s))if(r===0){let o=new L(s.path);this.Ue(t,o,ke.newNoDocument(o,K.min()))}else G(r===1);else{let o=this.Ye(t);if(o!==r){let l=this.Ze(e),u=l?this.Xe(l,e,o):1;if(u!==0){this.je(t);let c=u===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,c)}Vv?.et(function(d,m,p,y,S){var x,D,q,j,B,Y;let ne={localCacheCount:d,existenceFilterCount:m.count,databaseId:p.database,projectId:p.projectId},Q=m.unchangedNames;return Q&&(ne.bloomFilter={applied:S===0,hashCount:(x=Q?.hashCount)!==null&&x!==void 0?x:0,bitmapLength:(j=(q=(D=Q?.bits)===null||D===void 0?void 0:D.bitmap)===null||q===void 0?void 0:q.length)!==null&&j!==void 0?j:0,padding:(Y=(B=Q?.bits)===null||B===void 0?void 0:B.padding)!==null&&Y!==void 0?Y:0,mightContain:E=>{var _;return(_=y?.mightContain(E))!==null&&_!==void 0&&_}}),ne}(o,e.me,this.Le.tt(),l,u))}}}}Ze(e){let t=e.me.unchangedNames;if(!t||!t.bits)return null;let{bits:{bitmap:r="",padding:i=0},hashCount:s=0}=t,o,l;try{o=On(r).toUint8Array()}catch(u){if(u instanceof Ul)return Ct("Decoding the base64 bloom filter in existence filter failed ("+u.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw u}try{l=new of(o,i,s)}catch(u){return Ct(u instanceof dr?"BloomFilter error: ":"Applying bloom filter failed: ",u),null}return l.Ie===0?null:l}Xe(e,t,r){return t.me.count===r-this.nt(e,t.targetId)?0:2}nt(e,t){let r=this.Le.getRemoteKeysForTarget(t),i=0;return r.forEach(s=>{let o=this.Le.tt(),l=`projects/${o.projectId}/databases/${o.database}/documents/${s.path.canonicalString()}`;e.mightContain(l)||(this.Ue(t,s,null),i++)}),i}rt(e){let t=new Map;this.Be.forEach((s,o)=>{let l=this.Je(o);if(l){if(s.current&&Gl(l.target)){let u=new L(l.target.path);this.ke.get(u)!==null||this.it(o,u)||this.Ue(o,u,ke.newNoDocument(u,e))}s.be&&(t.set(o,s.ve()),s.Ce())}});let r=H();this.qe.forEach((s,o)=>{let l=!0;o.forEachWhile(u=>{let c=this.Je(u);return!c||c.purpose==="TargetPurposeLimboResolution"||(l=!1,!1)}),l&&(r=r.add(s))}),this.ke.forEach((s,o)=>o.setReadTime(e));let i=new go(e,t,this.Qe,this.ke,r);return this.ke=at(),this.qe=Mv(),this.Qe=new _e(W),i}$e(e,t){if(!this.ze(e))return;let r=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,r),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,r){if(!this.ze(e))return;let i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),r&&(this.ke=this.ke.insert(t,r))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Ql,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new fe(W),this.qe=this.qe.insert(e,t)),t}ze(e){let t=this.Je(e)!==null;return t||V("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Ql),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}};function Mv(){return new _e(L.comparator)}function Lv(){return new _e(L.comparator)}var wC={asc:"ASCENDING",desc:"DESCENDING"},EC={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},IC={and:"AND",or:"OR"},lf=class{constructor(e,t){this.databaseId=e,this.useProto3Json=t}};function uf(n,e){return n.useProto3Json||Ro(e)?e:{value:e}}function Ti(n,e){return n.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function rE(n,e){return n.useProto3Json?e.toBase64():e.toUint8Array()}function TC(n,e){return Ti(n,e.toTimestamp())}function be(n){return G(!!n),K.fromTimestamp(function(t){let r=nn(t);return new Ee(r.seconds,r.nanos)}(n))}function Um(n,e){return cf(n,e).canonicalString()}function cf(n,e){let t=function(i){return new se(["projects",i.projectId,"databases",i.database])}(n).child("documents");return e===void 0?t:t.child(e)}function iE(n){let e=se.fromString(n);return G(mE(e)),e}function yo(n,e){return Um(n.databaseId,e.path)}function qt(n,e){let t=iE(e);if(t.get(1)!==n.databaseId.projectId)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+t.get(1)+" vs "+n.databaseId.projectId);if(t.get(3)!==n.databaseId.database)throw new k(P.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+t.get(3)+" vs "+n.databaseId.database);return new L(aE(t))}function sE(n,e){return Um(n.databaseId,e)}function oE(n){let e=iE(n);return e.length===4?se.emptyPath():aE(e)}function hf(n){return new se(["projects",n.databaseId.projectId,"databases",n.databaseId.database]).canonicalString()}function aE(n){return G(n.length>4&&n.get(4)==="documents"),n.popFirst(5)}function Uv(n,e,t){return{name:yo(n,e),fields:t.value.mapValue.fields}}function lE(n,e,t){let r=qt(n,e.name),i=be(e.updateTime),s=e.createTime?be(e.createTime):K.min(),o=new Ye({mapValue:{fields:e.fields}}),l=ke.newFoundDocument(r,i,s,o);return t&&l.setHasCommittedMutations(),t?l.setHasCommittedMutations():l}function AC(n,e){return"found"in e?function(r,i){G(!!i.found),i.found.name,i.found.updateTime;let s=qt(r,i.found.name),o=be(i.found.updateTime),l=i.found.createTime?be(i.found.createTime):K.min(),u=new Ye({mapValue:{fields:i.found.fields}});return ke.newFoundDocument(s,o,l,u)}(n,e):"missing"in e?function(r,i){G(!!i.missing),G(!!i.readTime);let s=qt(r,i.missing),o=be(i.readTime);return ke.newNoDocument(s,o)}(n,e):U()}function SC(n,e){let t;if("targetChange"in e){e.targetChange;let r=function(c){return c==="NO_CHANGE"?0:c==="ADD"?1:c==="REMOVE"?2:c==="CURRENT"?3:c==="RESET"?4:U()}(e.targetChange.targetChangeType||"NO_CHANGE"),i=e.targetChange.targetIds||[],s=function(c,d){return c.useProto3Json?(G(d===void 0||typeof d=="string"),Re.fromBase64String(d||"")):(G(d===void 0||d instanceof Buffer||d instanceof Uint8Array),Re.fromUint8Array(d||new Uint8Array))}(n,e.targetChange.resumeToken),o=e.targetChange.cause,l=o&&function(c){let d=c.code===void 0?P.UNKNOWN:tE(c.code);return new k(d,c.message||"")}(o);t=new Wl(r,i,s,l||null)}else if("documentChange"in e){e.documentChange;let r=e.documentChange;r.document,r.document.name,r.document.updateTime;let i=qt(n,r.document.name),s=be(r.document.updateTime),o=r.document.createTime?be(r.document.createTime):K.min(),l=new Ye({mapValue:{fields:r.document.fields}}),u=ke.newFoundDocument(i,s,o,l),c=r.targetIds||[],d=r.removedTargetIds||[];t=new gi(c,d,u.key,u)}else if("documentDelete"in e){e.documentDelete;let r=e.documentDelete;r.document;let i=qt(n,r.document),s=r.readTime?be(r.readTime):K.min(),o=ke.newNoDocument(i,s),l=r.removedTargetIds||[];t=new gi([],l,o.key,o)}else if("documentRemove"in e){e.documentRemove;let r=e.documentRemove;r.document;let i=qt(n,r.document),s=r.removedTargetIds||[];t=new gi([],s,i,null)}else{if(!("filter"in e))return U();{e.filter;let r=e.filter;r.targetId;let{count:i=0,unchangedNames:s}=r,o=new sf(i,s),l=r.targetId;t=new zl(l,o)}}return t}function vo(n,e){let t;if(e instanceof Bn)t={update:Uv(n,e.key,e.value)};else if(e instanceof qn)t={delete:yo(n,e.key)};else if(e instanceof Rt)t={update:Uv(n,e.key,e.data),updateMask:NC(e.fieldMask)};else{if(!(e instanceof fo))return U();t={verify:yo(n,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(r=>function(s,o){let l=o.transform;if(l instanceof Ln)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(l instanceof rn)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:l.elements}};if(l instanceof sn)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:l.elements}};if(l instanceof Un)return{fieldPath:o.field.canonicalString(),increment:l.Pe};throw U()}(0,r))),e.precondition.isNone||(t.currentDocument=function(i,s){return s.updateTime!==void 0?{updateTime:TC(i,s.updateTime)}:s.exists!==void 0?{exists:s.exists}:U()}(n,e.precondition)),t}function df(n,e){let t=e.currentDocument?function(s){return s.updateTime!==void 0?Ae.updateTime(be(s.updateTime)):s.exists!==void 0?Ae.exists(s.exists):Ae.none()}(e.currentDocument):Ae.none(),r=e.updateTransforms?e.updateTransforms.map(i=>function(o,l){let u=null;if("setToServerValue"in l)G(l.setToServerValue==="REQUEST_TIME"),u=new Ln;else if("appendMissingElements"in l){let d=l.appendMissingElements.values||[];u=new rn(d)}else if("removeAllFromArray"in l){let d=l.removeAllFromArray.values||[];u=new sn(d)}else"increment"in l?u=new Un(o,l.increment):U();let c=Ce.fromServerFormat(l.fieldPath);return new yr(c,u)}(n,i)):[];if(e.update){e.update.name;let i=qt(n,e.update.name),s=new Ye({mapValue:{fields:e.update.fields}});if(e.updateMask){let o=function(u){let c=u.fieldPaths||[];return new mt(c.map(d=>Ce.fromServerFormat(d)))}(e.updateMask);return new Rt(i,s,o,t,r)}return new Bn(i,s,t,r)}if(e.delete){let i=qt(n,e.delete);return new qn(i,t)}if(e.verify){let i=qt(n,e.verify);return new fo(i,t)}return U()}function CC(n,e){return n&&n.length>0?(G(e!==void 0),n.map(t=>function(i,s){let o=i.updateTime?be(i.updateTime):be(s);return o.isEqual(K.min())&&(o=be(s)),new nf(o,i.transformResults||[])}(t,e))):[]}function uE(n,e){return{documents:[sE(n,e.path)]}}function cE(n,e){let t={structuredQuery:{}},r=e.path,i;e.collectionGroup!==null?(i=r,t.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(i=r.popLast(),t.structuredQuery.from=[{collectionId:r.lastSegment()}]),t.parent=sE(n,i);let s=function(c){if(c.length!==0)return fE(ce.create(c,"and"))}(e.filters);s&&(t.structuredQuery.where=s);let o=function(c){if(c.length!==0)return c.map(d=>function(p){return{field:ci(p.field),direction:RC(p.dir)}}(d))}(e.orderBy);o&&(t.structuredQuery.orderBy=o);let l=uf(n,e.limit);return l!==null&&(t.structuredQuery.limit=l),e.startAt&&(t.structuredQuery.startAt=function(c){return{before:c.inclusive,values:c.position}}(e.startAt)),e.endAt&&(t.structuredQuery.endAt=function(c){return{before:!c.inclusive,values:c.position}}(e.endAt)),{_t:t,parent:i}}function hE(n){let e=oE(n.parent),t=n.structuredQuery,r=t.from?t.from.length:0,i=null;if(r>0){G(r===1);let d=t.from[0];d.allDescendants?i=d.collectionId:e=e.child(d.collectionId)}let s=[];t.where&&(s=function(m){let p=dE(m);return p instanceof ce&&Om(p)?p.getFilters():[p]}(t.where));let o=[];t.orderBy&&(o=function(m){return m.map(p=>function(S){return new gr(hi(S.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(S.direction))}(p))}(t.orderBy));let l=null;t.limit&&(l=function(m){let p;return p=typeof m=="object"?m.value:m,Ro(p)?null:p}(t.limit));let u=null;t.startAt&&(u=function(m){let p=!!m.before,y=m.values||[];return new Kt(y,p)}(t.startAt));let c=null;return t.endAt&&(c=function(m){let p=!m.before,y=m.values||[];return new Kt(y,p)}(t.endAt)),Uw(e,i,o,s,l,"F",u,c)}function bC(n,e){let t=function(i){switch(i){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return U()}}(e.purpose);return t==null?null:{"goog-listen-tags":t}}function dE(n){return n.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":let r=hi(t.unaryFilter.field);return te.create(r,"==",{doubleValue:NaN});case"IS_NULL":let i=hi(t.unaryFilter.field);return te.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let s=hi(t.unaryFilter.field);return te.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=hi(t.unaryFilter.field);return te.create(o,"!=",{nullValue:"NULL_VALUE"});default:return U()}}(n):n.fieldFilter!==void 0?function(t){return te.create(hi(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return U()}}(t.fieldFilter.op),t.fieldFilter.value)}(n):n.compositeFilter!==void 0?function(t){return ce.create(t.compositeFilter.filters.map(r=>dE(r)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return U()}}(t.compositeFilter.op))}(n):U()}function RC(n){return wC[n]}function PC(n){return EC[n]}function xC(n){return IC[n]}function ci(n){return{fieldPath:n.canonicalString()}}function hi(n){return Ce.fromServerFormat(n.fieldPath)}function fE(n){return n instanceof te?function(t){if(t.op==="=="){if(Iv(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NAN"}};if(Ev(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NULL"}}}else if(t.op==="!="){if(Iv(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NOT_NAN"}};if(Ev(t.value))return{unaryFilter:{field:ci(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:ci(t.field),op:PC(t.op),value:t.value}}}(n):n instanceof ce?function(t){let r=t.getFilters().map(i=>fE(i));return r.length===1?r[0]:{compositeFilter:{op:xC(t.op),filters:r}}}(n):U()}function NC(n){let e=[];return n.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function mE(n){return n.length>=4&&n.get(0)==="projects"&&n.get(2)==="databases"}var Ai=class n{constructor(e,t,r,i,s=K.min(),o=K.min(),l=Re.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=r,this.sequenceNumber=i,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=l,this.expectedCount=u}withSequenceNumber(e){return new n(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new n(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}};var $l=class{constructor(e){this.ct=e}};function DC(n,e){let t;if(e.document)t=lE(n.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){let r=L.fromSegments(e.noDocument.path),i=wr(e.noDocument.readTime);t=ke.newNoDocument(r,i),e.hasCommittedMutations&&t.setHasCommittedMutations()}else{if(!e.unknownDocument)return U();{let r=L.fromSegments(e.unknownDocument.path),i=wr(e.unknownDocument.version);t=ke.newUnknownDocument(r,i)}}return e.readTime&&t.setReadTime(function(i){let s=new Ee(i[0],i[1]);return K.fromTimestamp(s)}(e.readTime)),t}function Bv(n,e){let t=e.key,r={prefixPath:t.getCollectionPath().popLast().toArray(),collectionGroup:t.collectionGroup,documentId:t.path.lastSegment(),readTime:Hl(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(s,o){return{name:yo(s,o.key),fields:o.data.value.mapValue.fields,updateTime:Ti(s,o.version.toTimestamp()),createTime:Ti(s,o.createTime.toTimestamp())}}(n.ct,e);else if(e.isNoDocument())r.noDocument={path:t.path.toArray(),readTime:vr(e.version)};else{if(!e.isUnknownDocument())return U();r.unknownDocument={path:t.path.toArray(),version:vr(e.version)}}return r}function Hl(n){let e=n.toTimestamp();return[e.seconds,e.nanoseconds]}function vr(n){let e=n.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wr(n){let e=new Ee(n.seconds,n.nanoseconds);return K.fromTimestamp(e)}function ur(n,e){let t=(e.baseMutations||[]).map(s=>df(n.ct,s));for(let s=0;s<e.mutations.length-1;++s){let o=e.mutations[s];if(s+1<e.mutations.length&&e.mutations[s+1].transform!==void 0){let l=e.mutations[s+1];o.updateTransforms=l.transform.fieldTransforms,e.mutations.splice(s+1,1),++s}}let r=e.mutations.map(s=>df(n.ct,s)),i=Ee.fromMillis(e.localWriteTimeMs);return new mo(e.batchId,i,t,r)}function eo(n){let e=wr(n.readTime),t=n.lastLimboFreeSnapshotVersion!==void 0?wr(n.lastLimboFreeSnapshotVersion):K.min(),r;return r=function(s){return s.documents!==void 0}(n.query)?function(s){return G(s.documents.length===1),it(Oi(oE(s.documents[0])))}(n.query):function(s){return it(hE(s))}(n.query),new Ai(r,n.targetId,"TargetPurposeListen",n.lastListenSequenceNumber,e,t,Re.fromBase64String(n.resumeToken))}function pE(n,e){let t=vr(e.snapshotVersion),r=vr(e.lastLimboFreeSnapshotVersion),i;i=Gl(e.target)?uE(n.ct,e.target):cE(n.ct,e.target)._t;let s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:_r(e.target),readTime:t,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function Bm(n){let e=hE({parent:n.parent,structuredQuery:n.structuredQuery});return n.limitType==="LAST"?Kl(e,e.limit,"L"):e}function Sd(n,e){return new po(e.largestBatchId,df(n.ct,e.overlayMutation))}function qv(n,e){let t=e.path.lastSegment();return[n,rt(e.path.popLast()),t]}function Gv(n,e,t,r){return{indexId:n,uid:e,sequenceNumber:t,readTime:vr(r.readTime),documentKey:rt(r.documentKey.path),largestBatchId:r.largestBatchId}}var ff=class{getBundleMetadata(e,t){return jv(e).get(t).next(r=>{if(r)return function(s){return{id:s.bundleId,createTime:wr(s.createTime),version:s.version}}(r)})}saveBundleMetadata(e,t){return jv(e).put(function(i){return{bundleId:i.id,createTime:vr(be(i.createTime)),version:i.version}}(t))}getNamedQuery(e,t){return Kv(e).get(t).next(r=>{if(r)return function(s){return{name:s.name,query:Bm(s.bundledQuery),readTime:wr(s.readTime)}}(r)})}saveNamedQuery(e,t){return Kv(e).put(function(i){return{name:i.name,readTime:vr(be(i.readTime)),bundledQuery:i.bundledQuery}}(t))}};function jv(n){return Me(n,"bundles")}function Kv(n){return Me(n,"namedQueries")}var Yl=class n{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){let r=t.uid||"";return new n(e,r)}getOverlay(e,t){return Hs(e).get(qv(this.userId,t)).next(r=>r?Sd(this.serializer,r):null)}getOverlays(e,t){let r=Ut();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){let i=[];return r.forEach((s,o)=>{let l=new po(t,o);i.push(this.ht(e,l))}),b.waitFor(i)}removeOverlaysForBatchId(e,t,r){let i=new Set;t.forEach(o=>i.add(rt(o.getCollectionPath())));let s=[];return i.forEach(o=>{let l=IDBKeyRange.bound([this.userId,o,r],[this.userId,o,r+1],!1,!0);s.push(Hs(e).j("collectionPathOverlayIndex",l))}),b.waitFor(s)}getOverlaysForCollection(e,t,r){let i=Ut(),s=rt(t),o=IDBKeyRange.bound([this.userId,s,r],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Hs(e).U("collectionPathOverlayIndex",o).next(l=>{for(let u of l){let c=Sd(this.serializer,u);i.set(c.getKey(),c)}return i})}getOverlaysForCollectionGroup(e,t,r,i){let s=Ut(),o,l=IDBKeyRange.bound([this.userId,t,r],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Hs(e).J({index:"collectionGroupOverlayIndex",range:l},(u,c,d)=>{let m=Sd(this.serializer,c);s.size()<i||m.largestBatchId===o?(s.set(m.getKey(),m),o=m.largestBatchId):d.done()}).next(()=>s)}ht(e,t){return Hs(e).put(function(i,s,o){let[l,u,c]=qv(s,o.mutation.key);return{userId:s,collectionPath:u,documentId:c,collectionGroup:o.mutation.key.getCollectionGroup(),largestBatchId:o.largestBatchId,overlayMutation:vo(i.ct,o.mutation)}}(this.serializer,this.userId,t))}};function Hs(n){return Me(n,"documentOverlays")}var mf=class{Pt(e){return Me(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(t=>{let r=t?.value;return r?Re.fromUint8Array(r):Re.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}};var en=class{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(e.booleanValue?1:0);else if("integerValue"in e)this.dt(t,15),t.At(ve(e.integerValue));else if("doubleValue"in e){let r=ve(e.doubleValue);isNaN(r)?this.dt(t,13):(this.dt(t,15),ao(r)?t.At(0):t.At(r))}else if("timestampValue"in e){let r=e.timestampValue;this.dt(t,20),typeof r=="string"&&(r=nn(r)),t.Rt(`${r.seconds||""}`),t.At(r.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(On(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let r=e.geoPointValue;this.dt(t,45),t.At(r.latitude||0),t.At(r.longitude||0)}else"mapValue"in e?Nw(e)?this.dt(t,Number.MAX_SAFE_INTEGER):Nu(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):U()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){let r=e.fields||{};this.dt(t,55);for(let i of Object.keys(r))this.Vt(i,t),this.Tt(r[i],t)}wt(e,t){var r,i;let s=e.fields||{};this.dt(t,53);let o="value",l=((i=(r=s[o].arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.length)||0;this.dt(t,15),t.At(ve(l)),this.Vt(o,t),this.Tt(s[o],t)}bt(e,t){let r=e.values||[];this.dt(t,50);for(let i of r)this.Tt(i,t)}yt(e,t){this.dt(t,37),L.fromName(e).path.forEach(r=>{this.dt(t,60),this.Dt(r,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}};en.vt=new en;function kC(n){if(n===0)return 8;let e=0;return!(n>>4)&&(e+=4,n<<=4),!(n>>6)&&(e+=2,n<<=2),!(n>>7)&&(e+=1),e}function zv(n){let e=64-function(r){let i=0;for(let s=0;s<8;++s){let o=kC(255&r[s]);if(i+=o,o!==8)break}return i}(n);return Math.ceil(e/8)}var pf=class{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ft(r.value),r=t.next();this.Mt()}xt(e){let t=e[Symbol.iterator](),r=t.next();for(;!r.done;)this.Ot(r.value),r=t.next();this.Nt()}Lt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ft(r);else if(r<2048)this.Ft(960|r>>>6),this.Ft(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ft(480|r>>>12),this.Ft(128|63&r>>>6),this.Ft(128|63&r);else{let i=t.codePointAt(0);this.Ft(240|i>>>18),this.Ft(128|63&i>>>12),this.Ft(128|63&i>>>6),this.Ft(128|63&i)}}this.Mt()}Bt(e){for(let t of e){let r=t.charCodeAt(0);if(r<128)this.Ot(r);else if(r<2048)this.Ot(960|r>>>6),this.Ot(128|63&r);else if(t<"\uD800"||"\uDBFF"<t)this.Ot(480|r>>>12),this.Ot(128|63&r>>>6),this.Ot(128|63&r);else{let i=t.codePointAt(0);this.Ot(240|i>>>18),this.Ot(128|63&i>>>12),this.Ot(128|63&i>>>6),this.Ot(128|63&i)}}this.Nt()}kt(e){let t=this.qt(e),r=zv(t);this.Qt(1+r),this.buffer[this.position++]=255&r;for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=255&t[i]}Kt(e){let t=this.qt(e),r=zv(t);this.Qt(1+r),this.buffer[this.position++]=~(255&r);for(let i=t.length-r;i<t.length;++i)this.buffer[this.position++]=~(255&t[i])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){let t=function(s){let o=new DataView(new ArrayBuffer(8));return o.setFloat64(0,s,!1),new Uint8Array(o.buffer)}(e),r=(128&t[0])!=0;t[0]^=r?255:128;for(let i=1;i<t.length;++i)t[i]^=r?255:0;return t}Ft(e){let t=255&e;t===0?(this.Ut(0),this.Ut(255)):t===255?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){let t=255&e;t===0?(this.Gt(0),this.Gt(255)):t===255?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let r=2*this.buffer.length;r<t&&(r=t);let i=new Uint8Array(r);i.set(this.buffer),this.buffer=i}},gf=class{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}},_f=class{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}},cr=class{constructor(){this.jt=new pf,this.Ht=new gf(this.jt),this.Jt=new _f(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return e===0?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}};var hr=class n{constructor(e,t,r,i){this.indexId=e,this.documentKey=t,this.arrayValue=r,this.directionalValue=i}Zt(){let e=this.directionalValue.length,t=e===0||this.directionalValue[e-1]===255?e+1:e,r=new Uint8Array(t);return r.set(this.directionalValue,0),t!==e?r.set([0],this.directionalValue.length):++r[r.length-1],new n(this.indexId,this.documentKey,this.arrayValue,r)}};function bn(n,e){let t=n.indexId-e.indexId;return t!==0?t:(t=Wv(n.arrayValue,e.arrayValue),t!==0?t:(t=Wv(n.directionalValue,e.directionalValue),t!==0?t:L.comparator(n.documentKey,e.documentKey)))}function Wv(n,e){for(let t=0;t<n.length&&t<e.length;++t){let r=n[t]-e[t];if(r!==0)return r}return n.length-e.length}var Jl=class{constructor(e){this.Xt=new fe((t,r)=>Ce.comparator(t.field,r.field)),this.collectionId=e.collectionGroup!=null?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[];for(let t of e.filters){let r=t;r.isInequality()?this.Xt=this.Xt.add(r):this.tn.push(r)}}get nn(){return this.Xt.size>1}rn(e){if(G(e.collectionGroup===this.collectionId),this.nn)return!1;let t=Md(e);if(t!==void 0&&!this.sn(t))return!1;let r=ar(e),i=new Set,s=0,o=0;for(;s<r.length&&this.sn(r[s]);++s)i=i.add(r[s].fieldPath.canonicalString());if(s===r.length)return!0;if(this.Xt.size>0){let l=this.Xt.getIterator().getNext();if(!i.has(l.field.canonicalString())){let u=r[s];if(!this.on(l,u)||!this._n(this.en[o++],u))return!1}++s}for(;s<r.length;++s){let l=r[s];if(o>=this.en.length||!this._n(this.en[o++],l))return!1}return!0}an(){if(this.nn)return null;let e=new fe(Ce.comparator),t=[];for(let r of this.tn)if(!r.field.isKeyField())if(r.op==="array-contains"||r.op==="array-contains-any")t.push(new mi(r.field,2));else{if(e.has(r.field))continue;e=e.add(r.field),t.push(new mi(r.field,0))}for(let r of this.en)r.field.isKeyField()||e.has(r.field)||(e=e.add(r.field),t.push(new mi(r.field,r.dir==="asc"?0:1)));return new yi(yi.UNKNOWN_ID,this.collectionId,t,oo.empty())}sn(e){for(let t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(e===void 0||!e.field.isEqual(t.fieldPath))return!1;let r=e.op==="array-contains"||e.op==="array-contains-any";return t.kind===2===r}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(t.kind===0&&e.dir==="asc"||t.kind===1&&e.dir==="desc")}};function gE(n){var e,t;if(G(n instanceof te||n instanceof ce),n instanceof te){if(n instanceof ql){let i=((t=(e=n.value.arrayValue)===null||e===void 0?void 0:e.values)===null||t===void 0?void 0:t.map(s=>te.create(n.field,"==",s)))||[];return ce.create(i,"or")}return n}let r=n.filters.map(i=>gE(i));return ce.create(r,n.op)}function VC(n){if(n.getFilters().length===0)return[];let e=wf(gE(n));return G(_E(e)),yf(e)||vf(e)?[e]:e.getFilters()}function yf(n){return n instanceof te}function vf(n){return n instanceof ce&&Om(n)}function _E(n){return yf(n)||vf(n)||function(t){if(t instanceof ce&&zd(t)){for(let r of t.getFilters())if(!yf(r)&&!vf(r))return!1;return!0}return!1}(n)}function wf(n){if(G(n instanceof te||n instanceof ce),n instanceof te)return n;if(n.filters.length===1)return wf(n.filters[0]);let e=n.filters.map(r=>wf(r)),t=ce.create(e,n.op);return t=Xl(t),_E(t)?t:(G(t instanceof ce),G(wi(t)),G(t.filters.length>1),t.filters.reduce((r,i)=>qm(r,i)))}function qm(n,e){let t;return G(n instanceof te||n instanceof ce),G(e instanceof te||e instanceof ce),t=n instanceof te?e instanceof te?function(i,s){return ce.create([i,s],"and")}(n,e):Qv(n,e):e instanceof te?Qv(e,n):function(i,s){if(G(i.filters.length>0&&s.filters.length>0),wi(i)&&wi(s))return Fw(i,s.getFilters());let o=zd(i)?i:s,l=zd(i)?s:i,u=o.filters.map(c=>qm(c,l));return ce.create(u,"or")}(n,e),Xl(t)}function Qv(n,e){if(wi(e))return Fw(e,n.getFilters());{let t=e.filters.map(r=>qm(n,r));return ce.create(t,"or")}}function Xl(n){if(G(n instanceof te||n instanceof ce),n instanceof te)return n;let e=n.getFilters();if(e.length===1)return Xl(e[0]);if(Vw(n))return n;let t=e.map(i=>Xl(i)),r=[];return t.forEach(i=>{i instanceof te?r.push(i):i instanceof ce&&(i.op===n.op?r.push(...i.filters):r.push(i))}),r.length===1?r[0]:ce.create(r,n.op)}var Ef=class{constructor(){this.un=new wo}addToCollectionParentIndex(e,t){return this.un.add(t),b.resolve()}getCollectionParents(e,t){return b.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return b.resolve()}deleteFieldIndex(e,t){return b.resolve()}deleteAllFieldIndexes(e){return b.resolve()}createTargetIndexes(e,t){return b.resolve()}getDocumentsMatchingTarget(e,t){return b.resolve(null)}getIndexType(e,t){return b.resolve(0)}getFieldIndexes(e,t){return b.resolve([])}getNextCollectionGroupToUpdate(e){return b.resolve(null)}getMinOffset(e,t){return b.resolve(Et.min())}getMinOffsetFromCollectionGroup(e,t){return b.resolve(Et.min())}updateCollectionGroup(e,t,r){return b.resolve()}updateIndexEntries(e,t){return b.resolve()}},wo=class{constructor(){this.index={}}add(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t]||new fe(se.comparator),s=!i.has(r);return this.index[t]=i.add(r),s}has(e){let t=e.lastSegment(),r=e.popLast(),i=this.index[t];return i&&i.has(r)}getEntries(e){return(this.index[e]||new fe(se.comparator)).toArray()}};var Al=new Uint8Array(0),If=class{constructor(e,t){this.databaseId=t,this.cn=new wo,this.ln=new zt(r=>_r(r),(r,i)=>Po(r,i)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){let r=t.lastSegment(),i=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});let s={collectionId:r,parent:rt(i)};return $v(e).put(s)}return b.resolve()}getCollectionParents(e,t){let r=[],i=IDBKeyRange.bound([t,""],[vw(t),""],!1,!0);return $v(e).U(i).next(s=>{for(let o of s){if(o.collectionId!==t)break;r.push(Lt(o.parent))}return r})}addFieldIndex(e,t){let r=Ys(e),i=function(l){return{indexId:l.indexId,collectionGroup:l.collectionGroup,fields:l.fields.map(u=>[u.fieldPath.canonicalString(),u.kind])}}(t);delete i.indexId;let s=r.add(i);if(t.indexState){let o=oi(e);return s.next(l=>{o.put(Gv(l,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){let r=Ys(e),i=oi(e),s=si(e);return r.delete(t.indexId).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=Ys(e),r=si(e),i=oi(e);return t.j().next(()=>r.j()).next(()=>i.j())}createTargetIndexes(e,t){return b.forEach(this.hn(t),r=>this.getIndexType(e,r).next(i=>{if(i===0||i===1){let s=new Jl(r).an();if(s!=null)return this.addFieldIndex(e,s)}}))}getDocumentsMatchingTarget(e,t){let r=si(e),i=!0,s=new Map;return b.forEach(this.hn(t),o=>this.Pn(e,o).next(l=>{i&&(i=!!l),s.set(o,l)})).next(()=>{if(i){let o=H(),l=[];return b.forEach(s,(u,c)=>{V("IndexedDbIndexManager",`Using index ${function(B){return`id=${B.indexId}|cg=${B.collectionGroup}|f=${B.fields.map(Y=>`${Y.fieldPath}:${Y.kind}`).join(",")}`}(u)} to execute ${_r(t)}`);let d=function(B,Y){let ne=Md(Y);if(ne===void 0)return null;for(let Q of jl(B,ne.fieldPath))switch(Q.op){case"array-contains-any":return Q.value.arrayValue.values||[];case"array-contains":return[Q.value]}return null}(c,u),m=function(B,Y){let ne=new Map;for(let Q of ar(Y))for(let E of jl(B,Q.fieldPath))switch(E.op){case"==":case"in":ne.set(Q.fieldPath.canonicalString(),E.value);break;case"not-in":case"!=":return ne.set(Q.fieldPath.canonicalString(),E.value),Array.from(ne.values())}return null}(c,u),p=function(B,Y){let ne=[],Q=!0;for(let E of ar(Y)){let _=E.kind===0?bv(B,E.fieldPath,B.startAt):Rv(B,E.fieldPath,B.startAt);ne.push(_.value),Q&&(Q=_.inclusive)}return new Kt(ne,Q)}(c,u),y=function(B,Y){let ne=[],Q=!0;for(let E of ar(Y)){let _=E.kind===0?Rv(B,E.fieldPath,B.endAt):bv(B,E.fieldPath,B.endAt);ne.push(_.value),Q&&(Q=_.inclusive)}return new Kt(ne,Q)}(c,u),S=this.In(u,c,p),x=this.In(u,c,y),D=this.Tn(u,c,m),q=this.En(u.indexId,d,S,p.inclusive,x,y.inclusive,D);return b.forEach(q,j=>r.G(j,t.limit).next(B=>{B.forEach(Y=>{let ne=L.fromSegments(Y.documentKey);o.has(ne)||(o=o.add(ne),l.push(ne))})}))}).next(()=>l)}return b.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(e.filters.length===0?t=[e]:t=VC(ce.create(e.filters,"and")).map(r=>ef(e.path,e.collectionGroup,e.orderBy,r.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t),t)}En(e,t,r,i,s,o,l){let u=(t!=null?t.length:1)*Math.max(r.length,s.length),c=u/(t!=null?t.length:1),d=[];for(let m=0;m<u;++m){let p=t?this.dn(t[m/c]):Al,y=this.An(e,p,r[m%c],i),S=this.Rn(e,p,s[m%c],o),x=l.map(D=>this.An(e,p,D,!0));d.push(...this.createRange(y,S,x))}return d}An(e,t,r,i){let s=new hr(e,L.empty(),t,r);return i?s:s.Zt()}Rn(e,t,r,i){let s=new hr(e,L.empty(),t,r);return i?s.Zt():s}Pn(e,t){let r=new Jl(t),i=t.collectionGroup!=null?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,i).next(s=>{let o=null;for(let l of s)r.rn(l)&&(!o||l.fields.length>o.fields.length)&&(o=l);return o})}getIndexType(e,t){let r=2,i=this.hn(t);return b.forEach(i,s=>this.Pn(e,s).next(o=>{o?r!==0&&o.fields.length<function(u){let c=new fe(Ce.comparator),d=!1;for(let m of u.filters)for(let p of m.getFlattenedFilters())p.field.isKeyField()||(p.op==="array-contains"||p.op==="array-contains-any"?d=!0:c=c.add(p.field));for(let m of u.orderBy)m.field.isKeyField()||(c=c.add(m.field));return c.size+(d?1:0)}(s)&&(r=1):r=0})).next(()=>function(o){return o.limit!==null}(t)&&i.length>1&&r===2?1:r)}Vn(e,t){let r=new cr;for(let i of ar(e)){let s=t.data.field(i.fieldPath);if(s==null)return null;let o=r.Yt(i.kind);en.vt.It(s,o)}return r.zt()}dn(e){let t=new cr;return en.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){let r=new cr;return en.vt.It(pr(this.databaseId,t),r.Yt(function(s){let o=ar(s);return o.length===0?0:o[o.length-1].kind}(e))),r.zt()}Tn(e,t,r){if(r===null)return[];let i=[];i.push(new cr);let s=0;for(let o of ar(e)){let l=r[s++];for(let u of i)if(this.fn(t,o.fieldPath)&&ho(l))i=this.gn(i,o,l);else{let c=u.Yt(o.kind);en.vt.It(l,c)}}return this.pn(i)}In(e,t,r){return this.Tn(e,t,r.position)}pn(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e[r].zt();return t}gn(e,t,r){let i=[...e],s=[];for(let o of r.arrayValue.values||[])for(let l of i){let u=new cr;u.seed(l.zt()),en.vt.It(o,u.Yt(t.kind)),s.push(u)}return s}fn(e,t){return!!e.filters.find(r=>r instanceof te&&r.field.isEqual(t)&&(r.op==="in"||r.op==="not-in"))}getFieldIndexes(e,t){let r=Ys(e),i=oi(e);return(t?r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):r.U()).next(s=>{let o=[];return b.forEach(s,l=>i.get([l.indexId,this.uid]).next(u=>{o.push(function(d,m){let p=m?new oo(m.sequenceNumber,new Et(wr(m.readTime),new L(Lt(m.documentKey)),m.largestBatchId)):oo.empty(),y=d.fields.map(([S,x])=>new mi(Ce.fromServerFormat(S),x));return new yi(d.indexId,d.collectionGroup,y,p)}(l,u))})).next(()=>o)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(t=>t.length===0?null:(t.sort((r,i)=>{let s=r.indexState.sequenceNumber-i.indexState.sequenceNumber;return s!==0?s:W(r.collectionGroup,i.collectionGroup)}),t[0].collectionGroup))}updateCollectionGroup(e,t,r){let i=Ys(e),s=oi(e);return this.yn(e).next(o=>i.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(l=>b.forEach(l,u=>s.put(Gv(u.indexId,this.uid,o,r)))))}updateIndexEntries(e,t){let r=new Map;return b.forEach(t,(i,s)=>{let o=r.get(i.collectionGroup);return(o?b.resolve(o):this.getFieldIndexes(e,i.collectionGroup)).next(l=>(r.set(i.collectionGroup,l),b.forEach(l,u=>this.wn(e,i,u).next(c=>{let d=this.Sn(s,u);return c.isEqual(d)?b.resolve():this.bn(e,s,u,c,d)}))))})}Dn(e,t,r,i){return si(e).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.mn(r,t.key),documentKey:t.key.path.toArray()})}vn(e,t,r,i){return si(e).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.mn(r,t.key),t.key.path.toArray()])}wn(e,t,r){let i=si(e),s=new fe(bn);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.mn(r,t)])},(o,l)=>{s=s.add(new hr(r.indexId,t,l.arrayValue,l.directionalValue))}).next(()=>s)}Sn(e,t){let r=new fe(bn),i=this.Vn(t,e);if(i==null)return r;let s=Md(t);if(s!=null){let o=e.data.field(s.fieldPath);if(ho(o))for(let l of o.arrayValue.values||[])r=r.add(new hr(t.indexId,e.key,this.dn(l),i))}else r=r.add(new hr(t.indexId,e.key,Al,i));return r}bn(e,t,r,i,s){V("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let o=[];return function(u,c,d,m,p){let y=u.getIterator(),S=c.getIterator(),x=ii(y),D=ii(S);for(;x||D;){let q=!1,j=!1;if(x&&D){let B=d(x,D);B<0?j=!0:B>0&&(q=!0)}else x!=null?j=!0:q=!0;q?(m(D),D=ii(S)):j?(p(x),x=ii(y)):(x=ii(y),D=ii(S))}}(i,s,bn,l=>{o.push(this.Dn(e,t,r,l))},l=>{o.push(this.vn(e,t,r,l))}),b.waitFor(o)}yn(e){let t=1;return oi(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(r,i,s)=>{s.done(),t=i.sequenceNumber+1}).next(()=>t)}createRange(e,t,r){r=r.sort((o,l)=>bn(o,l)).filter((o,l,u)=>!l||bn(o,u[l-1])!==0);let i=[];i.push(e);for(let o of r){let l=bn(o,e),u=bn(o,t);if(l===0)i[0]=e.Zt();else if(l>0&&u<0)i.push(o),i.push(o.Zt());else if(u>0)break}i.push(t);let s=[];for(let o=0;o<i.length;o+=2){if(this.Cn(i[o],i[o+1]))return[];let l=[i[o].indexId,this.uid,i[o].arrayValue,i[o].directionalValue,Al,[]],u=[i[o+1].indexId,this.uid,i[o+1].arrayValue,i[o+1].directionalValue,Al,[]];s.push(IDBKeyRange.bound(l,u))}return s}Cn(e,t){return bn(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Hv)}getMinOffset(e,t){return b.mapArray(this.hn(t),r=>this.Pn(e,r).next(i=>i||U())).next(Hv)}};function $v(n){return Me(n,"collectionParents")}function si(n){return Me(n,"indexEntries")}function Ys(n){return Me(n,"indexConfiguration")}function oi(n){return Me(n,"indexState")}function Hv(n){G(n.length!==0);let e=n[0].indexState.offset,t=e.largestBatchId;for(let r=1;r<n.length;r++){let i=n[r].indexState.offset;Nm(i,e)<0&&(e=i),t<i.largestBatchId&&(t=i.largestBatchId)}return new Et(e.readTime,e.documentKey,t)}var Yv={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},wt=class n{constructor(e,t,r){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=r}static withCacheSize(e){return new n(e,n.DEFAULT_COLLECTION_PERCENTILE,n.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};function yE(n,e,t){let r=n.store("mutations"),i=n.store("documentMutations"),s=[],o=IDBKeyRange.only(t.batchId),l=0,u=r.J({range:o},(d,m,p)=>(l++,p.delete()));s.push(u.next(()=>{G(l===1)}));let c=[];for(let d of t.mutations){let m=Sw(e,d.key.path,t.batchId);s.push(i.delete(m)),c.push(d.key)}return b.waitFor(s).next(()=>c)}function Zl(n){if(!n)return 0;let e;if(n.document)e=n.document;else if(n.unknownDocument)e=n.unknownDocument;else{if(!n.noDocument)throw U();e=n.noDocument}return JSON.stringify(e).length}wt.DEFAULT_COLLECTION_PERCENTILE=10,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,wt.DEFAULT=new wt(41943040,wt.DEFAULT_COLLECTION_PERCENTILE,wt.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),wt.DISABLED=new wt(-1,0,0);var eu=class n{constructor(e,t,r,i){this.userId=e,this.serializer=t,this.indexManager=r,this.referenceDelegate=i,this.Fn={}}static lt(e,t,r,i){G(e.uid!=="");let s=e.isAuthenticated()?e.uid:"";return new n(s,t,r,i)}checkEmpty(e){let t=!0,r=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Rn(e).J({index:"userMutationsIndex",range:r},(i,s,o)=>{t=!1,o.done()}).next(()=>t)}addMutationBatch(e,t,r,i){let s=di(e),o=Rn(e);return o.add({}).next(l=>{G(typeof l=="number");let u=new mo(l,t,r,i),c=function(y,S,x){let D=x.baseMutations.map(j=>vo(y.ct,j)),q=x.mutations.map(j=>vo(y.ct,j));return{userId:S,batchId:x.batchId,localWriteTimeMs:x.localWriteTime.toMillis(),baseMutations:D,mutations:q}}(this.serializer,this.userId,u),d=[],m=new fe((p,y)=>W(p.canonicalString(),y.canonicalString()));for(let p of i){let y=Sw(this.userId,p.key.path,l);m=m.add(p.key.path.popLast()),d.push(o.put(c)),d.push(s.put(y,BS))}return m.forEach(p=>{d.push(this.indexManager.addToCollectionParentIndex(e,p))}),e.addOnCommittedListener(()=>{this.Fn[l]=u.keys()}),b.waitFor(d).next(()=>u)})}lookupMutationBatch(e,t){return Rn(e).get(t).next(r=>r?(G(r.userId===this.userId),ur(this.serializer,r)):null)}Mn(e,t){return this.Fn[t]?b.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(r=>{if(r){let i=r.keys();return this.Fn[t]=i,i}return null})}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=IDBKeyRange.lowerBound([this.userId,r]),s=null;return Rn(e).J({index:"userMutationsIndex",range:i},(o,l,u)=>{l.userId===this.userId&&(G(l.batchId>=r),s=ur(this.serializer,l)),u.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),r=-1;return Rn(e).J({index:"userMutationsIndex",range:t,reverse:!0},(i,s,o)=>{r=s.batchId,o.done()}).next(()=>r)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Rn(e).U("userMutationsIndex",t).next(r=>r.map(i=>ur(this.serializer,i)))}getAllMutationBatchesAffectingDocumentKey(e,t){let r=Rl(this.userId,t.path),i=IDBKeyRange.lowerBound(r),s=[];return di(e).J({range:i},(o,l,u)=>{let[c,d,m]=o,p=Lt(d);if(c===this.userId&&t.path.isEqual(p))return Rn(e).get(m).next(y=>{if(!y)throw U();G(y.userId===this.userId),s.push(ur(this.serializer,y))});u.done()}).next(()=>s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new fe(W),i=[];return t.forEach(s=>{let o=Rl(this.userId,s.path),l=IDBKeyRange.lowerBound(o),u=di(e).J({range:l},(c,d,m)=>{let[p,y,S]=c,x=Lt(y);p===this.userId&&s.path.isEqual(x)?r=r.add(S):m.done()});i.push(u)}),b.waitFor(i).next(()=>this.xn(e,r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=Rl(this.userId,r),o=IDBKeyRange.lowerBound(s),l=new fe(W);return di(e).J({range:o},(u,c,d)=>{let[m,p,y]=u,S=Lt(p);m===this.userId&&r.isPrefixOf(S)?S.length===i&&(l=l.add(y)):d.done()}).next(()=>this.xn(e,l))}xn(e,t){let r=[],i=[];return t.forEach(s=>{i.push(Rn(e).get(s).next(o=>{if(o===null)throw U();G(o.userId===this.userId),r.push(ur(this.serializer,o))}))}),b.waitFor(i).next(()=>r)}removeMutationBatch(e,t){return yE(e._e,this.userId,t).next(r=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),b.forEach(r,i=>this.referenceDelegate.markPotentiallyOrphaned(e,i))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return b.resolve();let r=IDBKeyRange.lowerBound(function(o){return[o]}(this.userId)),i=[];return di(e).J({range:r},(s,o,l)=>{if(s[0]===this.userId){let u=Lt(s[1]);i.push(u)}else l.done()}).next(()=>{G(i.length===0)})})}containsKey(e,t){return vE(e,this.userId,t)}Nn(e){return wE(e).get(this.userId).next(t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}};function vE(n,e,t){let r=Rl(e,t.path),i=r[1],s=IDBKeyRange.lowerBound(r),o=!1;return di(n).J({range:s,H:!0},(l,u,c)=>{let[d,m,p]=l;d===e&&m===i&&(o=!0),c.done()}).next(()=>o)}function Rn(n){return Me(n,"mutations")}function di(n){return Me(n,"documentMutations")}function wE(n){return Me(n,"mutationQueues")}var Si=class n{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new n(0)}static kn(){return new n(-1)}};var Tf=class{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{let r=new Si(t.highestTargetId);return t.highestTargetId=r.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(t=>K.fromTimestamp(new Ee(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,t,r){return this.qn(e).next(i=>(i.highestListenSequenceNumber=t,r&&(i.lastRemoteSnapshotVersion=r.toTimestamp()),t>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=t),this.Qn(e,i)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(r=>(r.targetCount+=1,this.$n(t,r),this.Qn(e,r))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>ai(e).delete(t.targetId)).next(()=>this.qn(e)).next(r=>(G(r.targetCount>0),r.targetCount-=1,this.Qn(e,r)))}removeTargets(e,t,r){let i=0,s=[];return ai(e).J((o,l)=>{let u=eo(l);u.sequenceNumber<=t&&r.get(u.targetId)===null&&(i++,s.push(this.removeTargetData(e,u)))}).next(()=>b.waitFor(s)).next(()=>i)}forEachTarget(e,t){return ai(e).J((r,i)=>{let s=eo(i);t(s)})}qn(e){return Jv(e).get("targetGlobalKey").next(t=>(G(t!==null),t))}Qn(e,t){return Jv(e).put("targetGlobalKey",t)}Kn(e,t){return ai(e).put(pE(this.serializer,t))}$n(e,t){let r=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,r=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,r=!0),r}getTargetCount(e){return this.qn(e).next(t=>t.targetCount)}getTargetData(e,t){let r=_r(t),i=IDBKeyRange.bound([r,Number.NEGATIVE_INFINITY],[r,Number.POSITIVE_INFINITY]),s=null;return ai(e).J({range:i,index:"queryTargetsIndex"},(o,l,u)=>{let c=eo(l);Po(t,c.target)&&(s=c,u.done())}).next(()=>s)}addMatchingKeys(e,t,r){let i=[],s=Pn(e);return t.forEach(o=>{let l=rt(o.path);i.push(s.put({targetId:r,path:l})),i.push(this.referenceDelegate.addReference(e,r,o))}),b.waitFor(i)}removeMatchingKeys(e,t,r){let i=Pn(e);return b.forEach(t,s=>{let o=rt(s.path);return b.waitFor([i.delete([r,o]),this.referenceDelegate.removeReference(e,r,s)])})}removeMatchingKeysForTargetId(e,t){let r=Pn(e),i=IDBKeyRange.bound([t],[t+1],!1,!0);return r.delete(i)}getMatchingKeysForTargetId(e,t){let r=IDBKeyRange.bound([t],[t+1],!1,!0),i=Pn(e),s=H();return i.J({range:r,H:!0},(o,l,u)=>{let c=Lt(o[1]),d=new L(c);s=s.add(d)}).next(()=>s)}containsKey(e,t){let r=rt(t.path),i=IDBKeyRange.bound([r],[vw(r)],!1,!0),s=0;return Pn(e).J({index:"documentTargetsIndex",H:!0,range:i},([o,l],u,c)=>{o!==0&&(s++,c.done())}).next(()=>s>0)}ot(e,t){return ai(e).get(t).next(r=>r?eo(r):null)}};function ai(n){return Me(n,"targets")}function Jv(n){return Me(n,"targetGlobal")}function Pn(n){return Me(n,"targetDocuments")}function Xv([n,e],[t,r]){let i=W(n,t);return i===0?W(e,r):i}var Af=class{constructor(e){this.Un=e,this.buffer=new fe(Xv),this.Wn=0}Gn(){return++this.Wn}zn(e){let t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{let r=this.buffer.last();Xv(t,r)<0&&(this.buffer=this.buffer.delete(r).add(t))}}get maxValue(){return this.buffer.last()[0]}},Sf=class{constructor(e,t,r){this.garbageCollector=e,this.asyncQueue=t,this.localStore=r,this.jn=null}start(){this.garbageCollector.params.cacheSizeCollectionThreshold!==-1&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return this.jn!==null}Hn(e){V("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,()=>N(this,null,function*(){this.jn=null;try{yield this.localStore.collectGarbage(this.garbageCollector)}catch(t){Kn(t)?V("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):yield jn(t)}yield this.Hn(3e5)}))}},Cf=class{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(r=>Math.floor(t/100*r))}nthSequenceNumber(e,t){if(t===0)return b.resolve(ft.oe);let r=new Af(t);return this.Jn.forEachTarget(e,i=>r.zn(i.sequenceNumber)).next(()=>this.Jn.Zn(e,i=>r.zn(i))).next(()=>r.maxValue)}removeTargets(e,t,r){return this.Jn.removeTargets(e,t,r)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return this.params.cacheSizeCollectionThreshold===-1?(V("LruGarbageCollector","Garbage collection skipped; disabled"),b.resolve(Yv)):this.getCacheSize(e).next(r=>r<this.params.cacheSizeCollectionThreshold?(V("LruGarbageCollector",`Garbage collection skipped; Cache size ${r} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Yv):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let r,i,s,o,l,u,c,d=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(m=>(m>this.params.maximumSequenceNumbersToCollect?(V("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${m}`),i=this.params.maximumSequenceNumbersToCollect):i=m,o=Date.now(),this.nthSequenceNumber(e,i))).next(m=>(r=m,l=Date.now(),this.removeTargets(e,r,t))).next(m=>(s=m,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(m=>(c=Date.now(),li()<=gt.DEBUG&&V("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${o-d}ms
	Determined least recently used ${i} in `+(l-o)+`ms
	Removed ${s} targets in `+(u-l)+`ms
	Removed ${m} documents in `+(c-u)+`ms
Total Duration: ${c-d}ms`),b.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:m})))}};function OC(n,e){return new Cf(n,e)}var bf=class{constructor(e,t){this.db=e,this.garbageCollector=OC(this,t)}Yn(e){let t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(r=>t.next(i=>r+i))}er(e){let t=0;return this.Zn(e,r=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(r,i)=>t(i))}addReference(e,t,r){return Sl(e,r)}removeReference(e,t,r){return Sl(e,r)}removeTargets(e,t,r){return this.db.getTargetCache().removeTargets(e,t,r)}markPotentiallyOrphaned(e,t){return Sl(e,t)}nr(e,t){return function(i,s){let o=!1;return wE(i).Y(l=>vE(i,l,s).next(u=>(u&&(o=!0),b.resolve(!u)))).next(()=>o)}(e,t)}removeOrphanedDocuments(e,t){let r=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[],s=0;return this.tr(e,(o,l)=>{if(l<=t){let u=this.nr(e,o).next(c=>{if(!c)return s++,r.getEntry(e,o).next(()=>(r.removeEntry(o,K.min()),Pn(e).delete(function(m){return[0,rt(m.path)]}(o))))});i.push(u)}}).next(()=>b.waitFor(i)).next(()=>r.apply(e)).next(()=>s)}removeTarget(e,t){let r=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,r)}updateLimboDocument(e,t){return Sl(e,t)}tr(e,t){let r=Pn(e),i,s=ft.oe;return r.J({index:"documentTargetsIndex"},([o,l],{path:u,sequenceNumber:c})=>{o===0?(s!==ft.oe&&t(new L(Lt(i)),s),s=c,i=u):s=ft.oe}).next(()=>{s!==ft.oe&&t(new L(Lt(i)),s)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}};function Sl(n,e){return Pn(n).put(function(r,i){return{targetId:0,path:rt(r.path),sequenceNumber:i}}(e,n.currentSequenceNumber))}var tu=class{constructor(){this.changes=new zt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,ke.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let r=this.changes.get(t);return r!==void 0?b.resolve(r):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}};var Rf=class{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,r){return or(e).put(r)}removeEntry(e,t,r){return or(e).delete(function(s,o){let l=s.path.toArray();return[l.slice(0,l.length-2),l[l.length-2],Hl(o),l[l.length-1]]}(t,r))}updateMetadata(e,t){return this.getMetadata(e).next(r=>(r.byteSize+=t,this.rr(e,r)))}getEntry(e,t){let r=ke.newInvalidDocument(t);return or(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Js(t))},(i,s)=>{r=this.ir(t,s)}).next(()=>r)}sr(e,t){let r={size:0,document:ke.newInvalidDocument(t)};return or(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(Js(t))},(i,s)=>{r={document:this.ir(t,s),size:Zl(s)}}).next(()=>r)}getEntries(e,t){let r=at();return this._r(e,t,(i,s)=>{let o=this.ir(i,s);r=r.insert(i,o)}).next(()=>r)}ar(e,t){let r=at(),i=new _e(L.comparator);return this._r(e,t,(s,o)=>{let l=this.ir(s,o);r=r.insert(s,l),i=i.insert(s,Zl(o))}).next(()=>({documents:r,ur:i}))}_r(e,t,r){if(t.isEmpty())return b.resolve();let i=new fe(tw);t.forEach(u=>i=i.add(u));let s=IDBKeyRange.bound(Js(i.first()),Js(i.last())),o=i.getIterator(),l=o.getNext();return or(e).J({index:"documentKeyIndex",range:s},(u,c,d)=>{let m=L.fromSegments([...c.prefixPath,c.collectionGroup,c.documentId]);for(;l&&tw(l,m)<0;)r(l,null),l=o.getNext();l&&l.isEqual(m)&&(r(l,c),l=o.hasNext()?o.getNext():null),l?d.$(Js(l)):d.done()}).next(()=>{for(;l;)r(l,null),l=o.hasNext()?o.getNext():null})}getDocumentsMatchingQuery(e,t,r,i,s){let o=t.path,l=[o.popLast().toArray(),o.lastSegment(),Hl(r.readTime),r.documentKey.path.isEmpty()?"":r.documentKey.path.lastSegment()],u=[o.popLast().toArray(),o.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return or(e).U(IDBKeyRange.bound(l,u,!0)).next(c=>{s?.incrementDocumentReadCount(c.length);let d=at();for(let m of c){let p=this.ir(L.fromSegments(m.prefixPath.concat(m.collectionGroup,m.documentId)),m);p.isFoundDocument()&&(No(t,p)||i.has(p.key))&&(d=d.insert(p.key,p))}return d})}getAllFromCollectionGroup(e,t,r,i){let s=at(),o=ew(t,r),l=ew(t,Et.max());return or(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(o,l,!0)},(u,c,d)=>{let m=this.ir(L.fromSegments(c.prefixPath.concat(c.collectionGroup,c.documentId)),c);s=s.insert(m.key,m),s.size===i&&d.done()}).next(()=>s)}newChangeBuffer(e){return new Pf(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(t=>t.byteSize)}getMetadata(e){return Zv(e).get("remoteDocumentGlobalKey").next(t=>(G(!!t),t))}rr(e,t){return Zv(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){let r=DC(this.serializer,t);if(!(r.isNoDocument()&&r.version.isEqual(K.min())))return r}return ke.newInvalidDocument(e)}};function EE(n){return new Rf(n)}var Pf=class extends tu{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new zt(r=>r.toString(),(r,i)=>r.isEqual(i))}applyChanges(e){let t=[],r=0,i=new fe((s,o)=>W(s.canonicalString(),o.canonicalString()));return this.changes.forEach((s,o)=>{let l=this.lr.get(s);if(t.push(this.cr.removeEntry(e,s,l.readTime)),o.isValidDocument()){let u=Bv(this.cr.serializer,o);i=i.add(s.path.popLast());let c=Zl(u);r+=c-l.size,t.push(this.cr.addEntry(e,s,u))}else if(r-=l.size,this.trackRemovals){let u=Bv(this.cr.serializer,o.convertToNoDocument(K.min()));t.push(this.cr.addEntry(e,s,u))}}),i.forEach(s=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,s))}),t.push(this.cr.updateMetadata(e,r)),b.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(r=>(this.lr.set(t,{size:r.size,readTime:r.document.readTime}),r.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:r,ur:i})=>(i.forEach((s,o)=>{this.lr.set(s,{size:o,readTime:r.get(s).readTime})}),r))}};function Zv(n){return Me(n,"remoteDocumentGlobal")}function or(n){return Me(n,"remoteDocumentsV14")}function Js(n){let e=n.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function ew(n,e){let t=e.documentKey.path.toArray();return[n,Hl(e.readTime),t.slice(0,t.length-2),t.length>0?t[t.length-1]:""]}function tw(n,e){let t=n.path.toArray(),r=e.path.toArray(),i=0;for(let s=0;s<t.length-2&&s<r.length-2;++s)if(i=W(t[s],r[s]),i)return i;return i=W(t.length,r.length),i||(i=W(t[t.length-2],r[r.length-2]),i||W(t[t.length-1],r[r.length-1]))}var xf=class{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}};var nu=class{constructor(e,t,r,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=r,this.indexManager=i}getDocument(e,t){let r=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(r=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(r!==null&&ro(r.mutation,i,mt.empty(),Ee.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.getLocalViewOfDocuments(e,r,H()).next(()=>r))}getLocalViewOfDocuments(e,t,r=H()){let i=Ut();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,r).next(s=>{let o=Zs();return s.forEach((l,u)=>{o=o.insert(l,u.overlayedDocument)}),o}))}getOverlayedDocuments(e,t){let r=Ut();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,H()))}populateOverlays(e,t,r){let i=[];return r.forEach(s=>{t.has(s)||i.push(s)}),this.documentOverlayCache.getOverlays(e,i).next(s=>{s.forEach((o,l)=>{t.set(o,l)})})}computeViews(e,t,r,i){let s=at(),o=no(),l=function(){return no()}();return t.forEach((u,c)=>{let d=r.get(c.key);i.has(c.key)&&(d===void 0||d.mutation instanceof Rt)?s=s.insert(c.key,c):d!==void 0?(o.set(c.key,d.mutation.getFieldMask()),ro(d.mutation,c,d.mutation.getFieldMask(),Ee.now())):o.set(c.key,mt.empty())}),this.recalculateAndSaveOverlays(e,s).next(u=>(u.forEach((c,d)=>o.set(c,d)),t.forEach((c,d)=>{var m;return l.set(c,new xf(d,(m=o.get(c))!==null&&m!==void 0?m:null))}),l))}recalculateAndSaveOverlays(e,t){let r=no(),i=new _e((o,l)=>o-l),s=H();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(o=>{for(let l of o)l.keys().forEach(u=>{let c=t.get(u);if(c===null)return;let d=r.get(u)||mt.empty();d=l.applyToLocalView(c,d),r.set(u,d);let m=(i.get(l.batchId)||H()).add(u);i=i.insert(l.batchId,m)})}).next(()=>{let o=[],l=i.getReverseIterator();for(;l.hasNext();){let u=l.getNext(),c=u.key,d=u.value,m=zw();d.forEach(p=>{if(!s.has(p)){let y=Xw(t.get(p),r.get(p));y!==null&&m.set(p,y),s=s.add(p)}}),o.push(this.documentOverlayCache.saveOverlays(e,c,m))}return b.waitFor(o)}).next(()=>r)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(r=>this.recalculateAndSaveOverlays(e,r))}getDocumentsMatchingQuery(e,t,r,i){return function(o){return L.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Fm(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,r,i):this.getDocumentsMatchingCollectionQuery(e,t,r,i)}getNextDocuments(e,t,r,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,r,i).next(s=>{let o=i-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,r.largestBatchId,i-s.size):b.resolve(Ut()),l=-1,u=s;return o.next(c=>b.forEach(c,(d,m)=>(l<m.largestBatchId&&(l=m.largestBatchId),s.get(d)?b.resolve():this.remoteDocumentCache.getEntry(e,d).next(p=>{u=u.insert(d,p)}))).next(()=>this.populateOverlays(e,c,s)).next(()=>this.computeViews(e,u,c,H())).next(d=>({batchId:l,changes:Kw(d)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new L(t)).next(r=>{let i=Zs();return r.isFoundDocument()&&(i=i.insert(r.key,r)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,r,i){let s=t.collectionGroup,o=Zs();return this.indexManager.getCollectionParents(e,s).next(l=>b.forEach(l,u=>{let c=function(m,p){return new bt(p,null,m.explicitOrderBy.slice(),m.filters.slice(),m.limit,m.limitType,m.startAt,m.endAt)}(t,u.child(s));return this.getDocumentsMatchingCollectionQuery(e,c,r,i).next(d=>{d.forEach((m,p)=>{o=o.insert(m,p)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(e,t,r,i){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,r.largestBatchId).next(o=>(s=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,r,s,i))).next(o=>{s.forEach((u,c)=>{let d=c.getKey();o.get(d)===null&&(o=o.insert(d,ke.newInvalidDocument(d)))});let l=Zs();return o.forEach((u,c)=>{let d=s.get(u);d!==void 0&&ro(d.mutation,c,mt.empty(),Ee.now()),No(t,c)&&(l=l.insert(u,c))}),l})}};var Nf=class{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return b.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:be(i.createTime)}}(t)),b.resolve()}getNamedQuery(e,t){return b.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(i){return{name:i.name,query:Bm(i.bundledQuery),readTime:be(i.readTime)}}(t)),b.resolve()}};var Df=class{constructor(){this.overlays=new _e(L.comparator),this.Ir=new Map}getOverlay(e,t){return b.resolve(this.overlays.get(t))}getOverlays(e,t){let r=Ut();return b.forEach(t,i=>this.getOverlay(e,i).next(s=>{s!==null&&r.set(i,s)})).next(()=>r)}saveOverlays(e,t,r){return r.forEach((i,s)=>{this.ht(e,t,s)}),b.resolve()}removeOverlaysForBatchId(e,t,r){let i=this.Ir.get(r);return i!==void 0&&(i.forEach(s=>this.overlays=this.overlays.remove(s)),this.Ir.delete(r)),b.resolve()}getOverlaysForCollection(e,t,r){let i=Ut(),s=t.length+1,o=new L(t.child("")),l=this.overlays.getIteratorFrom(o);for(;l.hasNext();){let u=l.getNext().value,c=u.getKey();if(!t.isPrefixOf(c.path))break;c.path.length===s&&u.largestBatchId>r&&i.set(u.getKey(),u)}return b.resolve(i)}getOverlaysForCollectionGroup(e,t,r,i){let s=new _e((c,d)=>c-d),o=this.overlays.getIterator();for(;o.hasNext();){let c=o.getNext().value;if(c.getKey().getCollectionGroup()===t&&c.largestBatchId>r){let d=s.get(c.largestBatchId);d===null&&(d=Ut(),s=s.insert(c.largestBatchId,d)),d.set(c.getKey(),c)}}let l=Ut(),u=s.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach((c,d)=>l.set(c,d)),!(l.size()>=i)););return b.resolve(l)}ht(e,t,r){let i=this.overlays.get(r.key);if(i!==null){let o=this.Ir.get(i.largestBatchId).delete(r.key);this.Ir.set(i.largestBatchId,o)}this.overlays=this.overlays.insert(r.key,new po(t,r));let s=this.Ir.get(t);s===void 0&&(s=H(),this.Ir.set(t,s)),this.Ir.set(t,s.add(r.key))}};var kf=class{constructor(){this.sessionToken=Re.EMPTY_BYTE_STRING}getSessionToken(e){return b.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,b.resolve()}};var Eo=class{constructor(){this.Tr=new fe(Ne.Er),this.dr=new fe(Ne.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){let r=new Ne(e,t);this.Tr=this.Tr.add(r),this.dr=this.dr.add(r)}Rr(e,t){e.forEach(r=>this.addReference(r,t))}removeReference(e,t){this.Vr(new Ne(e,t))}mr(e,t){e.forEach(r=>this.removeReference(r,t))}gr(e){let t=new L(new se([])),r=new Ne(t,e),i=new Ne(t,e+1),s=[];return this.dr.forEachInRange([r,i],o=>{this.Vr(o),s.push(o.key)}),s}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){let t=new L(new se([])),r=new Ne(t,e),i=new Ne(t,e+1),s=H();return this.dr.forEachInRange([r,i],o=>{s=s.add(o.key)}),s}containsKey(e){let t=new Ne(e,0),r=this.Tr.firstAfterOrEqual(t);return r!==null&&e.isEqual(r.key)}},Ne=class{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return L.comparator(e.key,t.key)||W(e.wr,t.wr)}static Ar(e,t){return W(e.wr,t.wr)||L.comparator(e.key,t.key)}};var Vf=class{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new fe(Ne.Er)}checkEmpty(e){return b.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,r,i){let s=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new mo(s,t,r,i);this.mutationQueue.push(o);for(let l of i)this.br=this.br.add(new Ne(l.key,s)),this.indexManager.addToCollectionParentIndex(e,l.key.path.popLast());return b.resolve(o)}lookupMutationBatch(e,t){return b.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){let r=t+1,i=this.vr(r),s=i<0?0:i;return b.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return b.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(e){return b.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let r=new Ne(t,0),i=new Ne(t,Number.POSITIVE_INFINITY),s=[];return this.br.forEachInRange([r,i],o=>{let l=this.Dr(o.wr);s.push(l)}),b.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let r=new fe(W);return t.forEach(i=>{let s=new Ne(i,0),o=new Ne(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([s,o],l=>{r=r.add(l.wr)})}),b.resolve(this.Cr(r))}getAllMutationBatchesAffectingQuery(e,t){let r=t.path,i=r.length+1,s=r;L.isDocumentKey(s)||(s=s.child(""));let o=new Ne(new L(s),0),l=new fe(W);return this.br.forEachWhile(u=>{let c=u.key.path;return!!r.isPrefixOf(c)&&(c.length===i&&(l=l.add(u.wr)),!0)},o),b.resolve(this.Cr(l))}Cr(e){let t=[];return e.forEach(r=>{let i=this.Dr(r);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){G(this.Fr(t.batchId,"removed")===0),this.mutationQueue.shift();let r=this.br;return b.forEach(t.mutations,i=>{let s=new Ne(i.key,t.batchId);return r=r.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=r})}On(e){}containsKey(e,t){let r=new Ne(t,0),i=this.br.firstAfterOrEqual(r);return b.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,b.resolve()}Fr(e,t){return this.vr(e)}vr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Dr(e){let t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}};var Of=class{constructor(e){this.Mr=e,this.docs=function(){return new _e(L.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let r=t.key,i=this.docs.get(r),s=i?i.size:0,o=this.Mr(t);return this.docs=this.docs.insert(r,{document:t.mutableCopy(),size:o}),this.size+=o-s,this.indexManager.addToCollectionParentIndex(e,r.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let r=this.docs.get(t);return b.resolve(r?r.document.mutableCopy():ke.newInvalidDocument(t))}getEntries(e,t){let r=at();return t.forEach(i=>{let s=this.docs.get(i);r=r.insert(i,s?s.document.mutableCopy():ke.newInvalidDocument(i))}),b.resolve(r)}getDocumentsMatchingQuery(e,t,r,i){let s=at(),o=t.path,l=new L(o.child("")),u=this.docs.getIteratorFrom(l);for(;u.hasNext();){let{key:c,value:{document:d}}=u.getNext();if(!o.isPrefixOf(c.path))break;c.path.length>o.length+1||Nm(Ew(d),r)<=0||(i.has(d.key)||No(t,d))&&(s=s.insert(d.key,d.mutableCopy()))}return b.resolve(s)}getAllFromCollectionGroup(e,t,r,i){U()}Or(e,t){return b.forEach(this.docs,r=>t(r))}newChangeBuffer(e){return new Ff(this)}getSize(e){return b.resolve(this.size)}},Ff=class extends tu{constructor(e){super(),this.cr=e}applyChanges(e){let t=[];return this.changes.forEach((r,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(r)}),b.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}};var Mf=class{constructor(e){this.persistence=e,this.Nr=new zt(t=>_r(t),Po),this.lastRemoteSnapshotVersion=K.min(),this.highestTargetId=0,this.Lr=0,this.Br=new Eo,this.targetCount=0,this.kr=Si.Bn()}forEachTarget(e,t){return this.Nr.forEach((r,i)=>t(i)),b.resolve()}getLastRemoteSnapshotVersion(e){return b.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return b.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),b.resolve(this.highestTargetId)}setTargetsMetadata(e,t,r){return r&&(this.lastRemoteSnapshotVersion=r),t>this.Lr&&(this.Lr=t),b.resolve()}Kn(e){this.Nr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.kr=new Si(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,b.resolve()}updateTargetData(e,t){return this.Kn(t),b.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,b.resolve()}removeTargets(e,t,r){let i=0,s=[];return this.Nr.forEach((o,l)=>{l.sequenceNumber<=t&&r.get(l.targetId)===null&&(this.Nr.delete(o),s.push(this.removeMatchingKeysForTargetId(e,l.targetId)),i++)}),b.waitFor(s).next(()=>i)}getTargetCount(e){return b.resolve(this.targetCount)}getTargetData(e,t){let r=this.Nr.get(t)||null;return b.resolve(r)}addMatchingKeys(e,t,r){return this.Br.Rr(t,r),b.resolve()}removeMatchingKeys(e,t,r){this.Br.mr(t,r);let i=this.persistence.referenceDelegate,s=[];return i&&t.forEach(o=>{s.push(i.markPotentiallyOrphaned(e,o))}),b.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),b.resolve()}getMatchingKeysForTargetId(e,t){let r=this.Br.yr(t);return b.resolve(r)}containsKey(e,t){return b.resolve(this.Br.containsKey(t))}};var ru=class{constructor(e,t){this.qr={},this.overlays={},this.Qr=new ft(0),this.Kr=!1,this.Kr=!0,this.$r=new kf,this.referenceDelegate=e(this),this.Ur=new Mf(this),this.indexManager=new Ef,this.remoteDocumentCache=function(i){return new Of(i)}(r=>this.referenceDelegate.Wr(r)),this.serializer=new $l(t),this.Gr=new Nf(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Df,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let r=this.qr[e.toKey()];return r||(r=new Vf(t,this.referenceDelegate),this.qr[e.toKey()]=r),r}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("MemoryPersistence","Starting transaction:",e);let i=new Lf(this.Qr.next());return this.referenceDelegate.zr(),r(i).next(s=>this.referenceDelegate.jr(i).next(()=>s)).toPromise().then(s=>(i.raiseOnCommittedEvent(),s))}Hr(e,t){return b.or(Object.values(this.qr).map(r=>()=>r.containsKey(e,t)))}},Lf=class extends Fl{constructor(e){super(),this.currentSequenceNumber=e}},iu=class n{constructor(e){this.persistence=e,this.Jr=new Eo,this.Yr=null}static Zr(e){return new n(e)}get Xr(){if(this.Yr)return this.Yr;throw U()}addReference(e,t,r){return this.Jr.addReference(r,t),this.Xr.delete(r.toString()),b.resolve()}removeReference(e,t,r){return this.Jr.removeReference(r,t),this.Xr.add(r.toString()),b.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),b.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));let r=this.persistence.getTargetCache();return r.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(s=>this.Xr.add(s.toString()))}).next(()=>r.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return b.forEach(this.Xr,r=>{let i=L.fromPath(r);return this.ei(e,i).next(s=>{s||t.removeEntry(i,K.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(r=>{r?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return b.or([()=>b.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}};var Uf=class{constructor(e){this.serializer=e}O(e,t,r,i){let s=new Ml("createOrUpgrade",t);r<1&&i>=1&&(function(u){u.createObjectStore("owner")}(e),function(u){u.createObjectStore("mutationQueues",{keyPath:"userId"}),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_v,{unique:!0}),u.createObjectStore("documentMutations")}(e),nw(e),function(u){u.createObjectStore("remoteDocuments")}(e));let o=b.resolve();return r<3&&i>=3&&(r!==0&&(function(u){u.deleteObjectStore("targetDocuments"),u.deleteObjectStore("targets"),u.deleteObjectStore("targetGlobal")}(e),nw(e)),o=o.next(()=>function(u){let c=u.store("targetGlobal"),d={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:K.min().toTimestamp(),targetCount:0};return c.put("targetGlobalKey",d)}(s))),r<4&&i>=4&&(r!==0&&(o=o.next(()=>function(u,c){return c.store("mutations").U().next(d=>{u.deleteObjectStore("mutations"),u.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",_v,{unique:!0});let m=c.store("mutations"),p=d.map(y=>m.put(y));return b.waitFor(p)})}(e,s))),o=o.next(()=>{(function(u){u.createObjectStore("clientMetadata",{keyPath:"clientId"})})(e)})),r<5&&i>=5&&(o=o.next(()=>this.ni(s))),r<6&&i>=6&&(o=o.next(()=>(function(u){u.createObjectStore("remoteDocumentGlobal")}(e),this.ri(s)))),r<7&&i>=7&&(o=o.next(()=>this.ii(s))),r<8&&i>=8&&(o=o.next(()=>this.si(e,s))),r<9&&i>=9&&(o=o.next(()=>{(function(u){u.objectStoreNames.contains("remoteDocumentChanges")&&u.deleteObjectStore("remoteDocumentChanges")})(e)})),r<10&&i>=10&&(o=o.next(()=>this.oi(s))),r<11&&i>=11&&(o=o.next(()=>{(function(u){u.createObjectStore("bundles",{keyPath:"bundleId"})})(e),function(u){u.createObjectStore("namedQueries",{keyPath:"name"})}(e)})),r<12&&i>=12&&(o=o.next(()=>{(function(u){let c=u.createObjectStore("documentOverlays",{keyPath:XS});c.createIndex("collectionPathOverlayIndex",ZS,{unique:!1}),c.createIndex("collectionGroupOverlayIndex",eC,{unique:!1})})(e)})),r<13&&i>=13&&(o=o.next(()=>function(u){let c=u.createObjectStore("remoteDocumentsV14",{keyPath:qS});c.createIndex("documentKeyIndex",GS),c.createIndex("collectionGroupIndex",jS)}(e)).next(()=>this._i(e,s)).next(()=>e.deleteObjectStore("remoteDocuments"))),r<14&&i>=14&&(o=o.next(()=>this.ai(e,s))),r<15&&i>=15&&(o=o.next(()=>function(u){u.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),u.createObjectStore("indexState",{keyPath:$S}).createIndex("sequenceNumberIndex",HS,{unique:!1}),u.createObjectStore("indexEntries",{keyPath:YS}).createIndex("documentKeyIndex",JS,{unique:!1})}(e))),r<16&&i>=16&&(o=o.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),r<17&&i>=17&&(o=o.next(()=>{(function(u){u.createObjectStore("globals",{keyPath:"name"})})(e)})),o}ri(e){let t=0;return e.store("remoteDocuments").J((r,i)=>{t+=Zl(i)}).next(()=>{let r={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",r)})}ni(e){let t=e.store("mutationQueues"),r=e.store("mutations");return t.U().next(i=>b.forEach(i,s=>{let o=IDBKeyRange.bound([s.userId,-1],[s.userId,s.lastAcknowledgedBatchId]);return r.U("userMutationsIndex",o).next(l=>b.forEach(l,u=>{G(u.userId===s.userId);let c=ur(this.serializer,u);return yE(e,s.userId,c).next(()=>{})}))}))}ii(e){let t=e.store("targetDocuments"),r=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(i=>{let s=[];return r.J((o,l)=>{let u=new se(o),c=function(m){return[0,rt(m)]}(u);s.push(t.get(c).next(d=>d?b.resolve():(m=>t.put({targetId:0,path:rt(m),sequenceNumber:i.highestListenSequenceNumber}))(u)))}).next(()=>b.waitFor(s))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:QS});let r=t.store("collectionParents"),i=new wo,s=o=>{if(i.add(o)){let l=o.lastSegment(),u=o.popLast();return r.put({collectionId:l,parent:rt(u)})}};return t.store("remoteDocuments").J({H:!0},(o,l)=>{let u=new se(o);return s(u.popLast())}).next(()=>t.store("documentMutations").J({H:!0},([o,l,u],c)=>{let d=Lt(l);return s(d.popLast())}))}oi(e){let t=e.store("targets");return t.J((r,i)=>{let s=eo(i),o=pE(this.serializer,s);return t.put(o)})}_i(e,t){let r=t.store("remoteDocuments"),i=[];return r.J((s,o)=>{let l=t.store("remoteDocumentsV14"),u=function(m){return m.document?new L(se.fromString(m.document.name).popFirst(5)):m.noDocument?L.fromSegments(m.noDocument.path):m.unknownDocument?L.fromSegments(m.unknownDocument.path):U()}(o).path.toArray(),c={prefixPath:u.slice(0,u.length-2),collectionGroup:u[u.length-2],documentId:u[u.length-1],readTime:o.readTime||[0,0],unknownDocument:o.unknownDocument,noDocument:o.noDocument,document:o.document,hasCommittedMutations:!!o.hasCommittedMutations};i.push(l.put(c))}).next(()=>b.waitFor(i))}ai(e,t){let r=t.store("mutations"),i=EE(this.serializer),s=new ru(iu.Zr,this.serializer.ct);return r.U().next(o=>{let l=new Map;return o.forEach(u=>{var c;let d=(c=l.get(u.userId))!==null&&c!==void 0?c:H();ur(this.serializer,u).keys().forEach(m=>d=d.add(m)),l.set(u.userId,d)}),b.forEach(l,(u,c)=>{let d=new De(c),m=Yl.lt(this.serializer,d),p=s.getIndexManager(d),y=eu.lt(d,this.serializer,p,s.referenceDelegate);return new nu(i,y,m,p).recalculateAndSaveOverlaysForDocumentKeys(new lo(t,ft.oe),u).next()})})}};function nw(n){n.createObjectStore("targetDocuments",{keyPath:zS}).createIndex("documentTargetsIndex",WS,{unique:!0}),n.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",KS,{unique:!0}),n.createObjectStore("targetGlobal")}var Cd="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.",Bf=class n{constructor(e,t,r,i,s,o,l,u,c,d,m=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=r,this.ui=s,this.window=o,this.document=l,this.ci=c,this.li=d,this.hi=m,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=p=>Promise.resolve(),!n.D())throw new k(P.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new bf(this,i),this.Ai=t+"main",this.serializer=new $l(u),this.Ri=new Vn(this.Ai,this.hi,new Uf(this.serializer)),this.$r=new mf,this.Ur=new Tf(this.referenceDelegate,this.serializer),this.remoteDocumentCache=EE(this.serializer),this.Gr=new ff,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,d===!1&&Se("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,Cd);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new ft(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=t=>N(this,null,function*(){if(this.started)return e(t)}),e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(t=>N(this,null,function*(){t.newVersion===null&&(yield e())}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(()=>N(this,null,function*(){this.started&&(yield this.mi())})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>Cl(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(t=>{t||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(Kn(e))return V("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return V("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return Xs(e).get("owner").next(t=>b.resolve(this.vi(t)))}Ci(e){return Cl(e).delete(this.clientId)}Fi(){return N(this,null,function*(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let e=yield this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{let r=Me(t,"clientMetadata");return r.U().next(i=>{let s=this.xi(i,18e5),o=i.filter(l=>s.indexOf(l)===-1);return b.forEach(o,l=>r.delete(l.clientId)).next(()=>o)})}).catch(()=>[]);if(this.Vi)for(let t of e)this.Vi.removeItem(this.Oi(t.clientId))}})}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?b.resolve(!0):Xs(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new k(P.FAILED_PRECONDITION,Cd);return!1}}return!(!this.networkEnabled||!this.inForeground)||Cl(e).U().next(r=>this.xi(r,5e3).find(i=>{if(this.clientId!==i.clientId){let s=!this.networkEnabled&&i.networkEnabled,o=!this.inForeground&&i.inForeground,l=this.networkEnabled===i.networkEnabled;if(s||o&&l)return!0}return!1})===void 0)}).next(t=>(this.isPrimary!==t&&V("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}shutdown(){return N(this,null,function*(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),yield this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new lo(e,ft.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()})}xi(e,t){return e.filter(r=>this.Mi(r.updateTimeMs,t)&&!this.Ni(r.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>Cl(e).U().next(t=>this.xi(t,18e5).map(r=>r.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return eu.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new If(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Yl.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,r){V("IndexedDbPersistence","Starting transaction:",e);let i=t==="readonly"?"readonly":"readwrite",s=function(u){return u===17?rC:u===16?nC:u===15?km:u===14?Rw:u===13?bw:u===12?tC:u===11?Cw:void U()}(this.hi),o;return this.Ri.runTransaction(e,i,s,l=>(o=new lo(l,this.Qr?this.Qr.next():ft.oe),t==="readwrite-primary"?this.wi(o).next(u=>!!u||this.Si(o)).next(u=>{if(!u)throw Se(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new k(P.FAILED_PRECONDITION,Iw);return r(o)}).next(u=>this.Di(o).next(()=>u)):this.Ki(o).next(()=>r(o)))).then(l=>(o.raiseOnCommittedEvent(),l))}Ki(e){return Xs(e).get("owner").next(t=>{if(t!==null&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)&&!this.vi(t)&&!(this.li||this.allowTabSynchronization&&t.allowTabSynchronization))throw new k(P.FAILED_PRECONDITION,Cd)})}Di(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Xs(e).put("owner",t)}static D(){return Vn.D()}bi(e){let t=Xs(e);return t.get("owner").next(r=>this.vi(r)?(V("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):b.resolve())}Mi(e,t){let r=Date.now();return!(e<r-t)&&(!(e>r)||(Se(`Detected an update time that is in the future: ${e} > ${r}`),!1))}fi(){this.document!==null&&typeof this.document.addEventListener=="function"&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground=this.document.visibilityState==="visible",this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground=this.document.visibilityState==="visible")}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;typeof((e=this.window)===null||e===void 0?void 0:e.addEventListener)=="function"&&(this.Pi=()=>{this.Li();let t=/(?:Version|Mobile)\/1[456]/;Ec()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{let r=((t=this.Vi)===null||t===void 0?void 0:t.getItem(this.Oi(e)))!==null;return V("IndexedDbPersistence",`Client '${e}' ${r?"is":"is not"} zombied in LocalStorage`),r}catch(r){return Se("IndexedDbPersistence","Failed to get zombied client id.",r),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){Se("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch{}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}};function Xs(n){return Me(n,"owner")}function Cl(n){return Me(n,"clientMetadata")}function Gm(n,e){let t=n.projectId;return n.isDefaultDatabase||(t+="."+n.database),"firestore/"+e+"/"+t+"/"}var qf=class n{constructor(e,t,r,i){this.targetId=e,this.fromCache=t,this.$i=r,this.Ui=i}static Wi(e,t){let r=H(),i=H();for(let s of t.docChanges)switch(s.type){case 0:r=r.add(s.doc.key);break;case 1:i=i.add(s.doc.key)}return new n(e,t.fromCache,r,i)}};var Gf=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}};var su=class{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return Ec()?8:Tw(ds())>0?6:4}()}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,r,i){let s={result:null};return this.Yi(e,t).next(o=>{s.result=o}).next(()=>{if(!s.result)return this.Zi(e,t,i,r).next(o=>{s.result=o})}).next(()=>{if(s.result)return;let o=new Gf;return this.Xi(e,t,o).next(l=>{if(s.result=l,this.zi)return this.es(e,t,o,l.size)})}).next(()=>s.result)}es(e,t,r,i){return r.documentReadCount<this.ji?(li()<=gt.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",ui(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),b.resolve()):(li()<=gt.DEBUG&&V("QueryEngine","Query:",ui(t),"scans",r.documentReadCount,"local documents and returns",i,"documents as results."),r.documentReadCount>this.Hi*i?(li()<=gt.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",ui(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,it(t))):b.resolve())}Yi(e,t){if(Pv(t))return b.resolve(null);let r=it(t);return this.indexManager.getIndexType(e,r).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=Kl(t,null,"F"),r=it(t)),this.indexManager.getDocumentsMatchingTarget(e,r).next(s=>{let o=H(...s);return this.Ji.getDocuments(e,o).next(l=>this.indexManager.getMinOffset(e,r).next(u=>{let c=this.ts(t,l);return this.ns(t,c,o,u.readTime)?this.Yi(e,Kl(t,null,"F")):this.rs(e,c,t,u)}))})))}Zi(e,t,r,i){return Pv(t)||i.isEqual(K.min())?b.resolve(null):this.Ji.getDocuments(e,r).next(s=>{let o=this.ts(t,s);return this.ns(t,o,r,i)?b.resolve(null):(li()<=gt.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),ui(t)),this.rs(e,o,t,ww(i,-1)).next(l=>l))})}ts(e,t){let r=new fe(Gw(e));return t.forEach((i,s)=>{No(e,s)&&(r=r.add(s))}),r}ns(e,t,r,i){if(e.limit===null)return!1;if(r.size!==t.size)return!0;let s=e.limitType==="F"?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(i)>0)}Xi(e,t,r){return li()<=gt.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",ui(t)),this.Ji.getDocumentsMatchingQuery(e,t,Et.min(),r)}rs(e,t,r,i){return this.Ji.getDocumentsMatchingQuery(e,r,i).next(s=>(t.forEach(o=>{s=s.insert(o.key,o)}),s))}};var jf=class{constructor(e,t,r,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new _e(W),this._s=new zt(s=>_r(s),Po),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(r)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new nu(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}};function IE(n,e,t,r){return new jf(n,e,t,r)}function TE(n,e){return N(this,null,function*(){let t=M(n);return yield t.persistence.runTransaction("Handle user change","readonly",r=>{let i;return t.mutationQueue.getAllMutationBatches(r).next(s=>(i=s,t.ls(e),t.mutationQueue.getAllMutationBatches(r))).next(s=>{let o=[],l=[],u=H();for(let c of i){o.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}for(let c of s){l.push(c.batchId);for(let d of c.mutations)u=u.add(d.key)}return t.localDocuments.getDocuments(r,u).next(c=>({hs:c,removedBatchIds:o,addedBatchIds:l}))})})})}function FC(n,e){let t=M(n);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",r=>{let i=e.batch.keys(),s=t.cs.newChangeBuffer({trackRemovals:!0});return function(l,u,c,d){let m=c.batch,p=m.keys(),y=b.resolve();return p.forEach(S=>{y=y.next(()=>d.getEntry(u,S)).next(x=>{let D=c.docVersions.get(S);G(D!==null),x.version.compareTo(D)<0&&(m.applyToRemoteDocument(x,c),x.isValidDocument()&&(x.setReadTime(c.commitVersion),d.addEntry(x)))})}),y.next(()=>l.mutationQueue.removeMutationBatch(u,m))}(t,r,e,s).next(()=>s.apply(r)).next(()=>t.mutationQueue.performConsistencyCheck(r)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(r,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(r,function(l){let u=H();for(let c=0;c<l.mutationResults.length;++c)l.mutationResults[c].transformResults.length>0&&(u=u.add(l.batch.mutations[c].key));return u}(e))).next(()=>t.localDocuments.getDocuments(r,i))})}function AE(n){let e=M(n);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function MC(n,e){let t=M(n),r=e.snapshotVersion,i=t.os;return t.persistence.runTransaction("Apply remote event","readwrite-primary",s=>{let o=t.cs.newChangeBuffer({trackRemovals:!0});i=t.os;let l=[];e.targetChanges.forEach((d,m)=>{let p=i.get(m);if(!p)return;l.push(t.Ur.removeMatchingKeys(s,d.removedDocuments,m).next(()=>t.Ur.addMatchingKeys(s,d.addedDocuments,m)));let y=p.withSequenceNumber(s.currentSequenceNumber);e.targetMismatches.get(m)!==null?y=y.withResumeToken(Re.EMPTY_BYTE_STRING,K.min()).withLastLimboFreeSnapshotVersion(K.min()):d.resumeToken.approximateByteSize()>0&&(y=y.withResumeToken(d.resumeToken,r)),i=i.insert(m,y),function(x,D,q){return x.resumeToken.approximateByteSize()===0||D.snapshotVersion.toMicroseconds()-x.snapshotVersion.toMicroseconds()>=3e8?!0:q.addedDocuments.size+q.modifiedDocuments.size+q.removedDocuments.size>0}(p,y,d)&&l.push(t.Ur.updateTargetData(s,y))});let u=at(),c=H();if(e.documentUpdates.forEach(d=>{e.resolvedLimboDocuments.has(d)&&l.push(t.persistence.referenceDelegate.updateLimboDocument(s,d))}),l.push(SE(s,o,e.documentUpdates).next(d=>{u=d.Ps,c=d.Is})),!r.isEqual(K.min())){let d=t.Ur.getLastRemoteSnapshotVersion(s).next(m=>t.Ur.setTargetsMetadata(s,s.currentSequenceNumber,r));l.push(d)}return b.waitFor(l).next(()=>o.apply(s)).next(()=>t.localDocuments.getLocalViewOfDocuments(s,u,c)).next(()=>u)}).then(s=>(t.os=i,s))}function SE(n,e,t){let r=H(),i=H();return t.forEach(s=>r=r.add(s)),e.getEntries(n,r).next(s=>{let o=at();return t.forEach((l,u)=>{let c=s.get(l);u.isFoundDocument()!==c.isFoundDocument()&&(i=i.add(l)),u.isNoDocument()&&u.version.isEqual(K.min())?(e.removeEntry(l,u.readTime),o=o.insert(l,u)):!c.isValidDocument()||u.version.compareTo(c.version)>0||u.version.compareTo(c.version)===0&&c.hasPendingWrites?(e.addEntry(u),o=o.insert(l,u)):V("LocalStore","Ignoring outdated watch update for ",l,". Current version:",c.version," Watch version:",u.version)}),{Ps:o,Is:i}})}function LC(n,e){let t=M(n);return t.persistence.runTransaction("Get next mutation batch","readonly",r=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(r,e)))}function Ci(n,e){let t=M(n);return t.persistence.runTransaction("Allocate target","readwrite",r=>{let i;return t.Ur.getTargetData(r,e).next(s=>s?(i=s,b.resolve(i)):t.Ur.allocateTargetId(r).next(o=>(i=new Ai(e,o,"TargetPurposeListen",r.currentSequenceNumber),t.Ur.addTargetData(r,i).next(()=>i))))}).then(r=>{let i=t.os.get(r.targetId);return(i===null||r.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(t.os=t.os.insert(r.targetId,r),t._s.set(e,r.targetId)),r})}function bi(n,e,t){return N(this,null,function*(){let r=M(n),i=r.os.get(e),s=t?"readwrite":"readwrite-primary";try{t||(yield r.persistence.runTransaction("Release target",s,o=>r.persistence.referenceDelegate.removeTarget(o,i)))}catch(o){if(!Kn(o))throw o;V("LocalStore",`Failed to update sequence numbers for target ${e}: ${o}`)}r.os=r.os.remove(e),r._s.delete(i.target)})}function ou(n,e,t){let r=M(n),i=K.min(),s=H();return r.persistence.runTransaction("Execute query","readwrite",o=>function(u,c,d){let m=M(u),p=m._s.get(d);return p!==void 0?b.resolve(m.os.get(p)):m.Ur.getTargetData(c,d)}(r,o,it(e)).next(l=>{if(l)return i=l.lastLimboFreeSnapshotVersion,r.Ur.getMatchingKeysForTargetId(o,l.targetId).next(u=>{s=u})}).next(()=>r.ss.getDocumentsMatchingQuery(o,e,t?i:K.min(),t?s:H())).next(l=>(RE(r,qw(e),l),{documents:l,Ts:s})))}function CE(n,e){let t=M(n),r=M(t.Ur),i=t.os.get(e);return i?Promise.resolve(i.target):t.persistence.runTransaction("Get target data","readonly",s=>r.ot(s,e).next(o=>o?o.target:null))}function bE(n,e){let t=M(n),r=t.us.get(e)||K.min();return t.persistence.runTransaction("Get new document changes","readonly",i=>t.cs.getAllFromCollectionGroup(i,e,ww(r,-1),Number.MAX_SAFE_INTEGER)).then(i=>(RE(t,e,i),i))}function RE(n,e,t){let r=n.us.get(e)||K.min();t.forEach((i,s)=>{s.readTime.compareTo(r)>0&&(r=s.readTime)}),n.us.set(e,r)}function UC(n,e,t,r){return N(this,null,function*(){let i=M(n),s=H(),o=at();for(let c of t){let d=e.Es(c.metadata.name);c.document&&(s=s.add(d));let m=e.ds(c);m.setReadTime(e.As(c.metadata.readTime)),o=o.insert(d,m)}let l=i.cs.newChangeBuffer({trackRemovals:!0}),u=yield Ci(i,function(d){return it(Oi(se.fromString(`__bundle__/docs/${d}`)))}(r));return i.persistence.runTransaction("Apply bundle documents","readwrite",c=>SE(c,l,o).next(d=>(l.apply(c),d)).next(d=>i.Ur.removeMatchingKeysForTargetId(c,u.targetId).next(()=>i.Ur.addMatchingKeys(c,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(c,d.Ps,d.Is)).next(()=>d.Ps)))})}function BC(r,i){return N(this,arguments,function*(n,e,t=H()){let s=yield Ci(n,it(Bm(e.bundledQuery))),o=M(n);return o.persistence.runTransaction("Save named query","readwrite",l=>{let u=be(e.readTime);if(s.snapshotVersion.compareTo(u)>=0)return o.Gr.saveNamedQuery(l,e);let c=s.withResumeToken(Re.EMPTY_BYTE_STRING,u);return o.os=o.os.insert(c.targetId,c),o.Ur.updateTargetData(l,c).next(()=>o.Ur.removeMatchingKeysForTargetId(l,s.targetId)).next(()=>o.Ur.addMatchingKeys(l,t,s.targetId)).next(()=>o.Gr.saveNamedQuery(l,e))})})}function rw(n,e){return`firestore_clients_${n}_${e}`}function iw(n,e,t){let r=`firestore_mutations_${n}_${t}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function bd(n,e){return`firestore_targets_${n}_${e}`}var au=class n{constructor(e,t,r,i){this.user=e,this.batchId=t,this.state=r,this.error=i}static Rs(e,t,r){let i=JSON.parse(r),s,o=typeof i=="object"&&["pending","acknowledged","rejected"].indexOf(i.state)!==-1&&(i.error===void 0||typeof i.error=="object");return o&&i.error&&(o=typeof i.error.message=="string"&&typeof i.error.code=="string",o&&(s=new k(i.error.code,i.error.message))),o?new n(e,t,i.state,s):(Se("SharedClientState",`Failed to parse mutation state for ID '${t}': ${r}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},io=class n{constructor(e,t,r){this.targetId=e,this.state=t,this.error=r}static Rs(e,t){let r=JSON.parse(t),i,s=typeof r=="object"&&["not-current","current","rejected"].indexOf(r.state)!==-1&&(r.error===void 0||typeof r.error=="object");return s&&r.error&&(s=typeof r.error.message=="string"&&typeof r.error.code=="string",s&&(i=new k(r.error.code,r.error.message))),s?new n(e,r.state,i):(Se("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}},lu=class n{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){let r=JSON.parse(t),i=typeof r=="object"&&r.activeTargetIds instanceof Array,s=Mm();for(let o=0;i&&o<r.activeTargetIds.length;++o)i=Aw(r.activeTargetIds[o]),s=s.add(r.activeTargetIds[o]);return i?new n(e,s):(Se("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}},Kf=class n{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){let t=JSON.parse(e);return typeof t=="object"&&["Unknown","Online","Offline"].indexOf(t.onlineState)!==-1&&typeof t.clientId=="string"?new n(t.clientId,t.onlineState):(Se("SharedClientState",`Failed to parse online state: ${e}`),null)}},Io=class{constructor(){this.activeTargetIds=Mm()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){let e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}},so=class{constructor(e,t,r,i,s){this.window=e,this.ui=t,this.persistenceKey=r,this.ps=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new _e(W),this.started=!1,this.bs=[];let o=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Ds=rw(this.persistenceKey,this.ps),this.vs=function(u){return`firestore_sequence_number_${u}`}(this.persistenceKey),this.Ss=this.Ss.insert(this.ps,new Io),this.Cs=new RegExp(`^firestore_clients_${o}_([^_]*)$`),this.Fs=new RegExp(`^firestore_mutations_${o}_(\\d+)(?:_(.*))?$`),this.Ms=new RegExp(`^firestore_targets_${o}_(\\d+)$`),this.xs=function(u){return`firestore_online_state_${u}`}(this.persistenceKey),this.Os=function(u){return`firestore_bundle_loaded_v2_${u}`}(this.persistenceKey),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}start(){return N(this,null,function*(){let e=yield this.syncEngine.Qi();for(let r of e){if(r===this.ps)continue;let i=this.getItem(rw(this.persistenceKey,r));if(i){let s=lu.Rs(r,i);s&&(this.Ss=this.Ss.insert(s.clientId,s))}}this.Ns();let t=this.storage.getItem(this.xs);if(t){let r=this.Ls(t);r&&this.Bs(r)}for(let r of this.bs)this.ws(r);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0})}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((r,i)=>{i.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,r){this.qs(e,t,r),this.Qs(e)}addLocalQueryTarget(e,t=!0){let r="not-current";if(this.isActiveQueryTarget(e)){let i=this.storage.getItem(bd(this.persistenceKey,e));if(i){let s=io.Rs(e,i);s&&(r=s.state)}}return t&&this.Ks.fs(e),this.Ns(),r}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(bd(this.persistenceKey,e))}updateQueryState(e,t,r){this.$s(e,t,r)}handleUserChange(e,t,r){t.forEach(i=>{this.Qs(i)}),this.currentUser=e,r.forEach(i=>{this.addPendingMutation(i)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return V("SharedClientState","READ",e,t),t}setItem(e,t){V("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){V("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){let t=e;if(t.storageArea===this.storage){if(V("SharedClientState","EVENT",t.key,t.newValue),t.key===this.Ds)return void Se("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(()=>N(this,null,function*(){if(this.started){if(t.key!==null){if(this.Cs.test(t.key)){if(t.newValue==null){let r=this.Gs(t.key);return this.zs(r,null)}{let r=this.js(t.key,t.newValue);if(r)return this.zs(r.clientId,r)}}else if(this.Fs.test(t.key)){if(t.newValue!==null){let r=this.Hs(t.key,t.newValue);if(r)return this.Js(r)}}else if(this.Ms.test(t.key)){if(t.newValue!==null){let r=this.Ys(t.key,t.newValue);if(r)return this.Zs(r)}}else if(t.key===this.xs){if(t.newValue!==null){let r=this.Ls(t.newValue);if(r)return this.Bs(r)}}else if(t.key===this.vs){let r=function(s){let o=ft.oe;if(s!=null)try{let l=JSON.parse(s);G(typeof l=="number"),o=l}catch(l){Se("SharedClientState","Failed to read sequence number from WebStorage",l)}return o}(t.newValue);r!==ft.oe&&this.sequenceNumberHandler(r)}else if(t.key===this.Os){let r=this.Xs(t.newValue);yield Promise.all(r.map(i=>this.syncEngine.eo(i)))}}}else this.bs.push(t)}))}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,r){let i=new au(this.currentUser,e,t,r),s=iw(this.persistenceKey,this.currentUser,e);this.setItem(s,i.Vs())}Qs(e){let t=iw(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){let t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,r){let i=bd(this.persistenceKey,e),s=new io(e,t,r);this.setItem(i,s.Vs())}Ws(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){let t=this.Cs.exec(e);return t?t[1]:null}js(e,t){let r=this.Gs(e);return lu.Rs(r,t)}Hs(e,t){let r=this.Fs.exec(e),i=Number(r[1]),s=r[2]!==void 0?r[2]:null;return au.Rs(new De(s),i,t)}Ys(e,t){let r=this.Ms.exec(e),i=Number(r[1]);return io.Rs(i,t)}Ls(e){return Kf.Rs(e)}Xs(e){return JSON.parse(e)}Js(e){return N(this,null,function*(){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);V("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)})}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){let r=t?this.Ss.insert(e,t):this.Ss.remove(e),i=this.ks(this.Ss),s=this.ks(r),o=[],l=[];return s.forEach(u=>{i.has(u)||o.push(u)}),i.forEach(u=>{s.has(u)||l.push(u)}),this.syncEngine.io(o,l).then(()=>{this.Ss=r})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=Mm();return e.forEach((r,i)=>{t=t.unionWith(i.activeTargetIds)}),t}},uu=class{constructor(){this.so=new Io,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,r){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,r){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Io,Promise.resolve()}handleUserChange(e,t,r){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}};var zf=class{_o(e){}shutdown(){}};var cu=class{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let e of this.ho)e(0)}lo(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let e of this.ho)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var bl=null;function Rd(){return bl===null?bl=function(){return 268435456+Math.round(2147483648*Math.random())}():bl++,"0x"+bl.toString(16)}var qC={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Wf=class{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}};var He="WebChannelConnection",Qf=class extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;let r=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),s=encodeURIComponent(this.databaseId.database);this.Do=r+"://"+t.host,this.vo=`projects/${i}/databases/${s}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${s}`}get Fo(){return!1}Mo(t,r,i,s,o){let l=Rd(),u=this.xo(t,r.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${l}:`,u,i);let c={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(c,s,o),this.No(t,u,c,i).then(d=>(V("RestConnection",`Received RPC '${t}' ${l}: `,d),d),d=>{throw Ct("RestConnection",`RPC '${t}' ${l} failed with error: `,d,"url: ",u,"request:",i),d})}Lo(t,r,i,s,o,l){return this.Mo(t,r,i,s,o)}Oo(t,r,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Vi}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),r&&r.headers.forEach((s,o)=>t[o]=s),i&&i.headers.forEach((s,o)=>t[o]=s)}xo(t,r){let i=qC[t];return`${this.Do}/v1/${r}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,r,i){let s=Rd();return new Promise((o,l)=>{let u=new wd;u.setWithCredentials(!0),u.listenOnce(Ed.COMPLETE,()=>{try{switch(u.getLastErrorCode()){case $s.NO_ERROR:let d=u.getResponseJson();V(He,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(d)),o(d);break;case $s.TIMEOUT:V(He,`RPC '${e}' ${s} timed out`),l(new k(P.DEADLINE_EXCEEDED,"Request time out"));break;case $s.HTTP_ERROR:let m=u.getStatus();if(V(He,`RPC '${e}' ${s} failed with status:`,m,"response text:",u.getResponseText()),m>0){let p=u.getResponseJson();Array.isArray(p)&&(p=p[0]);let y=p?.error;if(y&&y.status&&y.message){let S=function(D){let q=D.toLowerCase().replace(/_/g,"-");return Object.values(P).indexOf(q)>=0?q:P.UNKNOWN}(y.status);l(new k(S,y.message))}else l(new k(P.UNKNOWN,"Server responded with status "+u.getStatus()))}else l(new k(P.UNAVAILABLE,"Connection failed."));break;default:U()}}finally{V(He,`RPC '${e}' ${s} completed.`)}});let c=JSON.stringify(i);V(He,`RPC '${e}' ${s} sending request:`,i),u.send(t,"POST",c,r,15)})}Bo(e,t,r){let i=Rd(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=Ad(),l=Td(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;c!==void 0&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.useFetchStreams=!0),this.Oo(u.initMessageHeaders,t,r),u.encodeInitMessageHeaders=!0;let d=s.join("");V(He,`Creating RPC '${e}' stream ${i}: ${d}`,u);let m=o.createWebChannel(d,u),p=!1,y=!1,S=new Wf({Io:D=>{y?V(He,`Not sending because RPC '${e}' stream ${i} is closed:`,D):(p||(V(He,`Opening RPC '${e}' stream ${i} transport.`),m.open(),p=!0),V(He,`RPC '${e}' stream ${i} sending:`,D),m.send(D))},To:()=>m.close()}),x=(D,q,j)=>{D.listen(q,B=>{try{j(B)}catch(Y){setTimeout(()=>{throw Y},0)}})};return x(m,ri.EventType.OPEN,()=>{y||(V(He,`RPC '${e}' stream ${i} transport opened.`),S.yo())}),x(m,ri.EventType.CLOSE,()=>{y||(y=!0,V(He,`RPC '${e}' stream ${i} transport closed`),S.So())}),x(m,ri.EventType.ERROR,D=>{y||(y=!0,Ct(He,`RPC '${e}' stream ${i} transport errored:`,D),S.So(new k(P.UNAVAILABLE,"The operation could not be completed")))}),x(m,ri.EventType.MESSAGE,D=>{var q;if(!y){let j=D.data[0];G(!!j);let B=j,Y=B.error||((q=B[0])===null||q===void 0?void 0:q.error);if(Y){V(He,`RPC '${e}' stream ${i} received error:`,Y);let ne=Y.status,Q=function(w){let I=xe[w];if(I!==void 0)return tE(I)}(ne),E=Y.message;Q===void 0&&(Q=P.INTERNAL,E="Unknown error status: "+ne+" with message "+Y.message),y=!0,S.So(new k(Q,E)),m.close()}else V(He,`RPC '${e}' stream ${i} received:`,j),S.bo(j)}}),x(l,Id.STAT_EVENT,D=>{D.stat===Tl.PROXY?V(He,`RPC '${e}' stream ${i} detected buffering proxy`):D.stat===Tl.NOPROXY&&V(He,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{S.wo()},0),S}};function PE(){return typeof window<"u"?window:null}function Dl(){return typeof document<"u"?document:null}function Do(n){return new lf(n,!0)}var To=class{constructor(e,t,r=1e3,i=1.5,s=6e4){this.ui=e,this.timerId=t,this.ko=r,this.qo=i,this.Qo=s,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();let t=Math.floor(this.Ko+this.zo()),r=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-r);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${r} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}};var hu=class{constructor(e,t,r,i,s,o,l,u){this.ui=e,this.Ho=r,this.Jo=i,this.connection=s,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=l,this.listener=u,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new To(e,t)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}stop(){return N(this,null,function*(){this.n_()&&(yield this.close(0))})}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}__(){return N(this,null,function*(){if(this.r_())return this.close(0)})}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}close(e,t){return N(this,null,function*(){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,e!==4?this.t_.reset():t&&t.code===P.RESOURCE_EXHAUSTED?(Se(t.toString()),Se("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===P.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,yield this.listener.mo(t)})}l_(){}auth(){this.state=1;let e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([r,i])=>{this.Yo===t&&this.P_(r,i)},r=>{e(()=>{let i=new k(P.UNKNOWN,"Fetching auth token failed: "+r.message);return this.I_(i)})})}P_(e,t){let r=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{r(()=>this.listener.Eo())}),this.stream.Ro(()=>{r(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{r(()=>this.I_(i))}),this.stream.onMessage(i=>{r(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(()=>N(this,null,function*(){this.state=0,this.start()}))}I_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}},$f=class extends hu{constructor(e,t,r,i,s,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();let t=SC(this.serializer,e),r=function(s){if(!("targetChange"in s))return K.min();let o=s.targetChange;return o.targetIds&&o.targetIds.length?K.min():o.readTime?be(o.readTime):K.min()}(e);return this.listener.d_(t,r)}A_(e){let t={};t.database=hf(this.serializer),t.addTarget=function(s,o){let l,u=o.target;if(l=Gl(u)?{documents:uE(s,u)}:{query:cE(s,u)._t},l.targetId=o.targetId,o.resumeToken.approximateByteSize()>0){l.resumeToken=rE(s,o.resumeToken);let c=uf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}else if(o.snapshotVersion.compareTo(K.min())>0){l.readTime=Ti(s,o.snapshotVersion.toTimestamp());let c=uf(s,o.expectedCount);c!==null&&(l.expectedCount=c)}return l}(this.serializer,e);let r=bC(this.serializer,e);r&&(t.labels=r),this.a_(t)}R_(e){let t={};t.database=hf(this.serializer),t.removeTarget=e,this.a_(t)}},Hf=class extends hu{constructor(e,t,r,i,s,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,r,i,o),this.serializer=s}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return G(!!e.streamToken),this.lastStreamToken=e.streamToken,G(!e.writeResults||e.writeResults.length===0),this.listener.f_()}onNext(e){G(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();let t=CC(e.writeResults,e.commitTime),r=be(e.commitTime);return this.listener.g_(r,t)}p_(){let e={};e.database=hf(this.serializer),this.a_(e)}m_(e){let t={streamToken:this.lastStreamToken,writes:e.map(r=>vo(this.serializer,r))};this.a_(t)}};var Yf=class extends class{}{constructor(e,t,r,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=r,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,r,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,o])=>this.connection.Mo(e,cf(t,r),i,s,o)).catch(s=>{throw s.name==="FirebaseError"?(s.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),s):new k(P.UNKNOWN,s.toString())})}Lo(e,t,r,i,s){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,l])=>this.connection.Lo(e,cf(t,r),i,o,l,s)).catch(o=>{throw o.name==="FirebaseError"?(o.code===P.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new k(P.UNKNOWN,o.toString())})}terminate(){this.y_=!0,this.connection.terminate()}},Jf=class{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,e==="Online"&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(Se(t),this.D_=!1):V("OnlineStateTracker",t)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}};var Xf=class{constructor(e,t,r,i,s){this.localStore=e,this.datastore=t,this.asyncQueue=r,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=s,this.k_._o(o=>{r.enqueueAndForget(()=>N(this,null,function*(){zn(this)&&(V("RemoteStore","Restarting streams for network reachability change."),yield function(u){return N(this,null,function*(){let c=M(u);c.L_.add(4),yield Fi(c),c.q_.set("Unknown"),c.L_.delete(4),yield ko(c)})}(this))}))}),this.q_=new Jf(r,i)}};function ko(n){return N(this,null,function*(){if(zn(n))for(let e of n.B_)yield e(!0)})}function Fi(n){return N(this,null,function*(){for(let e of n.B_)yield e(!1)})}function Du(n,e){let t=M(n);t.N_.has(e.targetId)||(t.N_.set(e.targetId,e),zm(t)?Km(t):Li(t).r_()&&jm(t,e))}function Ri(n,e){let t=M(n),r=Li(t);t.N_.delete(e),r.r_()&&xE(t,e),t.N_.size===0&&(r.r_()?r.o_():zn(t)&&t.q_.set("Unknown"))}function jm(n,e){if(n.Q_.xe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(K.min())>0){let t=n.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(t)}Li(n).A_(e)}function xE(n,e){n.Q_.xe(e),Li(n).R_(e)}function Km(n){n.Q_=new af({getRemoteKeysForTarget:e=>n.remoteSyncer.getRemoteKeysForTarget(e),ot:e=>n.N_.get(e)||null,tt:()=>n.datastore.serializer.databaseId}),Li(n).start(),n.q_.v_()}function zm(n){return zn(n)&&!Li(n).n_()&&n.N_.size>0}function zn(n){return M(n).L_.size===0}function NE(n){n.Q_=void 0}function GC(n){return N(this,null,function*(){n.q_.set("Online")})}function jC(n){return N(this,null,function*(){n.N_.forEach((e,t)=>{jm(n,e)})})}function KC(n,e){return N(this,null,function*(){NE(n),zm(n)?(n.q_.M_(e),Km(n)):n.q_.set("Unknown")})}function zC(n,e,t){return N(this,null,function*(){if(n.q_.set("Online"),e instanceof Wl&&e.state===2&&e.cause)try{yield function(i,s){return N(this,null,function*(){let o=s.cause;for(let l of s.targetIds)i.N_.has(l)&&(yield i.remoteSyncer.rejectListen(l,o),i.N_.delete(l),i.Q_.removeTarget(l))})}(n,e)}catch(r){V("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),r),yield du(n,r)}else if(e instanceof gi?n.Q_.Ke(e):e instanceof zl?n.Q_.He(e):n.Q_.We(e),!t.isEqual(K.min()))try{let r=yield AE(n.localStore);t.compareTo(r)>=0&&(yield function(s,o){let l=s.Q_.rt(o);return l.targetChanges.forEach((u,c)=>{if(u.resumeToken.approximateByteSize()>0){let d=s.N_.get(c);d&&s.N_.set(c,d.withResumeToken(u.resumeToken,o))}}),l.targetMismatches.forEach((u,c)=>{let d=s.N_.get(u);if(!d)return;s.N_.set(u,d.withResumeToken(Re.EMPTY_BYTE_STRING,d.snapshotVersion)),xE(s,u);let m=new Ai(d.target,u,c,d.sequenceNumber);jm(s,m)}),s.remoteSyncer.applyRemoteEvent(l)}(n,t))}catch(r){V("RemoteStore","Failed to raise snapshot:",r),yield du(n,r)}})}function du(n,e,t){return N(this,null,function*(){if(!Kn(e))throw e;n.L_.add(1),yield Fi(n),n.q_.set("Offline"),t||(t=()=>AE(n.localStore)),n.asyncQueue.enqueueRetryable(()=>N(this,null,function*(){V("RemoteStore","Retrying IndexedDB access"),yield t(),n.L_.delete(1),yield ko(n)}))})}function DE(n,e){return e().catch(t=>du(n,t,e))}function Mi(n){return N(this,null,function*(){let e=M(n),t=Gn(e),r=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;WC(e);)try{let i=yield LC(e.localStore,r);if(i===null){e.O_.length===0&&t.o_();break}r=i.batchId,QC(e,i)}catch(i){yield du(e,i)}kE(e)&&VE(e)})}function WC(n){return zn(n)&&n.O_.length<10}function QC(n,e){n.O_.push(e);let t=Gn(n);t.r_()&&t.V_&&t.m_(e.mutations)}function kE(n){return zn(n)&&!Gn(n).n_()&&n.O_.length>0}function VE(n){Gn(n).start()}function $C(n){return N(this,null,function*(){Gn(n).p_()})}function HC(n){return N(this,null,function*(){let e=Gn(n);for(let t of n.O_)e.m_(t.mutations)})}function YC(n,e,t){return N(this,null,function*(){let r=n.O_.shift(),i=rf.from(r,e,t);yield DE(n,()=>n.remoteSyncer.applySuccessfulWrite(i)),yield Mi(n)})}function JC(n,e){return N(this,null,function*(){e&&Gn(n).V_&&(yield function(r,i){return N(this,null,function*(){if(function(o){return eE(o)&&o!==P.ABORTED}(i.code)){let s=r.O_.shift();Gn(r).s_(),yield DE(r,()=>r.remoteSyncer.rejectFailedWrite(s.batchId,i)),yield Mi(r)}})}(n,e)),kE(n)&&VE(n)})}function sw(n,e){return N(this,null,function*(){let t=M(n);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");let r=zn(t);t.L_.add(3),yield Fi(t),r&&t.q_.set("Unknown"),yield t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),yield ko(t)})}function Zf(n,e){return N(this,null,function*(){let t=M(n);e?(t.L_.delete(2),yield ko(t)):e||(t.L_.add(2),yield Fi(t),t.q_.set("Unknown"))})}function Li(n){return n.K_||(n.K_=function(t,r,i){let s=M(t);return s.w_(),new $f(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:GC.bind(null,n),Ro:jC.bind(null,n),mo:KC.bind(null,n),d_:zC.bind(null,n)}),n.B_.push(e=>N(this,null,function*(){e?(n.K_.s_(),zm(n)?Km(n):n.q_.set("Unknown")):(yield n.K_.stop(),NE(n))}))),n.K_}function Gn(n){return n.U_||(n.U_=function(t,r,i){let s=M(t);return s.w_(),new Hf(r,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,i)}(n.datastore,n.asyncQueue,{Eo:()=>Promise.resolve(),Ro:$C.bind(null,n),mo:JC.bind(null,n),f_:HC.bind(null,n),g_:YC.bind(null,n)}),n.B_.push(e=>N(this,null,function*(){e?(n.U_.s_(),yield Mi(n)):(yield n.U_.stop(),n.O_.length>0&&(V("RemoteStore",`Stopping write stream with ${n.O_.length} pending writes`),n.O_=[]))}))),n.U_}var em=class n{constructor(e,t,r,i,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=r,this.op=i,this.removalCallback=s,this.deferred=new Fe,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,r,i,s){let o=Date.now()+r,l=new n(e,t,o,i,s);return l.start(r),l}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new k(P.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function Ui(n,e){if(Se("AsyncQueue",`${e}: ${n}`),Kn(n))return new k(P.UNAVAILABLE,`${e}: ${n}`);throw n}var fu=class n{constructor(e){this.comparator=e?(t,r)=>e(t,r)||L.comparator(t.key,r.key):(t,r)=>L.comparator(t.key,r.key),this.keyedMap=Zs(),this.sortedSet=new _e(this.comparator)}static emptySet(e){return new n(e.comparator)}has(e){return this.keyedMap.get(e)!=null}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,r)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof n)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),r=e.sortedSet.getIterator();for(;t.hasNext();){let i=t.getNext().key,s=r.getNext().key;if(!i.isEqual(s))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),e.length===0?"DocumentSet ()":`DocumentSet (
  `+e.join(`  
`)+`
)`}copy(e,t){let r=new n;return r.comparator=this.comparator,r.keyedMap=e,r.sortedSet=t,r}};var mu=class{constructor(){this.W_=new _e(L.comparator)}track(e){let t=e.doc.key,r=this.W_.get(t);r?e.type!==0&&r.type===3?this.W_=this.W_.insert(t,e):e.type===3&&r.type!==1?this.W_=this.W_.insert(t,{type:r.type,doc:e.doc}):e.type===2&&r.type===2?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):e.type===2&&r.type===0?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):e.type===1&&r.type===0?this.W_=this.W_.remove(t):e.type===1&&r.type===2?this.W_=this.W_.insert(t,{type:1,doc:r.doc}):e.type===0&&r.type===1?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):U():this.W_=this.W_.insert(t,e)}G_(){let e=[];return this.W_.inorderTraversal((t,r)=>{e.push(r)}),e}},Pi=class n{constructor(e,t,r,i,s,o,l,u,c){this.query=e,this.docs=t,this.oldDocs=r,this.docChanges=i,this.mutatedKeys=s,this.fromCache=o,this.syncStateChanged=l,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,r,i,s){let o=[];return t.forEach(l=>{o.push({type:0,doc:l})}),new n(e,t,fu.emptySet(t),o,r,i,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&xo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,r=e.docChanges;if(t.length!==r.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==r[i].type||!t[i].doc.isEqual(r[i].doc))return!1;return!0}};var tm=class{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}},nm=class{constructor(){this.queries=ow(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(t,r){let i=M(t),s=i.queries;i.queries=ow(),s.forEach((o,l)=>{for(let u of l.j_)u.onError(r)})})(this,new k(P.ABORTED,"Firestore shutting down"))}};function ow(){return new zt(n=>Bw(n),xo)}function Wm(n,e){return N(this,null,function*(){let t=M(n),r=3,i=e.query,s=t.queries.get(i);s?!s.H_()&&e.J_()&&(r=2):(s=new tm,r=e.J_()?0:1);try{switch(r){case 0:s.z_=yield t.onListen(i,!0);break;case 1:s.z_=yield t.onListen(i,!1);break;case 2:yield t.onFirstRemoteStoreListen(i)}}catch(o){let l=Ui(o,`Initialization of query '${ui(e.query)}' failed`);return void e.onError(l)}t.queries.set(i,s),s.j_.push(e),e.Z_(t.onlineState),s.z_&&e.X_(s.z_)&&$m(t)})}function Qm(n,e){return N(this,null,function*(){let t=M(n),r=e.query,i=3,s=t.queries.get(r);if(s){let o=s.j_.indexOf(e);o>=0&&(s.j_.splice(o,1),s.j_.length===0?i=e.J_()?0:1:!s.H_()&&e.J_()&&(i=2))}switch(i){case 0:return t.queries.delete(r),t.onUnlisten(r,!0);case 1:return t.queries.delete(r),t.onUnlisten(r,!1);case 2:return t.onLastRemoteStoreUnlisten(r);default:return}})}function XC(n,e){let t=M(n),r=!1;for(let i of e){let s=i.query,o=t.queries.get(s);if(o){for(let l of o.j_)l.X_(i)&&(r=!0);o.z_=i}}r&&$m(t)}function ZC(n,e,t){let r=M(n),i=r.queries.get(e);if(i)for(let s of i.j_)s.onError(t);r.queries.delete(e)}function $m(n){n.Y_.forEach(e=>{e.next()})}var rm,aw;(aw=rm||(rm={})).ea="default",aw.Cache="cache";var Ao=class{constructor(e,t,r){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=r||{}}X_(e){if(!this.options.includeMetadataChanges){let r=[];for(let i of e.docChanges)i.type!==3&&r.push(i);e=new Pi(e.query,e.docs,e.oldDocs,r,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){if(!e.fromCache||!this.J_())return!0;let r=t!=="Offline";return(!this.options._a||!r)&&(!e.docs.isEmpty()||e.hasCachedResults||t==="Offline")}ia(e){if(e.docChanges.length>0)return!0;let t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&this.options.includeMetadataChanges===!0}oa(e){e=Pi.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==rm.Cache}};var im=class{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}};var pu=class{constructor(e){this.serializer=e}Es(e){return qt(this.serializer,e)}ds(e){return e.metadata.exists?lE(this.serializer,e.document,!1):ke.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return be(e)}},sm=class{constructor(e,t,r){this.ca=e,this.localStore=t,this.serializer=r,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=OE(e)}la(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.aa.namedQuery)this.queries.push(e.aa.namedQuery);else if(e.aa.documentMetadata){this.documents.push({metadata:e.aa.documentMetadata}),e.aa.documentMetadata.exists||++t;let r=se.fromString(e.aa.documentMetadata.name);this.collectionGroups.add(r.get(r.length-2))}else e.aa.document&&(this.documents[this.documents.length-1].document=e.aa.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ha(e){let t=new Map,r=new pu(this.serializer);for(let i of e)if(i.metadata.queries){let s=r.Es(i.metadata.name);for(let o of i.metadata.queries){let l=(t.get(o)||H()).add(s);t.set(o,l)}}return t}complete(){return N(this,null,function*(){let e=yield UC(this.localStore,new pu(this.serializer),this.documents,this.ca.id),t=this.ha(this.documents);for(let r of this.queries)yield BC(this.localStore,r,t.get(r.name));return this.progress.taskState="Success",{progress:this.progress,Pa:this.collectionGroups,Ia:e}})}};function OE(n){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:n.totalDocuments,totalBytes:n.totalBytes}}var gu=class{constructor(e){this.key=e}},_u=class{constructor(e){this.key=e}},yu=class{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=H(),this.mutatedKeys=H(),this.Aa=Gw(e),this.Ra=new fu(this.Aa)}get Va(){return this.Ta}ma(e,t){let r=t?t.fa:new mu,i=t?t.Ra:this.Ra,s=t?t.mutatedKeys:this.mutatedKeys,o=i,l=!1,u=this.query.limitType==="F"&&i.size===this.query.limit?i.last():null,c=this.query.limitType==="L"&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal((d,m)=>{let p=i.get(d),y=No(this.query,m)?m:null,S=!!p&&this.mutatedKeys.has(p.key),x=!!y&&(y.hasLocalMutations||this.mutatedKeys.has(y.key)&&y.hasCommittedMutations),D=!1;p&&y?p.data.isEqual(y.data)?S!==x&&(r.track({type:3,doc:y}),D=!0):this.ga(p,y)||(r.track({type:2,doc:y}),D=!0,(u&&this.Aa(y,u)>0||c&&this.Aa(y,c)<0)&&(l=!0)):!p&&y?(r.track({type:0,doc:y}),D=!0):p&&!y&&(r.track({type:1,doc:p}),D=!0,(u||c)&&(l=!0)),D&&(y?(o=o.add(y),s=x?s.add(d):s.delete(d)):(o=o.delete(d),s=s.delete(d)))}),this.query.limit!==null)for(;o.size>this.query.limit;){let d=this.query.limitType==="F"?o.last():o.first();o=o.delete(d.key),s=s.delete(d.key),r.track({type:1,doc:d})}return{Ra:o,fa:r,ns:l,mutatedKeys:s}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,r,i){let s=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;let o=e.fa.G_();o.sort((d,m)=>function(y,S){let x=D=>{switch(D){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return U()}};return x(y)-x(S)}(d.type,m.type)||this.Aa(d.doc,m.doc)),this.pa(r),i=i!=null&&i;let l=t&&!i?this.ya():[],u=this.da.size===0&&this.current&&!i?1:0,c=u!==this.Ea;return this.Ea=u,o.length!==0||c?{snapshot:new Pi(this.query,e.Ra,s,o,e.mutatedKeys,u===0,c,!1,!!r&&r.resumeToken.approximateByteSize()>0),wa:l}:{wa:l}}Z_(e){return this.current&&e==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new mu,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(t=>this.Ta=this.Ta.add(t)),e.modifiedDocuments.forEach(t=>{}),e.removedDocuments.forEach(t=>this.Ta=this.Ta.delete(t)),this.current=e.current)}ya(){if(!this.current)return[];let e=this.da;this.da=H(),this.Ra.forEach(r=>{this.Sa(r.key)&&(this.da=this.da.add(r.key))});let t=[];return e.forEach(r=>{this.da.has(r)||t.push(new _u(r))}),this.da.forEach(r=>{e.has(r)||t.push(new gu(r))}),t}ba(e){this.Ta=e.Ts,this.da=H();let t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return Pi.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}},om=class{constructor(e,t,r){this.query=e,this.targetId=t,this.view=r}},am=class{constructor(e){this.key=e,this.va=!1}},lm=class{constructor(e,t,r,i,s,o){this.localStore=e,this.remoteStore=t,this.eventManager=r,this.sharedClientState=i,this.currentUser=s,this.maxConcurrentLimboResolutions=o,this.Ca={},this.Fa=new zt(l=>Bw(l),xo),this.Ma=new Map,this.xa=new Set,this.Oa=new _e(L.comparator),this.Na=new Map,this.La=new Eo,this.Ba={},this.ka=new Map,this.qa=Si.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}};function eb(n,e,t=!0){return N(this,null,function*(){let r=ku(n),i,s=r.Fa.get(e);return s?(r.sharedClientState.addLocalQueryTarget(s.targetId),i=s.view.Da()):i=yield FE(r,e,t,!0),i})}function tb(n,e){return N(this,null,function*(){let t=ku(n);yield FE(t,e,!0,!1)})}function FE(n,e,t,r){return N(this,null,function*(){let i=yield Ci(n.localStore,it(e)),s=i.targetId,o=n.sharedClientState.addLocalQueryTarget(s,t),l;return r&&(l=yield Hm(n,e,s,o==="current",i.resumeToken)),n.isPrimaryClient&&t&&Du(n.remoteStore,i),l})}function Hm(n,e,t,r,i){return N(this,null,function*(){n.Ka=(m,p,y)=>function(x,D,q,j){return N(this,null,function*(){let B=D.view.ma(q);B.ns&&(B=yield ou(x.localStore,D.query,!1).then(({documents:E})=>D.view.ma(E,B)));let Y=j&&j.targetChanges.get(D.targetId),ne=j&&j.targetMismatches.get(D.targetId)!=null,Q=D.view.applyChanges(B,x.isPrimaryClient,Y,ne);return um(x,D.targetId,Q.wa),Q.snapshot})}(n,m,p,y);let s=yield ou(n.localStore,e,!0),o=new yu(e,s.Ts),l=o.ma(s.documents),u=_o.createSynthesizedTargetChangeForCurrentChange(t,r&&n.onlineState!=="Offline",i),c=o.applyChanges(l,n.isPrimaryClient,u);um(n,t,c.wa);let d=new om(e,t,o);return n.Fa.set(e,d),n.Ma.has(t)?n.Ma.get(t).push(e):n.Ma.set(t,[e]),c.snapshot})}function nb(n,e,t){return N(this,null,function*(){let r=M(n),i=r.Fa.get(e),s=r.Ma.get(i.targetId);if(s.length>1)return r.Ma.set(i.targetId,s.filter(o=>!xo(o,e))),void r.Fa.delete(e);r.isPrimaryClient?(r.sharedClientState.removeLocalQueryTarget(i.targetId),r.sharedClientState.isActiveQueryTarget(i.targetId)||(yield bi(r.localStore,i.targetId,!1).then(()=>{r.sharedClientState.clearQueryState(i.targetId),t&&Ri(r.remoteStore,i.targetId),xi(r,i.targetId)}).catch(jn))):(xi(r,i.targetId),yield bi(r.localStore,i.targetId,!0))})}function rb(n,e){return N(this,null,function*(){let t=M(n),r=t.Fa.get(e),i=t.Ma.get(r.targetId);t.isPrimaryClient&&i.length===1&&(t.sharedClientState.removeLocalQueryTarget(r.targetId),Ri(t.remoteStore,r.targetId))})}function ib(n,e,t){return N(this,null,function*(){let r=Zm(n);try{let i=yield function(o,l){let u=M(o),c=Ee.now(),d=l.reduce((y,S)=>y.add(S.key),H()),m,p;return u.persistence.runTransaction("Locally write mutations","readwrite",y=>{let S=at(),x=H();return u.cs.getEntries(y,d).next(D=>{S=D,S.forEach((q,j)=>{j.isValidDocument()||(x=x.add(q))})}).next(()=>u.localDocuments.getOverlayedDocuments(y,S)).next(D=>{m=D;let q=[];for(let j of l){let B=yC(j,m.get(j.key).overlayedDocument);B!=null&&q.push(new Rt(j.key,B,kw(B.value.mapValue),Ae.exists(!0)))}return u.mutationQueue.addMutationBatch(y,c,q,l)}).next(D=>{p=D;let q=D.applyToLocalDocumentSet(m,x);return u.documentOverlayCache.saveOverlays(y,D.batchId,q)})}).then(()=>({batchId:p.batchId,changes:Kw(m)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(i.batchId),function(o,l,u){let c=o.Ba[o.currentUser.toKey()];c||(c=new _e(W)),c=c.insert(l,u),o.Ba[o.currentUser.toKey()]=c}(r,i.batchId,t),yield ln(r,i.changes),yield Mi(r.remoteStore)}catch(i){let s=Ui(i,"Failed to persist write");t.reject(s)}})}function ME(n,e){return N(this,null,function*(){let t=M(n);try{let r=yield MC(t.localStore,e);e.targetChanges.forEach((i,s)=>{let o=t.Na.get(s);o&&(G(i.addedDocuments.size+i.modifiedDocuments.size+i.removedDocuments.size<=1),i.addedDocuments.size>0?o.va=!0:i.modifiedDocuments.size>0?G(o.va):i.removedDocuments.size>0&&(G(o.va),o.va=!1))}),yield ln(t,r,e)}catch(r){yield jn(r)}})}function lw(n,e,t){let r=M(n);if(r.isPrimaryClient&&t===0||!r.isPrimaryClient&&t===1){let i=[];r.Fa.forEach((s,o)=>{let l=o.view.Z_(e);l.snapshot&&i.push(l.snapshot)}),function(o,l){let u=M(o);u.onlineState=l;let c=!1;u.queries.forEach((d,m)=>{for(let p of m.j_)p.Z_(l)&&(c=!0)}),c&&$m(u)}(r.eventManager,e),i.length&&r.Ca.d_(i),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}function sb(n,e,t){return N(this,null,function*(){let r=M(n);r.sharedClientState.updateQueryState(e,"rejected",t);let i=r.Na.get(e),s=i&&i.key;if(s){let o=new _e(L.comparator);o=o.insert(s,ke.newNoDocument(s,K.min()));let l=H().add(s),u=new go(K.min(),new Map,new _e(W),o,l);yield ME(r,u),r.Oa=r.Oa.remove(s),r.Na.delete(e),Xm(r)}else yield bi(r.localStore,e,!1).then(()=>xi(r,e,t)).catch(jn)})}function ob(n,e){return N(this,null,function*(){let t=M(n),r=e.batch.batchId;try{let i=yield FC(t.localStore,e);Jm(t,r,null),Ym(t,r),t.sharedClientState.updateMutationState(r,"acknowledged"),yield ln(t,i)}catch(i){yield jn(i)}})}function ab(n,e,t){return N(this,null,function*(){let r=M(n);try{let i=yield function(o,l){let u=M(o);return u.persistence.runTransaction("Reject batch","readwrite-primary",c=>{let d;return u.mutationQueue.lookupMutationBatch(c,l).next(m=>(G(m!==null),d=m.keys(),u.mutationQueue.removeMutationBatch(c,m))).next(()=>u.mutationQueue.performConsistencyCheck(c)).next(()=>u.documentOverlayCache.removeOverlaysForBatchId(c,d,l)).next(()=>u.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(c,d)).next(()=>u.localDocuments.getDocuments(c,d))})}(r.localStore,e);Jm(r,e,t),Ym(r,e),r.sharedClientState.updateMutationState(e,"rejected",t),yield ln(r,i)}catch(i){yield jn(i)}})}function lb(n,e){return N(this,null,function*(){let t=M(n);zn(t.remoteStore)||V("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{let r=yield function(o){let l=M(o);return l.persistence.runTransaction("Get highest unacknowledged batch id","readonly",u=>l.mutationQueue.getHighestUnacknowledgedBatchId(u))}(t.localStore);if(r===-1)return void e.resolve();let i=t.ka.get(r)||[];i.push(e),t.ka.set(r,i)}catch(r){let i=Ui(r,"Initialization of waitForPendingWrites() operation failed");e.reject(i)}})}function Ym(n,e){(n.ka.get(e)||[]).forEach(t=>{t.resolve()}),n.ka.delete(e)}function Jm(n,e,t){let r=M(n),i=r.Ba[r.currentUser.toKey()];if(i){let s=i.get(e);s&&(t?s.reject(t):s.resolve(),i=i.remove(e)),r.Ba[r.currentUser.toKey()]=i}}function xi(n,e,t=null){n.sharedClientState.removeLocalQueryTarget(e);for(let r of n.Ma.get(e))n.Fa.delete(r),t&&n.Ca.$a(r,t);n.Ma.delete(e),n.isPrimaryClient&&n.La.gr(e).forEach(r=>{n.La.containsKey(r)||LE(n,r)})}function LE(n,e){n.xa.delete(e.path.canonicalString());let t=n.Oa.get(e);t!==null&&(Ri(n.remoteStore,t),n.Oa=n.Oa.remove(e),n.Na.delete(t),Xm(n))}function um(n,e,t){for(let r of t)r instanceof gu?(n.La.addReference(r.key,e),ub(n,r)):r instanceof _u?(V("SyncEngine","Document no longer in limbo: "+r.key),n.La.removeReference(r.key,e),n.La.containsKey(r.key)||LE(n,r.key)):U()}function ub(n,e){let t=e.key,r=t.path.canonicalString();n.Oa.get(t)||n.xa.has(r)||(V("SyncEngine","New document in limbo: "+t),n.xa.add(r),Xm(n))}function Xm(n){for(;n.xa.size>0&&n.Oa.size<n.maxConcurrentLimboResolutions;){let e=n.xa.values().next().value;n.xa.delete(e);let t=new L(se.fromString(e)),r=n.qa.next();n.Na.set(r,new am(t)),n.Oa=n.Oa.insert(t,r),Du(n.remoteStore,new Ai(it(Oi(t.path)),r,"TargetPurposeLimboResolution",ft.oe))}}function ln(n,e,t){return N(this,null,function*(){let r=M(n),i=[],s=[],o=[];r.Fa.isEmpty()||(r.Fa.forEach((l,u)=>{o.push(r.Ka(u,e,t).then(c=>{var d;if((c||t)&&r.isPrimaryClient){let m=c?!c.fromCache:(d=t?.targetChanges.get(u.targetId))===null||d===void 0?void 0:d.current;r.sharedClientState.updateQueryState(u.targetId,m?"current":"not-current")}if(c){i.push(c);let m=qf.Wi(u.targetId,c);s.push(m)}}))}),yield Promise.all(o),r.Ca.d_(i),yield function(u,c){return N(this,null,function*(){let d=M(u);try{yield d.persistence.runTransaction("notifyLocalViewChanges","readwrite",m=>b.forEach(c,p=>b.forEach(p.$i,y=>d.persistence.referenceDelegate.addReference(m,p.targetId,y)).next(()=>b.forEach(p.Ui,y=>d.persistence.referenceDelegate.removeReference(m,p.targetId,y)))))}catch(m){if(!Kn(m))throw m;V("LocalStore","Failed to update sequence numbers: "+m)}for(let m of c){let p=m.targetId;if(!m.fromCache){let y=d.os.get(p),S=y.snapshotVersion,x=y.withLastLimboFreeSnapshotVersion(S);d.os=d.os.insert(p,x)}}})}(r.localStore,s))})}function cb(n,e){return N(this,null,function*(){let t=M(n);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());let r=yield TE(t.localStore,e);t.currentUser=e,function(s,o){s.ka.forEach(l=>{l.forEach(u=>{u.reject(new k(P.CANCELLED,o))})}),s.ka.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),yield ln(t,r.hs)}})}function hb(n,e){let t=M(n),r=t.Na.get(e);if(r&&r.va)return H().add(r.key);{let i=H(),s=t.Ma.get(e);if(!s)return i;for(let o of s){let l=t.Fa.get(o);i=i.unionWith(l.view.Va)}return i}}function db(n,e){return N(this,null,function*(){let t=M(n),r=yield ou(t.localStore,e.query,!0),i=e.view.ba(r);return t.isPrimaryClient&&um(t,e.targetId,i.wa),i})}function fb(n,e){return N(this,null,function*(){let t=M(n);return bE(t.localStore,e).then(r=>ln(t,r))})}function mb(n,e,t,r){return N(this,null,function*(){let i=M(n),s=yield function(l,u){let c=M(l),d=M(c.mutationQueue);return c.persistence.runTransaction("Lookup mutation documents","readonly",m=>d.Mn(m,u).next(p=>p?c.localDocuments.getDocuments(m,p):b.resolve(null)))}(i.localStore,e);s!==null?(t==="pending"?yield Mi(i.remoteStore):t==="acknowledged"||t==="rejected"?(Jm(i,e,r||null),Ym(i,e),function(l,u){M(M(l).mutationQueue).On(u)}(i.localStore,e)):U(),yield ln(i,s)):V("SyncEngine","Cannot apply mutation batch with id: "+e)})}function pb(n,e){return N(this,null,function*(){let t=M(n);if(ku(t),Zm(t),e===!0&&t.Qa!==!0){let r=t.sharedClientState.getAllActiveQueryTargets(),i=yield uw(t,r.toArray());t.Qa=!0,yield Zf(t.remoteStore,!0);for(let s of i)Du(t.remoteStore,s)}else if(e===!1&&t.Qa!==!1){let r=[],i=Promise.resolve();t.Ma.forEach((s,o)=>{t.sharedClientState.isLocalQueryTarget(o)?r.push(o):i=i.then(()=>(xi(t,o),bi(t.localStore,o,!0))),Ri(t.remoteStore,o)}),yield i,yield uw(t,r),function(o){let l=M(o);l.Na.forEach((u,c)=>{Ri(l.remoteStore,c)}),l.La.pr(),l.Na=new Map,l.Oa=new _e(L.comparator)}(t),t.Qa=!1,yield Zf(t.remoteStore,!1)}})}function uw(n,e,t){return N(this,null,function*(){let r=M(n),i=[],s=[];for(let o of e){let l,u=r.Ma.get(o);if(u&&u.length!==0){l=yield Ci(r.localStore,it(u[0]));for(let c of u){let d=r.Fa.get(c),m=yield db(r,d);m.snapshot&&s.push(m.snapshot)}}else{let c=yield CE(r.localStore,o);l=yield Ci(r.localStore,c),yield Hm(r,UE(c),o,!1,l.resumeToken)}i.push(l)}return r.Ca.d_(s),i})}function UE(n){return Uw(n.path,n.collectionGroup,n.orderBy,n.filters,n.limit,"F",n.startAt,n.endAt)}function gb(n){return function(t){return M(M(t).persistence).Qi()}(M(n).localStore)}function _b(n,e,t,r){return N(this,null,function*(){let i=M(n);if(i.Qa)return void V("SyncEngine","Ignoring unexpected query state notification.");let s=i.Ma.get(e);if(s&&s.length>0)switch(t){case"current":case"not-current":{let o=yield bE(i.localStore,qw(s[0])),l=go.createSynthesizedRemoteEventForCurrentChange(e,t==="current",Re.EMPTY_BYTE_STRING);yield ln(i,o,l);break}case"rejected":yield bi(i.localStore,e,!0),xi(i,e,r);break;default:U()}})}function yb(n,e,t){return N(this,null,function*(){let r=ku(n);if(r.Qa){for(let i of e){if(r.Ma.has(i)&&r.sharedClientState.isActiveQueryTarget(i)){V("SyncEngine","Adding an already active target "+i);continue}let s=yield CE(r.localStore,i),o=yield Ci(r.localStore,s);yield Hm(r,UE(s),o.targetId,!1,o.resumeToken),Du(r.remoteStore,o)}for(let i of t)r.Ma.has(i)&&(yield bi(r.localStore,i,!1).then(()=>{Ri(r.remoteStore,i),xi(r,i)}).catch(jn))}})}function ku(n){let e=M(n);return e.remoteStore.remoteSyncer.applyRemoteEvent=ME.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=hb.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=sb.bind(null,e),e.Ca.d_=XC.bind(null,e.eventManager),e.Ca.$a=ZC.bind(null,e.eventManager),e}function Zm(n){let e=M(n);return e.remoteStore.remoteSyncer.applySuccessfulWrite=ob.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ab.bind(null,e),e}function vb(n,e,t){let r=M(n);(function(s,o,l){return N(this,null,function*(){try{let u=yield o.getMetadata();if(yield function(y,S){let x=M(y),D=be(S.createTime);return x.persistence.runTransaction("hasNewerBundle","readonly",q=>x.Gr.getBundleMetadata(q,S.id)).then(q=>!!q&&q.createTime.compareTo(D)>=0)}(s.localStore,u))return yield o.close(),l._completeWith(function(y){return{taskState:"Success",documentsLoaded:y.totalDocuments,bytesLoaded:y.totalBytes,totalDocuments:y.totalDocuments,totalBytes:y.totalBytes}}(u)),Promise.resolve(new Set);l._updateProgress(OE(u));let c=new sm(u,s.localStore,o.serializer),d=yield o.Ua();for(;d;){let p=yield c.la(d);p&&l._updateProgress(p),d=yield o.Ua()}let m=yield c.complete();return yield ln(s,m.Ia,void 0),yield function(y,S){let x=M(y);return x.persistence.runTransaction("Save bundle","readwrite",D=>x.Gr.saveBundleMetadata(D,S))}(s.localStore,u),l._completeWith(m.progress),Promise.resolve(m.Pa)}catch(u){return Ct("SyncEngine",`Loading bundle failed with ${u}`),l._failWith(u),Promise.resolve(new Set)}})})(r,e,t).then(i=>{r.sharedClientState.notifyBundleLoaded(i)})}var cm=(()=>{class n{constructor(){this.kind="memory",this.synchronizeTabs=!1}initialize(t){return N(this,null,function*(){this.serializer=Do(t.databaseInfo.databaseId),this.sharedClientState=this.Wa(t),this.persistence=this.Ga(t),yield this.persistence.start(),this.localStore=this.za(t),this.gcScheduler=this.ja(t,this.localStore),this.indexBackfillerScheduler=this.Ha(t,this.localStore)})}ja(t,r){return null}Ha(t,r){return null}za(t){return IE(this.persistence,new su,t.initialUser,this.serializer)}Ga(t){return new ru(iu.Zr,this.serializer)}Wa(t){return new uu}terminate(){return N(this,null,function*(){var t,r;(t=this.gcScheduler)===null||t===void 0||t.stop(),(r=this.indexBackfillerScheduler)===null||r===void 0||r.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}}return n.provider={build:()=>new n},n})();var vu=class n extends cm{constructor(e,t,r){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=r,this.kind="persistent",this.synchronizeTabs=!1}initialize(e){return N(this,null,function*(){yield _c(n.prototype,this,"initialize").call(this,e),yield this.Ja.initialize(this,e),yield Zm(this.Ja.syncEngine),yield Mi(this.Ja.remoteStore),yield this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))})}za(e){return IE(this.persistence,new su,e.initialUser,this.serializer)}ja(e,t){let r=this.persistence.referenceDelegate.garbageCollector;return new Sf(r,e.asyncQueue,t)}Ha(e,t){let r=new qd(t,this.persistence);return new Bd(e.asyncQueue,r)}Ga(e){let t=Gm(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),r=this.cacheSizeBytes!==void 0?wt.withCacheSize(this.cacheSizeBytes):wt.DEFAULT;return new Bf(this.synchronizeTabs,t,e.clientId,r,e.asyncQueue,PE(),Dl(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new uu}},hm=class n extends vu{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}initialize(e){return N(this,null,function*(){yield _c(n.prototype,this,"initialize").call(this,e);let t=this.Ja.syncEngine;this.sharedClientState instanceof so&&(this.sharedClientState.syncEngine={no:mb.bind(null,t),ro:_b.bind(null,t),io:yb.bind(null,t),Qi:gb.bind(null,t),eo:fb.bind(null,t)},yield this.sharedClientState.start()),yield this.persistence.yi(r=>N(this,null,function*(){yield pb(this.Ja.syncEngine,r),this.gcScheduler&&(r&&!this.gcScheduler.started?this.gcScheduler.start():r||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(r&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():r||this.indexBackfillerScheduler.stop())}))})}Wa(e){let t=PE();if(!so.D(t))throw new k(P.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let r=Gm(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new so(t,e.asyncQueue,r,e.clientId,e.initialUser)}},ep=(()=>{class n{initialize(t,r){return N(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(r),this.remoteStore=this.createRemoteStore(r),this.eventManager=this.createEventManager(r),this.syncEngine=this.createSyncEngine(r,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=i=>lw(this.syncEngine,i,1),this.remoteStore.remoteSyncer.handleCredentialChange=cb.bind(null,this.syncEngine),yield Zf(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new nm}()}createDatastore(t){let r=Do(t.databaseInfo.databaseId),i=function(o){return new Qf(o)}(t.databaseInfo);return function(o,l,u,c){return new Yf(o,l,u,c)}(t.authCredentials,t.appCheckCredentials,i,r)}createRemoteStore(t){return function(i,s,o,l,u){return new Xf(i,s,o,l,u)}(this.localStore,this.datastore,t.asyncQueue,r=>lw(this.syncEngine,r,0),function(){return cu.D()?new cu:new zf}())}createSyncEngine(t,r){return function(s,o,l,u,c,d,m){let p=new lm(s,o,l,u,c,d);return m&&(p.Qa=!0),p}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,r)}terminate(){return N(this,null,function*(){var t,r;yield function(s){return N(this,null,function*(){let o=M(s);V("RemoteStore","RemoteStore shutting down."),o.L_.add(5),yield Fi(o),o.k_.shutdown(),o.q_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate(),(r=this.eventManager)===null||r===void 0||r.terminate()})}}return n.provider={build:()=>new n},n})();function cw(n,e=10240){let t=0;return{read(){return N(this,null,function*(){if(t<n.byteLength){let i={value:n.slice(t,t+e),done:!1};return t+=e,i}return{done:!0}})},cancel(){return N(this,null,function*(){})},releaseLock(){},closed:Promise.resolve()}}var Ni=class{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):Se("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}};var dm=class{constructor(e,t){this.Xa=e,this.serializer=t,this.metadata=new Fe,this.buffer=new Uint8Array,this.eu=function(){return new TextDecoder("utf-8")}(),this.tu().then(r=>{r&&r.ua()?this.metadata.resolve(r.aa.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             ${JSON.stringify(r?.aa)}`))},r=>this.metadata.reject(r))}close(){return this.Xa.cancel()}getMetadata(){return N(this,null,function*(){return this.metadata.promise})}Ua(){return N(this,null,function*(){return yield this.getMetadata(),this.tu()})}tu(){return N(this,null,function*(){let e=yield this.nu();if(e===null)return null;let t=this.eu.decode(e),r=Number(t);isNaN(r)&&this.ru(`length string (${t}) is not valid number`);let i=yield this.iu(r);return new im(JSON.parse(i),e.length+r)})}su(){return this.buffer.findIndex(e=>e===123)}nu(){return N(this,null,function*(){for(;this.su()<0&&!(yield this.ou()););if(this.buffer.length===0)return null;let e=this.su();e<0&&this.ru("Reached the end of bundle when a length string is expected.");let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t})}iu(e){return N(this,null,function*(){for(;this.buffer.length<e;)(yield this.ou())&&this.ru("Reached the end of bundle when more is expected.");let t=this.eu.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t})}ru(e){throw this.Xa.cancel(),new Error(`Invalid bundle format: ${e}`)}ou(){return N(this,null,function*(){let e=yield this.Xa.read();if(!e.done){let t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done})}};var fm=class{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}lookup(e){return N(this,null,function*(){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new k(P.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=yield function(i,s){return N(this,null,function*(){let o=M(i),l={documents:s.map(m=>yo(o.serializer,m))},u=yield o.Lo("BatchGetDocuments",o.serializer.databaseId,se.emptyPath(),l,s.length),c=new Map;u.forEach(m=>{let p=AC(o.serializer,m);c.set(p.key.toString(),p)});let d=[];return s.forEach(m=>{let p=c.get(m.toString());G(!!p),d.push(p)}),d})}(this.datastore,e);return t.forEach(r=>this.recordVersion(r)),t})}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(r){this.lastTransactionError=r}this.writtenDocs.add(e.toString())}delete(e){this.write(new qn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}commit(){return N(this,null,function*(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,r)=>{let i=L.fromPath(r);this.mutations.push(new fo(i,this.precondition(i)))}),yield function(r,i){return N(this,null,function*(){let s=M(r),o={writes:i.map(l=>vo(s.serializer,l))};yield s.Mo("Commit",s.serializer.databaseId,se.emptyPath(),o)})}(this.datastore,this.mutations),this.committed=!0})}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw U();t=K.min()}let r=this.readVersions.get(e.key.toString());if(r){if(!t.isEqual(r))throw new k(P.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(K.min())?Ae.exists(!1):Ae.updateTime(t):Ae.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(K.min()))throw new k(P.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ae.updateTime(t)}return Ae.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}};var mm=class{constructor(e,t,r,i,s){this.asyncQueue=e,this.datastore=t,this.options=r,this.updateFunction=i,this.deferred=s,this._u=r.maxAttempts,this.t_=new To(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(()=>N(this,null,function*(){let e=new fm(this.datastore),t=this.cu(e);t&&t.then(r=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(r)}).catch(i=>{this.lu(i)}))}).catch(r=>{this.lu(r)})}))}cu(e){try{let t=this.updateFunction(e);return!Ro(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if(e.name==="FirebaseError"){let t=e.code;return t==="aborted"||t==="failed-precondition"||t==="already-exists"||!eE(t)}return!1}};var pm=class{constructor(e,t,r,i,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=r,this.databaseInfo=i,this.user=De.UNAUTHENTICATED,this.clientId=Vl.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=s,this.authCredentials.start(r,o=>N(this,null,function*(){V("FirestoreClient","Received user=",o.uid),yield this.authCredentialListener(o),this.user=o})),this.appCheckCredentials.start(r,o=>(V("FirestoreClient","Received new app check token=",o),this.appCheckCredentialListener(o,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new Fe;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>N(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){let r=Ui(t,"Failed to shutdown persistence");e.reject(r)}})),e.promise}};function Pd(n,e){return N(this,null,function*(){n.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");let t=n.configuration;yield e.initialize(t);let r=t.initialUser;n.setCredentialChangeListener(i=>N(this,null,function*(){r.isEqual(i)||(yield TE(e.localStore,i),r=i)})),e.persistence.setDatabaseDeletedListener(()=>n.terminate()),n._offlineComponents=e})}function hw(n,e){return N(this,null,function*(){n.asyncQueue.verifyOperationInProgress();let t=yield tp(n);V("FirestoreClient","Initializing OnlineComponentProvider"),yield e.initialize(t,n.configuration),n.setCredentialChangeListener(r=>sw(e.remoteStore,r)),n.setAppCheckTokenChangeListener((r,i)=>sw(e.remoteStore,i)),n._onlineComponents=e})}function tp(n){return N(this,null,function*(){if(!n._offlineComponents)if(n._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{yield Pd(n,n._uninitializedComponentsProvider._offline)}catch(e){let t=e;if(!function(i){return i.name==="FirebaseError"?i.code===P.FAILED_PRECONDITION||i.code===P.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11}(t))throw t;Ct("Error using user provided cache. Falling back to memory cache: "+t),yield Pd(n,new cm)}}else V("FirestoreClient","Using default OfflineComponentProvider"),yield Pd(n,new cm);return n._offlineComponents})}function Vu(n){return N(this,null,function*(){return n._onlineComponents||(n._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),yield hw(n,n._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),yield hw(n,new ep))),n._onlineComponents})}function BE(n){return tp(n).then(e=>e.persistence)}function np(n){return tp(n).then(e=>e.localStore)}function qE(n){return Vu(n).then(e=>e.remoteStore)}function rp(n){return Vu(n).then(e=>e.syncEngine)}function wb(n){return Vu(n).then(e=>e.datastore)}function Di(n){return N(this,null,function*(){let e=yield Vu(n),t=e.eventManager;return t.onListen=eb.bind(null,e.syncEngine),t.onUnlisten=nb.bind(null,e.syncEngine),t.onFirstRemoteStoreListen=tb.bind(null,e.syncEngine),t.onLastRemoteStoreUnlisten=rb.bind(null,e.syncEngine),t})}function Eb(n){return n.asyncQueue.enqueue(()=>N(this,null,function*(){let e=yield BE(n),t=yield qE(n);return e.setNetworkEnabled(!0),function(i){let s=M(i);return s.L_.delete(0),ko(s)}(t)}))}function Ib(n){return n.asyncQueue.enqueue(()=>N(this,null,function*(){let e=yield BE(n),t=yield qE(n);return e.setNetworkEnabled(!1),function(i){return N(this,null,function*(){let s=M(i);s.L_.add(0),yield Fi(s),s.q_.set("Offline")})}(t)}))}function Tb(n,e){let t=new Fe;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s,o){return N(this,null,function*(){try{let l=yield function(c,d){let m=M(c);return m.persistence.runTransaction("read document","readonly",p=>m.localDocuments.getDocument(p,d))}(i,s);l.isFoundDocument()?o.resolve(l):l.isNoDocument()?o.resolve(null):o.reject(new k(P.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(l){let u=Ui(l,`Failed to get document '${s} from cache`);o.reject(u)}})}(yield np(n),e,t)})),t.promise}function GE(n,e,t={}){let r=new Fe;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(s,o,l,u,c){let d=new Ni({next:p=>{d.Za(),o.enqueueAndForget(()=>Qm(s,m));let y=p.docs.has(l);!y&&p.fromCache?c.reject(new k(P.UNAVAILABLE,"Failed to get document because the client is offline.")):y&&p.fromCache&&u&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):c.resolve(p)},error:p=>c.reject(p)}),m=new Ao(Oi(l.path),d,{includeMetadataChanges:!0,_a:!0});return Wm(s,m)}(yield Di(n),n.asyncQueue,e,t,r)})),r.promise}function Ab(n,e){let t=new Fe;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s,o){return N(this,null,function*(){try{let l=yield ou(i,s,!0),u=new yu(s,l.Ts),c=u.ma(l.documents),d=u.applyChanges(c,!1);o.resolve(d.snapshot)}catch(l){let u=Ui(l,`Failed to execute query '${s} against cache`);o.reject(u)}})}(yield np(n),e,t)})),t.promise}function jE(n,e,t={}){let r=new Fe;return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(s,o,l,u,c){let d=new Ni({next:p=>{d.Za(),o.enqueueAndForget(()=>Qm(s,m)),p.fromCache&&u.source==="server"?c.reject(new k(P.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):c.resolve(p)},error:p=>c.reject(p)}),m=new Ao(l,d,{includeMetadataChanges:!0,_a:!0});return Wm(s,m)}(yield Di(n),n.asyncQueue,e,t,r)})),r.promise}function Sb(n,e){let t=new Ni(e);return n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s){M(i).Y_.add(s),s.next()}(yield Di(n),t)})),()=>{t.Za(),n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return function(i,s){M(i).Y_.delete(s)}(yield Di(n),t)}))}}function Cb(n,e,t,r){let i=function(o,l){let u;return u=typeof o=="string"?nE().encode(o):o,function(d,m){return new dm(d,m)}(function(d,m){if(d instanceof Uint8Array)return cw(d,m);if(d instanceof ArrayBuffer)return cw(new Uint8Array(d),m);if(d instanceof ReadableStream)return d.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(u),l)}(t,Do(e));n.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){vb(yield rp(n),i,r)}))}function bb(n,e){return n.asyncQueue.enqueue(()=>N(this,null,function*(){return function(r,i){let s=M(r);return s.persistence.runTransaction("Get named query","readonly",o=>s.Gr.getNamedQuery(o,i))}(yield np(n),e)}))}function KE(n){let e={};return n.timeoutSeconds!==void 0&&(e.timeoutSeconds=n.timeoutSeconds),e}var dw=new Map;function ip(n,e,t){if(!t)throw new k(P.INVALID_ARGUMENT,`Function ${n}() cannot be called with an empty ${e}.`)}function sp(n,e,t,r){if(e===!0&&r===!0)throw new k(P.INVALID_ARGUMENT,`${n} and ${t} cannot be used together.`)}function fw(n){if(!L.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${n} has ${n.length}.`)}function mw(n){if(L.isDocumentKey(n))throw new k(P.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${n} has ${n.length}.`)}function Ou(n){if(n===void 0)return"undefined";if(n===null)return"null";if(typeof n=="string")return n.length>20&&(n=`${n.substring(0,20)}...`),JSON.stringify(n);if(typeof n=="number"||typeof n=="boolean")return""+n;if(typeof n=="object"){if(n instanceof Array)return"an array";{let e=function(r){return r.constructor?r.constructor.name:null}(n);return e?`a custom ${e} object`:"an object"}}return typeof n=="function"?"a function":U()}function oe(n,e){if("_delegate"in n&&(n=n._delegate),!(n instanceof e)){if(e.name===n.constructor.name)throw new k(P.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let t=Ou(n);throw new k(P.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return n}function zE(n,e){if(e<=0)throw new k(P.INVALID_ARGUMENT,`Function ${n}() requires a positive number, but it was: ${e}.`)}var wu=class{constructor(e){var t,r;if(e.host===void 0){if(e.ssl!==void 0)throw new k(P.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new k(P.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}sp("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=KE((r=e.experimentalLongPollingOptions)!==null&&r!==void 0?r:{}),function(s){if(s.timeoutSeconds!==void 0){if(isNaN(s.timeoutSeconds))throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (must not be NaN)`);if(s.timeoutSeconds<5)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (minimum allowed value is 5)`);if(s.timeoutSeconds>30)throw new k(P.INVALID_ARGUMENT,`invalid long polling timeout: ${s.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(r,i){return r.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}},Er=class{constructor(e,t,r,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=r,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new wu({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new k(P.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new wu(e),e.credentials!==void 0&&(this._authCredentials=function(r){if(!r)return new xd;switch(r.type){case"firstParty":return new Vd(r.sessionIndex||"0",r.iamToken||null,r.authTokenFactory||null);case"provider":return r.client;default:throw new k(P.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}_restart(){return N(this,null,function*(){this._terminateTask==="notTerminated"?yield this._terminate():this._terminateTask="notTerminated"})}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){let r=dw.get(t);r&&(V("ComponentProvider","Removing Datastore"),dw.delete(t),r.terminate())}(this),Promise.resolve()}};function WE(n,e,t,r={}){var i;let s=(n=oe(n,Er))._getSettings(),o=`${e}:${t}`;if(s.host!=="firestore.googleapis.com"&&s.host!==o&&Ct("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),n._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let l,u;if(typeof r.mockUserToken=="string")l=r.mockUserToken,u=De.MOCK_USER;else{l=ua(r.mockUserToken,(i=n._app)===null||i===void 0?void 0:i.options.projectId);let c=r.mockUserToken.sub||r.mockUserToken.user_id;if(!c)throw new k(P.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");u=new De(c)}n._authCredentials=new Nd(new kl(l,u))}}var Ge=class n{constructor(e,t,r){this.converter=t,this._query=r,this.type="query",this.firestore=e}withConverter(e){return new n(this.firestore,e,this._query)}},pe=class n{constructor(e,t,r){this.converter=t,this._key=r,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Gt(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new n(this.firestore,e,this._key)}},Gt=class n extends Ge{constructor(e,t,r){super(e,t,Oi(r)),this._path=r,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new pe(this.firestore,null,new L(e))}withConverter(e){return new n(this.firestore,e,this._path)}};function op(n,e,...t){if(n=ee(n),ip("collection","path",e),n instanceof Er){let r=se.fromString(e,...t);return mw(r),new Gt(n,null,r)}{if(!(n instanceof pe||n instanceof Gt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return mw(r),new Gt(n.firestore,null,r)}}function QE(n,e){if(n=oe(n,Er),ip("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new k(P.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ge(n,null,function(r){return new bt(se.emptyPath(),r)}(e))}function Vo(n,e,...t){if(n=ee(n),arguments.length===1&&(e=Vl.newId()),ip("doc","path",e),n instanceof Er){let r=se.fromString(e,...t);return fw(r),new pe(n,null,new L(r))}{if(!(n instanceof pe||n instanceof Gt))throw new k(P.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=n._path.child(se.fromString(e,...t));return fw(r),new pe(n.firestore,n instanceof Gt?n.converter:null,new L(r))}}function ap(n,e){return n=ee(n),e=ee(e),(n instanceof pe||n instanceof Gt)&&(e instanceof pe||e instanceof Gt)&&n.firestore===e.firestore&&n.path===e.path&&n.converter===e.converter}function lp(n,e){return n=ee(n),e=ee(e),n instanceof Ge&&e instanceof Ge&&n.firestore===e.firestore&&xo(n._query,e._query)&&n.converter===e.converter}var Eu=class{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new To(this,"async_queue_retry"),this.Vu=()=>{let r=Dl();r&&V("AsyncQueue","Visibility state changed to "+r.visibilityState),this.t_.jo()},this.mu=e;let t=Dl();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;let t=Dl();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});let t=new Fe;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}pu(){return N(this,null,function*(){if(this.Pu.length!==0){try{yield this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!Kn(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}})}gu(e){let t=this.mu.then(()=>(this.du=!0,e().catch(r=>{this.Eu=r,this.du=!1;let i=function(o){let l=o.message||"";return o.stack&&(l=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),l}(r);throw Se("INTERNAL UNHANDLED ERROR: ",i),r}).then(r=>(this.du=!1,r))));return this.mu=t,t}enqueueAfterDelay(e,t,r){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);let i=em.createAndSchedule(this,e,t,r,s=>this.yu(s));return this.Tu.push(i),i}fu(){this.Eu&&U()}verifyOperationInProgress(){}wu(){return N(this,null,function*(){let e;do e=this.mu,yield e;while(e!==this.mu)})}Su(e){for(let t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((t,r)=>t.targetTimeMs-r.targetTimeMs);for(let t of this.Tu)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){let t=this.Tu.indexOf(e);this.Tu.splice(t,1)}};function gm(n){return function(t,r){if(typeof t!="object"||t===null)return!1;let i=t;for(let s of r)if(s in i&&typeof i[s]=="function")return!0;return!1}(n,["next","error","complete"])}var _m=class{constructor(){this._progressObserver={},this._taskCompletionResolver=new Fe,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,r){this._progressObserver={next:e,error:t,complete:r}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}};var $E=-1,Ie=class extends Er{constructor(e,t,r,i){super(e,t,r,i),this.type="firestore",this._queue=new Eu,this._persistenceKey=i?.name||"[DEFAULT]"}_terminate(){return N(this,null,function*(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new Eu(e),this._firestoreClient=void 0,yield e}})}};function je(n){if(n._terminated)throw new k(P.FAILED_PRECONDITION,"The client has already been terminated.");return n._firestoreClient||HE(n),n._firestoreClient}function HE(n){var e,t,r;let i=n._freezeSettings(),s=function(l,u,c,d){return new Gd(l,u,c,d.host,d.ssl,d.experimentalForceLongPolling,d.experimentalAutoDetectLongPolling,KE(d.experimentalLongPollingOptions),d.useFetchStreams)}(n._databaseId,((e=n._app)===null||e===void 0?void 0:e.options.appId)||"",n._persistenceKey,i);n._componentsProvider||!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((r=i.localCache)===null||r===void 0)&&r._onlineComponentProvider)&&(n._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),n._firestoreClient=new pm(n._authCredentials,n._appCheckCredentials,n._queue,s,n._componentsProvider&&function(l){let u=l?._online.build();return{_offline:l?._offline.build(u),_online:u}}(n._componentsProvider))}function YE(n,e){Ct("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let t=n._freezeSettings();return XE(n,ep.provider,{build:r=>new vu(r,t.cacheSizeBytes,e?.forceOwnership)}),Promise.resolve()}function JE(n){return N(this,null,function*(){Ct("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");let e=n._freezeSettings();XE(n,ep.provider,{build:t=>new hm(t,e.cacheSizeBytes)})})}function XE(n,e,t){if((n=oe(n,Ie))._firestoreClient||n._terminated)throw new k(P.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.");if(n._componentsProvider||n._getSettings().localCache)throw new k(P.FAILED_PRECONDITION,"SDK cache is already specified.");n._componentsProvider={_online:e,_offline:t},HE(n)}function ZE(n){if(n._initialized&&!n._terminated)throw new k(P.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");let e=new Fe;return n._queue.enqueueAndForgetEvenWhileRestricted(()=>N(this,null,function*(){try{yield function(r){return N(this,null,function*(){if(!Vn.D())return Promise.resolve();let i=r+"main";yield Vn.delete(i)})}(Gm(n._databaseId,n._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function eI(n){return function(t){let r=new Fe;return t.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return lb(yield rp(t),r)})),r.promise}(je(n=oe(n,Ie)))}function tI(n){return Eb(je(n=oe(n,Ie)))}function nI(n){return Ib(je(n=oe(n,Ie)))}function rI(n,e){let t=je(n=oe(n,Ie)),r=new _m;return Cb(t,n._databaseId,e,r),r}function iI(n,e){return bb(je(n=oe(n,Ie)),e).then(t=>t?new Ge(n,null,t.query):null)}var Wt=class n{constructor(e){this._byteString=e}static fromBase64String(e){try{return new n(Re.fromBase64String(e))}catch(t){throw new k(P.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new n(Re.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}};var Pt=class{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new k(P.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Ce(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}};var on=class{constructor(e){this._methodName=e}};var Ir=class{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new k(P.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new k(P.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return W(this._lat,e._lat)||W(this._long,e._long)}};var So=class{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(r,i){if(r.length!==i.length)return!1;for(let s=0;s<r.length;++s)if(r[s]!==i[s])return!1;return!0}(this._values,e._values)}};var Rb=/^__.*__$/,ym=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return this.fieldMask!==null?new Rt(e,this.data,this.fieldMask,t,this.fieldTransforms):new Bn(e,this.data,t,this.fieldTransforms)}},Iu=class{constructor(e,t,r){this.data=e,this.fieldMask=t,this.fieldTransforms=r}toMutation(e,t){return new Rt(e,this.data,this.fieldMask,t,this.fieldTransforms)}};function sI(n){switch(n){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw U()}}var Tu=class n{constructor(e,t,r,i,s,o){this.settings=e,this.databaseId=t,this.serializer=r,this.ignoreUndefinedProperties=i,s===void 0&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=o||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new n(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:r,xu:!1});return i.Ou(e),i}Nu(e){var t;let r=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:r,xu:!1});return i.vu(),i}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return Au(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(e.length===0)throw this.Bu("Document fields must not be empty");if(sI(this.Cu)&&Rb.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}},vm=class{constructor(e,t,r){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=r||Do(e)}Qu(e,t,r,i=!1){return new Tu({Cu:e,methodName:t,qu:r,path:Ce.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}};function Cr(n){let e=n._freezeSettings(),t=Do(n._databaseId);return new vm(n._databaseId,!!e.ignoreUndefinedProperties,t)}function Fu(n,e,t,r,i,s={}){let o=n.Qu(s.merge||s.mergeFields?2:0,e,t,i);hp("Data must be an object, but it was:",o,r);let l=lI(r,o),u,c;if(s.merge)u=new mt(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){let d=[];for(let m of s.mergeFields){let p=Am(e,m,t);if(!o.contains(p))throw new k(P.INVALID_ARGUMENT,`Field '${p}' is specified in your field mask but missing from your input data.`);cI(d,p)||d.push(p)}u=new mt(d),c=o.fieldTransforms.filter(m=>u.covers(m.field))}else u=null,c=o.fieldTransforms;return new ym(new Ye(l),u,c)}var Co=class n extends on{_toFieldTransform(e){if(e.Cu!==2)throw e.Cu===1?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof n}};function oI(n,e,t){return new Tu({Cu:3,qu:e.settings.qu,methodName:n._methodName,xu:t},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}var wm=class n extends on{_toFieldTransform(e){return new yr(e.path,new Ln)}isEqual(e){return e instanceof n}},Em=class n extends on{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=oI(this,e,!0),r=this.Ku.map(s=>br(s,t)),i=new rn(r);return new yr(e.path,i)}isEqual(e){return e instanceof n&&Ic(this.Ku,e.Ku)}},Im=class n extends on{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=oI(this,e,!0),r=this.Ku.map(s=>br(s,t)),i=new sn(r);return new yr(e.path,i)}isEqual(e){return e instanceof n&&Ic(this.Ku,e.Ku)}},Tm=class n extends on{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){let t=new Un(e.serializer,Qw(e.serializer,this.$u));return new yr(e.path,t)}isEqual(e){return e instanceof n&&this.$u===e.$u}};function up(n,e,t,r){let i=n.Qu(1,e,t);hp("Data must be an object, but it was:",i,r);let s=[],o=Ye.empty();Sr(r,(u,c)=>{let d=dp(e,u,t);c=ee(c);let m=i.Nu(d);if(c instanceof Co)s.push(d);else{let p=br(c,m);p!=null&&(s.push(d),o.set(d,p))}});let l=new mt(s);return new Iu(o,l,i.fieldTransforms)}function cp(n,e,t,r,i,s){let o=n.Qu(1,e,t),l=[Am(e,r,t)],u=[i];if(s.length%2!=0)throw new k(P.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let p=0;p<s.length;p+=2)l.push(Am(e,s[p])),u.push(s[p+1]);let c=[],d=Ye.empty();for(let p=l.length-1;p>=0;--p)if(!cI(c,l[p])){let y=l[p],S=u[p];S=ee(S);let x=o.Nu(y);if(S instanceof Co)c.push(y);else{let D=br(S,x);D!=null&&(c.push(y),d.set(y,D))}}let m=new mt(c);return new Iu(d,m,o.fieldTransforms)}function aI(n,e,t,r=!1){return br(t,n.Qu(r?4:3,e))}function br(n,e){if(uI(n=ee(n)))return hp("Unsupported field value:",e,n),lI(n,e);if(n instanceof on)return function(r,i){if(!sI(i.Cu))throw i.Bu(`${r._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${r._methodName}() is not currently supported inside arrays`);let s=r._toFieldTransform(i);s&&i.fieldTransforms.push(s)}(n,e),null;if(n===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),n instanceof Array){if(e.settings.xu&&e.Cu!==4)throw e.Bu("Nested arrays are not supported");return function(r,i){let s=[],o=0;for(let l of r){let u=br(l,i.Lu(o));u==null&&(u={nullValue:"NULL_VALUE"}),s.push(u),o++}return{arrayValue:{values:s}}}(n,e)}return function(r,i){if((r=ee(r))===null)return{nullValue:"NULL_VALUE"};if(typeof r=="number")return Qw(i.serializer,r);if(typeof r=="boolean")return{booleanValue:r};if(typeof r=="string")return{stringValue:r};if(r instanceof Date){let s=Ee.fromDate(r);return{timestampValue:Ti(i.serializer,s)}}if(r instanceof Ee){let s=new Ee(r.seconds,1e3*Math.floor(r.nanoseconds/1e3));return{timestampValue:Ti(i.serializer,s)}}if(r instanceof Ir)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Wt)return{bytesValue:rE(i.serializer,r._byteString)};if(r instanceof pe){let s=i.databaseId,o=r.firestore._databaseId;if(!o.isEqual(s))throw i.Bu(`Document reference is for database ${o.projectId}/${o.database} but should be for database ${s.projectId}/${s.database}`);return{referenceValue:Um(r.firestore._databaseId||i.databaseId,r._key.path)}}if(r instanceof So)return function(o,l){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:o.toArray().map(u=>{if(typeof u!="number")throw l.Bu("VectorValues must only contain numeric values.");return Lm(l.serializer,u)})}}}}}}(r,i);throw i.Bu(`Unsupported field value: ${Ou(r)}`)}(n,e)}function lI(n,e){let t={};return Pw(n)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Sr(n,(r,i)=>{let s=br(i,e.Mu(r));s!=null&&(t[r]=s)}),{mapValue:{fields:t}}}function uI(n){return!(typeof n!="object"||n===null||n instanceof Array||n instanceof Date||n instanceof Ee||n instanceof Ir||n instanceof Wt||n instanceof pe||n instanceof on||n instanceof So)}function hp(n,e,t){if(!uI(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){let r=Ou(t);throw r==="an object"?e.Bu(n+" a custom object"):e.Bu(n+" "+r)}}function Am(n,e,t){if((e=ee(e))instanceof Pt)return e._internalPath;if(typeof e=="string")return dp(n,e);throw Au("Field path arguments must be of type string or ",n,!1,void 0,t)}var Pb=new RegExp("[~\\*/\\[\\]]");function dp(n,e,t){if(e.search(Pb)>=0)throw Au(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,n,!1,void 0,t);try{return new Pt(...e.split("."))._internalPath}catch{throw Au(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,n,!1,void 0,t)}}function Au(n,e,t,r,i){let s=r&&!r.isEmpty(),o=i!==void 0,l=`Function ${e}() called with invalid data`;t&&(l+=" (via `toFirestore()`)"),l+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new k(P.INVALID_ARGUMENT,l+n+u)}function cI(n,e){return n.some(t=>t.isEqual(e))}var Tr=class{constructor(e,t,r,i,s){this._firestore=e,this._userDataWriter=t,this._key=r,this._document=i,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new pe(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){let e=new Sm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(Mu("DocumentSnapshot.get",e));if(t!==null)return this._userDataWriter.convertValue(t)}}},Sm=class extends Tr{data(){return super.data()}};function Mu(n,e){return typeof e=="string"?dp(n,e):e instanceof Pt?e._internalPath:e._delegate._internalPath}function hI(n){if(n.limitType==="L"&&n.explicitOrderBy.length===0)throw new k(P.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}var bo=class{},Ar=class extends bo{};function un(n,e,...t){let r=[];e instanceof bo&&r.push(e),r=r.concat(t),function(s){let o=s.filter(u=>u instanceof Cm).length,l=s.filter(u=>u instanceof Su).length;if(o>1||o>0&&l>0)throw new k(P.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(let i of r)n=i._apply(n);return n}var Su=class n extends Ar{constructor(e,t,r){super(),this._field=e,this._op=t,this._value=r,this.type="where"}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=this._parse(e);return EI(e._query,t),new Ge(e.firestore,e.converter,tf(e._query,t))}_parse(e){let t=Cr(e.firestore);return function(s,o,l,u,c,d,m){let p;if(c.isKeyField()){if(d==="array-contains"||d==="array-contains-any")throw new k(P.INVALID_ARGUMENT,`Invalid Query. You can't perform '${d}' queries on documentId().`);if(d==="in"||d==="not-in"){gw(m,d);let y=[];for(let S of m)y.push(pw(u,s,S));p={arrayValue:{values:y}}}else p=pw(u,s,m)}else d!=="in"&&d!=="not-in"&&d!=="array-contains-any"||gw(m,d),p=aI(l,o,m,d==="in"||d==="not-in");return te.create(c,d,p)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}};function dI(n,e,t){let r=e,i=Mu("where",n);return Su._create(i,r,t)}var Cm=class n extends bo{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new n(e,t)}_parse(e){let t=this._queryConstraints.map(r=>r._parse(e)).filter(r=>r.getFilters().length>0);return t.length===1?t[0]:ce.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return t.getFilters().length===0?e:(function(i,s){let o=i,l=s.getFlattenedFilters();for(let u of l)EI(o,u),o=tf(o,u)}(e._query,t),new Ge(e.firestore,e.converter,tf(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return this.type==="and"?"and":"or"}};var bm=class n extends Ar{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new n(e,t)}_apply(e){let t=function(i,s,o){if(i.startAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(i.endAt!==null)throw new k(P.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new gr(s,o)}(e._query,this._field,this._direction);return new Ge(e.firestore,e.converter,function(i,s){let o=i.explicitOrderBy.concat([s]);return new bt(i.path,i.collectionGroup,o,i.filters.slice(),i.limit,i.limitType,i.startAt,i.endAt)}(e._query,t))}};function fI(n,e="asc"){let t=e,r=Mu("orderBy",n);return bm._create(r,t)}var Cu=class n extends Ar{constructor(e,t,r){super(),this.type=e,this._limit=t,this._limitType=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){return new Ge(e.firestore,e.converter,Kl(e._query,this._limit,this._limitType))}};function mI(n){return zE("limit",n),Cu._create("limit",n,"F")}function pI(n){return zE("limitToLast",n),Cu._create("limitToLast",n,"L")}var bu=class n extends Ar{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=wI(e,this.type,this._docOrFields,this._inclusive);return new Ge(e.firestore,e.converter,function(i,s){return new bt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,s,i.endAt)}(e._query,t))}};function gI(...n){return bu._create("startAt",n,!0)}function _I(...n){return bu._create("startAfter",n,!1)}var Ru=class n extends Ar{constructor(e,t,r){super(),this.type=e,this._docOrFields=t,this._inclusive=r}static _create(e,t,r){return new n(e,t,r)}_apply(e){let t=wI(e,this.type,this._docOrFields,this._inclusive);return new Ge(e.firestore,e.converter,function(i,s){return new bt(i.path,i.collectionGroup,i.explicitOrderBy.slice(),i.filters.slice(),i.limit,i.limitType,i.startAt,s)}(e._query,t))}};function yI(...n){return Ru._create("endBefore",n,!1)}function vI(...n){return Ru._create("endAt",n,!0)}function wI(n,e,t,r){if(t[0]=ee(t[0]),t[0]instanceof Tr)return function(s,o,l,u,c){if(!u)throw new k(P.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${l}().`);let d=[];for(let m of pi(s))if(m.field.isKeyField())d.push(pr(o,u.key));else{let p=u.data.field(m.field);if(xu(p))throw new k(P.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+m.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(p===null){let y=m.field.canonicalString();throw new k(P.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${y}' (used as the orderBy) does not exist.`)}d.push(p)}return new Kt(d,c)}(n._query,n.firestore._databaseId,e,t[0]._document,r);{let i=Cr(n.firestore);return function(o,l,u,c,d,m){let p=o.explicitOrderBy;if(d.length>p.length)throw new k(P.INVALID_ARGUMENT,`Too many arguments provided to ${c}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let y=[];for(let S=0;S<d.length;S++){let x=d[S];if(p[S].field.isKeyField()){if(typeof x!="string")throw new k(P.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${c}(), but got a ${typeof x}`);if(!Fm(o)&&x.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${c}() must be a plain document ID, but '${x}' contains a slash.`);let D=o.path.child(se.fromString(x));if(!L.isDocumentKey(D))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${c}() must result in a valid document path, but '${D}' is not because it contains an odd number of segments.`);let q=new L(D);y.push(pr(l,q))}else{let D=aI(u,c,x);y.push(D)}}return new Kt(y,m)}(n._query,n.firestore._databaseId,i,e,t,r)}}function pw(n,e,t){if(typeof(t=ee(t))=="string"){if(t==="")throw new k(P.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Fm(e)&&t.indexOf("/")!==-1)throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${t}' contains a '/' character.`);let r=e.path.child(se.fromString(t));if(!L.isDocumentKey(r))throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return pr(n,new L(r))}if(t instanceof pe)return pr(n,t._key);throw new k(P.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ou(t)}.`)}function gw(n,e){if(!Array.isArray(n)||n.length===0)throw new k(P.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function EI(n,e){let t=function(i,s){for(let o of i)for(let l of o.getFlattenedFilters())if(s.indexOf(l.op)>=0)return l.op;return null}(n.filters,function(i){switch(i){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(t!==null)throw t===e.op?new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new k(P.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${t.toString()}' filters.`)}var ki=class{convertValue(e,t="none"){switch(mr(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ve(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(On(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw U()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let r={};return Sr(e,(i,s)=>{r[i]=this.convertValue(s,t)}),r}convertVectorValue(e){var t,r,i;let s=(i=(r=(t=e.fields)===null||t===void 0?void 0:t.value.arrayValue)===null||r===void 0?void 0:r.values)===null||i===void 0?void 0:i.map(o=>ve(o.doubleValue));return new So(s)}convertGeoPoint(e){return new Ir(ve(e.latitude),ve(e.longitude))}convertArray(e,t){return(e.values||[]).map(r=>this.convertValue(r,t))}convertServerTimestamp(e,t){switch(t){case"previous":let r=Vm(e);return r==null?null:this.convertValue(r,t);case"estimate":return this.convertTimestamp(uo(e));default:return null}}convertTimestamp(e){let t=nn(e);return new Ee(t.seconds,t.nanos)}convertDocumentKey(e,t){let r=se.fromString(e);G(mE(r));let i=new Fn(r.get(1),r.get(3)),s=new L(r.popFirst(5));return i.isEqual(t)||Se(`Document ${s} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}};function Lu(n,e,t){let r;return r=n?t&&(t.merge||t.mergeFields)?n.toFirestore(e,t):n.toFirestore(e):e,r}var Rm=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new pe(this.firestore,null,t)}};var tn=class{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}},It=class extends Tr{constructor(e,t,r,i,s,o){super(e,t,r,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new Dn(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let r=this._document.data.field(Mu("DocumentSnapshot.get",e));if(r!==null)return this._userDataWriter.convertValue(r,t.serverTimestamps)}}},Dn=class extends It{data(e={}){return super.data(e)}},xt=class{constructor(e,t,r,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new tn(i.hasPendingWrites,i.fromCache),this.query=r}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(e,t){this._snapshot.docs.forEach(r=>{e.call(t,new Dn(this._firestore,this._userDataWriter,r.key,r,new tn(this._snapshot.mutatedKeys.has(r.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new k(P.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,s){if(i._snapshot.oldDocs.isEmpty()){let o=0;return i._snapshot.docChanges.map(l=>{let u=new Dn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new tn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter);return l.doc,{type:"added",doc:u,oldIndex:-1,newIndex:o++}})}{let o=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(l=>s||l.type!==3).map(l=>{let u=new Dn(i._firestore,i._userDataWriter,l.doc.key,l.doc,new tn(i._snapshot.mutatedKeys.has(l.doc.key),i._snapshot.fromCache),i.query.converter),c=-1,d=-1;return l.type!==0&&(c=o.indexOf(l.doc.key),o=o.delete(l.doc.key)),l.type!==1&&(o=o.add(l.doc),d=o.indexOf(l.doc.key)),{type:xb(l.type),doc:u,oldIndex:c,newIndex:d}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}};function xb(n){switch(n){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return U()}}function fp(n,e){return n instanceof It&&e instanceof It?n._firestore===e._firestore&&n._key.isEqual(e._key)&&(n._document===null?e._document===null:n._document.isEqual(e._document))&&n._converter===e._converter:n instanceof xt&&e instanceof xt&&n._firestore===e._firestore&&lp(n.query,e.query)&&n.metadata.isEqual(e.metadata)&&n._snapshot.isEqual(e._snapshot)}function II(n){n=oe(n,pe);let e=oe(n.firestore,Ie);return GE(je(e),n._key).then(t=>_p(e,n,t))}var an=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wt(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new pe(this.firestore,null,t)}};function TI(n){n=oe(n,pe);let e=oe(n.firestore,Ie),t=je(e),r=new an(e);return Tb(t,n._key).then(i=>new It(e,r,n._key,i,new tn(i!==null&&i.hasLocalMutations,!0),n.converter))}function AI(n){n=oe(n,pe);let e=oe(n.firestore,Ie);return GE(je(e),n._key,{source:"server"}).then(t=>_p(e,n,t))}function SI(n){n=oe(n,Ge);let e=oe(n.firestore,Ie),t=je(e),r=new an(e);return hI(n._query),jE(t,n._query).then(i=>new xt(e,r,n,i))}function CI(n){n=oe(n,Ge);let e=oe(n.firestore,Ie),t=je(e),r=new an(e);return Ab(t,n._query).then(i=>new xt(e,r,n,i))}function bI(n){n=oe(n,Ge);let e=oe(n.firestore,Ie),t=je(e),r=new an(e);return jE(t,n._query,{source:"server"}).then(i=>new xt(e,r,n,i))}function mp(n,e,t){n=oe(n,pe);let r=oe(n.firestore,Ie),i=Lu(n.converter,e,t);return Bi(r,[Fu(Cr(r),"setDoc",n._key,i,n.converter!==null,t).toMutation(n._key,Ae.none())])}function pp(n,e,t,...r){n=oe(n,pe);let i=oe(n.firestore,Ie),s=Cr(i),o;return o=typeof(e=ee(e))=="string"||e instanceof Pt?cp(s,"updateDoc",n._key,e,t,r):up(s,"updateDoc",n._key,e),Bi(i,[o.toMutation(n._key,Ae.exists(!0))])}function RI(n){return Bi(oe(n.firestore,Ie),[new qn(n._key,Ae.none())])}function PI(n,e){let t=oe(n.firestore,Ie),r=Vo(n),i=Lu(n.converter,e);return Bi(t,[Fu(Cr(n.firestore),"addDoc",r._key,i,n.converter!==null,{}).toMutation(r._key,Ae.exists(!1))]).then(()=>r)}function gp(n,...e){var t,r,i;n=ee(n);let s={includeMetadataChanges:!1,source:"default"},o=0;typeof e[o]!="object"||gm(e[o])||(s=e[o],o++);let l={includeMetadataChanges:s.includeMetadataChanges,source:s.source};if(gm(e[o])){let m=e[o];e[o]=(t=m.next)===null||t===void 0?void 0:t.bind(m),e[o+1]=(r=m.error)===null||r===void 0?void 0:r.bind(m),e[o+2]=(i=m.complete)===null||i===void 0?void 0:i.bind(m)}let u,c,d;if(n instanceof pe)c=oe(n.firestore,Ie),d=Oi(n._key.path),u={next:m=>{e[o]&&e[o](_p(c,n,m))},error:e[o+1],complete:e[o+2]};else{let m=oe(n,Ge);c=oe(m.firestore,Ie),d=m._query;let p=new an(c);u={next:y=>{e[o]&&e[o](new xt(c,p,m,y))},error:e[o+1],complete:e[o+2]},hI(n._query)}return function(p,y,S,x){let D=new Ni(x),q=new Ao(y,D,S);return p.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return Wm(yield Di(p),q)})),()=>{D.Za(),p.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return Qm(yield Di(p),q)}))}}(je(c),d,l,u)}function xI(n,e){return Sb(je(n=oe(n,Ie)),gm(e)?e:{next:e})}function Bi(n,e){return function(r,i){let s=new Fe;return r.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){return ib(yield rp(r),i,s)})),s.promise}(je(n),e)}function _p(n,e,t){let r=t.docs.get(e._key),i=new an(n);return new It(n,i,e._key,r,new tn(t.hasPendingWrites,t.fromCache),e.converter)}var Nb={maxAttempts:5};var Pu=class{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Cr(e)}set(e,t,r){this._verifyNotCommitted();let i=xn(e,this._firestore),s=Lu(i.converter,t,r),o=Fu(this._dataReader,"WriteBatch.set",i._key,s,i.converter!==null,r);return this._mutations.push(o.toMutation(i._key,Ae.none())),this}update(e,t,r,...i){this._verifyNotCommitted();let s=xn(e,this._firestore),o;return o=typeof(t=ee(t))=="string"||t instanceof Pt?cp(this._dataReader,"WriteBatch.update",s._key,t,r,i):up(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(o.toMutation(s._key,Ae.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=xn(e,this._firestore);return this._mutations=this._mutations.concat(new qn(t._key,Ae.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new k(P.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}};function xn(n,e){if((n=ee(n)).firestore!==e)throw new k(P.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return n}var Pm=class extends class{constructor(t,r){this._firestore=t,this._transaction=r,this._dataReader=Cr(t)}get(t){let r=xn(t,this._firestore),i=new Rm(this._firestore);return this._transaction.lookup([r._key]).then(s=>{if(!s||s.length!==1)return U();let o=s[0];if(o.isFoundDocument())return new Tr(this._firestore,i,o.key,o,r.converter);if(o.isNoDocument())return new Tr(this._firestore,i,r._key,null,r.converter);throw U()})}set(t,r,i){let s=xn(t,this._firestore),o=Lu(s.converter,r,i),l=Fu(this._dataReader,"Transaction.set",s._key,o,s.converter!==null,i);return this._transaction.set(s._key,l),this}update(t,r,i,...s){let o=xn(t,this._firestore),l;return l=typeof(r=ee(r))=="string"||r instanceof Pt?cp(this._dataReader,"Transaction.update",o._key,r,i,s):up(this._dataReader,"Transaction.update",o._key,r),this._transaction.update(o._key,l),this}delete(t){let r=xn(t,this._firestore);return this._transaction.delete(r._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=xn(e,this._firestore),r=new an(this._firestore);return super.get(e).then(i=>new It(this._firestore,r,t._key,i._document,new tn(!1,!1),t.converter))}};function NI(n,e,t){n=oe(n,Ie);let r=Object.assign(Object.assign({},Nb),t);return function(s){if(s.maxAttempts<1)throw new k(P.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(s,o,l){let u=new Fe;return s.asyncQueue.enqueueAndForget(()=>N(this,null,function*(){let c=yield wb(s);new mm(s.asyncQueue,c,l,o,u).au()})),u.promise}(je(n),i=>e(new Pm(n,i)),r)}function DI(){return new Co("deleteField")}function kI(){return new wm("serverTimestamp")}function VI(...n){return new Em("arrayUnion",n)}function OI(...n){return new Im("arrayRemove",n)}function FI(n){return new Tm("increment",n)}(function(e,t=!0){(function(i){Vi=i})(ma),fa(new Dt("firestore",(r,{instanceIdentifier:i,options:s})=>{let o=r.getProvider("app").getImmediate(),l=new Ie(new Dd(r.getProvider("auth-internal")),new Fd(r.getProvider("app-check-internal")),function(c,d){if(!Object.prototype.hasOwnProperty.apply(c.options,["projectId"]))throw new k(P.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Fn(c.options.projectId,d)}(o,i),o);return s=Object.assign({useFetchStreams:t},s),l._setSettings(s),l},"PUBLIC").setMultipleInstances(!0)),Ur(mv,"4.7.3",e),Ur(mv,"4.7.3","esm2017")})();var Db="@firebase/firestore-compat",kb="0.3.38";function Tp(n,e){if(e===void 0)return{merge:!1};if(e.mergeFields!==void 0&&e.merge!==void 0)throw new k("invalid-argument",`Invalid options passed to function ${n}(): You cannot specify both "merge" and "mergeFields".`);return e}function MI(){if(typeof Uint8Array>"u")throw new k("unimplemented","Uint8Arrays are not available in this environment.")}function LI(){if(!xw())throw new k("unimplemented","Blobs are unavailable in Firestore in this environment.")}var Uu=class n{constructor(e){this._delegate=e}static fromBase64String(e){return LI(),new n(Wt.fromBase64String(e))}static fromUint8Array(e){return MI(),new n(Wt.fromUint8Array(e))}toBase64(){return LI(),this._delegate.toBase64()}toUint8Array(){return MI(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}};function yp(n){return Vb(n,["next","error","complete"])}function Vb(n,e){if(typeof n!="object"||n===null)return!1;let t=n;for(let r of e)if(r in t&&typeof t[r]=="function")return!0;return!1}var vp=class{enableIndexedDbPersistence(e,t){return YE(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return JE(e._delegate)}clearIndexedDbPersistence(e){return ZE(e._delegate)}},Bu=class{constructor(e,t,r){this._delegate=t,this._persistenceProvider=r,this.INTERNAL={delete:()=>this.terminate()},e instanceof Fn||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){let t=this._delegate._getSettings();!e.merge&&t.host!==e.host&&Ct("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&(e=Object.assign(Object.assign({},t),e),delete e.merge),this._delegate._setSettings(e)}useEmulator(e,t,r={}){WE(this._delegate,e,t,r)}enableNetwork(){return tI(this._delegate)}disableNetwork(){return nI(this._delegate)}enablePersistence(e){let t=!1,r=!1;return e&&(t=!!e.synchronizeTabs,r=!!e.experimentalForceOwningTab,sp("synchronizeTabs",t,"experimentalForceOwningTab",r)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,r)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return eI(this._delegate)}onSnapshotsInSync(e){return xI(this._delegate,e)}get app(){if(!this._appCompat)throw new k("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new ji(this,op(this._delegate,e))}catch(t){throw st(t,"collection()","Firestore.collection()")}}doc(e){try{return new Qt(this,Vo(this._delegate,e))}catch(t){throw st(t,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new Nr(this,QE(this._delegate,e))}catch(t){throw st(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return NI(this._delegate,t=>e(new qu(this,t)))}batch(){return je(this._delegate),new Gu(new Pu(this._delegate,e=>Bi(this._delegate,e)))}loadBundle(e){return rI(this._delegate,e)}namedQuery(e){return iI(this._delegate,e).then(t=>t?new Nr(this,t):null)}},qi=class extends ki{constructor(e){super(),this.firestore=e}convertBytes(e){return new Uu(new Wt(e))}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return Qt.forKey(t,this.firestore,null)}};function Ob(n){_w(n)}var qu=class{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new qi(e)}get(e){let t=Rr(e);return this._delegate.get(t).then(r=>new Pr(this._firestore,new It(this._firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,t.converter)))}set(e,t,r){let i=Rr(e);return r?(Tp("Transaction.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Rr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Rr(e);return this._delegate.delete(t),this}},Gu=class{constructor(e){this._delegate=e}set(e,t,r){let i=Rr(e);return r?(Tp("WriteBatch.set",r),this._delegate.set(i,t,r)):this._delegate.set(i,t),this}update(e,t,r,...i){let s=Rr(e);return arguments.length===2?this._delegate.update(s,t):this._delegate.update(s,t,r,...i),this}delete(e){let t=Rr(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}},Gi=class n{constructor(e,t,r){this._firestore=e,this._userDataWriter=t,this._delegate=r}fromFirestore(e,t){let r=new Dn(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new xr(this._firestore,r),t??{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){let r=n.INSTANCES,i=r.get(e);i||(i=new WeakMap,r.set(e,i));let s=i.get(t);return s||(s=new n(e,new qi(e),t),i.set(t,s)),s}};Gi.INSTANCES=new WeakMap;var Qt=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new qi(e)}static forPath(e,t,r){if(e.length%2!==0)throw new k("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new n(t,new pe(t._delegate,r,new L(e)))}static forKey(e,t,r){return new n(t,new pe(t._delegate,r,e))}get id(){return this._delegate.id}get parent(){return new ji(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new ji(this.firestore,op(this._delegate,e))}catch(t){throw st(t,"collection()","DocumentReference.collection()")}}isEqual(e){return e=ee(e),e instanceof pe?ap(this._delegate,e):!1}set(e,t){t=Tp("DocumentReference.set",t);try{return t?mp(this._delegate,e,t):mp(this._delegate,e)}catch(r){throw st(r,"setDoc()","DocumentReference.set()")}}update(e,t,...r){try{return arguments.length===1?pp(this._delegate,e):pp(this._delegate,e,t,...r)}catch(i){throw st(i,"updateDoc()","DocumentReference.update()")}}delete(){return RI(this._delegate)}onSnapshot(...e){let t=UI(e),r=BI(e,i=>new Pr(this.firestore,new It(this.firestore._delegate,this._userDataWriter,i._key,i._document,i.metadata,this._delegate.converter)));return gp(this._delegate,t,r)}get(e){let t;return e?.source==="cache"?t=TI(this._delegate):e?.source==="server"?t=AI(this._delegate):t=II(this._delegate),t.then(r=>new Pr(this.firestore,new It(this.firestore._delegate,this._userDataWriter,r._key,r._document,r.metadata,this._delegate.converter)))}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function st(n,e,t){return n.message=n.message.replace(e,t),n}function UI(n){for(let e of n)if(typeof e=="object"&&!yp(e))return e;return{}}function BI(n,e){var t,r;let i;return yp(n[0])?i=n[0]:yp(n[1])?i=n[1]:typeof n[0]=="function"?i={next:n[0],error:n[1],complete:n[2]}:i={next:n[1],error:n[2],complete:n[3]},{next:s=>{i.next&&i.next(e(s))},error:(t=i.error)===null||t===void 0?void 0:t.bind(i),complete:(r=i.complete)===null||r===void 0?void 0:r.bind(i)}}var Pr=class{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new Qt(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return fp(this._delegate,e._delegate)}},xr=class extends Pr{data(e){let t=this._delegate.data(e);return this._delegate._converter||yw(t!==void 0,"Document in a QueryDocumentSnapshot should exist"),t}},Nr=class n{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new qi(e)}where(e,t,r){try{return new n(this.firestore,un(this._delegate,dI(e,t,r)))}catch(i){throw st(i,/(orderBy|where)\(\)/,"Query.$1()")}}orderBy(e,t){try{return new n(this.firestore,un(this._delegate,fI(e,t)))}catch(r){throw st(r,/(orderBy|where)\(\)/,"Query.$1()")}}limit(e){try{return new n(this.firestore,un(this._delegate,mI(e)))}catch(t){throw st(t,"limit()","Query.limit()")}}limitToLast(e){try{return new n(this.firestore,un(this._delegate,pI(e)))}catch(t){throw st(t,"limitToLast()","Query.limitToLast()")}}startAt(...e){try{return new n(this.firestore,un(this._delegate,gI(...e)))}catch(t){throw st(t,"startAt()","Query.startAt()")}}startAfter(...e){try{return new n(this.firestore,un(this._delegate,_I(...e)))}catch(t){throw st(t,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new n(this.firestore,un(this._delegate,yI(...e)))}catch(t){throw st(t,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new n(this.firestore,un(this._delegate,vI(...e)))}catch(t){throw st(t,"endAt()","Query.endAt()")}}isEqual(e){return lp(this._delegate,e._delegate)}get(e){let t;return e?.source==="cache"?t=CI(this._delegate):e?.source==="server"?t=bI(this._delegate):t=SI(this._delegate),t.then(r=>new Oo(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,r._snapshot)))}onSnapshot(...e){let t=UI(e),r=BI(e,i=>new Oo(this.firestore,new xt(this.firestore._delegate,this._userDataWriter,this._delegate,i._snapshot)));return gp(this._delegate,t,r)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}},wp=class{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new xr(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}},Oo=class{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new Nr(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new xr(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(t=>new wp(this._firestore,t))}forEach(e,t){this._delegate.forEach(r=>{e.call(t,new xr(this._firestore,r))})}isEqual(e){return fp(this._delegate,e._delegate)}},ji=class n extends Nr{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){let e=this._delegate.parent;return e?new Qt(this.firestore,e):null}doc(e){try{return e===void 0?new Qt(this.firestore,Vo(this._delegate)):new Qt(this.firestore,Vo(this._delegate,e))}catch(t){throw st(t,"doc()","CollectionReference.doc()")}}add(e){return PI(this._delegate,e).then(t=>new Qt(this.firestore,t))}isEqual(e){return ap(this._delegate,e._delegate)}withConverter(e){return new n(this.firestore,e?this._delegate.withConverter(Gi.getInstance(this.firestore,e)):this._delegate.withConverter(null))}};function Rr(n){return oe(n,pe)}var Ep=class n{constructor(...e){this._delegate=new Pt(...e)}static documentId(){return new n(Ce.keyField().canonicalString())}isEqual(e){return e=ee(e),e instanceof Pt?this._delegate._internalPath.isEqual(e._internalPath):!1}};var Ip=class n{constructor(e){this._delegate=e}static serverTimestamp(){let e=kI();return e._methodName="FieldValue.serverTimestamp",new n(e)}static delete(){let e=DI();return e._methodName="FieldValue.delete",new n(e)}static arrayUnion(...e){let t=VI(...e);return t._methodName="FieldValue.arrayUnion",new n(t)}static arrayRemove(...e){let t=OI(...e);return t._methodName="FieldValue.arrayRemove",new n(t)}static increment(e){let t=FI(e);return t._methodName="FieldValue.increment",new n(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}};var Fb={Firestore:Bu,GeoPoint:Ir,Timestamp:Ee,Blob:Uu,Transaction:qu,WriteBatch:Gu,DocumentReference:Qt,DocumentSnapshot:Pr,Query:Nr,QueryDocumentSnapshot:xr,QuerySnapshot:Oo,CollectionReference:ji,FieldPath:Ep,FieldValue:Ip,setLogLevel:Ob,CACHE_SIZE_UNLIMITED:$E};function Mb(n,e){n.INTERNAL.registerComponent(new Dt("firestore-compat",t=>{let r=t.getProvider("app-compat").getImmediate(),i=t.getProvider("firestore").getImmediate();return e(r,i)},"PUBLIC").setServiceProps(Object.assign({},Fb)))}function Lb(n){Mb(n,(e,t)=>new Bu(e,t,new vp)),n.registerVersion(Db,kb)}Lb(gn);function Ub(n,e=ea){return new Zo(t=>{let r;return e!=null?e.schedule(()=>{r=n.onSnapshot({includeMetadataChanges:!0},t)}):r=n.onSnapshot({includeMetadataChanges:!0},t),()=>{r?.()}})}function qI(n,e){return Ub(n,e)}function Bb(n,e){return qI(n,e).pipe(ra(void 0),na(),Le(t=>{let[r,i]=t;return i.exists?r?.exists?{payload:i,type:"modified"}:{payload:i,type:"added"}:{payload:i,type:"removed"}}))}function Cp(n,e){return qI(n,e).pipe(Le(t=>({payload:t,type:"query"})))}var ju=class{ref;afs;constructor(e,t){this.ref=e,this.afs=t}set(e,t){return this.ref.set(e,t)}update(e){return this.ref.update(e)}delete(){return this.ref.delete()}collection(e,t){let r=this.ref.collection(e),{ref:i,query:s}=WI(r,t);return new zu(i,s,this.afs)}snapshotChanges(){return Bb(this.ref,this.afs.schedulers.outsideAngular).pipe(Oe)}valueChanges(e={}){return this.snapshotChanges().pipe(Le(({payload:t})=>e.idField?us(Fr({},t.data()),{[e.idField]:t.id}):t.data()))}get(e){return cs(this.ref.get(e)).pipe(Oe)}};function Ku(n,e){return Cp(n,e).pipe(ra(void 0),na(),Le(t=>{let[r,i]=t,s=i.payload.docChanges(),o=s.map(l=>({type:l.type,payload:l}));return r&&JSON.stringify(r.payload.metadata)!==JSON.stringify(i.payload.metadata)&&i.payload.docs.forEach((l,u)=>{let c=s.find(m=>m.doc.ref.isEqual(l.ref)),d=r?.payload.docs.find(m=>m.ref.isEqual(l.ref));c&&JSON.stringify(c.doc.metadata)===JSON.stringify(l.metadata)||!c&&d&&JSON.stringify(d.metadata)===JSON.stringify(l.metadata)||o.push({type:"modified",payload:{oldIndex:u,newIndex:u,type:"modified",doc:l}})}),o}))}function GI(n,e,t){return Ku(n,t).pipe(Yn((r,i)=>qb(r,i.map(s=>s.payload),e),[]),ta(),Le(r=>r.map(i=>({type:i.type,payload:i}))))}function qb(n,e,t){return e.forEach(r=>{t.indexOf(r.type)>-1&&(n=Gb(n,r))}),n}function Ap(n,e,t,...r){let i=n.slice();return i.splice(e,t,...r),i}function Gb(n,e){switch(e.type){case"added":if(!(n[e.newIndex]&&n[e.newIndex].doc.ref.isEqual(e.doc.ref)))return Ap(n,e.newIndex,0,e);break;case"modified":if(n[e.oldIndex]==null||n[e.oldIndex].doc.ref.isEqual(e.doc.ref))if(e.oldIndex!==e.newIndex){let t=n.slice();return t.splice(e.oldIndex,1),t.splice(e.newIndex,0,e),t}else return Ap(n,e.newIndex,1,e);break;case"removed":if(n[e.oldIndex]&&n[e.oldIndex].doc.ref.isEqual(e.doc.ref))return Ap(n,e.oldIndex,1);break}return n}function jI(n){return(!n||n.length===0)&&(n=["added","removed","modified"]),n}var zu=class{ref;query;afs;constructor(e,t,r){this.ref=e,this.query=t,this.afs=r}stateChanges(e){let t=Ku(this.query,this.afs.schedulers.outsideAngular);return e&&e.length>0&&(t=t.pipe(Le(r=>r.filter(i=>e.indexOf(i.type)>-1)))),t.pipe(ra(void 0),na(),vc(([r,i])=>i.length>0||!r),Le(([,r])=>r),Oe)}auditTrail(e){return this.stateChanges(e).pipe(Yn((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=jI(e);return GI(this.query,t,this.afs.schedulers.outsideAngular).pipe(Oe)}valueChanges(e={}){return Cp(this.query,this.afs.schedulers.outsideAngular).pipe(Le(t=>t.payload.docs.map(r=>e.idField?us(Fr({},r.data()),{[e.idField]:r.id}):r.data())),Oe)}get(e){return cs(this.query.get(e)).pipe(Oe)}add(e){return this.ref.add(e)}doc(e){return new ju(this.ref.doc(e),this.afs)}},Sp=class{query;afs;constructor(e,t){this.query=e,this.afs=t}stateChanges(e){return!e||e.length===0?Ku(this.query,this.afs.schedulers.outsideAngular).pipe(Oe):Ku(this.query,this.afs.schedulers.outsideAngular).pipe(Le(t=>t.filter(r=>e.indexOf(r.type)>-1)),vc(t=>t.length>0),Oe)}auditTrail(e){return this.stateChanges(e).pipe(Yn((t,r)=>[...t,...r],[]))}snapshotChanges(e){let t=jI(e);return GI(this.query,t,this.afs.schedulers.outsideAngular).pipe(Oe)}valueChanges(e={}){return Cp(this.query,this.afs.schedulers.outsideAngular).pipe(Le(r=>r.payload.docs.map(i=>e.idField?Fr({[e.idField]:i.id},i.data()):i.data())),Oe)}get(e){return cs(this.query.get(e)).pipe(Oe)}},KI=new mn("angularfire2.enableFirestorePersistence"),zI=new mn("angularfire2.firestore.persistenceSettings"),jb=new mn("angularfire2.firestore.settings"),Kb=new mn("angularfire2.firestore.use-emulator");function WI(n,e=t=>t){return{query:e(n),ref:n}}var zb=(()=>{class n{schedulers;firestore;persistenceEnabled$;constructor(t,r,i,s,o,l,u,c,d,m,p,y,S,x,D,q,j){this.schedulers=u;let B=wa(t,l,r),Y=d;m&&Ra(B,l,p,S,x,D,y,q),[this.firestore,this.persistenceEnabled$]=Ea(`${B.name}.firestore`,"AngularFirestore",B.name,()=>{let ne=l.runOutsideAngular(()=>B.firestore());if(s&&ne.settings(s),Y&&ne.useEmulator(...Y),i&&!Dg(o)){let Q=()=>{try{return cs(ne.enablePersistence(c||void 0).then(()=>!0,()=>!1))}catch(E){return typeof console<"u"&&console.warn(E),hs(!1)}};return[ne,l.runOutsideAngular(Q)]}else return[ne,hs(!1)]},[s,Y,i])}collection(t,r){let i;typeof t=="string"?i=this.firestore.collection(t):i=t;let{ref:s,query:o}=WI(i,r),l=this.schedulers.ngZone.run(()=>s);return new zu(l,o,this)}collectionGroup(t,r){let i=r||(o=>o),s=this.firestore.collectionGroup(t);return new Sp(i(s),this)}doc(t){let r;typeof t=="string"?r=this.firestore.doc(t):r=t;let i=this.schedulers.ngZone.run(()=>r);return new ju(i,this)}createId(){return this.firestore.collection("_").doc().id}static \u0275fac=function(r){return new(r||n)(re(ya),re(va,8),re(KI,8),re(jb,8),re(aa),re(la),re(_a),re(zI,8),re(Kb,8),re(Pa,8),re(Ia,8),re(Ta,8),re(Aa,8),re(Sa,8),re(Ca,8),re(ba,8),re(ga,8))};static \u0275prov=ia({token:n,factory:n.\u0275fac,providedIn:"any"})}return n})(),iP=(()=>{class n{constructor(){gn.registerVersion("angularfire",pa.full,"fst-compat")}static enablePersistence(t){return{ngModule:n,providers:[{provide:KI,useValue:!0},{provide:zI,useValue:t}]}}static \u0275fac=function(r){return new(r||n)};static \u0275mod=oa({type:n});static \u0275inj=sa({providers:[zb]})}return n})();var aP={production:!0,firebase:{apiKey:"********************************",authDomain:"********************************",projectId:"********************************",storageBucket:"********************************",messagingSenderId:"********************************",appId:"********************************",measurementId:"********************************"}};export{yR as a,iP as b,aP as c};
